// livekit-client@2.15.6 downloaded from https://ga.jspm.io/npm:livekit-client@2.15.6/dist/livekit-client.esm.mjs

function e(e,t){t.forEach((function(t){t&&typeof t!=="string"&&!Array.isArray(t)&&Object.keys(t).forEach((function(i){if(i!=="default"&&!(i in e)){var n=Object.getOwnPropertyDescriptor(t,i);Object.defineProperty(e,i,n.get?n:{enumerable:true,get:function(){return t[i]}})}}))}));return Object.freeze(e)}var t=Object.defineProperty;var i=(e,i,n)=>i in e?t(e,i,{enumerable:true,configurable:true,writable:true,value:n}):e[i]=n;var n=(e,t,n)=>i(e,typeof t!="symbol"?t+"":t,n);class _{constructor(){n(this,"_locking");n(this,"_locks");this._locking=Promise.resolve(),this._locks=0}isLocked(){return this._locks>0}lock(){this._locks+=1;let e;const t=new Promise((t=>e=()=>{this._locks-=1,t()})),i=this._locking.then((()=>e));return this._locking=this._locking.then((()=>t)),i}}function r(e,t){if(!e)throw new Error(t)}const s=34028234663852886e22,o=-34028234663852886e22,a=4294967295,c=2147483647,d=-2147483648;function l(e){if(typeof e!=="number")throw new Error("invalid int 32: "+typeof e);if(!Number.isInteger(e)||e>c||e<d)throw new Error("invalid int 32: "+e)}function u(e){if(typeof e!=="number")throw new Error("invalid uint 32: "+typeof e);if(!Number.isInteger(e)||e>a||e<0)throw new Error("invalid uint 32: "+e)}function h(e){if(typeof e!=="number")throw new Error("invalid float 32: "+typeof e);if(Number.isFinite(e)&&(e>s||e<o))throw new Error("invalid float 32: "+e)}const p=Symbol("@bufbuild/protobuf/enum-type");function m(e){const t=e[p];r(t,"missing enum type on enum object");return t}function g(e,t,i,n){e[p]=f(t,i.map((t=>({no:t.no,name:t.name,localName:e[t.no]}))))}function f(e,t,i){const n=Object.create(null);const r=Object.create(null);const s=[];for(const e of t){const t=k(e);s.push(t);n[e.name]=t;r[e.no]=t}return{typeName:e,values:s,findName(e){return n[e]},findNumber(e){return r[e]}}}function v(e,t,i){const n={};for(const e of t){const t=k(e);n[t.localName]=t.no;n[t.no]=t.localName}g(n,e,t);return n}function k(e){return"localName"in e?e:Object.assign(Object.assign({},e),{localName:e.name})}class Message{equals(e){return this.getType().runtime.util.equals(this.getType(),this,e)}clone(){return this.getType().runtime.util.clone(this)}fromBinary(e,t){const i=this.getType(),n=i.runtime.bin,r=n.makeReadOptions(t);n.readMessage(this,r.readerFactory(e),e.byteLength,r);return this}fromJson(e,t){const i=this.getType(),n=i.runtime.json,r=n.makeReadOptions(t);n.readMessage(i,e,r,this);return this}fromJsonString(e,t){let i;try{i=JSON.parse(e)}catch(e){throw new Error("cannot decode ".concat(this.getType().typeName," from JSON: ").concat(e instanceof Error?e.message:String(e)))}return this.fromJson(i,t)}toBinary(e){const t=this.getType(),i=t.runtime.bin,n=i.makeWriteOptions(e),r=n.writerFactory();i.writeMessage(this,r,n);return r.finish()}toJson(e){const t=this.getType(),i=t.runtime.json,n=i.makeWriteOptions(e);return i.writeMessage(this,n)}toJsonString(e){var t;const i=this.toJson(e);return JSON.stringify(i,null,(t=e===null||e===void 0?void 0:e.prettySpaces)!==null&&t!==void 0?t:0)}toJSON(){return this.toJson({emitDefaultValues:true})}getType(){return Object.getPrototypeOf(this).constructor}}function b(e,t,i,n){var r;const s=(r=n===null||n===void 0?void 0:n.localName)!==null&&r!==void 0?r:t.substring(t.lastIndexOf(".")+1);const o={[s]:function(t){e.util.initFields(this);e.util.initPartial(t,this)}}[s];Object.setPrototypeOf(o.prototype,new Message);Object.assign(o,{runtime:e,typeName:t,fields:e.util.newFieldList(i),fromBinary(e,t){return(new o).fromBinary(e,t)},fromJson(e,t){return(new o).fromJson(e,t)},fromJsonString(e,t){return(new o).fromJsonString(e,t)},equals(t,i){return e.util.equals(o,t,i)}});return o}
/* eslint-disable prefer-const,@typescript-eslint/restrict-plus-operands */function y(){let e=0;let t=0;for(let i=0;i<28;i+=7){let n=this.buf[this.pos++];e|=(n&127)<<i;if((n&128)==0){this.assertBounds();return[e,t]}}let i=this.buf[this.pos++];e|=(i&15)<<28;t=(i&112)>>4;if((i&128)==0){this.assertBounds();return[e,t]}for(let i=3;i<=31;i+=7){let n=this.buf[this.pos++];t|=(n&127)<<i;if((n&128)==0){this.assertBounds();return[e,t]}}throw new Error("invalid varint")}function T(e,t,i){for(let n=0;n<28;n+=7){const r=e>>>n;const s=!(r>>>7==0&&t==0);const o=(s?r|128:r)&255;i.push(o);if(!s)return}const n=e>>>28&15|(t&7)<<4;const r=!(t>>3==0);i.push((r?n|128:n)&255);if(r){for(let e=3;e<31;e+=7){const n=t>>>e;const r=!(n>>>7==0);const s=(r?n|128:n)&255;i.push(s);if(!r)return}i.push(t>>>31&1)}}const C=4294967296;function S(e){const t=e[0]==="-";t&&(e=e.slice(1));const i=1e6;let n=0;let r=0;function s(t,s){const o=Number(e.slice(t,s));r*=i;n=n*i+o;if(n>=C){r+=n/C|0;n%=C}}s(-24,-18);s(-18,-12);s(-12,-6);s(-6);return t?I(n,r):R(n,r)}function w(e,t){let i=R(e,t);const n=i.hi&2147483648;n&&(i=I(i.lo,i.hi));const r=E(i.lo,i.hi);return n?"-"+r:r}function E(e,t){({lo:e,hi:t}=P(e,t));if(t<=2097151)return String(C*t+e);const i=e&16777215;const n=16777215&(e>>>24|t<<8);const r=t>>16&65535;let s=i+n*6777216+r*6710656;let o=n+r*8147497;let a=r*2;const c=1e7;if(s>=c){o+=Math.floor(s/c);s%=c}if(o>=c){a+=Math.floor(o/c);o%=c}return a.toString()+O(o)+O(s)}function P(e,t){return{lo:e>>>0,hi:t>>>0}}function R(e,t){return{lo:e|0,hi:t|0}}function I(e,t){t=~t;e?e=1+~e:t+=1;return R(e,t)}const O=e=>{const t=String(e);return"0000000".slice(t.length)+t};function D(e,t){if(e>=0){while(e>127){t.push(e&127|128);e>>>=7}t.push(e)}else{for(let i=0;i<9;i++){t.push(e&127|128);e>>=7}t.push(1)}}function x(){let e=this.buf[this.pos++];let t=e&127;if((e&128)==0){this.assertBounds();return t}e=this.buf[this.pos++];t|=(e&127)<<7;if((e&128)==0){this.assertBounds();return t}e=this.buf[this.pos++];t|=(e&127)<<14;if((e&128)==0){this.assertBounds();return t}e=this.buf[this.pos++];t|=(e&127)<<21;if((e&128)==0){this.assertBounds();return t}e=this.buf[this.pos++];t|=(e&15)<<28;for(let t=5;(e&128)!==0&&t<10;t++)e=this.buf[this.pos++];if((e&128)!=0)throw new Error("invalid varint");this.assertBounds();return t>>>0}function M(){const e=new DataView(new ArrayBuffer(8));const t=typeof BigInt==="function"&&typeof e.getBigInt64==="function"&&typeof e.getBigUint64==="function"&&typeof e.setBigInt64==="function"&&typeof e.setBigUint64==="function"&&(typeof process!="object"||typeof process.env!="object"||process.env.BUF_BIGINT_DISABLE!=="1");if(t){const t=BigInt("-9223372036854775808"),i=BigInt("9223372036854775807"),n=BigInt("0"),r=BigInt("18446744073709551615");return{zero:BigInt(0),supported:true,parse(e){const n=typeof e=="bigint"?e:BigInt(e);if(n>i||n<t)throw new Error("int64 invalid: ".concat(e));return n},uParse(e){const t=typeof e=="bigint"?e:BigInt(e);if(t>r||t<n)throw new Error("uint64 invalid: ".concat(e));return t},enc(t){e.setBigInt64(0,this.parse(t),true);return{lo:e.getInt32(0,true),hi:e.getInt32(4,true)}},uEnc(t){e.setBigInt64(0,this.uParse(t),true);return{lo:e.getInt32(0,true),hi:e.getInt32(4,true)}},dec(t,i){e.setInt32(0,t,true);e.setInt32(4,i,true);return e.getBigInt64(0,true)},uDec(t,i){e.setInt32(0,t,true);e.setInt32(4,i,true);return e.getBigUint64(0,true)}}}const i=e=>r(/^-?[0-9]+$/.test(e),"int64 invalid: ".concat(e));const n=e=>r(/^[0-9]+$/.test(e),"uint64 invalid: ".concat(e));return{zero:"0",supported:false,parse(e){typeof e!="string"&&(e=e.toString());i(e);return e},uParse(e){typeof e!="string"&&(e=e.toString());n(e);return e},enc(e){typeof e!="string"&&(e=e.toString());i(e);return S(e)},uEnc(e){typeof e!="string"&&(e=e.toString());n(e);return S(e)},dec(e,t){return w(e,t)},uDec(e,t){return E(e,t)}}}const A=M();var N;(function(e){e[e.DOUBLE=1]="DOUBLE";e[e.FLOAT=2]="FLOAT";e[e.INT64=3]="INT64";e[e.UINT64=4]="UINT64";e[e.INT32=5]="INT32";e[e.FIXED64=6]="FIXED64";e[e.FIXED32=7]="FIXED32";e[e.BOOL=8]="BOOL";e[e.STRING=9]="STRING";e[e.BYTES=12]="BYTES";e[e.UINT32=13]="UINT32";e[e.SFIXED32=15]="SFIXED32";e[e.SFIXED64=16]="SFIXED64";e[e.SINT32=17]="SINT32";e[e.SINT64=18]="SINT64"})(N||(N={}));var L;(function(e){e[e.BIGINT=0]="BIGINT";e[e.STRING=1]="STRING"})(L||(L={}));function U(e,t,i){if(t===i)return true;if(e==N.BYTES){if(!(t instanceof Uint8Array)||!(i instanceof Uint8Array))return false;if(t.length!==i.length)return false;for(let e=0;e<t.length;e++)if(t[e]!==i[e])return false;return true}switch(e){case N.UINT64:case N.FIXED64:case N.INT64:case N.SFIXED64:case N.SINT64:return t==i}return false}function j(e,t){switch(e){case N.BOOL:return false;case N.UINT64:case N.FIXED64:case N.INT64:case N.SFIXED64:case N.SINT64:return t==0?A.zero:"0";case N.DOUBLE:case N.FLOAT:return 0;case N.BYTES:return new Uint8Array(0);case N.STRING:return"";default:return 0}}function F(e,t){switch(e){case N.BOOL:return t===false;case N.STRING:return t==="";case N.BYTES:return t instanceof Uint8Array&&!t.byteLength;default:return t==0}}
/* eslint-disable prefer-const,no-case-declarations,@typescript-eslint/restrict-plus-operands */var B;(function(e){e[e.Varint=0]="Varint";e[e.Bit64=1]="Bit64";e[e.LengthDelimited=2]="LengthDelimited";e[e.StartGroup=3]="StartGroup";e[e.EndGroup=4]="EndGroup";e[e.Bit32=5]="Bit32"})(B||(B={}));class BinaryWriter{constructor(e){this.stack=[];this.textEncoder=e!==null&&e!==void 0?e:new TextEncoder;this.chunks=[];this.buf=[]}finish(){this.chunks.push(new Uint8Array(this.buf));let e=0;for(let t=0;t<this.chunks.length;t++)e+=this.chunks[t].length;let t=new Uint8Array(e);let i=0;for(let e=0;e<this.chunks.length;e++){t.set(this.chunks[e],i);i+=this.chunks[e].length}this.chunks=[];return t}fork(){this.stack.push({chunks:this.chunks,buf:this.buf});this.chunks=[];this.buf=[];return this}join(){let e=this.finish();let t=this.stack.pop();if(!t)throw new Error("invalid state, fork stack empty");this.chunks=t.chunks;this.buf=t.buf;this.uint32(e.byteLength);return this.raw(e)}tag(e,t){return this.uint32((e<<3|t)>>>0)}raw(e){if(this.buf.length){this.chunks.push(new Uint8Array(this.buf));this.buf=[]}this.chunks.push(e);return this}uint32(e){u(e);while(e>127){this.buf.push(e&127|128);e>>>=7}this.buf.push(e);return this}int32(e){l(e);D(e,this.buf);return this}bool(e){this.buf.push(e?1:0);return this}bytes(e){this.uint32(e.byteLength);return this.raw(e)}string(e){let t=this.textEncoder.encode(e);this.uint32(t.byteLength);return this.raw(t)}float(e){h(e);let t=new Uint8Array(4);new DataView(t.buffer).setFloat32(0,e,true);return this.raw(t)}double(e){let t=new Uint8Array(8);new DataView(t.buffer).setFloat64(0,e,true);return this.raw(t)}fixed32(e){u(e);let t=new Uint8Array(4);new DataView(t.buffer).setUint32(0,e,true);return this.raw(t)}sfixed32(e){l(e);let t=new Uint8Array(4);new DataView(t.buffer).setInt32(0,e,true);return this.raw(t)}sint32(e){l(e);e=(e<<1^e>>31)>>>0;D(e,this.buf);return this}sfixed64(e){let t=new Uint8Array(8),i=new DataView(t.buffer),n=A.enc(e);i.setInt32(0,n.lo,true);i.setInt32(4,n.hi,true);return this.raw(t)}fixed64(e){let t=new Uint8Array(8),i=new DataView(t.buffer),n=A.uEnc(e);i.setInt32(0,n.lo,true);i.setInt32(4,n.hi,true);return this.raw(t)}int64(e){let t=A.enc(e);T(t.lo,t.hi,this.buf);return this}sint64(e){let t=A.enc(e),i=t.hi>>31,n=t.lo<<1^i,r=(t.hi<<1|t.lo>>>31)^i;T(n,r,this.buf);return this}uint64(e){let t=A.uEnc(e);T(t.lo,t.hi,this.buf);return this}}class BinaryReader{constructor(e,t){this.varint64=y;this.uint32=x;this.buf=e;this.len=e.length;this.pos=0;this.view=new DataView(e.buffer,e.byteOffset,e.byteLength);this.textDecoder=t!==null&&t!==void 0?t:new TextDecoder}tag(){let e=this.uint32(),t=e>>>3,i=e&7;if(t<=0||i<0||i>5)throw new Error("illegal tag: field no "+t+" wire type "+i);return[t,i]}skip(e,t){let i=this.pos;switch(e){case B.Varint:while(this.buf[this.pos++]&128);break;case B.Bit64:this.pos+=4;case B.Bit32:this.pos+=4;break;case B.LengthDelimited:let i=this.uint32();this.pos+=i;break;case B.StartGroup:for(;;){const[e,i]=this.tag();if(i===B.EndGroup){if(t!==void 0&&e!==t)throw new Error("invalid end group tag");break}this.skip(i,e)}break;default:throw new Error("cant skip wire type "+e)}this.assertBounds();return this.buf.subarray(i,this.pos)}assertBounds(){if(this.pos>this.len)throw new RangeError("premature EOF")}int32(){return this.uint32()|0}sint32(){let e=this.uint32();return e>>>1^-(e&1)}int64(){return A.dec(...this.varint64())}uint64(){return A.uDec(...this.varint64())}sint64(){let[e,t]=this.varint64();let i=-(e&1);e=(e>>>1|(t&1)<<31)^i;t=t>>>1^i;return A.dec(e,t)}bool(){let[e,t]=this.varint64();return e!==0||t!==0}fixed32(){return this.view.getUint32((this.pos+=4)-4,true)}sfixed32(){return this.view.getInt32((this.pos+=4)-4,true)}fixed64(){return A.uDec(this.sfixed32(),this.sfixed32())}sfixed64(){return A.dec(this.sfixed32(),this.sfixed32())}float(){return this.view.getFloat32((this.pos+=4)-4,true)}double(){return this.view.getFloat64((this.pos+=8)-8,true)}bytes(){let e=this.uint32(),t=this.pos;this.pos+=e;this.assertBounds();return this.buf.subarray(t,t+e)}string(){return this.textDecoder.decode(this.bytes())}}function V(e,t,i,n){let r;return{typeName:t,extendee:i,get field(){if(!r){const i=typeof n=="function"?n():n;i.name=t.split(".").pop();i.jsonName="[".concat(t,"]");r=e.util.newFieldList([i]).list()[0]}return r},runtime:e}}function q(e){const t=e.field.localName;const i=Object.create(null);i[t]=H(e);return[i,()=>i[t]]}function H(e){const t=e.field;if(t.repeated)return[];if(t.default!==void 0)return t.default;switch(t.kind){case"enum":return t.T.values[0].no;case"scalar":return j(t.T,t.L);case"message":const e=t.T,i=new e;return e.fieldWrapper?e.fieldWrapper.unwrapField(i):i;case"map":throw"map fields are not allowed to be extensions"}}function W(e,t){if(!t.repeated&&(t.kind=="enum"||t.kind=="scalar")){for(let i=e.length-1;i>=0;--i)if(e[i].no==t.no)return[e[i]];return[]}return e.filter((e=>e.no===t.no))}
/* eslint-disable @typescript-eslint/ban-ts-comment, @typescript-eslint/no-unnecessary-condition, prefer-const */let K="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split("");let G=[];for(let e=0;e<K.length;e++)G[K[e].charCodeAt(0)]=e;G["-".charCodeAt(0)]=K.indexOf("+");G["_".charCodeAt(0)]=K.indexOf("/");const z={dec(e){let t=e.length*3/4;e[e.length-2]=="="?t-=2:e[e.length-1]=="="&&(t-=1);let i,n=new Uint8Array(t),r=0,s=0,o=0;for(let t=0;t<e.length;t++){i=G[e.charCodeAt(t)];if(i===void 0)switch(e[t]){case"=":s=0;case"\n":case"\r":case"\t":case" ":continue;default:throw Error("invalid base64 string.")}switch(s){case 0:o=i;s=1;break;case 1:n[r++]=o<<2|(i&48)>>4;o=i;s=2;break;case 2:n[r++]=(o&15)<<4|(i&60)>>2;o=i;s=3;break;case 3:n[r++]=(o&3)<<6|i;s=0;break}}if(s==1)throw Error("invalid base64 string.");return n.subarray(0,r)},enc(e){let t,i="",n=0,r=0;for(let s=0;s<e.length;s++){t=e[s];switch(n){case 0:i+=K[t>>2];r=(t&3)<<4;n=1;break;case 1:i+=K[r|t>>4];r=(t&15)<<2;n=2;break;case 2:i+=K[r|t>>6];i+=K[t&63];n=0;break}}if(n){i+=K[r];i+="=";n==1&&(i+="=")}return i}};function J(e,t,i){X(t,e);const n=t.runtime.bin.makeReadOptions(i);const r=W(e.getType().runtime.bin.listUnknownFields(e),t.field);const[s,o]=q(t);for(const e of r)t.runtime.bin.readField(s,n.readerFactory(e.data),t.field,e.wireType,n);return o()}function Q(e,t,i,n){X(t,e);const r=t.runtime.bin.makeReadOptions(n);const s=t.runtime.bin.makeWriteOptions(n);if(Y(e,t)){const i=e.getType().runtime.bin.listUnknownFields(e).filter((e=>e.no!=t.field.no));e.getType().runtime.bin.discardUnknownFields(e);for(const t of i)e.getType().runtime.bin.onUnknownField(e,t.no,t.wireType,t.data)}const o=s.writerFactory();let a=t.field;a.opt||a.repeated||a.kind!="enum"&&a.kind!="scalar"||(a=Object.assign(Object.assign({},t.field),{opt:true}));t.runtime.bin.writeField(a,i,o,s);const c=r.readerFactory(o.finish());while(c.pos<c.len){const[t,i]=c.tag();const n=c.skip(i,t);e.getType().runtime.bin.onUnknownField(e,t,i,n)}}function Y(e,t){const i=e.getType();return t.extendee.typeName===i.typeName&&!!i.runtime.bin.listUnknownFields(e).find((e=>e.no==t.field.no))}function X(e,t){r(e.extendee.typeName==t.getType().typeName,"extension ".concat(e.typeName," can only be applied to message ").concat(e.extendee.typeName))}function Z(e,t){const i=e.localName;if(e.repeated)return t[i].length>0;if(e.oneof)return t[e.oneof.localName].case===i;switch(e.kind){case"enum":case"scalar":return e.opt||e.req?t[i]!==void 0:e.kind=="enum"?t[i]!==e.T.values[0].no:!F(e.T,t[i]);case"message":return t[i]!==void 0;case"map":return Object.keys(t[i]).length>0}}function $(e,t){const i=e.localName;const n=!e.opt&&!e.req;if(e.repeated)t[i]=[];else if(e.oneof)t[e.oneof.localName]={case:void 0};else switch(e.kind){case"map":t[i]={};break;case"enum":t[i]=n?e.T.values[0].no:void 0;break;case"scalar":t[i]=n?j(e.T,e.L):void 0;break;case"message":t[i]=void 0;break}}function ee(e,t){if(e===null||typeof e!="object")return false;if(!Object.getOwnPropertyNames(Message.prototype).every((t=>t in e&&typeof e[t]=="function")))return false;const i=e.getType();return i!==null&&typeof i=="function"&&"typeName"in i&&typeof i.typeName=="string"&&(t===void 0||i.typeName==t.typeName)}function te(e,t){return ee(t)||!e.fieldWrapper?t:e.fieldWrapper.wrapField(t)}({"google.protobuf.DoubleValue":N.DOUBLE,"google.protobuf.FloatValue":N.FLOAT,"google.protobuf.Int64Value":N.INT64,"google.protobuf.UInt64Value":N.UINT64,"google.protobuf.Int32Value":N.INT32,"google.protobuf.UInt32Value":N.UINT32,"google.protobuf.BoolValue":N.BOOL,"google.protobuf.StringValue":N.STRING,"google.protobuf.BytesValue":N.BYTES});
/* eslint-disable no-case-declarations,@typescript-eslint/no-unsafe-argument,@typescript-eslint/no-unsafe-assignment,@typescript-eslint/no-unsafe-member-access,@typescript-eslint/no-unsafe-call */const ie={ignoreUnknownFields:false};const ne={emitDefaultValues:false,enumAsInteger:false,useProtoFieldName:false,prettySpaces:0};function re(e){return e?Object.assign(Object.assign({},ie),e):ie}function se(e){return e?Object.assign(Object.assign({},ne),e):ne}const oe=Symbol();const ae=Symbol();function ce(){return{makeReadOptions:re,makeWriteOptions:se,readMessage(e,t,i,n){if(t==null||Array.isArray(t)||typeof t!="object")throw new Error("cannot decode message ".concat(e.typeName," from JSON: ").concat(de(t)));n=n!==null&&n!==void 0?n:new e;const r=new Map;const s=i.typeRegistry;for(const[o,a]of Object.entries(t)){const t=e.fields.findJsonName(o);if(t){if(t.oneof){if(a===null&&t.kind=="scalar")continue;const i=r.get(t.oneof);if(i!==void 0)throw new Error("cannot decode message ".concat(e.typeName,' from JSON: multiple keys for oneof "').concat(t.oneof.name,'" present: "').concat(i,'", "').concat(o,'"'));r.set(t.oneof,o)}le(n,a,t,i,e)}else{let t=false;if((s===null||s===void 0?void 0:s.findExtension)&&o.startsWith("[")&&o.endsWith("]")){const r=s.findExtension(o.substring(1,o.length-1));if(r&&r.extendee.typeName==e.typeName){t=true;const[e,s]=q(r);le(e,a,r.field,i,r);Q(n,r,s(),i)}}if(!t&&!i.ignoreUnknownFields)throw new Error("cannot decode message ".concat(e.typeName,' from JSON: key "').concat(o,'" is unknown'))}}return n},writeMessage(e,t){const i=e.getType();const n={};let r;try{for(r of i.fields.byNumber()){if(!Z(r,e)){if(r.req)throw"required field not set";if(!t.emitDefaultValues)continue;if(!me(r))continue}const i=r.oneof?e[r.oneof.localName].value:e[r.localName];const s=ge(r,i,t);s!==void 0&&(n[t.useProtoFieldName?r.name:r.jsonName]=s)}const s=t.typeRegistry;if(s===null||s===void 0?void 0:s.findExtensionFor)for(const r of i.runtime.bin.listUnknownFields(e)){const o=s.findExtensionFor(i.typeName,r.no);if(o&&Y(e,o)){const i=J(e,o,t);const r=ge(o.field,i,t);r!==void 0&&(n[o.field.jsonName]=r)}}}catch(e){const t=r?"cannot encode field ".concat(i.typeName,".").concat(r.name," to JSON"):"cannot encode message ".concat(i.typeName," to JSON");const n=e instanceof Error?e.message:String(e);throw new Error(t+(n.length>0?": ".concat(n):""))}return n},readScalar(e,t,i){return he(e,t,i!==null&&i!==void 0?i:L.BIGINT,true)},writeScalar(e,t,i){if(t!==void 0)return i||F(e,t)?ve(e,t):void 0},debug:de}}function de(e){if(e===null)return"null";switch(typeof e){case"object":return Array.isArray(e)?"array":"object";case"string":return e.length>100?"string":'"'.concat(e.split('"').join('\\"'),'"');default:return String(e)}}function le(e,t,i,n,s){let o=i.localName;if(i.repeated){r(i.kind!="map");if(t===null)return;if(!Array.isArray(t))throw new Error("cannot decode field ".concat(s.typeName,".").concat(i.name," from JSON: ").concat(de(t)));const a=e[o];for(const e of t){if(e===null)throw new Error("cannot decode field ".concat(s.typeName,".").concat(i.name," from JSON: ").concat(de(e)));switch(i.kind){case"message":a.push(i.T.fromJson(e,n));break;case"enum":const t=pe(i.T,e,n.ignoreUnknownFields,true);t!==ae&&a.push(t);break;case"scalar":try{a.push(he(i.T,e,i.L,true))}catch(t){let n="cannot decode field ".concat(s.typeName,".").concat(i.name," from JSON: ").concat(de(e));t instanceof Error&&t.message.length>0&&(n+=": ".concat(t.message));throw new Error(n)}break}}}else if(i.kind=="map"){if(t===null)return;if(typeof t!="object"||Array.isArray(t))throw new Error("cannot decode field ".concat(s.typeName,".").concat(i.name," from JSON: ").concat(de(t)));const r=e[o];for(const[e,o]of Object.entries(t)){if(o===null)throw new Error("cannot decode field ".concat(s.typeName,".").concat(i.name," from JSON: map value null"));let a;try{a=ue(i.K,e)}catch(e){let n="cannot decode map key for field ".concat(s.typeName,".").concat(i.name," from JSON: ").concat(de(t));e instanceof Error&&e.message.length>0&&(n+=": ".concat(e.message));throw new Error(n)}switch(i.V.kind){case"message":r[a]=i.V.T.fromJson(o,n);break;case"enum":const e=pe(i.V.T,o,n.ignoreUnknownFields,true);e!==ae&&(r[a]=e);break;case"scalar":try{r[a]=he(i.V.T,o,L.BIGINT,true)}catch(e){let n="cannot decode map value for field ".concat(s.typeName,".").concat(i.name," from JSON: ").concat(de(t));e instanceof Error&&e.message.length>0&&(n+=": ".concat(e.message));throw new Error(n)}break}}}else{if(i.oneof){e=e[i.oneof.localName]={case:o};o="value"}switch(i.kind){case"message":const r=i.T;if(t===null&&r.typeName!="google.protobuf.Value")return;let a=e[o];if(ee(a))a.fromJson(t,n);else{e[o]=a=r.fromJson(t,n);r.fieldWrapper&&!i.oneof&&(e[o]=r.fieldWrapper.unwrapField(a))}break;case"enum":const c=pe(i.T,t,n.ignoreUnknownFields,false);switch(c){case oe:$(i,e);break;case ae:break;default:e[o]=c;break}break;case"scalar":try{const n=he(i.T,t,i.L,false);switch(n){case oe:$(i,e);break;default:e[o]=n;break}}catch(e){let n="cannot decode field ".concat(s.typeName,".").concat(i.name," from JSON: ").concat(de(t));e instanceof Error&&e.message.length>0&&(n+=": ".concat(e.message));throw new Error(n)}break}}}function ue(e,t){if(e===N.BOOL)switch(t){case"true":t=true;break;case"false":t=false;break}return he(e,t,L.BIGINT,true).toString()}function he(e,t,i,n){if(t===null)return n?j(e,i):oe;switch(e){case N.DOUBLE:case N.FLOAT:if(t==="NaN")return Number.NaN;if(t==="Infinity")return Number.POSITIVE_INFINITY;if(t==="-Infinity")return Number.NEGATIVE_INFINITY;if(t==="")break;if(typeof t=="string"&&t.trim().length!==t.length)break;if(typeof t!="string"&&typeof t!="number")break;const n=Number(t);if(Number.isNaN(n))break;if(!Number.isFinite(n))break;e==N.FLOAT&&h(n);return n;case N.INT32:case N.FIXED32:case N.SFIXED32:case N.SINT32:case N.UINT32:let r;typeof t=="number"?r=t:typeof t=="string"&&t.length>0&&t.trim().length===t.length&&(r=Number(t));if(r===void 0)break;e==N.UINT32||e==N.FIXED32?u(r):l(r);return r;case N.INT64:case N.SFIXED64:case N.SINT64:if(typeof t!="number"&&typeof t!="string")break;const s=A.parse(t);return i?s.toString():s;case N.FIXED64:case N.UINT64:if(typeof t!="number"&&typeof t!="string")break;const o=A.uParse(t);return i?o.toString():o;case N.BOOL:if(typeof t!=="boolean")break;return t;case N.STRING:if(typeof t!=="string")break;try{encodeURIComponent(t)}catch(e){throw new Error("invalid UTF8")}return t;case N.BYTES:if(t==="")return new Uint8Array(0);if(typeof t!=="string")break;return z.dec(t)}throw new Error}function pe(e,t,i,n){if(t===null)return e.typeName=="google.protobuf.NullValue"?0:n?e.values[0].no:oe;switch(typeof t){case"number":if(Number.isInteger(t))return t;break;case"string":const n=e.findName(t);if(n!==void 0)return n.no;if(i)return ae;break}throw new Error("cannot decode enum ".concat(e.typeName," from JSON: ").concat(de(t)))}function me(e){return!(!e.repeated&&e.kind!="map")||!e.oneof&&(e.kind!="message"&&(!e.opt&&!e.req))}function ge(e,t,i){if(e.kind=="map"){r(typeof t=="object"&&t!=null);const n={};const s=Object.entries(t);switch(e.V.kind){case"scalar":for(const[t,i]of s)n[t.toString()]=ve(e.V.T,i);break;case"message":for(const[e,t]of s)n[e.toString()]=t.toJson(i);break;case"enum":const t=e.V.T;for(const[e,r]of s)n[e.toString()]=fe(t,r,i.enumAsInteger);break}return i.emitDefaultValues||s.length>0?n:void 0}if(e.repeated){r(Array.isArray(t));const n=[];switch(e.kind){case"scalar":for(let i=0;i<t.length;i++)n.push(ve(e.T,t[i]));break;case"enum":for(let r=0;r<t.length;r++)n.push(fe(e.T,t[r],i.enumAsInteger));break;case"message":for(let e=0;e<t.length;e++)n.push(t[e].toJson(i));break}return i.emitDefaultValues||n.length>0?n:void 0}switch(e.kind){case"scalar":return ve(e.T,t);case"enum":return fe(e.T,t,i.enumAsInteger);case"message":return te(e.T,t).toJson(i)}}function fe(e,t,i){var n;r(typeof t=="number");if(e.typeName=="google.protobuf.NullValue")return null;if(i)return t;const s=e.findNumber(t);return(n=s===null||s===void 0?void 0:s.name)!==null&&n!==void 0?n:t}function ve(e,t){switch(e){case N.INT32:case N.SFIXED32:case N.SINT32:case N.FIXED32:case N.UINT32:r(typeof t=="number");return t;case N.FLOAT:case N.DOUBLE:r(typeof t=="number");return Number.isNaN(t)?"NaN":t===Number.POSITIVE_INFINITY?"Infinity":t===Number.NEGATIVE_INFINITY?"-Infinity":t;case N.STRING:r(typeof t=="string");return t;case N.BOOL:r(typeof t=="boolean");return t;case N.UINT64:case N.FIXED64:case N.INT64:case N.SFIXED64:case N.SINT64:r(typeof t=="bigint"||typeof t=="string"||typeof t=="number");return t.toString();case N.BYTES:r(t instanceof Uint8Array);return z.enc(t)}}
/* eslint-disable prefer-const,no-case-declarations,@typescript-eslint/no-explicit-any,@typescript-eslint/no-unsafe-argument,@typescript-eslint/no-unsafe-assignment,@typescript-eslint/no-unsafe-member-access,@typescript-eslint/no-unsafe-call,@typescript-eslint/no-unsafe-return */const ke=Symbol("@bufbuild/protobuf/unknown-fields");const be={readUnknownFields:true,readerFactory:e=>new BinaryReader(e)};const ye={writeUnknownFields:true,writerFactory:()=>new BinaryWriter};function Te(e){return e?Object.assign(Object.assign({},be),e):be}function Ce(e){return e?Object.assign(Object.assign({},ye),e):ye}function Se(){return{makeReadOptions:Te,makeWriteOptions:Ce,listUnknownFields(e){var t;return(t=e[ke])!==null&&t!==void 0?t:[]},discardUnknownFields(e){delete e[ke]},writeUnknownFields(e,t){const i=e;const n=i[ke];if(n)for(const e of n)t.tag(e.no,e.wireType).raw(e.data)},onUnknownField(e,t,i,n){const r=e;Array.isArray(r[ke])||(r[ke]=[]);r[ke].push({no:t,wireType:i,data:n})},readMessage(e,t,i,n,r){const s=e.getType();const o=r?t.len:t.pos+i;let a,c;while(t.pos<o){[a,c]=t.tag();if(r===true&&c==B.EndGroup)break;const i=s.fields.find(a);if(i)we(e,t,i,c,n);else{const i=t.skip(c,a);n.readUnknownFields&&this.onUnknownField(e,a,c,i)}}if(r&&(c!=B.EndGroup||a!==i))throw new Error("invalid end group tag")},readField:we,writeMessage(e,t,i){const n=e.getType();for(const r of n.fields.byNumber()){if(!Z(r,e)){if(r.req)throw new Error("cannot encode field ".concat(n.typeName,".").concat(r.name," to binary: required field not set"));continue}const s=r.oneof?e[r.oneof.localName].value:e[r.localName];Oe(r,s,t,i)}i.writeUnknownFields&&this.writeUnknownFields(e,t);return t},writeField(e,t,i,n){t!==void 0&&Oe(e,t,i,n)}}}function we(e,t,i,n,r){let{repeated:s,localName:o}=i;if(i.oneof){e=e[i.oneof.localName];e.case!=o&&delete e.value;e.case=o;o="value"}switch(i.kind){case"scalar":case"enum":const a=i.kind=="enum"?N.INT32:i.T;let c=Ie;i.kind=="scalar"&&i.L>0&&(c=Re);if(s){let i=e[o];const r=n==B.LengthDelimited&&a!=N.STRING&&a!=N.BYTES;if(r){let e=t.uint32()+t.pos;while(t.pos<e)i.push(c(t,a))}else i.push(c(t,a))}else e[o]=c(t,a);break;case"message":const d=i.T;if(s)e[o].push(Ee(t,new d,r,i));else if(ee(e[o]))Ee(t,e[o],r,i);else{e[o]=Ee(t,new d,r,i);!d.fieldWrapper||i.oneof||i.repeated||(e[o]=d.fieldWrapper.unwrapField(e[o]))}break;case"map":let[l,u]=Pe(i,t,r);e[o][l]=u;break}}function Ee(e,t,i,n){const r=t.getType().runtime.bin;const s=n===null||n===void 0?void 0:n.delimited;r.readMessage(t,e,s?n.no:e.uint32(),i,s);return t}function Pe(e,t,i){const n=t.uint32(),r=t.pos+n;let s,o;while(t.pos<r){const[n]=t.tag();switch(n){case 1:s=Ie(t,e.K);break;case 2:switch(e.V.kind){case"scalar":o=Ie(t,e.V.T);break;case"enum":o=t.int32();break;case"message":o=Ee(t,new e.V.T,i,void 0);break}break}}s===void 0&&(s=j(e.K,L.BIGINT));typeof s!="string"&&typeof s!="number"&&(s=s.toString());if(o===void 0)switch(e.V.kind){case"scalar":o=j(e.V.T,L.BIGINT);break;case"enum":o=e.V.T.values[0].no;break;case"message":o=new e.V.T;break}return[s,o]}function Re(e,t){const i=Ie(e,t);return typeof i=="bigint"?i.toString():i}function Ie(e,t){switch(t){case N.STRING:return e.string();case N.BOOL:return e.bool();case N.DOUBLE:return e.double();case N.FLOAT:return e.float();case N.INT32:return e.int32();case N.INT64:return e.int64();case N.UINT64:return e.uint64();case N.FIXED64:return e.fixed64();case N.BYTES:return e.bytes();case N.FIXED32:return e.fixed32();case N.SFIXED32:return e.sfixed32();case N.SFIXED64:return e.sfixed64();case N.SINT64:return e.sint64();case N.UINT32:return e.uint32();case N.SINT32:return e.sint32()}}function Oe(e,t,i,n){r(t!==void 0);const s=e.repeated;switch(e.kind){case"scalar":case"enum":let o=e.kind=="enum"?N.INT32:e.T;if(s){r(Array.isArray(t));if(e.packed)Ae(i,o,e.no,t);else for(const n of t)Me(i,o,e.no,n)}else Me(i,o,e.no,t);break;case"message":if(s){r(Array.isArray(t));for(const r of t)xe(i,n,e,r)}else xe(i,n,e,t);break;case"map":r(typeof t=="object"&&t!=null);for(const[r,s]of Object.entries(t))De(i,n,e,r,s);break}}function De(e,t,i,n,s){e.tag(i.no,B.LengthDelimited);e.fork();let o=n;switch(i.K){case N.INT32:case N.FIXED32:case N.UINT32:case N.SFIXED32:case N.SINT32:o=Number.parseInt(n);break;case N.BOOL:r(n=="true"||n=="false");o=n=="true";break}Me(e,i.K,1,o);switch(i.V.kind){case"scalar":Me(e,i.V.T,2,s);break;case"enum":Me(e,N.INT32,2,s);break;case"message":r(s!==void 0);e.tag(2,B.LengthDelimited).bytes(s.toBinary(t));break}e.join()}function xe(e,t,i,n){const r=te(i.T,n);i.delimited?e.tag(i.no,B.StartGroup).raw(r.toBinary(t)).tag(i.no,B.EndGroup):e.tag(i.no,B.LengthDelimited).bytes(r.toBinary(t))}function Me(e,t,i,n){r(n!==void 0);let[s,o]=_e(t);e.tag(i,s)[o](n)}function Ae(e,t,i,n){if(!n.length)return;e.tag(i,B.LengthDelimited).fork();let[,r]=_e(t);for(let t=0;t<n.length;t++)e[r](n[t]);e.join()}function _e(e){let t=B.Varint;switch(e){case N.BYTES:case N.STRING:t=B.LengthDelimited;break;case N.DOUBLE:case N.FIXED64:case N.SFIXED64:t=B.Bit64;break;case N.FIXED32:case N.SFIXED32:case N.FLOAT:t=B.Bit32;break}const i=N[e].toLowerCase();return[t,i]}
/* eslint-disable @typescript-eslint/no-explicit-any,@typescript-eslint/no-unsafe-assignment,@typescript-eslint/no-unsafe-member-access,@typescript-eslint/no-unsafe-return,@typescript-eslint/no-unsafe-argument,no-case-declarations */function Ne(){return{setEnumType:g,initPartial(e,t){if(e===void 0)return;const i=t.getType();for(const n of i.fields.byMember()){const i=n.localName,r=t,s=e;if(s[i]!=null)switch(n.kind){case"oneof":const e=s[i].case;if(e===void 0)continue;const t=n.findField(e);let o=s[i].value;t&&t.kind=="message"&&!ee(o,t.T)?o=new t.T(o):t&&t.kind==="scalar"&&t.T===N.BYTES&&(o=Ue(o));r[i]={case:e,value:o};break;case"scalar":case"enum":let a=s[i];n.T===N.BYTES&&(a=n.repeated?a.map(Ue):Ue(a));r[i]=a;break;case"map":switch(n.V.kind){case"scalar":case"enum":if(n.V.T===N.BYTES)for(const[e,t]of Object.entries(s[i]))r[i][e]=Ue(t);else Object.assign(r[i],s[i]);break;case"message":const e=n.V.T;for(const t of Object.keys(s[i])){let n=s[i][t];e.fieldWrapper||(n=new e(n));r[i][t]=n}break}break;case"message":const c=n.T;if(n.repeated)r[i]=s[i].map((e=>ee(e,c)?e:new c(e)));else{const e=s[i];c.fieldWrapper?c.typeName==="google.protobuf.BytesValue"?r[i]=Ue(e):r[i]=e:r[i]=ee(e,c)?e:new c(e)}break}}},equals(e,t,i){return t===i||!(!t||!i)&&e.fields.byMember().every((e=>{const n=t[e.localName];const r=i[e.localName];if(e.repeated){if(n.length!==r.length)return false;switch(e.kind){case"message":return n.every(((t,i)=>e.T.equals(t,r[i])));case"scalar":return n.every(((t,i)=>U(e.T,t,r[i])));case"enum":return n.every(((e,t)=>U(N.INT32,e,r[t])))}throw new Error("repeated cannot contain ".concat(e.kind))}switch(e.kind){case"message":let t=n;let i=r;if(e.T.fieldWrapper){t===void 0||ee(t)||(t=e.T.fieldWrapper.wrapField(t));i===void 0||ee(i)||(i=e.T.fieldWrapper.wrapField(i))}return e.T.equals(t,i);case"enum":return U(N.INT32,n,r);case"scalar":return U(e.T,n,r);case"oneof":if(n.case!==r.case)return false;const s=e.findField(n.case);if(s===void 0)return true;switch(s.kind){case"message":return s.T.equals(n.value,r.value);case"enum":return U(N.INT32,n.value,r.value);case"scalar":return U(s.T,n.value,r.value)}throw new Error("oneof cannot contain ".concat(s.kind));case"map":const o=Object.keys(n).concat(Object.keys(r));switch(e.V.kind){case"message":const t=e.V.T;return o.every((e=>t.equals(n[e],r[e])));case"enum":return o.every((e=>U(N.INT32,n[e],r[e])));case"scalar":const i=e.V.T;return o.every((e=>U(i,n[e],r[e])))}break}}))},clone(e){const t=e.getType(),i=new t,n=i;for(const i of t.fields.byMember()){const t=e[i.localName];let r;if(i.repeated)r=t.map(Le);else if(i.kind=="map"){r=n[i.localName];for(const[e,i]of Object.entries(t))r[e]=Le(i)}else if(i.kind=="oneof"){const e=i.findField(t.case);r=e?{case:t.case,value:Le(t.value)}:{case:void 0}}else r=Le(t);n[i.localName]=r}for(const i of t.runtime.bin.listUnknownFields(e))t.runtime.bin.onUnknownField(n,i.no,i.wireType,i.data);return i}}}function Le(e){if(e===void 0)return e;if(ee(e))return e.clone();if(e instanceof Uint8Array){const t=new Uint8Array(e.byteLength);t.set(e);return t}return e}function Ue(e){return e instanceof Uint8Array?e:new Uint8Array(e)}function je(e,t,i){return{syntax:e,json:ce(),bin:Se(),util:Object.assign(Object.assign({},Ne()),{newFieldList:t,initFields:i}),makeMessageType(e,t,i){return b(this,e,t,i)},makeEnum:v,makeEnumType:f,getEnumType:m,makeExtension(e,t,i){return V(this,e,t,i)}}}class InternalFieldList{constructor(e,t){this._fields=e;this._normalizer=t}findJsonName(e){if(!this.jsonNames){const e={};for(const t of this.list())e[t.jsonName]=e[t.name]=t;this.jsonNames=e}return this.jsonNames[e]}find(e){if(!this.numbers){const e={};for(const t of this.list())e[t.no]=t;this.numbers=e}return this.numbers[e]}list(){this.all||(this.all=this._normalizer(this._fields));return this.all}byNumber(){this.numbersAsc||(this.numbersAsc=this.list().concat().sort(((e,t)=>e.no-t.no)));return this.numbersAsc}byMember(){if(!this.members){this.members=[];const e=this.members;let t;for(const i of this.list())if(i.oneof){if(i.oneof!==t){t=i.oneof;e.push(t)}}else e.push(i)}return this.members}}function Fe(e,t){const i=qe(e);return t?i:ze(Ge(i))}function Be(e){return Fe(e,false)}const Ve=qe;function qe(e){let t=false;const i=[];for(let n=0;n<e.length;n++){let r=e.charAt(n);switch(r){case"_":t=true;break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":i.push(r);t=false;break;default:if(t){t=false;r=r.toUpperCase()}i.push(r);break}}return i.join("")}const He=new Set(["constructor","toString","toJSON","valueOf"]);const We=new Set(["getType","clone","equals","fromBinary","fromJson","fromJsonString","toBinary","toJson","toJsonString","toObject"]);const Ke=e=>"".concat(e,"$");const Ge=e=>We.has(e)?Ke(e):e;const ze=e=>He.has(e)?Ke(e):e;class InternalOneofInfo{constructor(e){this.kind="oneof";this.repeated=false;this.packed=false;this.opt=false;this.req=false;this.default=void 0;this.fields=[];this.name=e;this.localName=Be(e)}addField(e){r(e.oneof===this,"field ".concat(e.name," not one of ").concat(this.name));this.fields.push(e)}findField(e){if(!this._lookup){this._lookup=Object.create(null);for(let e=0;e<this.fields.length;e++)this._lookup[this.fields[e].localName]=this.fields[e]}return this._lookup[e]}}function Je(e,t){var i,n,r,s,o,a;const c=[];let d;for(const t of typeof e=="function"?e():e){const e=t;e.localName=Fe(t.name,t.oneof!==void 0);e.jsonName=(i=t.jsonName)!==null&&i!==void 0?i:Ve(t.name);e.repeated=(n=t.repeated)!==null&&n!==void 0&&n;t.kind=="scalar"&&(e.L=(r=t.L)!==null&&r!==void 0?r:L.BIGINT);e.delimited=(s=t.delimited)!==null&&s!==void 0&&s;e.req=(o=t.req)!==null&&o!==void 0&&o;e.opt=(a=t.opt)!==null&&a!==void 0&&a;t.packed===void 0&&(e.packed=t.kind=="enum"||t.kind=="scalar"&&t.T!=N.BYTES&&t.T!=N.STRING);if(t.oneof!==void 0){const i=typeof t.oneof=="string"?t.oneof:t.oneof.name;d&&d.name==i||(d=new InternalOneofInfo(i));e.oneof=d;d.addField(e)}c.push(e)}return c}const Qe=je("proto3",(e=>new InternalFieldList(e,(e=>Je(e)))),(e=>{for(const t of e.getType().fields.byMember()){if(t.opt)continue;const i=t.localName,n=e;if(t.repeated)n[i]=[];else switch(t.kind){case"oneof":n[i]={case:void 0};break;case"enum":n[i]=0;break;case"map":n[i]={};break;case"scalar":n[i]=j(t.T,t.L);break}}}));class Timestamp extends Message{constructor(e){super();this.seconds=A.zero;this.nanos=0;Qe.util.initPartial(e,this)}fromJson(e,t){if(typeof e!=="string")throw new Error("cannot decode google.protobuf.Timestamp from JSON: ".concat(Qe.json.debug(e)));const i=e.match(/^([0-9]{4})-([0-9]{2})-([0-9]{2})T([0-9]{2}):([0-9]{2}):([0-9]{2})(?:Z|\.([0-9]{3,9})Z|([+-][0-9][0-9]:[0-9][0-9]))$/);if(!i)throw new Error("cannot decode google.protobuf.Timestamp from JSON: invalid RFC 3339 string");const n=Date.parse(i[1]+"-"+i[2]+"-"+i[3]+"T"+i[4]+":"+i[5]+":"+i[6]+(i[8]?i[8]:"Z"));if(Number.isNaN(n))throw new Error("cannot decode google.protobuf.Timestamp from JSON: invalid RFC 3339 string");if(n<Date.parse("0001-01-01T00:00:00Z")||n>Date.parse("9999-12-31T23:59:59Z"))throw new Error("cannot decode message google.protobuf.Timestamp from JSON: must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive");this.seconds=A.parse(n/1e3);this.nanos=0;i[7]&&(this.nanos=parseInt("1"+i[7]+"0".repeat(9-i[7].length))-1e9);return this}toJson(e){const t=Number(this.seconds)*1e3;if(t<Date.parse("0001-01-01T00:00:00Z")||t>Date.parse("9999-12-31T23:59:59Z"))throw new Error("cannot encode google.protobuf.Timestamp to JSON: must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive");if(this.nanos<0)throw new Error("cannot encode google.protobuf.Timestamp to JSON: nanos must not be negative");let i="Z";if(this.nanos>0){const e=(this.nanos+1e9).toString().substring(1);i=e.substring(3)==="000000"?"."+e.substring(0,3)+"Z":e.substring(6)==="000"?"."+e.substring(0,6)+"Z":"."+e+"Z"}return new Date(t).toISOString().replace(".000Z",i)}toDate(){return new Date(Number(this.seconds)*1e3+Math.ceil(this.nanos/1e6))}static now(){return Timestamp.fromDate(new Date)}static fromDate(e){const t=e.getTime();return new Timestamp({seconds:A.parse(Math.floor(t/1e3)),nanos:t%1e3*1e6})}static fromBinary(e,t){return(new Timestamp).fromBinary(e,t)}static fromJson(e,t){return(new Timestamp).fromJson(e,t)}static fromJsonString(e,t){return(new Timestamp).fromJsonString(e,t)}static equals(e,t){return Qe.util.equals(Timestamp,e,t)}}Timestamp.runtime=Qe;Timestamp.typeName="google.protobuf.Timestamp";Timestamp.fields=Qe.util.newFieldList((()=>[{no:1,name:"seconds",kind:"scalar",T:3},{no:2,name:"nanos",kind:"scalar",T:5}]));const Ye=Qe.makeMessageType("livekit.MetricsBatch",(()=>[{no:1,name:"timestamp_ms",kind:"scalar",T:3},{no:2,name:"normalized_timestamp",kind:"message",T:Timestamp},{no:3,name:"str_data",kind:"scalar",T:9,repeated:true},{no:4,name:"time_series",kind:"message",T:Xe,repeated:true},{no:5,name:"events",kind:"message",T:$e,repeated:true}]));const Xe=Qe.makeMessageType("livekit.TimeSeriesMetric",(()=>[{no:1,name:"label",kind:"scalar",T:13},{no:2,name:"participant_identity",kind:"scalar",T:13},{no:3,name:"track_sid",kind:"scalar",T:13},{no:4,name:"samples",kind:"message",T:Ze,repeated:true},{no:5,name:"rid",kind:"scalar",T:13}]));const Ze=Qe.makeMessageType("livekit.MetricSample",(()=>[{no:1,name:"timestamp_ms",kind:"scalar",T:3},{no:2,name:"normalized_timestamp",kind:"message",T:Timestamp},{no:3,name:"value",kind:"scalar",T:2}]));const $e=Qe.makeMessageType("livekit.EventMetric",(()=>[{no:1,name:"label",kind:"scalar",T:13},{no:2,name:"participant_identity",kind:"scalar",T:13},{no:3,name:"track_sid",kind:"scalar",T:13},{no:4,name:"start_timestamp_ms",kind:"scalar",T:3},{no:5,name:"end_timestamp_ms",kind:"scalar",T:3,opt:true},{no:6,name:"normalized_start_timestamp",kind:"message",T:Timestamp},{no:7,name:"normalized_end_timestamp",kind:"message",T:Timestamp,opt:true},{no:8,name:"metadata",kind:"scalar",T:9},{no:9,name:"rid",kind:"scalar",T:13}]));const et=Qe.makeEnum("livekit.BackupCodecPolicy",[{no:0,name:"PREFER_REGRESSION"},{no:1,name:"SIMULCAST"},{no:2,name:"REGRESSION"}]);const tt=Qe.makeEnum("livekit.TrackType",[{no:0,name:"AUDIO"},{no:1,name:"VIDEO"},{no:2,name:"DATA"}]);const it=Qe.makeEnum("livekit.TrackSource",[{no:0,name:"UNKNOWN"},{no:1,name:"CAMERA"},{no:2,name:"MICROPHONE"},{no:3,name:"SCREEN_SHARE"},{no:4,name:"SCREEN_SHARE_AUDIO"}]);const nt=Qe.makeEnum("livekit.VideoQuality",[{no:0,name:"LOW"},{no:1,name:"MEDIUM"},{no:2,name:"HIGH"},{no:3,name:"OFF"}]);const rt=Qe.makeEnum("livekit.ConnectionQuality",[{no:0,name:"POOR"},{no:1,name:"GOOD"},{no:2,name:"EXCELLENT"},{no:3,name:"LOST"}]);const st=Qe.makeEnum("livekit.ClientConfigSetting",[{no:0,name:"UNSET"},{no:1,name:"DISABLED"},{no:2,name:"ENABLED"}]);const ot=Qe.makeEnum("livekit.DisconnectReason",[{no:0,name:"UNKNOWN_REASON"},{no:1,name:"CLIENT_INITIATED"},{no:2,name:"DUPLICATE_IDENTITY"},{no:3,name:"SERVER_SHUTDOWN"},{no:4,name:"PARTICIPANT_REMOVED"},{no:5,name:"ROOM_DELETED"},{no:6,name:"STATE_MISMATCH"},{no:7,name:"JOIN_FAILURE"},{no:8,name:"MIGRATION"},{no:9,name:"SIGNAL_CLOSE"},{no:10,name:"ROOM_CLOSED"},{no:11,name:"USER_UNAVAILABLE"},{no:12,name:"USER_REJECTED"},{no:13,name:"SIP_TRUNK_FAILURE"},{no:14,name:"CONNECTION_TIMEOUT"},{no:15,name:"MEDIA_FAILURE"}]);const at=Qe.makeEnum("livekit.ReconnectReason",[{no:0,name:"RR_UNKNOWN"},{no:1,name:"RR_SIGNAL_DISCONNECTED"},{no:2,name:"RR_PUBLISHER_FAILED"},{no:3,name:"RR_SUBSCRIBER_FAILED"},{no:4,name:"RR_SWITCH_CANDIDATE"}]);const ct=Qe.makeEnum("livekit.SubscriptionError",[{no:0,name:"SE_UNKNOWN"},{no:1,name:"SE_CODEC_UNSUPPORTED"},{no:2,name:"SE_TRACK_NOTFOUND"}]);const dt=Qe.makeEnum("livekit.AudioTrackFeature",[{no:0,name:"TF_STEREO"},{no:1,name:"TF_NO_DTX"},{no:2,name:"TF_AUTO_GAIN_CONTROL"},{no:3,name:"TF_ECHO_CANCELLATION"},{no:4,name:"TF_NOISE_SUPPRESSION"},{no:5,name:"TF_ENHANCED_NOISE_CANCELLATION"},{no:6,name:"TF_PRECONNECT_BUFFER"}]);const lt=Qe.makeMessageType("livekit.Room",(()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"empty_timeout",kind:"scalar",T:13},{no:14,name:"departure_timeout",kind:"scalar",T:13},{no:4,name:"max_participants",kind:"scalar",T:13},{no:5,name:"creation_time",kind:"scalar",T:3},{no:15,name:"creation_time_ms",kind:"scalar",T:3},{no:6,name:"turn_password",kind:"scalar",T:9},{no:7,name:"enabled_codecs",kind:"message",T:ut,repeated:true},{no:8,name:"metadata",kind:"scalar",T:9},{no:9,name:"num_participants",kind:"scalar",T:13},{no:11,name:"num_publishers",kind:"scalar",T:13},{no:10,name:"active_recording",kind:"scalar",T:8},{no:13,name:"version",kind:"message",T:qt}]));const ut=Qe.makeMessageType("livekit.Codec",(()=>[{no:1,name:"mime",kind:"scalar",T:9},{no:2,name:"fmtp_line",kind:"scalar",T:9}]));const ht=Qe.makeMessageType("livekit.ParticipantPermission",(()=>[{no:1,name:"can_subscribe",kind:"scalar",T:8},{no:2,name:"can_publish",kind:"scalar",T:8},{no:3,name:"can_publish_data",kind:"scalar",T:8},{no:9,name:"can_publish_sources",kind:"enum",T:Qe.getEnumType(it),repeated:true},{no:7,name:"hidden",kind:"scalar",T:8},{no:8,name:"recorder",kind:"scalar",T:8},{no:10,name:"can_update_metadata",kind:"scalar",T:8},{no:11,name:"agent",kind:"scalar",T:8},{no:12,name:"can_subscribe_metrics",kind:"scalar",T:8}]));const pt=Qe.makeMessageType("livekit.ParticipantInfo",(()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"identity",kind:"scalar",T:9},{no:3,name:"state",kind:"enum",T:Qe.getEnumType(mt)},{no:4,name:"tracks",kind:"message",T:bt,repeated:true},{no:5,name:"metadata",kind:"scalar",T:9},{no:6,name:"joined_at",kind:"scalar",T:3},{no:17,name:"joined_at_ms",kind:"scalar",T:3},{no:9,name:"name",kind:"scalar",T:9},{no:10,name:"version",kind:"scalar",T:13},{no:11,name:"permission",kind:"message",T:ht},{no:12,name:"region",kind:"scalar",T:9},{no:13,name:"is_publisher",kind:"scalar",T:8},{no:14,name:"kind",kind:"enum",T:Qe.getEnumType(gt)},{no:15,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:16,name:"disconnect_reason",kind:"enum",T:Qe.getEnumType(ot)},{no:18,name:"kind_details",kind:"enum",T:Qe.getEnumType(ft),repeated:true}]));const mt=Qe.makeEnum("livekit.ParticipantInfo.State",[{no:0,name:"JOINING"},{no:1,name:"JOINED"},{no:2,name:"ACTIVE"},{no:3,name:"DISCONNECTED"}]);const gt=Qe.makeEnum("livekit.ParticipantInfo.Kind",[{no:0,name:"STANDARD"},{no:1,name:"INGRESS"},{no:2,name:"EGRESS"},{no:3,name:"SIP"},{no:4,name:"AGENT"}]);const ft=Qe.makeEnum("livekit.ParticipantInfo.KindDetail",[{no:0,name:"CLOUD_AGENT"},{no:1,name:"FORWARDED"}]);const vt=Qe.makeEnum("livekit.Encryption.Type",[{no:0,name:"NONE"},{no:1,name:"GCM"},{no:2,name:"CUSTOM"}]);const kt=Qe.makeMessageType("livekit.SimulcastCodecInfo",(()=>[{no:1,name:"mime_type",kind:"scalar",T:9},{no:2,name:"mid",kind:"scalar",T:9},{no:3,name:"cid",kind:"scalar",T:9},{no:4,name:"layers",kind:"message",T:yt,repeated:true}]));const bt=Qe.makeMessageType("livekit.TrackInfo",(()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"type",kind:"enum",T:Qe.getEnumType(tt)},{no:3,name:"name",kind:"scalar",T:9},{no:4,name:"muted",kind:"scalar",T:8},{no:5,name:"width",kind:"scalar",T:13},{no:6,name:"height",kind:"scalar",T:13},{no:7,name:"simulcast",kind:"scalar",T:8},{no:8,name:"disable_dtx",kind:"scalar",T:8},{no:9,name:"source",kind:"enum",T:Qe.getEnumType(it)},{no:10,name:"layers",kind:"message",T:yt,repeated:true},{no:11,name:"mime_type",kind:"scalar",T:9},{no:12,name:"mid",kind:"scalar",T:9},{no:13,name:"codecs",kind:"message",T:kt,repeated:true},{no:14,name:"stereo",kind:"scalar",T:8},{no:15,name:"disable_red",kind:"scalar",T:8},{no:16,name:"encryption",kind:"enum",T:Qe.getEnumType(vt)},{no:17,name:"stream",kind:"scalar",T:9},{no:18,name:"version",kind:"message",T:qt},{no:19,name:"audio_features",kind:"enum",T:Qe.getEnumType(dt),repeated:true},{no:20,name:"backup_codec_policy",kind:"enum",T:Qe.getEnumType(et)}]));const yt=Qe.makeMessageType("livekit.VideoLayer",(()=>[{no:1,name:"quality",kind:"enum",T:Qe.getEnumType(nt)},{no:2,name:"width",kind:"scalar",T:13},{no:3,name:"height",kind:"scalar",T:13},{no:4,name:"bitrate",kind:"scalar",T:13},{no:5,name:"ssrc",kind:"scalar",T:13},{no:6,name:"spatial_layer",kind:"scalar",T:5},{no:7,name:"rid",kind:"scalar",T:9}]));const Tt=Qe.makeMessageType("livekit.DataPacket",(()=>[{no:1,name:"kind",kind:"enum",T:Qe.getEnumType(Ct)},{no:4,name:"participant_identity",kind:"scalar",T:9},{no:5,name:"destination_identities",kind:"scalar",T:9,repeated:true},{no:2,name:"user",kind:"message",T:Et,oneof:"value"},{no:3,name:"speaker",kind:"message",T:St,oneof:"value"},{no:6,name:"sip_dtmf",kind:"message",T:Pt,oneof:"value"},{no:7,name:"transcription",kind:"message",T:Rt,oneof:"value"},{no:8,name:"metrics",kind:"message",T:Ye,oneof:"value"},{no:9,name:"chat_message",kind:"message",T:Ot,oneof:"value"},{no:10,name:"rpc_request",kind:"message",T:Dt,oneof:"value"},{no:11,name:"rpc_ack",kind:"message",T:xt,oneof:"value"},{no:12,name:"rpc_response",kind:"message",T:Mt,oneof:"value"},{no:13,name:"stream_header",kind:"message",T:Gt,oneof:"value"},{no:14,name:"stream_chunk",kind:"message",T:zt,oneof:"value"},{no:15,name:"stream_trailer",kind:"message",T:Jt,oneof:"value"},{no:16,name:"sequence",kind:"scalar",T:13},{no:17,name:"participant_sid",kind:"scalar",T:9}]));const Ct=Qe.makeEnum("livekit.DataPacket.Kind",[{no:0,name:"RELIABLE"},{no:1,name:"LOSSY"}]);const St=Qe.makeMessageType("livekit.ActiveSpeakerUpdate",(()=>[{no:1,name:"speakers",kind:"message",T:wt,repeated:true}]));const wt=Qe.makeMessageType("livekit.SpeakerInfo",(()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"level",kind:"scalar",T:2},{no:3,name:"active",kind:"scalar",T:8}]));const Et=Qe.makeMessageType("livekit.UserPacket",(()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:5,name:"participant_identity",kind:"scalar",T:9},{no:2,name:"payload",kind:"scalar",T:12},{no:3,name:"destination_sids",kind:"scalar",T:9,repeated:true},{no:6,name:"destination_identities",kind:"scalar",T:9,repeated:true},{no:4,name:"topic",kind:"scalar",T:9,opt:true},{no:8,name:"id",kind:"scalar",T:9,opt:true},{no:9,name:"start_time",kind:"scalar",T:4,opt:true},{no:10,name:"end_time",kind:"scalar",T:4,opt:true},{no:11,name:"nonce",kind:"scalar",T:12}]));const Pt=Qe.makeMessageType("livekit.SipDTMF",(()=>[{no:3,name:"code",kind:"scalar",T:13},{no:4,name:"digit",kind:"scalar",T:9}]));const Rt=Qe.makeMessageType("livekit.Transcription",(()=>[{no:2,name:"transcribed_participant_identity",kind:"scalar",T:9},{no:3,name:"track_id",kind:"scalar",T:9},{no:4,name:"segments",kind:"message",T:It,repeated:true}]));const It=Qe.makeMessageType("livekit.TranscriptionSegment",(()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"text",kind:"scalar",T:9},{no:3,name:"start_time",kind:"scalar",T:4},{no:4,name:"end_time",kind:"scalar",T:4},{no:5,name:"final",kind:"scalar",T:8},{no:6,name:"language",kind:"scalar",T:9}]));const Ot=Qe.makeMessageType("livekit.ChatMessage",(()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"timestamp",kind:"scalar",T:3},{no:3,name:"edit_timestamp",kind:"scalar",T:3,opt:true},{no:4,name:"message",kind:"scalar",T:9},{no:5,name:"deleted",kind:"scalar",T:8},{no:6,name:"generated",kind:"scalar",T:8}]));const Dt=Qe.makeMessageType("livekit.RpcRequest",(()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"method",kind:"scalar",T:9},{no:3,name:"payload",kind:"scalar",T:9},{no:4,name:"response_timeout_ms",kind:"scalar",T:13},{no:5,name:"version",kind:"scalar",T:13}]));const xt=Qe.makeMessageType("livekit.RpcAck",(()=>[{no:1,name:"request_id",kind:"scalar",T:9}]));const Mt=Qe.makeMessageType("livekit.RpcResponse",(()=>[{no:1,name:"request_id",kind:"scalar",T:9},{no:2,name:"payload",kind:"scalar",T:9,oneof:"value"},{no:3,name:"error",kind:"message",T:At,oneof:"value"}]));const At=Qe.makeMessageType("livekit.RpcError",(()=>[{no:1,name:"code",kind:"scalar",T:13},{no:2,name:"message",kind:"scalar",T:9},{no:3,name:"data",kind:"scalar",T:9}]));const _t=Qe.makeMessageType("livekit.ParticipantTracks",(()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sids",kind:"scalar",T:9,repeated:true}]));const Nt=Qe.makeMessageType("livekit.ServerInfo",(()=>[{no:1,name:"edition",kind:"enum",T:Qe.getEnumType(Lt)},{no:2,name:"version",kind:"scalar",T:9},{no:3,name:"protocol",kind:"scalar",T:5},{no:4,name:"region",kind:"scalar",T:9},{no:5,name:"node_id",kind:"scalar",T:9},{no:6,name:"debug_info",kind:"scalar",T:9},{no:7,name:"agent_protocol",kind:"scalar",T:5}]));const Lt=Qe.makeEnum("livekit.ServerInfo.Edition",[{no:0,name:"Standard"},{no:1,name:"Cloud"}]);const Ut=Qe.makeMessageType("livekit.ClientInfo",(()=>[{no:1,name:"sdk",kind:"enum",T:Qe.getEnumType(jt)},{no:2,name:"version",kind:"scalar",T:9},{no:3,name:"protocol",kind:"scalar",T:5},{no:4,name:"os",kind:"scalar",T:9},{no:5,name:"os_version",kind:"scalar",T:9},{no:6,name:"device_model",kind:"scalar",T:9},{no:7,name:"browser",kind:"scalar",T:9},{no:8,name:"browser_version",kind:"scalar",T:9},{no:9,name:"address",kind:"scalar",T:9},{no:10,name:"network",kind:"scalar",T:9},{no:11,name:"other_sdks",kind:"scalar",T:9}]));const jt=Qe.makeEnum("livekit.ClientInfo.SDK",[{no:0,name:"UNKNOWN"},{no:1,name:"JS"},{no:2,name:"SWIFT"},{no:3,name:"ANDROID"},{no:4,name:"FLUTTER"},{no:5,name:"GO"},{no:6,name:"UNITY"},{no:7,name:"REACT_NATIVE"},{no:8,name:"RUST"},{no:9,name:"PYTHON"},{no:10,name:"CPP"},{no:11,name:"UNITY_WEB"},{no:12,name:"NODE"},{no:13,name:"UNREAL"},{no:14,name:"ESP32"}]);const Ft=Qe.makeMessageType("livekit.ClientConfiguration",(()=>[{no:1,name:"video",kind:"message",T:Bt},{no:2,name:"screen",kind:"message",T:Bt},{no:3,name:"resume_connection",kind:"enum",T:Qe.getEnumType(st)},{no:4,name:"disabled_codecs",kind:"message",T:Vt},{no:5,name:"force_relay",kind:"enum",T:Qe.getEnumType(st)}]));const Bt=Qe.makeMessageType("livekit.VideoConfiguration",(()=>[{no:1,name:"hardware_encoder",kind:"enum",T:Qe.getEnumType(st)}]));const Vt=Qe.makeMessageType("livekit.DisabledCodecs",(()=>[{no:1,name:"codecs",kind:"message",T:ut,repeated:true},{no:2,name:"publish",kind:"message",T:ut,repeated:true}]));const qt=Qe.makeMessageType("livekit.TimedVersion",(()=>[{no:1,name:"unix_micro",kind:"scalar",T:3},{no:2,name:"ticks",kind:"scalar",T:5}]));const Ht=Qe.makeEnum("livekit.DataStream.OperationType",[{no:0,name:"CREATE"},{no:1,name:"UPDATE"},{no:2,name:"DELETE"},{no:3,name:"REACTION"}]);const Wt=Qe.makeMessageType("livekit.DataStream.TextHeader",(()=>[{no:1,name:"operation_type",kind:"enum",T:Qe.getEnumType(Ht)},{no:2,name:"version",kind:"scalar",T:5},{no:3,name:"reply_to_stream_id",kind:"scalar",T:9},{no:4,name:"attached_stream_ids",kind:"scalar",T:9,repeated:true},{no:5,name:"generated",kind:"scalar",T:8}]),{localName:"DataStream_TextHeader"});const Kt=Qe.makeMessageType("livekit.DataStream.ByteHeader",(()=>[{no:1,name:"name",kind:"scalar",T:9}]),{localName:"DataStream_ByteHeader"});const Gt=Qe.makeMessageType("livekit.DataStream.Header",(()=>[{no:1,name:"stream_id",kind:"scalar",T:9},{no:2,name:"timestamp",kind:"scalar",T:3},{no:3,name:"topic",kind:"scalar",T:9},{no:4,name:"mime_type",kind:"scalar",T:9},{no:5,name:"total_length",kind:"scalar",T:4,opt:true},{no:7,name:"encryption_type",kind:"enum",T:Qe.getEnumType(vt)},{no:8,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:9,name:"text_header",kind:"message",T:Wt,oneof:"content_header"},{no:10,name:"byte_header",kind:"message",T:Kt,oneof:"content_header"}]),{localName:"DataStream_Header"});const zt=Qe.makeMessageType("livekit.DataStream.Chunk",(()=>[{no:1,name:"stream_id",kind:"scalar",T:9},{no:2,name:"chunk_index",kind:"scalar",T:4},{no:3,name:"content",kind:"scalar",T:12},{no:4,name:"version",kind:"scalar",T:5},{no:5,name:"iv",kind:"scalar",T:12,opt:true}]),{localName:"DataStream_Chunk"});const Jt=Qe.makeMessageType("livekit.DataStream.Trailer",(()=>[{no:1,name:"stream_id",kind:"scalar",T:9},{no:2,name:"reason",kind:"scalar",T:9},{no:3,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}}]),{localName:"DataStream_Trailer"});const Qt=Qe.makeEnum("livekit.SignalTarget",[{no:0,name:"PUBLISHER"},{no:1,name:"SUBSCRIBER"}]);const Yt=Qe.makeEnum("livekit.StreamState",[{no:0,name:"ACTIVE"},{no:1,name:"PAUSED"}]);const Xt=Qe.makeEnum("livekit.CandidateProtocol",[{no:0,name:"UDP"},{no:1,name:"TCP"},{no:2,name:"TLS"}]);const Zt=Qe.makeMessageType("livekit.SignalRequest",(()=>[{no:1,name:"offer",kind:"message",T:ci,oneof:"message"},{no:2,name:"answer",kind:"message",T:ci,oneof:"message"},{no:3,name:"trickle",kind:"message",T:ii,oneof:"message"},{no:4,name:"add_track",kind:"message",T:ti,oneof:"message"},{no:5,name:"mute",kind:"message",T:ni,oneof:"message"},{no:6,name:"subscription",kind:"message",T:li,oneof:"message"},{no:7,name:"track_setting",kind:"message",T:ui,oneof:"message"},{no:8,name:"leave",kind:"message",T:mi,oneof:"message"},{no:10,name:"update_layers",kind:"message",T:fi,oneof:"message"},{no:11,name:"subscription_permission",kind:"message",T:Oi,oneof:"message"},{no:12,name:"sync_state",kind:"message",T:Mi,oneof:"message"},{no:13,name:"simulate",kind:"message",T:Ni,oneof:"message"},{no:14,name:"ping",kind:"scalar",T:3,oneof:"message"},{no:15,name:"update_metadata",kind:"message",T:vi,oneof:"message"},{no:16,name:"ping_req",kind:"message",T:Li,oneof:"message"},{no:17,name:"update_audio_track",kind:"message",T:hi,oneof:"message"},{no:18,name:"update_video_track",kind:"message",T:pi,oneof:"message"}]));const $t=Qe.makeMessageType("livekit.SignalResponse",(()=>[{no:1,name:"join",kind:"message",T:ri,oneof:"message"},{no:2,name:"answer",kind:"message",T:ci,oneof:"message"},{no:3,name:"offer",kind:"message",T:ci,oneof:"message"},{no:4,name:"trickle",kind:"message",T:ii,oneof:"message"},{no:5,name:"update",kind:"message",T:di,oneof:"message"},{no:6,name:"track_published",kind:"message",T:oi,oneof:"message"},{no:8,name:"leave",kind:"message",T:mi,oneof:"message"},{no:9,name:"mute",kind:"message",T:ni,oneof:"message"},{no:10,name:"speakers_changed",kind:"message",T:bi,oneof:"message"},{no:11,name:"room_update",kind:"message",T:yi,oneof:"message"},{no:12,name:"connection_quality",kind:"message",T:Ci,oneof:"message"},{no:13,name:"stream_state_update",kind:"message",T:wi,oneof:"message"},{no:14,name:"subscribed_quality_update",kind:"message",T:Ri,oneof:"message"},{no:15,name:"subscription_permission_update",kind:"message",T:Di,oneof:"message"},{no:16,name:"refresh_token",kind:"scalar",T:9,oneof:"message"},{no:17,name:"track_unpublished",kind:"message",T:ai,oneof:"message"},{no:18,name:"pong",kind:"scalar",T:3,oneof:"message"},{no:19,name:"reconnect",kind:"message",T:si,oneof:"message"},{no:20,name:"pong_resp",kind:"message",T:Ui,oneof:"message"},{no:21,name:"subscription_response",kind:"message",T:Bi,oneof:"message"},{no:22,name:"request_response",kind:"message",T:Vi,oneof:"message"},{no:23,name:"track_subscribed",kind:"message",T:Hi,oneof:"message"},{no:24,name:"room_moved",kind:"message",T:xi,oneof:"message"}]));const ei=Qe.makeMessageType("livekit.SimulcastCodec",(()=>[{no:1,name:"codec",kind:"scalar",T:9},{no:2,name:"cid",kind:"scalar",T:9}]));const ti=Qe.makeMessageType("livekit.AddTrackRequest",(()=>[{no:1,name:"cid",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"type",kind:"enum",T:Qe.getEnumType(tt)},{no:4,name:"width",kind:"scalar",T:13},{no:5,name:"height",kind:"scalar",T:13},{no:6,name:"muted",kind:"scalar",T:8},{no:7,name:"disable_dtx",kind:"scalar",T:8},{no:8,name:"source",kind:"enum",T:Qe.getEnumType(it)},{no:9,name:"layers",kind:"message",T:yt,repeated:true},{no:10,name:"simulcast_codecs",kind:"message",T:ei,repeated:true},{no:11,name:"sid",kind:"scalar",T:9},{no:12,name:"stereo",kind:"scalar",T:8},{no:13,name:"disable_red",kind:"scalar",T:8},{no:14,name:"encryption",kind:"enum",T:Qe.getEnumType(vt)},{no:15,name:"stream",kind:"scalar",T:9},{no:16,name:"backup_codec_policy",kind:"enum",T:Qe.getEnumType(et)},{no:17,name:"audio_features",kind:"enum",T:Qe.getEnumType(dt),repeated:true}]));const ii=Qe.makeMessageType("livekit.TrickleRequest",(()=>[{no:1,name:"candidateInit",kind:"scalar",T:9},{no:2,name:"target",kind:"enum",T:Qe.getEnumType(Qt)},{no:3,name:"final",kind:"scalar",T:8}]));const ni=Qe.makeMessageType("livekit.MuteTrackRequest",(()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"muted",kind:"scalar",T:8}]));const ri=Qe.makeMessageType("livekit.JoinResponse",(()=>[{no:1,name:"room",kind:"message",T:lt},{no:2,name:"participant",kind:"message",T:pt},{no:3,name:"other_participants",kind:"message",T:pt,repeated:true},{no:4,name:"server_version",kind:"scalar",T:9},{no:5,name:"ice_servers",kind:"message",T:ki,repeated:true},{no:6,name:"subscriber_primary",kind:"scalar",T:8},{no:7,name:"alternative_url",kind:"scalar",T:9},{no:8,name:"client_configuration",kind:"message",T:Ft},{no:9,name:"server_region",kind:"scalar",T:9},{no:10,name:"ping_timeout",kind:"scalar",T:5},{no:11,name:"ping_interval",kind:"scalar",T:5},{no:12,name:"server_info",kind:"message",T:Nt},{no:13,name:"sif_trailer",kind:"scalar",T:12},{no:14,name:"enabled_publish_codecs",kind:"message",T:ut,repeated:true},{no:15,name:"fast_publish",kind:"scalar",T:8}]));const si=Qe.makeMessageType("livekit.ReconnectResponse",(()=>[{no:1,name:"ice_servers",kind:"message",T:ki,repeated:true},{no:2,name:"client_configuration",kind:"message",T:Ft},{no:3,name:"server_info",kind:"message",T:Nt},{no:4,name:"last_message_seq",kind:"scalar",T:13}]));const oi=Qe.makeMessageType("livekit.TrackPublishedResponse",(()=>[{no:1,name:"cid",kind:"scalar",T:9},{no:2,name:"track",kind:"message",T:bt}]));const ai=Qe.makeMessageType("livekit.TrackUnpublishedResponse",(()=>[{no:1,name:"track_sid",kind:"scalar",T:9}]));const ci=Qe.makeMessageType("livekit.SessionDescription",(()=>[{no:1,name:"type",kind:"scalar",T:9},{no:2,name:"sdp",kind:"scalar",T:9},{no:3,name:"id",kind:"scalar",T:13}]));const di=Qe.makeMessageType("livekit.ParticipantUpdate",(()=>[{no:1,name:"participants",kind:"message",T:pt,repeated:true}]));const li=Qe.makeMessageType("livekit.UpdateSubscription",(()=>[{no:1,name:"track_sids",kind:"scalar",T:9,repeated:true},{no:2,name:"subscribe",kind:"scalar",T:8},{no:3,name:"participant_tracks",kind:"message",T:_t,repeated:true}]));const ui=Qe.makeMessageType("livekit.UpdateTrackSettings",(()=>[{no:1,name:"track_sids",kind:"scalar",T:9,repeated:true},{no:3,name:"disabled",kind:"scalar",T:8},{no:4,name:"quality",kind:"enum",T:Qe.getEnumType(nt)},{no:5,name:"width",kind:"scalar",T:13},{no:6,name:"height",kind:"scalar",T:13},{no:7,name:"fps",kind:"scalar",T:13},{no:8,name:"priority",kind:"scalar",T:13}]));const hi=Qe.makeMessageType("livekit.UpdateLocalAudioTrack",(()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"features",kind:"enum",T:Qe.getEnumType(dt),repeated:true}]));const pi=Qe.makeMessageType("livekit.UpdateLocalVideoTrack",(()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"width",kind:"scalar",T:13},{no:3,name:"height",kind:"scalar",T:13}]));const mi=Qe.makeMessageType("livekit.LeaveRequest",(()=>[{no:1,name:"can_reconnect",kind:"scalar",T:8},{no:2,name:"reason",kind:"enum",T:Qe.getEnumType(ot)},{no:3,name:"action",kind:"enum",T:Qe.getEnumType(gi)},{no:4,name:"regions",kind:"message",T:ji}]));const gi=Qe.makeEnum("livekit.LeaveRequest.Action",[{no:0,name:"DISCONNECT"},{no:1,name:"RESUME"},{no:2,name:"RECONNECT"}]);const fi=Qe.makeMessageType("livekit.UpdateVideoLayers",(()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"layers",kind:"message",T:yt,repeated:true}]));const vi=Qe.makeMessageType("livekit.UpdateParticipantMetadata",(()=>[{no:1,name:"metadata",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:4,name:"request_id",kind:"scalar",T:13}]));const ki=Qe.makeMessageType("livekit.ICEServer",(()=>[{no:1,name:"urls",kind:"scalar",T:9,repeated:true},{no:2,name:"username",kind:"scalar",T:9},{no:3,name:"credential",kind:"scalar",T:9}]));const bi=Qe.makeMessageType("livekit.SpeakersChanged",(()=>[{no:1,name:"speakers",kind:"message",T:wt,repeated:true}]));const yi=Qe.makeMessageType("livekit.RoomUpdate",(()=>[{no:1,name:"room",kind:"message",T:lt}]));const Ti=Qe.makeMessageType("livekit.ConnectionQualityInfo",(()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"quality",kind:"enum",T:Qe.getEnumType(rt)},{no:3,name:"score",kind:"scalar",T:2}]));const Ci=Qe.makeMessageType("livekit.ConnectionQualityUpdate",(()=>[{no:1,name:"updates",kind:"message",T:Ti,repeated:true}]));const Si=Qe.makeMessageType("livekit.StreamStateInfo",(()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sid",kind:"scalar",T:9},{no:3,name:"state",kind:"enum",T:Qe.getEnumType(Yt)}]));const wi=Qe.makeMessageType("livekit.StreamStateUpdate",(()=>[{no:1,name:"stream_states",kind:"message",T:Si,repeated:true}]));const Ei=Qe.makeMessageType("livekit.SubscribedQuality",(()=>[{no:1,name:"quality",kind:"enum",T:Qe.getEnumType(nt)},{no:2,name:"enabled",kind:"scalar",T:8}]));const Pi=Qe.makeMessageType("livekit.SubscribedCodec",(()=>[{no:1,name:"codec",kind:"scalar",T:9},{no:2,name:"qualities",kind:"message",T:Ei,repeated:true}]));const Ri=Qe.makeMessageType("livekit.SubscribedQualityUpdate",(()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"subscribed_qualities",kind:"message",T:Ei,repeated:true},{no:3,name:"subscribed_codecs",kind:"message",T:Pi,repeated:true}]));const Ii=Qe.makeMessageType("livekit.TrackPermission",(()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"all_tracks",kind:"scalar",T:8},{no:3,name:"track_sids",kind:"scalar",T:9,repeated:true},{no:4,name:"participant_identity",kind:"scalar",T:9}]));const Oi=Qe.makeMessageType("livekit.SubscriptionPermission",(()=>[{no:1,name:"all_participants",kind:"scalar",T:8},{no:2,name:"track_permissions",kind:"message",T:Ii,repeated:true}]));const Di=Qe.makeMessageType("livekit.SubscriptionPermissionUpdate",(()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sid",kind:"scalar",T:9},{no:3,name:"allowed",kind:"scalar",T:8}]));const xi=Qe.makeMessageType("livekit.RoomMovedResponse",(()=>[{no:1,name:"room",kind:"message",T:lt},{no:2,name:"token",kind:"scalar",T:9},{no:3,name:"participant",kind:"message",T:pt},{no:4,name:"other_participants",kind:"message",T:pt,repeated:true}]));const Mi=Qe.makeMessageType("livekit.SyncState",(()=>[{no:1,name:"answer",kind:"message",T:ci},{no:2,name:"subscription",kind:"message",T:li},{no:3,name:"publish_tracks",kind:"message",T:oi,repeated:true},{no:4,name:"data_channels",kind:"message",T:_i,repeated:true},{no:5,name:"offer",kind:"message",T:ci},{no:6,name:"track_sids_disabled",kind:"scalar",T:9,repeated:true},{no:7,name:"datachannel_receive_states",kind:"message",T:Ai,repeated:true}]));const Ai=Qe.makeMessageType("livekit.DataChannelReceiveState",(()=>[{no:1,name:"publisher_sid",kind:"scalar",T:9},{no:2,name:"last_seq",kind:"scalar",T:13}]));const _i=Qe.makeMessageType("livekit.DataChannelInfo",(()=>[{no:1,name:"label",kind:"scalar",T:9},{no:2,name:"id",kind:"scalar",T:13},{no:3,name:"target",kind:"enum",T:Qe.getEnumType(Qt)}]));const Ni=Qe.makeMessageType("livekit.SimulateScenario",(()=>[{no:1,name:"speaker_update",kind:"scalar",T:5,oneof:"scenario"},{no:2,name:"node_failure",kind:"scalar",T:8,oneof:"scenario"},{no:3,name:"migration",kind:"scalar",T:8,oneof:"scenario"},{no:4,name:"server_leave",kind:"scalar",T:8,oneof:"scenario"},{no:5,name:"switch_candidate_protocol",kind:"enum",T:Qe.getEnumType(Xt),oneof:"scenario"},{no:6,name:"subscriber_bandwidth",kind:"scalar",T:3,oneof:"scenario"},{no:7,name:"disconnect_signal_on_resume",kind:"scalar",T:8,oneof:"scenario"},{no:8,name:"disconnect_signal_on_resume_no_messages",kind:"scalar",T:8,oneof:"scenario"},{no:9,name:"leave_request_full_reconnect",kind:"scalar",T:8,oneof:"scenario"}]));const Li=Qe.makeMessageType("livekit.Ping",(()=>[{no:1,name:"timestamp",kind:"scalar",T:3},{no:2,name:"rtt",kind:"scalar",T:3}]));const Ui=Qe.makeMessageType("livekit.Pong",(()=>[{no:1,name:"last_ping_timestamp",kind:"scalar",T:3},{no:2,name:"timestamp",kind:"scalar",T:3}]));const ji=Qe.makeMessageType("livekit.RegionSettings",(()=>[{no:1,name:"regions",kind:"message",T:Fi,repeated:true}]));const Fi=Qe.makeMessageType("livekit.RegionInfo",(()=>[{no:1,name:"region",kind:"scalar",T:9},{no:2,name:"url",kind:"scalar",T:9},{no:3,name:"distance",kind:"scalar",T:3}]));const Bi=Qe.makeMessageType("livekit.SubscriptionResponse",(()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"err",kind:"enum",T:Qe.getEnumType(ct)}]));const Vi=Qe.makeMessageType("livekit.RequestResponse",(()=>[{no:1,name:"request_id",kind:"scalar",T:13},{no:2,name:"reason",kind:"enum",T:Qe.getEnumType(qi)},{no:3,name:"message",kind:"scalar",T:9}]));const qi=Qe.makeEnum("livekit.RequestResponse.Reason",[{no:0,name:"OK"},{no:1,name:"NOT_FOUND"},{no:2,name:"NOT_ALLOWED"},{no:3,name:"LIMIT_EXCEEDED"}]);const Hi=Qe.makeMessageType("livekit.TrackSubscribed",(()=>[{no:1,name:"track_sid",kind:"scalar",T:9}]));function Wi(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var Ki={exports:{}};var Gi=Ki.exports;var zi;function Ji(){if(zi)return Ki.exports;zi=1;(function(e){(function(t,i){e.exports?e.exports=i():t.log=i()})(Gi,(function(){var e=function(){};var t="undefined";var i=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent);var n=["trace","debug","info","warn","error"];var r={};var s=null;function o(e,t){var i=e[t];if(typeof i.bind==="function")return i.bind(e);try{return Function.prototype.bind.call(i,e)}catch(t){return function(){return Function.prototype.apply.apply(i,[e,arguments])}}}function a(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments]));console.trace&&console.trace()}function c(n){n==="debug"&&(n="log");return typeof console!==t&&(n==="trace"&&i?a:console[n]!==void 0?o(console,n):console.log!==void 0?o(console,"log"):e)}function d(){var i=this.getLevel();for(var r=0;r<n.length;r++){var s=n[r];this[s]=r<i?e:this.methodFactory(s,i,this.name)}this.log=this.debug;if(typeof console===t&&i<this.levels.SILENT)return"No console available for logging"}function l(e){return function(){if(typeof console!==t){d.call(this);this[e].apply(this,arguments)}}}function u(e,t,i){return c(e)||l.apply(this,arguments)}function h(e,i){var o=this;
/**
         * The level inherited from a parent logger (or a global default). We
         * cache this here rather than delegating to the parent so that it stays
         * in sync with the actual logging methods that we have installed (the
         * parent could change levels but we might not have rebuilt the loggers
         * in this child yet).
         * @type {number}
         */var a;
/**
         * The default level for this logger, if any. If set, this overrides
         * `inheritedLevel`.
         * @type {number|null}
         */var c;
/**
         * A user-specific level for this logger. If set, this overrides
         * `defaultLevel`.
         * @type {number|null}
         */var l;var h="loglevel";typeof e==="string"?h+=":"+e:typeof e==="symbol"&&(h=void 0);function p(e){var i=(n[e]||"silent").toUpperCase();if(typeof window!==t&&h){try{window.localStorage[h]=i;return}catch(e){}try{window.document.cookie=encodeURIComponent(h)+"="+i+";"}catch(e){}}}function m(){var e;if(typeof window!==t&&h){try{e=window.localStorage[h]}catch(e){}if(typeof e===t)try{var i=window.document.cookie;var n=encodeURIComponent(h);var r=i.indexOf(n+"=");r!==-1&&(e=/^([^;]+)/.exec(i.slice(r+n.length+1))[1])}catch(e){}o.levels[e]===void 0&&(e=void 0);return e}}function g(){if(typeof window!==t&&h){try{window.localStorage.removeItem(h)}catch(e){}try{window.document.cookie=encodeURIComponent(h)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch(e){}}}function f(e){var t=e;typeof t==="string"&&o.levels[t.toUpperCase()]!==void 0&&(t=o.levels[t.toUpperCase()]);if(typeof t==="number"&&t>=0&&t<=o.levels.SILENT)return t;throw new TypeError("log.setLevel() called with invalid level: "+e)}o.name=e;o.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5};o.methodFactory=i||u;o.getLevel=function(){return l!=null?l:c!=null?c:a};o.setLevel=function(e,t){l=f(e);t!==false&&p(l);return d.call(o)};o.setDefaultLevel=function(e){c=f(e);m()||o.setLevel(e,false)};o.resetLevel=function(){l=null;g();d.call(o)};o.enableAll=function(e){o.setLevel(o.levels.TRACE,e)};o.disableAll=function(e){o.setLevel(o.levels.SILENT,e)};o.rebuild=function(){s!==o&&(a=f(s.getLevel()));d.call(o);if(s===o)for(var e in r)r[e].rebuild()};a=f(s?s.getLevel():"WARN");var v=m();v!=null&&(l=f(v));d.call(o)}s=new h;s.getLogger=function(e){if(typeof e!=="symbol"&&typeof e!=="string"||e==="")throw new TypeError("You must supply a name when creating a logger.");var t=r[e];t||(t=r[e]=new h(e,s.methodFactory));return t};var p=typeof window!==t?window.log:void 0;s.noConflict=function(){typeof window!==t&&window.log===s&&(window.log=p);return s};s.getLoggers=function(){return r};s.default=s;return s}))})(Ki);return Ki.exports}var Qi=Ji();var Yi;(function(e){e[e.trace=0]="trace";e[e.debug=1]="debug";e[e.info=2]="info";e[e.warn=3]="warn";e[e.error=4]="error";e[e.silent=5]="silent"})(Yi||(Yi={}));var Xi;(function(e){e.Default="livekit";e.Room="livekit-room";e.Participant="livekit-participant";e.Track="livekit-track";e.Publication="livekit-track-publication";e.Engine="livekit-engine";e.Signal="livekit-signal";e.PCManager="livekit-pc-manager";e.PCTransport="livekit-pc-transport";e.E2EE="lk-e2ee"})(Xi||(Xi={}));let Zi=Qi.getLogger("livekit");const $i=Object.values(Xi).map((e=>Qi.getLogger(e)));Zi.setDefaultLevel(Yi.info);function en(e){const t=Qi.getLogger(e);t.setDefaultLevel(Zi.getLevel());return t}function tn(e,t){if(t)Qi.getLogger(t).setLevel(e);else for(const t of $i)t.setLevel(e)}function nn(e,t){const i=t?[t]:$i;i.forEach((t=>{const i=t.methodFactory;t.methodFactory=(t,n,r)=>{const s=i(t,n,r);const o=Yi[t];const a=o>=n&&o<Yi.silent;return(t,i)=>{i?s(t,i):s(t);a&&e(o,t,i)}};t.setLevel(t.getLevel())}))}const rn=Qi.getLogger("lk-e2ee");const sn=7e3;const on=[0,300,1200,2700,4800,sn,sn,sn,sn,sn];class DefaultReconnectPolicy{constructor(e){this._retryDelays=e!==void 0?[...e]:on}nextRetryDelayInMs(e){if(e.retryCount>=this._retryDelays.length)return null;const t=this._retryDelays[e.retryCount];return e.retryCount<=1?t:t+Math.random()*1e3}}function an(e,t){var i={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(i[n]=e[n]);if(e!=null&&typeof Object.getOwnPropertySymbols==="function"){var r=0;for(n=Object.getOwnPropertySymbols(e);r<n.length;r++)t.indexOf(n[r])<0&&Object.prototype.propertyIsEnumerable.call(e,n[r])&&(i[n[r]]=e[n[r]])}return i}function cn(e,t,i,n){function r(e){return e instanceof i?e:new i((function(t){t(e)}))}return new(i||(i=Promise))((function(i,s){function o(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){e.done?i(e.value):r(e.value).then(o,a)}c((n=n.apply(e,t||[])).next())}))}function dn(e){var t=typeof Symbol==="function"&&Symbol.iterator,i=t&&e[t],n=0;if(i)return i.call(e);if(e&&typeof e.length==="number")return{next:function(){e&&n>=e.length&&(e=void 0);return{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function ln(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,i=e[Symbol.asyncIterator];return i?i.call(e):(e=typeof dn==="function"?dn(e):e[Symbol.iterator](),t={},n("next"),n("throw"),n("return"),t[Symbol.asyncIterator]=function(){return this},t);function n(i){t[i]=e[i]&&function(t){return new Promise((function(n,s){t=e[i](t),r(n,s,t.done,t.value)}))}}function r(e,t,i,n){Promise.resolve(n).then((function(t){e({value:t,done:i})}),t)}}typeof SuppressedError==="function"?SuppressedError:function(e,t,i){var n=new Error(i);return n.name="SuppressedError",n.error=e,n.suppressed=t,n};var un={exports:{}};var hn;function pn(){if(hn)return un.exports;hn=1;var e=typeof Reflect==="object"?Reflect:null;var t=e&&typeof e.apply==="function"?e.apply:function(e,t,i){return Function.prototype.apply.call(e,t,i)};var i;i=e&&typeof e.ownKeys==="function"?e.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};function n(e){console&&console.warn&&console.warn(e)}var r=Number.isNaN||function(e){return e!==e};function s(){s.init.call(this)}un.exports=s;un.exports.once=v;s.EventEmitter=s;s.prototype._events=void 0;s.prototype._eventsCount=0;s.prototype._maxListeners=void 0;var o=10;function a(e){if(typeof e!=="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}Object.defineProperty(s,"defaultMaxListeners",{enumerable:true,get:function(){return o},set:function(e){if(typeof e!=="number"||e<0||r(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");o=e}});s.init=function(){if(this._events===void 0||this._events===Object.getPrototypeOf(this)._events){this._events=Object.create(null);this._eventsCount=0}this._maxListeners=this._maxListeners||void 0};s.prototype.setMaxListeners=function(e){if(typeof e!=="number"||e<0||r(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");this._maxListeners=e;return this};function c(e){return e._maxListeners===void 0?s.defaultMaxListeners:e._maxListeners}s.prototype.getMaxListeners=function(){return c(this)};s.prototype.emit=function(e){var i=[];for(var n=1;n<arguments.length;n++)i.push(arguments[n]);var r=e==="error";var s=this._events;if(s!==void 0)r=r&&s.error===void 0;else if(!r)return false;if(r){var o;i.length>0&&(o=i[0]);if(o instanceof Error)throw o;var a=new Error("Unhandled error."+(o?" ("+o.message+")":""));a.context=o;throw a}var c=s[e];if(c===void 0)return false;if(typeof c==="function")t(c,this,i);else{var d=c.length;var l=m(c,d);for(n=0;n<d;++n)t(l[n],this,i)}return true};function d(e,t,i,r){var s;var o;var d;a(i);o=e._events;if(o===void 0){o=e._events=Object.create(null);e._eventsCount=0}else{if(o.newListener!==void 0){e.emit("newListener",t,i.listener?i.listener:i);o=e._events}d=o[t]}if(d===void 0){d=o[t]=i;++e._eventsCount}else{typeof d==="function"?d=o[t]=r?[i,d]:[d,i]:r?d.unshift(i):d.push(i);s=c(e);if(s>0&&d.length>s&&!d.warned){d.warned=true;var l=new Error("Possible EventEmitter memory leak detected. "+d.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");l.name="MaxListenersExceededWarning";l.emitter=e;l.type=t;l.count=d.length;n(l)}}return e}s.prototype.addListener=function(e,t){return d(this,e,t,false)};s.prototype.on=s.prototype.addListener;s.prototype.prependListener=function(e,t){return d(this,e,t,true)};function l(){if(!this.fired){this.target.removeListener(this.type,this.wrapFn);this.fired=true;return arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}}function u(e,t,i){var n={fired:false,wrapFn:void 0,target:e,type:t,listener:i};var r=l.bind(n);r.listener=i;n.wrapFn=r;return r}s.prototype.once=function(e,t){a(t);this.on(e,u(this,e,t));return this};s.prototype.prependOnceListener=function(e,t){a(t);this.prependListener(e,u(this,e,t));return this};s.prototype.removeListener=function(e,t){var i,n,r,s,o;a(t);n=this._events;if(n===void 0)return this;i=n[e];if(i===void 0)return this;if(i===t||i.listener===t)if(--this._eventsCount===0)this._events=Object.create(null);else{delete n[e];n.removeListener&&this.emit("removeListener",e,i.listener||t)}else if(typeof i!=="function"){r=-1;for(s=i.length-1;s>=0;s--)if(i[s]===t||i[s].listener===t){o=i[s].listener;r=s;break}if(r<0)return this;r===0?i.shift():g(i,r);i.length===1&&(n[e]=i[0]);n.removeListener!==void 0&&this.emit("removeListener",e,o||t)}return this};s.prototype.off=s.prototype.removeListener;s.prototype.removeAllListeners=function(e){var t,i,n;i=this._events;if(i===void 0)return this;if(i.removeListener===void 0){if(arguments.length===0){this._events=Object.create(null);this._eventsCount=0}else i[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete i[e]);return this}if(arguments.length===0){var r=Object.keys(i);var s;for(n=0;n<r.length;++n){s=r[n];s!=="removeListener"&&this.removeAllListeners(s)}this.removeAllListeners("removeListener");this._events=Object.create(null);this._eventsCount=0;return this}t=i[e];if(typeof t==="function")this.removeListener(e,t);else if(t!==void 0)for(n=t.length-1;n>=0;n--)this.removeListener(e,t[n]);return this};function h(e,t,i){var n=e._events;if(n===void 0)return[];var r=n[t];return r===void 0?[]:typeof r==="function"?i?[r.listener||r]:[r]:i?f(r):m(r,r.length)}s.prototype.listeners=function(e){return h(this,e,true)};s.prototype.rawListeners=function(e){return h(this,e,false)};s.listenerCount=function(e,t){return typeof e.listenerCount==="function"?e.listenerCount(t):p.call(e,t)};s.prototype.listenerCount=p;function p(e){var t=this._events;if(t!==void 0){var i=t[e];if(typeof i==="function")return 1;if(i!==void 0)return i.length}return 0}s.prototype.eventNames=function(){return this._eventsCount>0?i(this._events):[]};function m(e,t){var i=new Array(t);for(var n=0;n<t;++n)i[n]=e[n];return i}function g(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}function f(e){var t=new Array(e.length);for(var i=0;i<t.length;++i)t[i]=e[i].listener||e[i];return t}function v(e,t){return new Promise((function(i,n){function r(i){e.removeListener(t,s);n(i)}function s(){typeof e.removeListener==="function"&&e.removeListener("error",r);i([].slice.call(arguments))}b(e,t,s,{once:true});t!=="error"&&k(e,r,{once:true})}))}function k(e,t,i){typeof e.on==="function"&&b(e,"error",t,i)}function b(e,t,i,n){if(typeof e.on==="function")n.once?e.once(t,i):e.on(t,i);else{if(typeof e.addEventListener!=="function")throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,(function r(s){n.once&&e.removeEventListener(t,r);i(s)}))}}return un.exports}var mn=pn();let gn=true;let fn=true;
/**
 * Extract browser version out of the provided user agent string.
 *
 * @param {!string} uastring userAgent string.
 * @param {!string} expr Regular expression used as match criteria.
 * @param {!number} pos position in the version string to be returned.
 * @return {!number} browser version.
 */function vn(e,t,i){const n=e.match(t);return n&&n.length>=i&&parseFloat(n[i],10)}function kn(e,t,i){if(!e.RTCPeerConnection)return;const n=e.RTCPeerConnection.prototype;const r=n.addEventListener;n.addEventListener=function(e,n){if(e!==t)return r.apply(this,arguments);const s=e=>{const t=i(e);t&&(n.handleEvent?n.handleEvent(t):n(t))};this._eventMap=this._eventMap||{};this._eventMap[t]||(this._eventMap[t]=new Map);this._eventMap[t].set(n,s);return r.apply(this,[e,s])};const s=n.removeEventListener;n.removeEventListener=function(e,i){if(e!==t||!this._eventMap||!this._eventMap[t])return s.apply(this,arguments);if(!this._eventMap[t].has(i))return s.apply(this,arguments);const n=this._eventMap[t].get(i);this._eventMap[t].delete(i);this._eventMap[t].size===0&&delete this._eventMap[t];Object.keys(this._eventMap).length===0&&delete this._eventMap;return s.apply(this,[e,n])};Object.defineProperty(n,"on"+t,{get(){return this["_on"+t]},set(e){if(this["_on"+t]){this.removeEventListener(t,this["_on"+t]);delete this["_on"+t]}e&&this.addEventListener(t,this["_on"+t]=e)},enumerable:true,configurable:true})}function bn(e){if(typeof e!=="boolean")return new Error("Argument type: "+typeof e+". Please use a boolean.");gn=e;return e?"adapter.js logging disabled":"adapter.js logging enabled"}
/**
 * Disable or enable deprecation warnings
 * @param {!boolean} bool set to true to disable warnings.
 */function yn(e){if(typeof e!=="boolean")return new Error("Argument type: "+typeof e+". Please use a boolean.");fn=!e;return"adapter.js deprecation warnings "+(e?"disabled":"enabled")}function Tn(){if(typeof window==="object"){if(gn)return;typeof console!=="undefined"&&typeof console.log==="function"&&console.log.apply(console,arguments)}}function Cn(e,t){fn&&console.warn(e+" is deprecated, please use "+t+" instead.")}function Sn(e){const t={browser:null,version:null};if(typeof e==="undefined"||!e.navigator||!e.navigator.userAgent){t.browser="Not a browser.";return t}const{navigator:i}=e;if(i.userAgentData&&i.userAgentData.brands){const e=i.userAgentData.brands.find((e=>e.brand==="Chromium"));if(e)return{browser:"chrome",version:parseInt(e.version,10)}}if(i.mozGetUserMedia){t.browser="firefox";t.version=parseInt(vn(i.userAgent,/Firefox\/(\d+)\./,1))}else if(i.webkitGetUserMedia||e.isSecureContext===false&&e.webkitRTCPeerConnection){t.browser="chrome";t.version=parseInt(vn(i.userAgent,/Chrom(e|ium)\/(\d+)\./,2))}else{if(!e.RTCPeerConnection||!i.userAgent.match(/AppleWebKit\/(\d+)\./)){t.browser="Not a supported browser.";return t}t.browser="safari";t.version=parseInt(vn(i.userAgent,/AppleWebKit\/(\d+)\./,1));t.supportsUnifiedPlan=e.RTCRtpTransceiver&&"currentDirection"in e.RTCRtpTransceiver.prototype;t._safariVersion=vn(i.userAgent,/Version\/(\d+(\.?\d+))/,1)}return t}
/**
 * Checks if something is an object.
 *
 * @param {*} val The something you want to check.
 * @return true if val is an object, false otherwise.
 */function wn(e){return Object.prototype.toString.call(e)==="[object Object]"}function En(e){return wn(e)?Object.keys(e).reduce((function(t,i){const n=wn(e[i]);const r=n?En(e[i]):e[i];const s=n&&!Object.keys(r).length;return r===void 0||s?t:Object.assign(t,{[i]:r})}),{}):e}function Pn(e,t,i){if(t&&!i.has(t.id)){i.set(t.id,t);Object.keys(t).forEach((n=>{n.endsWith("Id")?Pn(e,e.get(t[n]),i):n.endsWith("Ids")&&t[n].forEach((t=>{Pn(e,e.get(t),i)}))}))}}function Rn(e,t,i){const n=i?"outbound-rtp":"inbound-rtp";const r=new Map;if(t===null)return r;const s=[];e.forEach((e=>{e.type==="track"&&e.trackIdentifier===t.id&&s.push(e)}));s.forEach((t=>{e.forEach((i=>{i.type===n&&i.trackId===t.id&&Pn(e,i,r)}))}));return r}const In=Tn;function On(e,t){const i=e&&e.navigator;if(!i.mediaDevices)return;const n=function(e){if(typeof e!=="object"||e.mandatory||e.optional)return e;const t={};Object.keys(e).forEach((i=>{if(i==="require"||i==="advanced"||i==="mediaSource")return;const n=typeof e[i]==="object"?e[i]:{ideal:e[i]};n.exact!==void 0&&typeof n.exact==="number"&&(n.min=n.max=n.exact);const r=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):t==="deviceId"?"sourceId":t};if(n.ideal!==void 0){t.optional=t.optional||[];let e={};if(typeof n.ideal==="number"){e[r("min",i)]=n.ideal;t.optional.push(e);e={};e[r("max",i)]=n.ideal;t.optional.push(e)}else{e[r("",i)]=n.ideal;t.optional.push(e)}}if(n.exact!==void 0&&typeof n.exact!=="number"){t.mandatory=t.mandatory||{};t.mandatory[r("",i)]=n.exact}else["min","max"].forEach((e=>{if(n[e]!==void 0){t.mandatory=t.mandatory||{};t.mandatory[r(e,i)]=n[e]}}))}));e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced));return t};const r=function(e,r){if(t.version>=61)return r(e);e=JSON.parse(JSON.stringify(e));if(e&&typeof e.audio==="object"){const t=function(e,t,i){if(t in e&&!(i in e)){e[i]=e[t];delete e[t]}};e=JSON.parse(JSON.stringify(e));t(e.audio,"autoGainControl","googAutoGainControl");t(e.audio,"noiseSuppression","googNoiseSuppression");e.audio=n(e.audio)}if(e&&typeof e.video==="object"){let s=e.video.facingMode;s=s&&(typeof s==="object"?s:{ideal:s});const o=t.version<66;if(s&&(s.exact==="user"||s.exact==="environment"||s.ideal==="user"||s.ideal==="environment")&&!(i.mediaDevices.getSupportedConstraints&&i.mediaDevices.getSupportedConstraints().facingMode&&!o)){delete e.video.facingMode;let t;s.exact==="environment"||s.ideal==="environment"?t=["back","rear"]:s.exact!=="user"&&s.ideal!=="user"||(t=["front"]);if(t)return i.mediaDevices.enumerateDevices().then((i=>{i=i.filter((e=>e.kind==="videoinput"));let o=i.find((e=>t.some((t=>e.label.toLowerCase().includes(t)))));!o&&i.length&&t.includes("back")&&(o=i[i.length-1]);o&&(e.video.deviceId=s.exact?{exact:o.deviceId}:{ideal:o.deviceId});e.video=n(e.video);In("chrome: "+JSON.stringify(e));return r(e)}))}e.video=n(e.video)}In("chrome: "+JSON.stringify(e));return r(e)};const s=function(e){return t.version>=64?e:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};const o=function(e,t,n){r(e,(e=>{i.webkitGetUserMedia(e,t,(e=>{n&&n(s(e))}))}))};i.getUserMedia=o.bind(i);if(i.mediaDevices.getUserMedia){const e=i.mediaDevices.getUserMedia.bind(i.mediaDevices);i.mediaDevices.getUserMedia=function(t){return r(t,(t=>e(t).then((e=>{if(t.audio&&!e.getAudioTracks().length||t.video&&!e.getVideoTracks().length){e.getTracks().forEach((e=>{e.stop()}));throw new DOMException("","NotFoundError")}return e}),(e=>Promise.reject(s(e))))))}}}function Dn(e){e.MediaStream=e.MediaStream||e.webkitMediaStream}function xn(e){if(typeof e==="object"&&e.RTCPeerConnection&&!("ontrack"in e.RTCPeerConnection.prototype)){Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(e){this._ontrack&&this.removeEventListener("track",this._ontrack);this.addEventListener("track",this._ontrack=e)},enumerable:true,configurable:true});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){if(!this._ontrackpoly){this._ontrackpoly=t=>{t.stream.addEventListener("addtrack",(i=>{let n;n=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((e=>e.track&&e.track.id===i.track.id)):{track:i.track};const r=new Event("track");r.track=i.track;r.receiver=n;r.transceiver={receiver:n};r.streams=[t.stream];this.dispatchEvent(r)}));t.stream.getTracks().forEach((i=>{let n;n=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((e=>e.track&&e.track.id===i.id)):{track:i};const r=new Event("track");r.track=i;r.receiver=n;r.transceiver={receiver:n};r.streams=[t.stream];this.dispatchEvent(r)}))};this.addEventListener("addstream",this._ontrackpoly)}return t.apply(this,arguments)}}else kn(e,"track",(e=>{e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}});return e}))}function Mn(e){if(typeof e==="object"&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){const t=function(e,t){return{track:t,get dtmf(){this._dtmf===void 0&&(t.kind==="audio"?this._dtmf=e.createDTMFSender(t):this._dtmf=null);return this._dtmf},_pc:e}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){this._senders=this._senders||[];return this._senders.slice()};const i=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,n){let r=i.apply(this,arguments);if(!r){r=t(this,e);this._senders.push(r)}return r};const n=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){n.apply(this,arguments);const t=this._senders.indexOf(e);t!==-1&&this._senders.splice(t,1)}}const i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._senders=this._senders||[];i.apply(this,[e]);e.getTracks().forEach((e=>{this._senders.push(t(this,e))}))};const n=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){this._senders=this._senders||[];n.apply(this,[e]);e.getTracks().forEach((e=>{const t=this._senders.find((t=>t.track===e));t&&this._senders.splice(this._senders.indexOf(t),1)}))}}else if(typeof e==="object"&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);e.forEach((e=>e._pc=this));return e};Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null);return this._dtmf}})}}function An(e){if(!(typeof e==="object"&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver))return;if(!("getStats"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);e.forEach((e=>e._pc=this));return e});const i=e.RTCPeerConnection.prototype.addTrack;i&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=i.apply(this,arguments);e._pc=this;return e});e.RTCRtpSender.prototype.getStats=function(){const e=this;return this._pc.getStats().then((t=>Rn(t,e.track,true)))}}if(!("getStats"in e.RTCRtpReceiver.prototype)){const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);e.forEach((e=>e._pc=this));return e});kn(e,"track",(e=>{e.receiver._pc=e.srcElement;return e}));e.RTCRtpReceiver.prototype.getStats=function(){const e=this;return this._pc.getStats().then((t=>Rn(t,e.track,false)))}}if(!("getStats"in e.RTCRtpSender.prototype&&"getStats"in e.RTCRtpReceiver.prototype))return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof e.MediaStreamTrack){const e=arguments[0];let t;let i;let n;this.getSenders().forEach((i=>{i.track===e&&(t?n=true:t=i)}));this.getReceivers().forEach((t=>{t.track===e&&(i?n=true:i=t);return t.track===e}));return n||t&&i?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):t?t.getStats():i?i.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return t.apply(this,arguments)}}function _n(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){this._shimmedLocalStreams=this._shimmedLocalStreams||{};return Object.keys(this._shimmedLocalStreams).map((e=>this._shimmedLocalStreams[e][0]))};const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,i){if(!i)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const n=t.apply(this,arguments);this._shimmedLocalStreams[i.id]?this._shimmedLocalStreams[i.id].indexOf(n)===-1&&this._shimmedLocalStreams[i.id].push(n):this._shimmedLocalStreams[i.id]=[i,n];return n};const i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._shimmedLocalStreams=this._shimmedLocalStreams||{};e.getTracks().forEach((e=>{const t=this.getSenders().find((t=>t.track===e));if(t)throw new DOMException("Track already exists.","InvalidAccessError")}));const t=this.getSenders();i.apply(this,arguments);const n=this.getSenders().filter((e=>t.indexOf(e)===-1));this._shimmedLocalStreams[e.id]=[e].concat(n)};const n=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){this._shimmedLocalStreams=this._shimmedLocalStreams||{};delete this._shimmedLocalStreams[e.id];return n.apply(this,arguments)};const r=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){this._shimmedLocalStreams=this._shimmedLocalStreams||{};e&&Object.keys(this._shimmedLocalStreams).forEach((t=>{const i=this._shimmedLocalStreams[t].indexOf(e);i!==-1&&this._shimmedLocalStreams[t].splice(i,1);this._shimmedLocalStreams[t].length===1&&delete this._shimmedLocalStreams[t]}));return r.apply(this,arguments)}}function Nn(e,t){if(!e.RTCPeerConnection)return;if(e.RTCPeerConnection.prototype.addTrack&&t.version>=65)return _n(e);const i=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){const e=i.apply(this);this._reverseStreams=this._reverseStreams||{};return e.map((e=>this._reverseStreams[e.id]))};const n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){this._streams=this._streams||{};this._reverseStreams=this._reverseStreams||{};t.getTracks().forEach((e=>{const t=this.getSenders().find((t=>t.track===e));if(t)throw new DOMException("Track already exists.","InvalidAccessError")}));if(!this._reverseStreams[t.id]){const i=new e.MediaStream(t.getTracks());this._streams[t.id]=i;this._reverseStreams[i.id]=t;t=i}n.apply(this,[t])};const r=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){this._streams=this._streams||{};this._reverseStreams=this._reverseStreams||{};r.apply(this,[this._streams[e.id]||e]);delete this._reverseStreams[this._streams[e.id]?this._streams[e.id].id:e.id];delete this._streams[e.id]};e.RTCPeerConnection.prototype.addTrack=function(t,i){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const n=[].slice.call(arguments,1);if(n.length!==1||!n[0].getTracks().find((e=>e===t)))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");const r=this.getSenders().find((e=>e.track===t));if(r)throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{};this._reverseStreams=this._reverseStreams||{};const s=this._streams[i.id];if(s){s.addTrack(t);Promise.resolve().then((()=>{this.dispatchEvent(new Event("negotiationneeded"))}))}else{const n=new e.MediaStream([t]);this._streams[i.id]=n;this._reverseStreams[n.id]=i;this.addStream(n)}return this.getSenders().find((e=>e.track===t))};function s(e,t){let i=t.sdp;Object.keys(e._reverseStreams||[]).forEach((t=>{const n=e._reverseStreams[t];const r=e._streams[n.id];i=i.replace(new RegExp(r.id,"g"),n.id)}));return new RTCSessionDescription({type:t.type,sdp:i})}function o(e,t){let i=t.sdp;Object.keys(e._reverseStreams||[]).forEach((t=>{const n=e._reverseStreams[t];const r=e._streams[n.id];i=i.replace(new RegExp(n.id,"g"),r.id)}));return new RTCSessionDescription({type:t.type,sdp:i})}["createOffer","createAnswer"].forEach((function(t){const i=e.RTCPeerConnection.prototype[t];const n={[t](){const e=arguments;const t=arguments.length&&typeof arguments[0]==="function";return t?i.apply(this,[t=>{const i=s(this,t);e[0].apply(null,[i])},t=>{e[1]&&e[1].apply(null,t)},arguments[2]]):i.apply(this,arguments).then((e=>s(this,e)))}};e.RTCPeerConnection.prototype[t]=n[t]}));const a=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){if(!arguments.length||!arguments[0].type)return a.apply(this,arguments);arguments[0]=o(this,arguments[0]);return a.apply(this,arguments)};const c=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get(){const e=c.get.apply(this);return e.type===""?e:s(this,e)}});e.RTCPeerConnection.prototype.removeTrack=function(e){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!e._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");const t=e._pc===this;if(!t)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");this._streams=this._streams||{};let i;Object.keys(this._streams).forEach((t=>{const n=this._streams[t].getTracks().find((t=>e.track===t));n&&(i=this._streams[t])}));if(i){i.getTracks().length===1?this.removeStream(this._reverseStreams[i.id]):i.removeTrack(e.track);this.dispatchEvent(new Event("negotiationneeded"))}}}function Ln(e,t){!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=e.webkitRTCPeerConnection);e.RTCPeerConnection&&t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const i=e.RTCPeerConnection.prototype[t];const n={[t](){arguments[0]=new(t==="addIceCandidate"?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]);return i.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=n[t]}))}function Un(e,t){kn(e,"negotiationneeded",(e=>{const i=e.target;if(!(t.version<72||i.getConfiguration&&i.getConfiguration().sdpSemantics==="plan-b")||i.signalingState==="stable")return e}))}var jn=Object.freeze({__proto__:null,fixNegotiationNeeded:Un,shimAddTrackRemoveTrack:Nn,shimAddTrackRemoveTrackWithNative:_n,shimGetSendersWithDtmf:Mn,shimGetUserMedia:On,shimMediaStream:Dn,shimOnTrack:xn,shimPeerConnection:Ln,shimSenderReceiverGetStats:An});function Fn(e,t){const i=e&&e.navigator;const n=e&&e.MediaStreamTrack;i.getUserMedia=function(e,t,n){Cn("navigator.getUserMedia","navigator.mediaDevices.getUserMedia");i.mediaDevices.getUserMedia(e).then(t,n)};if(!(t.version>55&&"autoGainControl"in i.mediaDevices.getSupportedConstraints())){const e=function(e,t,i){if(t in e&&!(i in e)){e[i]=e[t];delete e[t]}};const t=i.mediaDevices.getUserMedia.bind(i.mediaDevices);i.mediaDevices.getUserMedia=function(i){if(typeof i==="object"&&typeof i.audio==="object"){i=JSON.parse(JSON.stringify(i));e(i.audio,"autoGainControl","mozAutoGainControl");e(i.audio,"noiseSuppression","mozNoiseSuppression")}return t(i)};if(n&&n.prototype.getSettings){const t=n.prototype.getSettings;n.prototype.getSettings=function(){const i=t.apply(this,arguments);e(i,"mozAutoGainControl","autoGainControl");e(i,"mozNoiseSuppression","noiseSuppression");return i}}if(n&&n.prototype.applyConstraints){const t=n.prototype.applyConstraints;n.prototype.applyConstraints=function(i){if(this.kind==="audio"&&typeof i==="object"){i=JSON.parse(JSON.stringify(i));e(i,"autoGainControl","mozAutoGainControl");e(i,"noiseSuppression","mozNoiseSuppression")}return t.apply(this,[i])}}}}function Bn(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(e.navigator.mediaDevices.getDisplayMedia=function(i){if(!(i&&i.video)){const e=new DOMException("getDisplayMedia without video constraints is undefined");e.name="NotFoundError";e.code=8;return Promise.reject(e)}i.video===true?i.video={mediaSource:t}:i.video.mediaSource=t;return e.navigator.mediaDevices.getUserMedia(i)})}function Vn(e){typeof e==="object"&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function qn(e,t){if(typeof e!=="object"||!(e.RTCPeerConnection||e.mozRTCPeerConnection))return;!e.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection);t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const i=e.RTCPeerConnection.prototype[t];const n={[t](){arguments[0]=new(t==="addIceCandidate"?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]);return i.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=n[t]}));const i={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"};const n=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,r,s]=arguments;return n.apply(this,[e||null]).then((e=>{if(t.version<53&&!r)try{e.forEach((e=>{e.type=i[e.type]||e.type}))}catch(t){if(t.name!=="TypeError")throw t;e.forEach(((t,n)=>{e.set(n,Object.assign({},t,{type:i[t.type]||t.type}))}))}return e})).then(r,s)}}function Hn(e){if(!(typeof e==="object"&&e.RTCPeerConnection&&e.RTCRtpSender))return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype)return;const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);e.forEach((e=>e._pc=this));return e});const i=e.RTCPeerConnection.prototype.addTrack;i&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=i.apply(this,arguments);e._pc=this;return e});e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function Wn(e){if(!(typeof e==="object"&&e.RTCPeerConnection&&e.RTCRtpSender))return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype)return;const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);e.forEach((e=>e._pc=this));return e});kn(e,"track",(e=>{e.receiver._pc=e.srcElement;return e}));e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function Kn(e){e.RTCPeerConnection&&!("removeStream"in e.RTCPeerConnection.prototype)&&(e.RTCPeerConnection.prototype.removeStream=function(e){Cn("removeStream","removeTrack");this.getSenders().forEach((t=>{t.track&&e.getTracks().includes(t.track)&&this.removeTrack(t)}))})}function Gn(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)}function zn(e){if(!(typeof e==="object"&&e.RTCPeerConnection))return;const t=e.RTCPeerConnection.prototype.addTransceiver;t&&(e.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let e=arguments[1]&&arguments[1].sendEncodings;e===void 0&&(e=[]);e=[...e];const i=e.length>0;i&&e.forEach((e=>{if("rid"in e){const t=/^[a-z0-9]{0,16}$/i;if(!t.test(e.rid))throw new TypeError("Invalid RID value provided.")}if("scaleResolutionDownBy"in e&&!(parseFloat(e.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in e&&!(parseFloat(e.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")}));const n=t.apply(this,arguments);if(i){const{sender:t}=n;const i=t.getParameters();if(!("encodings"in i)||i.encodings.length===1&&Object.keys(i.encodings[0]).length===0){i.encodings=e;t.sendEncodings=e;this.setParametersPromises.push(t.setParameters(i).then((()=>{delete t.sendEncodings})).catch((()=>{delete t.sendEncodings})))}}return n})}function Jn(e){if(!(typeof e==="object"&&e.RTCRtpSender))return;const t=e.RTCRtpSender.prototype.getParameters;t&&(e.RTCRtpSender.prototype.getParameters=function(){const e=t.apply(this,arguments);"encodings"in e||(e.encodings=[].concat(this.sendEncodings||[{}]));return e})}function Qn(e){if(!(typeof e==="object"&&e.RTCPeerConnection))return;const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((()=>t.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):t.apply(this,arguments)}}function Yn(e){if(!(typeof e==="object"&&e.RTCPeerConnection))return;const t=e.RTCPeerConnection.prototype.createAnswer;e.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((()=>t.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):t.apply(this,arguments)}}var Xn=Object.freeze({__proto__:null,shimAddTransceiver:zn,shimCreateAnswer:Yn,shimCreateOffer:Qn,shimGetDisplayMedia:Bn,shimGetParameters:Jn,shimGetUserMedia:Fn,shimOnTrack:Vn,shimPeerConnection:qn,shimRTCDataChannel:Gn,shimReceiverGetStats:Wn,shimRemoveStream:Kn,shimSenderGetStats:Hn});function Zn(e){if(typeof e==="object"&&e.RTCPeerConnection){"getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){this._localStreams||(this._localStreams=[]);return this._localStreams});if(!("addStream"in e.RTCPeerConnection.prototype)){const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(e){this._localStreams||(this._localStreams=[]);this._localStreams.includes(e)||this._localStreams.push(e);e.getAudioTracks().forEach((i=>t.call(this,i,e)));e.getVideoTracks().forEach((i=>t.call(this,i,e)))};e.RTCPeerConnection.prototype.addTrack=function(e){for(var i=arguments.length,n=new Array(i>1?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];n&&n.forEach((e=>{this._localStreams?this._localStreams.includes(e)||this._localStreams.push(e):this._localStreams=[e]}));return t.apply(this,arguments)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);const t=this._localStreams.indexOf(e);if(t===-1)return;this._localStreams.splice(t,1);const i=e.getTracks();this.getSenders().forEach((e=>{i.includes(e.track)&&this.removeTrack(e)}))})}}function $n(e){if(typeof e==="object"&&e.RTCPeerConnection){"getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]});if(!("onaddstream"in e.RTCPeerConnection.prototype)){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(e){if(this._onaddstream){this.removeEventListener("addstream",this._onaddstream);this.removeEventListener("track",this._onaddstreampoly)}this.addEventListener("addstream",this._onaddstream=e);this.addEventListener("track",this._onaddstreampoly=e=>{e.streams.forEach((e=>{this._remoteStreams||(this._remoteStreams=[]);if(this._remoteStreams.includes(e))return;this._remoteStreams.push(e);const t=new Event("addstream");t.stream=e;this.dispatchEvent(t)}))})}});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){const e=this;this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(t){t.streams.forEach((t=>{e._remoteStreams||(e._remoteStreams=[]);if(e._remoteStreams.indexOf(t)>=0)return;e._remoteStreams.push(t);const i=new Event("addstream");i.stream=t;e.dispatchEvent(i)}))});return t.apply(e,arguments)}}}}function er(e){if(typeof e!=="object"||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype;const i=t.createOffer;const n=t.createAnswer;const r=t.setLocalDescription;const s=t.setRemoteDescription;const o=t.addIceCandidate;t.createOffer=function(e,t){const n=arguments.length>=2?arguments[2]:arguments[0];const r=i.apply(this,[n]);if(!t)return r;r.then(e,t);return Promise.resolve()};t.createAnswer=function(e,t){const i=arguments.length>=2?arguments[2]:arguments[0];const r=n.apply(this,[i]);if(!t)return r;r.then(e,t);return Promise.resolve()};let a=function(e,t,i){const n=r.apply(this,[e]);if(!i)return n;n.then(t,i);return Promise.resolve()};t.setLocalDescription=a;a=function(e,t,i){const n=s.apply(this,[e]);if(!i)return n;n.then(t,i);return Promise.resolve()};t.setRemoteDescription=a;a=function(e,t,i){const n=o.apply(this,[e]);if(!i)return n;n.then(t,i);return Promise.resolve()};t.addIceCandidate=a}function tr(e){const t=e&&e.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){const e=t.mediaDevices;const i=e.getUserMedia.bind(e);t.mediaDevices.getUserMedia=e=>i(ir(e))}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(e,i,n){t.mediaDevices.getUserMedia(e).then(i,n)}.bind(t))}function ir(e){return e&&e.video!==void 0?Object.assign({},e,{video:En(e.video)}):e}function nr(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection;e.RTCPeerConnection=function(e,i){if(e&&e.iceServers){const t=[];for(let i=0;i<e.iceServers.length;i++){let n=e.iceServers[i];if(n.urls===void 0&&n.url){Cn("RTCIceServer.url","RTCIceServer.urls");n=JSON.parse(JSON.stringify(n));n.urls=n.url;delete n.url;t.push(n)}else t.push(e.iceServers[i])}e.iceServers=t}return new t(e,i)};e.RTCPeerConnection.prototype=t.prototype;"generateCertificate"in t&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get(){return t.generateCertificate}})}function rr(e){typeof e==="object"&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function sr(e){const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){if(e){typeof e.offerToReceiveAudio!=="undefined"&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);const t=this.getTransceivers().find((e=>e.receiver.track.kind==="audio"));e.offerToReceiveAudio===false&&t?t.direction==="sendrecv"?t.setDirection?t.setDirection("sendonly"):t.direction="sendonly":t.direction==="recvonly"&&(t.setDirection?t.setDirection("inactive"):t.direction="inactive"):e.offerToReceiveAudio!==true||t||this.addTransceiver("audio",{direction:"recvonly"});typeof e.offerToReceiveVideo!=="undefined"&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);const i=this.getTransceivers().find((e=>e.receiver.track.kind==="video"));e.offerToReceiveVideo===false&&i?i.direction==="sendrecv"?i.setDirection?i.setDirection("sendonly"):i.direction="sendonly":i.direction==="recvonly"&&(i.setDirection?i.setDirection("inactive"):i.direction="inactive"):e.offerToReceiveVideo!==true||i||this.addTransceiver("video",{direction:"recvonly"})}return t.apply(this,arguments)}}function or(e){typeof e!=="object"||e.AudioContext||(e.AudioContext=e.webkitAudioContext)}var ar=Object.freeze({__proto__:null,shimAudioContext:or,shimCallbacksAPI:er,shimConstraints:ir,shimCreateOfferLegacy:sr,shimGetUserMedia:tr,shimLocalStreamsAPI:Zn,shimRTCIceServerUrls:nr,shimRemoteStreamsAPI:$n,shimTrackEventTransceiver:rr});var cr={exports:{}};var dr;function lr(){if(dr)return cr.exports;dr=1;(function(e){const t={};t.generateIdentifier=function(){return Math.random().toString(36).substring(2,12)};t.localCName=t.generateIdentifier();t.splitLines=function(e){return e.trim().split("\n").map((e=>e.trim()))};t.splitSections=function(e){const t=e.split("\nm=");return t.map(((e,t)=>(t>0?"m="+e:e).trim()+"\r\n"))};t.getDescription=function(e){const i=t.splitSections(e);return i&&i[0]};t.getMediaSections=function(e){const i=t.splitSections(e);i.shift();return i};t.matchPrefix=function(e,i){return t.splitLines(e).filter((e=>e.indexOf(i)===0))};t.parseCandidate=function(e){let t;t=e.indexOf("a=candidate:")===0?e.substring(12).split(" "):e.substring(10).split(" ");const i={foundation:t[0],component:{1:"rtp",2:"rtcp"}[t[1]]||t[1],protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]};for(let e=8;e<t.length;e+=2)switch(t[e]){case"raddr":i.relatedAddress=t[e+1];break;case"rport":i.relatedPort=parseInt(t[e+1],10);break;case"tcptype":i.tcpType=t[e+1];break;case"ufrag":i.ufrag=t[e+1];i.usernameFragment=t[e+1];break;default:i[t[e]]===void 0&&(i[t[e]]=t[e+1]);break}return i};t.writeCandidate=function(e){const t=[];t.push(e.foundation);const i=e.component;i==="rtp"?t.push(1):i==="rtcp"?t.push(2):t.push(i);t.push(e.protocol.toUpperCase());t.push(e.priority);t.push(e.address||e.ip);t.push(e.port);const n=e.type;t.push("typ");t.push(n);if(n!=="host"&&e.relatedAddress&&e.relatedPort){t.push("raddr");t.push(e.relatedAddress);t.push("rport");t.push(e.relatedPort)}if(e.tcpType&&e.protocol.toLowerCase()==="tcp"){t.push("tcptype");t.push(e.tcpType)}if(e.usernameFragment||e.ufrag){t.push("ufrag");t.push(e.usernameFragment||e.ufrag)}return"candidate:"+t.join(" ")};t.parseIceOptions=function(e){return e.substring(14).split(" ")};t.parseRtpMap=function(e){let t=e.substring(9).split(" ");const i={payloadType:parseInt(t.shift(),10)};t=t[0].split("/");i.name=t[0];i.clockRate=parseInt(t[1],10);i.channels=t.length===3?parseInt(t[2],10):1;i.numChannels=i.channels;return i};t.writeRtpMap=function(e){let t=e.payloadType;e.preferredPayloadType!==void 0&&(t=e.preferredPayloadType);const i=e.channels||e.numChannels||1;return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(i!==1?"/"+i:"")+"\r\n"};t.parseExtmap=function(e){const t=e.substring(9).split(" ");return{id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1],attributes:t.slice(2).join(" ")}};t.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&e.direction!=="sendrecv"?"/"+e.direction:"")+" "+e.uri+(e.attributes?" "+e.attributes:"")+"\r\n"};t.parseFmtp=function(e){const t={};let i;const n=e.substring(e.indexOf(" ")+1).split(";");for(let e=0;e<n.length;e++){i=n[e].trim().split("=");t[i[0].trim()]=i[1]}return t};t.writeFmtp=function(e){let t="";let i=e.payloadType;e.preferredPayloadType!==void 0&&(i=e.preferredPayloadType);if(e.parameters&&Object.keys(e.parameters).length){const n=[];Object.keys(e.parameters).forEach((t=>{e.parameters[t]!==void 0?n.push(t+"="+e.parameters[t]):n.push(t)}));t+="a=fmtp:"+i+" "+n.join(";")+"\r\n"}return t};t.parseRtcpFb=function(e){const t=e.substring(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}};t.writeRtcpFb=function(e){let t="";let i=e.payloadType;e.preferredPayloadType!==void 0&&(i=e.preferredPayloadType);e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach((e=>{t+="a=rtcp-fb:"+i+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"}));return t};t.parseSsrcMedia=function(e){const t=e.indexOf(" ");const i={ssrc:parseInt(e.substring(7,t),10)};const n=e.indexOf(":",t);if(n>-1){i.attribute=e.substring(t+1,n);i.value=e.substring(n+1)}else i.attribute=e.substring(t+1);return i};t.parseSsrcGroup=function(e){const t=e.substring(13).split(" ");return{semantics:t.shift(),ssrcs:t.map((e=>parseInt(e,10)))}};t.getMid=function(e){const i=t.matchPrefix(e,"a=mid:")[0];if(i)return i.substring(6)};t.parseFingerprint=function(e){const t=e.substring(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1].toUpperCase()}};t.getDtlsParameters=function(e,i){const n=t.matchPrefix(e+i,"a=fingerprint:");return{role:"auto",fingerprints:n.map(t.parseFingerprint)}};t.writeDtlsParameters=function(e,t){let i="a=setup:"+t+"\r\n";e.fingerprints.forEach((e=>{i+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"}));return i};t.parseCryptoLine=function(e){const t=e.substring(9).split(" ");return{tag:parseInt(t[0],10),cryptoSuite:t[1],keyParams:t[2],sessionParams:t.slice(3)}};t.writeCryptoLine=function(e){return"a=crypto:"+e.tag+" "+e.cryptoSuite+" "+(typeof e.keyParams==="object"?t.writeCryptoKeyParams(e.keyParams):e.keyParams)+(e.sessionParams?" "+e.sessionParams.join(" "):"")+"\r\n"};t.parseCryptoKeyParams=function(e){if(e.indexOf("inline:")!==0)return null;const t=e.substring(7).split("|");return{keyMethod:"inline",keySalt:t[0],lifeTime:t[1],mkiValue:t[2]?t[2].split(":")[0]:void 0,mkiLength:t[2]?t[2].split(":")[1]:void 0}};t.writeCryptoKeyParams=function(e){return e.keyMethod+":"+e.keySalt+(e.lifeTime?"|"+e.lifeTime:"")+(e.mkiValue&&e.mkiLength?"|"+e.mkiValue+":"+e.mkiLength:"")};t.getCryptoParameters=function(e,i){const n=t.matchPrefix(e+i,"a=crypto:");return n.map(t.parseCryptoLine)};t.getIceParameters=function(e,i){const n=t.matchPrefix(e+i,"a=ice-ufrag:")[0];const r=t.matchPrefix(e+i,"a=ice-pwd:")[0];return n&&r?{usernameFragment:n.substring(12),password:r.substring(10)}:null};t.writeIceParameters=function(e){let t="a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n";e.iceLite&&(t+="a=ice-lite\r\n");return t};t.parseRtpParameters=function(e){const i={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]};const n=t.splitLines(e);const r=n[0].split(" ");i.profile=r[2];for(let n=3;n<r.length;n++){const s=r[n];const o=t.matchPrefix(e,"a=rtpmap:"+s+" ")[0];if(o){const n=t.parseRtpMap(o);const r=t.matchPrefix(e,"a=fmtp:"+s+" ");n.parameters=r.length?t.parseFmtp(r[0]):{};n.rtcpFeedback=t.matchPrefix(e,"a=rtcp-fb:"+s+" ").map(t.parseRtcpFb);i.codecs.push(n);switch(n.name.toUpperCase()){case"RED":case"ULPFEC":i.fecMechanisms.push(n.name.toUpperCase());break}}}t.matchPrefix(e,"a=extmap:").forEach((e=>{i.headerExtensions.push(t.parseExtmap(e))}));const s=t.matchPrefix(e,"a=rtcp-fb:* ").map(t.parseRtcpFb);i.codecs.forEach((e=>{s.forEach((t=>{const i=e.rtcpFeedback.find((e=>e.type===t.type&&e.parameter===t.parameter));i||e.rtcpFeedback.push(t)}))}));return i};t.writeRtpDescription=function(e,i){let n="";n+="m="+e+" ";n+=i.codecs.length>0?"9":"0";n+=" "+(i.profile||"UDP/TLS/RTP/SAVPF")+" ";n+=i.codecs.map((e=>e.preferredPayloadType!==void 0?e.preferredPayloadType:e.payloadType)).join(" ")+"\r\n";n+="c=IN IP4 0.0.0.0\r\n";n+="a=rtcp:9 IN IP4 0.0.0.0\r\n";i.codecs.forEach((e=>{n+=t.writeRtpMap(e);n+=t.writeFmtp(e);n+=t.writeRtcpFb(e)}));let r=0;i.codecs.forEach((e=>{e.maxptime>r&&(r=e.maxptime)}));r>0&&(n+="a=maxptime:"+r+"\r\n");i.headerExtensions&&i.headerExtensions.forEach((e=>{n+=t.writeExtmap(e)}));return n};t.parseRtpEncodingParameters=function(e){const i=[];const n=t.parseRtpParameters(e);const r=n.fecMechanisms.indexOf("RED")!==-1;const s=n.fecMechanisms.indexOf("ULPFEC")!==-1;const o=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>e.attribute==="cname"));const a=o.length>0&&o[0].ssrc;let c;const d=t.matchPrefix(e,"a=ssrc-group:FID").map((e=>{const t=e.substring(17).split(" ");return t.map((e=>parseInt(e,10)))}));d.length>0&&d[0].length>1&&d[0][0]===a&&(c=d[0][1]);n.codecs.forEach((e=>{if(e.name.toUpperCase()==="RTX"&&e.parameters.apt){let t={ssrc:a,codecPayloadType:parseInt(e.parameters.apt,10)};a&&c&&(t.rtx={ssrc:c});i.push(t);if(r){t=JSON.parse(JSON.stringify(t));t.fec={ssrc:a,mechanism:s?"red+ulpfec":"red"};i.push(t)}}}));i.length===0&&a&&i.push({ssrc:a});let l=t.matchPrefix(e,"b=");if(l.length){l=l[0].indexOf("b=TIAS:")===0?parseInt(l[0].substring(7),10):l[0].indexOf("b=AS:")===0?parseInt(l[0].substring(5),10)*1e3*.95-16e3:void 0;i.forEach((e=>{e.maxBitrate=l}))}return i};t.parseRtcpParameters=function(e){const i={};const n=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>e.attribute==="cname"))[0];if(n){i.cname=n.value;i.ssrc=n.ssrc}const r=t.matchPrefix(e,"a=rtcp-rsize");i.reducedSize=r.length>0;i.compound=r.length===0;const s=t.matchPrefix(e,"a=rtcp-mux");i.mux=s.length>0;return i};t.writeRtcpParameters=function(e){let t="";e.reducedSize&&(t+="a=rtcp-rsize\r\n");e.mux&&(t+="a=rtcp-mux\r\n");e.ssrc!==void 0&&e.cname&&(t+="a=ssrc:"+e.ssrc+" cname:"+e.cname+"\r\n");return t};t.parseMsid=function(e){let i;const n=t.matchPrefix(e,"a=msid:");if(n.length===1){i=n[0].substring(7).split(" ");return{stream:i[0],track:i[1]}}const r=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>e.attribute==="msid"));if(r.length>0){i=r[0].value.split(" ");return{stream:i[0],track:i[1]}}};t.parseSctpDescription=function(e){const i=t.parseMLine(e);const n=t.matchPrefix(e,"a=max-message-size:");let r;n.length>0&&(r=parseInt(n[0].substring(19),10));isNaN(r)&&(r=65536);const s=t.matchPrefix(e,"a=sctp-port:");if(s.length>0)return{port:parseInt(s[0].substring(12),10),protocol:i.fmt,maxMessageSize:r};const o=t.matchPrefix(e,"a=sctpmap:");if(o.length>0){const e=o[0].substring(10).split(" ");return{port:parseInt(e[0],10),protocol:e[1],maxMessageSize:r}}};t.writeSctpDescription=function(e,t){let i=[];i=e.protocol!=="DTLS/SCTP"?["m="+e.kind+" 9 "+e.protocol+" "+t.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+t.port+"\r\n"]:["m="+e.kind+" 9 "+e.protocol+" "+t.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+t.port+" "+t.protocol+" 65535\r\n"];t.maxMessageSize!==void 0&&i.push("a=max-message-size:"+t.maxMessageSize+"\r\n");return i.join("")};t.generateSessionId=function(){return Math.random().toString().substr(2,22)};t.writeSessionBoilerplate=function(e,i,n){let r;const s=i!==void 0?i:2;r=e||t.generateSessionId();const o=n||"thisisadapterortc";return"v=0\r\no="+o+" "+r+" "+s+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"};t.getDirection=function(e,i){const n=t.splitLines(e);for(let e=0;e<n.length;e++)switch(n[e]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return n[e].substring(2)}return i?t.getDirection(i):"sendrecv"};t.getKind=function(e){const i=t.splitLines(e);const n=i[0].split(" ");return n[0].substring(2)};t.isRejected=function(e){return e.split(" ",2)[1]==="0"};t.parseMLine=function(e){const i=t.splitLines(e);const n=i[0].substring(2).split(" ");return{kind:n[0],port:parseInt(n[1],10),protocol:n[2],fmt:n.slice(3).join(" ")}};t.parseOLine=function(e){const i=t.matchPrefix(e,"o=")[0];const n=i.substring(2).split(" ");return{username:n[0],sessionId:n[1],sessionVersion:parseInt(n[2],10),netType:n[3],addressType:n[4],address:n[5]}};t.isValidSDP=function(e){if(typeof e!=="string"||e.length===0)return false;const i=t.splitLines(e);for(let e=0;e<i.length;e++)if(i[e].length<2||i[e].charAt(1)!=="=")return false;return true};e.exports=t})(cr);return cr.exports}var ur=lr();var hr=Wi(ur);var pr=e({__proto__:null,default:hr},[ur]);function mr(e){if(!e.RTCIceCandidate||e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)return;const t=e.RTCIceCandidate;e.RTCIceCandidate=function(e){if(typeof e==="object"&&e.candidate&&e.candidate.indexOf("a=")===0){e=JSON.parse(JSON.stringify(e));e.candidate=e.candidate.substring(2)}if(e.candidate&&e.candidate.length){const i=new t(e);const n=hr.parseCandidate(e.candidate);for(const e in n)e in i||Object.defineProperty(i,e,{value:n[e]});i.toJSON=function(){return{candidate:i.candidate,sdpMid:i.sdpMid,sdpMLineIndex:i.sdpMLineIndex,usernameFragment:i.usernameFragment}};return i}return new t(e)};e.RTCIceCandidate.prototype=t.prototype;kn(e,"icecandidate",(t=>{t.candidate&&Object.defineProperty(t,"candidate",{value:new e.RTCIceCandidate(t.candidate),writable:"false"});return t}))}function gr(e){!e.RTCIceCandidate||e.RTCIceCandidate&&"relayProtocol"in e.RTCIceCandidate.prototype||kn(e,"icecandidate",(e=>{if(e.candidate){const t=hr.parseCandidate(e.candidate.candidate);t.type==="relay"&&(e.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[t.priority>>24])}return e}))}function fr(e,t){if(!e.RTCPeerConnection)return;"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get(){return typeof this._sctp==="undefined"?null:this._sctp}});const i=function(e){if(!e||!e.sdp)return false;const t=hr.splitSections(e.sdp);t.shift();return t.some((e=>{const t=hr.parseMLine(e);return t&&t.kind==="application"&&t.protocol.indexOf("SCTP")!==-1}))};const n=function(e){const t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(t===null||t.length<2)return-1;const i=parseInt(t[1],10);return i!==i?-1:i};const r=function(e){let i=65536;t.browser==="firefox"&&(i=t.version<57?e===-1?16384:2147483637:t.version<60?t.version===57?65535:65536:2147483637);return i};const s=function(e,i){let n=65536;t.browser==="firefox"&&t.version===57&&(n=65535);const r=hr.matchPrefix(e.sdp,"a=max-message-size:");r.length>0?n=parseInt(r[0].substring(19),10):t.browser==="firefox"&&i!==-1&&(n=2147483637);return n};const o=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){this._sctp=null;if(t.browser==="chrome"&&t.version>=76){const{sdpSemantics:e}=this.getConfiguration();e==="plan-b"&&Object.defineProperty(this,"sctp",{get(){return typeof this._sctp==="undefined"?null:this._sctp},enumerable:true,configurable:true})}if(i(arguments[0])){const e=n(arguments[0]);const t=r(e);const i=s(arguments[0],e);let o;o=t===0&&i===0?Number.POSITIVE_INFINITY:t===0||i===0?Math.max(t,i):Math.min(t,i);const a={};Object.defineProperty(a,"maxMessageSize",{get(){return o}});this._sctp=a}return o.apply(this,arguments)}}function vr(e){if(!(e.RTCPeerConnection&&"createDataChannel"in e.RTCPeerConnection.prototype))return;function t(e,t){const i=e.send;e.send=function(){const n=arguments[0];const r=n.length||n.size||n.byteLength;if(e.readyState==="open"&&t.sctp&&r>t.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+t.sctp.maxMessageSize+" bytes)");return i.apply(e,arguments)}}const i=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){const e=i.apply(this,arguments);t(e,this);return e};kn(e,"datachannel",(e=>{t(e.channel,e.target);return e}))}function kr(e){if(!e.RTCPeerConnection||"connectionState"in e.RTCPeerConnection.prototype)return;const t=e.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:true,configurable:true});Object.defineProperty(t,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(e){if(this._onconnectionstatechange){this.removeEventListener("connectionstatechange",this._onconnectionstatechange);delete this._onconnectionstatechange}e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e)},enumerable:true,configurable:true});["setLocalDescription","setRemoteDescription"].forEach((e=>{const i=t[e];t[e]=function(){if(!this._connectionstatechangepoly){this._connectionstatechangepoly=e=>{const t=e.target;if(t._lastConnectionState!==t.connectionState){t._lastConnectionState=t.connectionState;const i=new Event("connectionstatechange",e);t.dispatchEvent(i)}return e};this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)}return i.apply(this,arguments)}}))}function br(e,t){if(!e.RTCPeerConnection)return;if(t.browser==="chrome"&&t.version>=71)return;if(t.browser==="safari"&&t._safariVersion>=13.1)return;const i=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(t){if(t&&t.sdp&&t.sdp.indexOf("\na=extmap-allow-mixed")!==-1){const i=t.sdp.split("\n").filter((e=>e.trim()!=="a=extmap-allow-mixed")).join("\n");e.RTCSessionDescription&&t instanceof e.RTCSessionDescription?arguments[0]=new e.RTCSessionDescription({type:t.type,sdp:i}):t.sdp=i}return i.apply(this,arguments)}}function yr(e,t){if(!(e.RTCPeerConnection&&e.RTCPeerConnection.prototype))return;const i=e.RTCPeerConnection.prototype.addIceCandidate;i&&i.length!==0&&(e.RTCPeerConnection.prototype.addIceCandidate=function(){if(!arguments[0]){arguments[1]&&arguments[1].apply(null);return Promise.resolve()}return(t.browser==="chrome"&&t.version<78||t.browser==="firefox"&&t.version<68||t.browser==="safari")&&arguments[0]&&arguments[0].candidate===""?Promise.resolve():i.apply(this,arguments)})}function Tr(e,t){if(!(e.RTCPeerConnection&&e.RTCPeerConnection.prototype))return;const i=e.RTCPeerConnection.prototype.setLocalDescription;i&&i.length!==0&&(e.RTCPeerConnection.prototype.setLocalDescription=function(){let e=arguments[0]||{};if(typeof e!=="object"||e.type&&e.sdp)return i.apply(this,arguments);e={type:e.type,sdp:e.sdp};if(!e.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":e.type="offer";break;default:e.type="answer";break}if(e.sdp||e.type!=="offer"&&e.type!=="answer")return i.apply(this,[e]);const t=e.type==="offer"?this.createOffer:this.createAnswer;return t.apply(this).then((e=>i.apply(this,[e])))})}var Cr=Object.freeze({__proto__:null,removeExtmapAllowMixed:br,shimAddIceCandidateNullOrEmpty:yr,shimConnectionState:kr,shimMaxMessageSize:fr,shimParameterlessSetLocalDescription:Tr,shimRTCIceCandidate:mr,shimRTCIceCandidateRelayProtocol:gr,shimSendThrowTypeError:vr});function Sr(){let{window:e}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{shimChrome:true,shimFirefox:true,shimSafari:true};const i=Tn;const n=Sn(e);const r={browserDetails:n,commonShim:Cr,extractVersion:vn,disableLog:bn,disableWarnings:yn,sdp:pr};switch(n.browser){case"chrome":if(!jn||!Ln||!t.shimChrome){i("Chrome shim is not included in this adapter release.");return r}if(n.version===null){i("Chrome shim can not determine version, not shimming.");return r}i("adapter.js shimming chrome.");r.browserShim=jn;yr(e,n);Tr(e);On(e,n);Dn(e);Ln(e,n);xn(e);Nn(e,n);Mn(e);An(e);Un(e,n);mr(e);gr(e);kr(e);fr(e,n);vr(e);br(e,n);break;case"firefox":if(!Xn||!qn||!t.shimFirefox){i("Firefox shim is not included in this adapter release.");return r}i("adapter.js shimming firefox.");r.browserShim=Xn;yr(e,n);Tr(e);Fn(e,n);qn(e,n);Vn(e);Kn(e);Hn(e);Wn(e);Gn(e);zn(e);Jn(e);Qn(e);Yn(e);mr(e);kr(e);fr(e,n);vr(e);break;case"safari":if(!ar||!t.shimSafari){i("Safari shim is not included in this adapter release.");return r}i("adapter.js shimming safari.");r.browserShim=ar;yr(e,n);Tr(e);nr(e);sr(e);er(e);Zn(e);$n(e);rr(e);tr(e);or(e);mr(e);gr(e);fr(e,n);vr(e);br(e,n);break;default:i("Unsupported browser!");break}return r}Sr({window:typeof window==="undefined"?void 0:window});const wr="AES-GCM";const Er=10;const Pr="lk_e2ee";const Rr="LKFrameEncryptionKey";const Ir={sharedKey:false,ratchetSalt:Rr,ratchetWindowSize:8,failureTolerance:Er,keyringSize:16};var Or;(function(e){e.SetKey="setKey";e.RatchetRequest="ratchetRequest";e.KeyRatcheted="keyRatcheted"})(Or||(Or={}));var Dr;(function(e){e.KeyRatcheted="keyRatcheted"})(Dr||(Dr={}));var xr;(function(e){e.ParticipantEncryptionStatusChanged="participantEncryptionStatusChanged";e.EncryptionError="encryptionError"})(xr||(xr={}));var Mr;(function(e){e.Error="cryptorError"})(Mr||(Mr={}));function Ar(){return Nr()||_r()}function _r(){return typeof window.RTCRtpScriptTransform!=="undefined"}function Nr(){return typeof window.RTCRtpSender!=="undefined"&&typeof window.RTCRtpSender.prototype.createEncodedStreams!=="undefined"}function Lr(e){return"type"in e}function Ur(e){return cn(this,arguments,void 0,(function(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{name:wr};let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"encrypt";return function*(){return crypto.subtle.importKey("raw",e,t,false,i==="derive"?["deriveBits","deriveKey"]:["encrypt","decrypt"])}()}))}function jr(e){return cn(this,void 0,void 0,(function*(){let t=new TextEncoder;const i=yield crypto.subtle.importKey("raw",t.encode(e),{name:"PBKDF2"},false,["deriveBits","deriveKey"]);return i}))}function Fr(e){return cn(this,void 0,void 0,(function*(){const t=yield crypto.subtle.importKey("raw",e,"HKDF",false,["deriveBits","deriveKey"]);return t}))}function Br(e,t){const i=new TextEncoder;const n=i.encode(t);switch(e){case"HKDF":return{name:"HKDF",salt:n,hash:"SHA-256",info:new ArrayBuffer(128)};case"PBKDF2":return{name:"PBKDF2",salt:n,hash:"SHA-256",iterations:1e5};default:throw new Error("algorithm ".concat(e," is currently unsupported"))}}function Vr(e,t){return cn(this,void 0,void 0,(function*(){const i=Br(e.algorithm.name,t);const n=yield crypto.subtle.deriveKey(i,e,{name:wr,length:128},false,["encrypt","decrypt"]);return{material:e,encryptionKey:n}}))}function qr(){return window.crypto.getRandomValues(new Uint8Array(32))}function Hr(e,t){return cn(this,void 0,void 0,(function*(){const i=Br(e.algorithm.name,t);return crypto.subtle.deriveBits(i,e,256)}))}function Wr(e){for(var t=0;t<e.length-3;t++)if(e[t]==0&&e[t+1]==0&&e[t+2]==3)return true;return false}function Kr(e){const t=[];var i=e.length;for(var n=0;n<e.length;)if(i-n>=3&&!e[n]&&!e[n+1]&&e[n+2]==3){t.push(e[n++]);t.push(e[n++]);n++}else t.push(e[n++]);return new Uint8Array(t)}const Gr=2;const zr=3;function Jr(e){const t=[];var i=0;for(var n=0;n<e.length;++n){var r=e[n];if(r<=zr&&i>=Gr){t.push(zr);i=0}t.push(r);r==0?++i:i=0}return new Uint8Array(t)}class BaseKeyProvider extends mn.EventEmitter{constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};super();
/**
     * Callback being invoked after a key has been ratcheted.
     * Can happen when:
     * - A decryption failure occurs and the key is auto-ratcheted
     * - A ratchet request is sent (see {@link ratchetKey()})
     * @param ratchetResult Contains the ratcheted chain key (exportable to other participants) and the derived new key material.
     * @param participantId
     * @param keyIndex
     */this.onKeyRatcheted=(e,t,i)=>{Zi.debug("key ratcheted event received",{ratchetResult:e,participantId:t,keyIndex:i})};this.keyInfoMap=new Map;this.options=Object.assign(Object.assign({},Ir),e);this.on(Or.KeyRatcheted,this.onKeyRatcheted)}
/**
   * callback to invoke once a key has been set for a participant
   * @param key
   * @param participantIdentity
   * @param keyIndex
   */onSetEncryptionKey(e,t,i){const n={key:e,participantIdentity:t,keyIndex:i};if(!this.options.sharedKey&&!t)throw new Error("participant identity needs to be passed for encryption key if sharedKey option is false");this.keyInfoMap.set("".concat(t!==null&&t!==void 0?t:"shared","-").concat(i!==null&&i!==void 0?i:0),n);this.emit(Or.SetKey,n)}getKeys(){return Array.from(this.keyInfoMap.values())}getOptions(){return this.options}ratchetKey(e,t){this.emit(Or.RatchetRequest,e,t)}}class ExternalE2EEKeyProvider extends BaseKeyProvider{constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const t=Object.assign(Object.assign({},e),{sharedKey:true,ratchetWindowSize:0,failureTolerance:-1});super(t)}
/**
   * Accepts a passphrase that's used to create the crypto keys.
   * When passing in a string, PBKDF2 is used.
   * When passing in an Array buffer of cryptographically random numbers, HKDF is being used. (recommended)
   * @param key
   */setKey(e){return cn(this,void 0,void 0,(function*(){const t=typeof e==="string"?yield jr(e):yield Fr(e);this.onSetEncryptionKey(t)}))}}class LivekitError extends Error{constructor(e,t){super(t||"an error has occured");this.name="LiveKitError";this.code=e}}var Qr;(function(e){e[e.NotAllowed=0]="NotAllowed";e[e.ServerUnreachable=1]="ServerUnreachable";e[e.InternalError=2]="InternalError";e[e.Cancelled=3]="Cancelled";e[e.LeaveRequest=4]="LeaveRequest";e[e.Timeout=5]="Timeout"})(Qr||(Qr={}));class ConnectionError extends LivekitError{constructor(e,t,i,n){super(1,e);this.name="ConnectionError";this.status=i;this.reason=t;this.context=n;this.reasonName=Qr[t]}}class DeviceUnsupportedError extends LivekitError{constructor(e){super(21,e!==null&&e!==void 0?e:"device is unsupported");this.name="DeviceUnsupportedError"}}class TrackInvalidError extends LivekitError{constructor(e){super(20,e!==null&&e!==void 0?e:"track is invalid");this.name="TrackInvalidError"}}class UnsupportedServer extends LivekitError{constructor(e){super(10,e!==null&&e!==void 0?e:"unsupported server");this.name="UnsupportedServer"}}class UnexpectedConnectionState extends LivekitError{constructor(e){super(12,e!==null&&e!==void 0?e:"unexpected connection state");this.name="UnexpectedConnectionState"}}class NegotiationError extends LivekitError{constructor(e){super(13,e!==null&&e!==void 0?e:"unable to negotiate");this.name="NegotiationError"}}class PublishDataError extends LivekitError{constructor(e){super(14,e!==null&&e!==void 0?e:"unable to publish data");this.name="PublishDataError"}}class PublishTrackError extends LivekitError{constructor(e,t){super(15,e);this.name="PublishTrackError";this.status=t}}class SignalRequestError extends LivekitError{constructor(e,t){super(15,e);this.reason=t;this.reasonName=typeof t==="string"?t:qi[t]}}var Yr;(function(e){e[e.AlreadyOpened=0]="AlreadyOpened";e[e.AbnormalEnd=1]="AbnormalEnd";e[e.DecodeFailed=2]="DecodeFailed";e[e.LengthExceeded=3]="LengthExceeded";e[e.Incomplete=4]="Incomplete";e[e.HandlerAlreadyRegistered=7]="HandlerAlreadyRegistered"})(Yr||(Yr={}));class DataStreamError extends LivekitError{constructor(e,t){super(16,e);this.name="DataStreamError";this.reason=t;this.reasonName=Yr[t]}}var Xr;(function(e){e.PermissionDenied="PermissionDenied";e.NotFound="NotFound";e.DeviceInUse="DeviceInUse";e.Other="Other"})(Xr||(Xr={}));(function(e){function t(t){if(t&&"name"in t)return t.name==="NotFoundError"||t.name==="DevicesNotFoundError"?e.NotFound:t.name==="NotAllowedError"||t.name==="PermissionDeniedError"?e.PermissionDenied:t.name==="NotReadableError"||t.name==="TrackStartError"?e.DeviceInUse:e.Other}e.getFailure=t})(Xr||(Xr={}));var Zr;(function(e){e[e.InvalidKey=0]="InvalidKey";e[e.MissingKey=1]="MissingKey";e[e.InternalError=2]="InternalError"})(Zr||(Zr={}));class CryptorError extends LivekitError{constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Zr.InternalError;let i=arguments.length>2?arguments[2]:void 0;super(40,e);this.reason=t;this.participantIdentity=i}}var $r;(function(e){e.Connected="connected";e.Reconnecting="reconnecting";e.SignalReconnecting="signalReconnecting";e.Reconnected="reconnected";e.Disconnected="disconnected";e.ConnectionStateChanged="connectionStateChanged";e.Moved="moved";e.MediaDevicesChanged="mediaDevicesChanged";e.ParticipantConnected="participantConnected";e.ParticipantDisconnected="participantDisconnected";e.TrackPublished="trackPublished";e.TrackSubscribed="trackSubscribed";e.TrackSubscriptionFailed="trackSubscriptionFailed";e.TrackUnpublished="trackUnpublished";e.TrackUnsubscribed="trackUnsubscribed";e.TrackMuted="trackMuted";e.TrackUnmuted="trackUnmuted";e.LocalTrackPublished="localTrackPublished";e.LocalTrackUnpublished="localTrackUnpublished";e.LocalAudioSilenceDetected="localAudioSilenceDetected";e.ActiveSpeakersChanged="activeSpeakersChanged";e.ParticipantMetadataChanged="participantMetadataChanged";e.ParticipantNameChanged="participantNameChanged";e.ParticipantAttributesChanged="participantAttributesChanged";e.ParticipantActive="participantActive";e.RoomMetadataChanged="roomMetadataChanged";e.DataReceived="dataReceived";e.SipDTMFReceived="sipDTMFReceived";e.TranscriptionReceived="transcriptionReceived";e.ConnectionQualityChanged="connectionQualityChanged";e.TrackStreamStateChanged="trackStreamStateChanged";e.TrackSubscriptionPermissionChanged="trackSubscriptionPermissionChanged";e.TrackSubscriptionStatusChanged="trackSubscriptionStatusChanged";e.AudioPlaybackStatusChanged="audioPlaybackChanged";e.VideoPlaybackStatusChanged="videoPlaybackChanged";e.MediaDevicesError="mediaDevicesError";e.ParticipantPermissionsChanged="participantPermissionsChanged";e.SignalConnected="signalConnected";e.RecordingStatusChanged="recordingStatusChanged";e.ParticipantEncryptionStatusChanged="participantEncryptionStatusChanged";e.EncryptionError="encryptionError";e.DCBufferStatusChanged="dcBufferStatusChanged";e.ActiveDeviceChanged="activeDeviceChanged";e.ChatMessage="chatMessage";e.LocalTrackSubscribed="localTrackSubscribed";e.MetricsReceived="metricsReceived"})($r||($r={}));var es;(function(e){e.TrackPublished="trackPublished";e.TrackSubscribed="trackSubscribed";e.TrackSubscriptionFailed="trackSubscriptionFailed";e.TrackUnpublished="trackUnpublished";e.TrackUnsubscribed="trackUnsubscribed";e.TrackMuted="trackMuted";e.TrackUnmuted="trackUnmuted";e.LocalTrackPublished="localTrackPublished";e.LocalTrackUnpublished="localTrackUnpublished";e.LocalTrackCpuConstrained="localTrackCpuConstrained";e.LocalSenderCreated="localSenderCreated";e.ParticipantMetadataChanged="participantMetadataChanged";e.ParticipantNameChanged="participantNameChanged";e.DataReceived="dataReceived";e.SipDTMFReceived="sipDTMFReceived";e.TranscriptionReceived="transcriptionReceived";e.IsSpeakingChanged="isSpeakingChanged";e.ConnectionQualityChanged="connectionQualityChanged";e.TrackStreamStateChanged="trackStreamStateChanged";e.TrackSubscriptionPermissionChanged="trackSubscriptionPermissionChanged";e.TrackSubscriptionStatusChanged="trackSubscriptionStatusChanged";e.TrackCpuConstrained="trackCpuConstrained";e.MediaDevicesError="mediaDevicesError";e.AudioStreamAcquired="audioStreamAcquired";e.ParticipantPermissionsChanged="participantPermissionsChanged";e.PCTrackAdded="pcTrackAdded";e.AttributesChanged="attributesChanged";e.LocalTrackSubscribed="localTrackSubscribed";e.ChatMessage="chatMessage";e.Active="active"})(es||(es={}));var ts;(function(e){e.TransportsCreated="transportsCreated";e.Connected="connected";e.Disconnected="disconnected";e.Resuming="resuming";e.Resumed="resumed";e.Restarting="restarting";e.Restarted="restarted";e.SignalResumed="signalResumed";e.SignalRestarted="signalRestarted";e.Closing="closing";e.MediaTrackAdded="mediaTrackAdded";e.ActiveSpeakersUpdate="activeSpeakersUpdate";e.DataPacketReceived="dataPacketReceived";e.RTPVideoMapUpdate="rtpVideoMapUpdate";e.DCBufferStatusChanged="dcBufferStatusChanged";e.ParticipantUpdate="participantUpdate";e.RoomUpdate="roomUpdate";e.SpeakersChanged="speakersChanged";e.StreamStateChanged="streamStateChanged";e.ConnectionQualityUpdate="connectionQualityUpdate";e.SubscriptionError="subscriptionError";e.SubscriptionPermissionUpdate="subscriptionPermissionUpdate";e.RemoteMute="remoteMute";e.SubscribedQualityUpdate="subscribedQualityUpdate";e.LocalTrackUnpublished="localTrackUnpublished";e.LocalTrackSubscribed="localTrackSubscribed";e.Offline="offline";e.SignalRequestResponse="signalRequestResponse";e.SignalConnected="signalConnected";e.RoomMoved="roomMoved"})(ts||(ts={}));var is;(function(e){e.Message="message";e.Muted="muted";e.Unmuted="unmuted";e.Restarted="restarted";e.Ended="ended";e.Subscribed="subscribed";e.Unsubscribed="unsubscribed";e.CpuConstrained="cpuConstrained";e.UpdateSettings="updateSettings";e.UpdateSubscription="updateSubscription";e.AudioPlaybackStarted="audioPlaybackStarted";e.AudioPlaybackFailed="audioPlaybackFailed";e.AudioSilenceDetected="audioSilenceDetected";e.VisibilityChanged="visibilityChanged";e.VideoDimensionsChanged="videoDimensionsChanged";e.VideoPlaybackStarted="videoPlaybackStarted";e.VideoPlaybackFailed="videoPlaybackFailed";e.ElementAttached="elementAttached";e.ElementDetached="elementDetached";e.UpstreamPaused="upstreamPaused";e.UpstreamResumed="upstreamResumed";e.SubscriptionPermissionChanged="subscriptionPermissionChanged";e.SubscriptionStatusChanged="subscriptionStatusChanged";e.SubscriptionFailed="subscriptionFailed";e.TrackProcessorUpdate="trackProcessorUpdate";e.AudioTrackFeatureUpdate="audioTrackFeatureUpdate";e.TranscriptionReceived="transcriptionReceived";e.TimeSyncUpdate="timeSyncUpdate";e.PreConnectBufferFlushed="preConnectBufferFlushed"})(is||(is={}));function ns(e){return typeof e==="undefined"?e:typeof structuredClone==="function"?typeof e==="object"&&e!==null?structuredClone(Object.assign({},e)):structuredClone(e):JSON.parse(JSON.stringify(e))}const rs=/version\/(\d+(\.?_?\d+)+)/i;let ss;function os(e){let t=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(typeof e==="undefined"&&typeof navigator==="undefined")return;const i=(e!==null&&e!==void 0?e:navigator.userAgent).toLowerCase();if(ss===void 0||t){const e=as.find((e=>{let{test:t}=e;return t.test(i)}));ss=e===null||e===void 0?void 0:e.describe(i)}return ss}const as=[{test:/firefox|iceweasel|fxios/i,describe(e){const t={name:"Firefox",version:cs(/(?:firefox|iceweasel|fxios)[\s/](\d+(\.?_?\d+)+)/i,e),os:e.toLowerCase().includes("fxios")?"iOS":void 0,osVersion:ds(e)};return t}},{test:/chrom|crios|crmo/i,describe(e){const t={name:"Chrome",version:cs(/(?:chrome|chromium|crios|crmo)\/(\d+(\.?_?\d+)+)/i,e),os:e.toLowerCase().includes("crios")?"iOS":void 0,osVersion:ds(e)};return t}},{test:/safari|applewebkit/i,describe(e){const t={name:"Safari",version:cs(rs,e),os:e.includes("mobile/")?"iOS":"macOS",osVersion:ds(e)};return t}}];function cs(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1;const n=t.match(e);return n&&n.length>=i&&n[i]||""}function ds(e){return e.includes("mac os")?cs(/\(.+?(\d+_\d+(:?_\d+)?)/,e,1).replace(/_/g,"."):void 0}var ls="2.15.6";const us=ls;const hs=16;class CriticalTimers{}CriticalTimers.setTimeout=function(){return setTimeout(...arguments)};CriticalTimers.setInterval=function(){return setInterval(...arguments)};CriticalTimers.clearTimeout=function(){return clearTimeout(...arguments)};CriticalTimers.clearInterval=function(){return clearInterval(...arguments)};const ps=5e3;const ms=[];var gs;(function(e){e[e.LOW=0]="LOW";e[e.MEDIUM=1]="MEDIUM";e[e.HIGH=2]="HIGH"})(gs||(gs={}));class Track extends mn.EventEmitter{get streamState(){return this._streamState}setStreamState(e){this._streamState=e}constructor(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};var n;super();this.attachedElements=[];this.isMuted=false;this._streamState=Track.StreamState.Active;this.isInBackground=false;this._currentBitrate=0;this.log=Zi;this.appVisibilityChangedListener=()=>{this.backgroundTimeout&&clearTimeout(this.backgroundTimeout);document.visibilityState==="hidden"?this.backgroundTimeout=setTimeout((()=>this.handleAppVisibilityChanged()),ps):this.handleAppVisibilityChanged()};this.log=en((n=i.loggerName)!==null&&n!==void 0?n:Xi.Track);this.loggerContextCb=i.loggerContextCb;this.setMaxListeners(100);this.kind=t;this._mediaStreamTrack=e;this._mediaStreamID=e.id;this.source=Track.Source.Unknown}get logContext(){var e;return Object.assign(Object.assign({},(e=this.loggerContextCb)===null||e===void 0?void 0:e.call(this)),Ho(this))}get currentBitrate(){return this._currentBitrate}get mediaStreamTrack(){return this._mediaStreamTrack}get mediaStreamID(){return this._mediaStreamID}attach(e){let t="audio";this.kind===Track.Kind.Video&&(t="video");this.attachedElements.length===0&&this.kind===Track.Kind.Video&&this.addAppVisibilityListener();if(!e){if(t==="audio"){ms.forEach((t=>{t.parentElement!==null||e||(e=t)}));e&&ms.splice(ms.indexOf(e),1)}e||(e=document.createElement(t))}this.attachedElements.includes(e)||this.attachedElements.push(e);fs(this.mediaStreamTrack,e);const i=e.srcObject.getTracks();const n=i.some((e=>e.kind==="audio"));e.play().then((()=>{this.emit(n?is.AudioPlaybackStarted:is.VideoPlaybackStarted)})).catch((t=>{t.name==="NotAllowedError"?this.emit(n?is.AudioPlaybackFailed:is.VideoPlaybackFailed,t):t.name==="AbortError"?Zi.debug("".concat(n?"audio":"video"," playback aborted, likely due to new play request")):Zi.warn("could not playback ".concat(n?"audio":"video"),t);if(n&&e&&i.some((e=>e.kind==="video"))&&t.name==="NotAllowedError"){e.muted=true;e.play().catch((()=>{}))}}));this.emit(is.ElementAttached,e);return e}detach(e){try{if(e){vs(this.mediaStreamTrack,e);const t=this.attachedElements.indexOf(e);if(t>=0){this.attachedElements.splice(t,1);this.recycleElement(e);this.emit(is.ElementDetached,e)}return e}const t=[];this.attachedElements.forEach((e=>{vs(this.mediaStreamTrack,e);t.push(e);this.recycleElement(e);this.emit(is.ElementDetached,e)}));this.attachedElements=[];return t}finally{this.attachedElements.length===0&&this.removeAppVisibilityListener()}}stop(){this.stopMonitor();this._mediaStreamTrack.stop()}enable(){this._mediaStreamTrack.enabled=true}disable(){this._mediaStreamTrack.enabled=false}stopMonitor(){this.monitorInterval&&clearInterval(this.monitorInterval);this.timeSyncHandle&&cancelAnimationFrame(this.timeSyncHandle)}updateLoggerOptions(e){e.loggerName&&(this.log=en(e.loggerName));e.loggerContextCb&&(this.loggerContextCb=e.loggerContextCb)}recycleElement(e){if(e instanceof HTMLAudioElement){let t=true;e.pause();ms.forEach((e=>{e.parentElement||(t=false)}));t&&ms.push(e)}}handleAppVisibilityChanged(){return cn(this,void 0,void 0,(function*(){this.isInBackground=document.visibilityState==="hidden";this.isInBackground||this.kind!==Track.Kind.Video||setTimeout((()=>this.attachedElements.forEach((e=>e.play().catch((()=>{}))))),0)}))}addAppVisibilityListener(){if(Gs()){this.isInBackground=document.visibilityState==="hidden";document.addEventListener("visibilitychange",this.appVisibilityChangedListener)}else this.isInBackground=false}removeAppVisibilityListener(){Gs()&&document.removeEventListener("visibilitychange",this.appVisibilityChangedListener)}}function fs(e,t){let i;i=t.srcObject instanceof MediaStream?t.srcObject:new MediaStream;let n;n=e.kind==="audio"?i.getAudioTracks():i.getVideoTracks();if(!n.includes(e)){n.forEach((e=>{i.removeTrack(e)}));i.addTrack(e)}Bs()&&t instanceof HTMLVideoElement||(t.autoplay=true);t.muted=i.getAudioTracks().length===0;t instanceof HTMLVideoElement&&(t.playsInline=true);if(t.srcObject!==i){t.srcObject=i;(Bs()||Fs())&&t instanceof HTMLVideoElement&&setTimeout((()=>{t.srcObject=i;t.play().catch((()=>{}))}),0)}}function vs(e,t){if(t.srcObject instanceof MediaStream){const i=t.srcObject;i.removeTrack(e);i.getTracks().length>0?t.srcObject=i:t.srcObject=null}}(function(e){let t;(function(e){e.Audio="audio";e.Video="video";e.Unknown="unknown"})(t=e.Kind||(e.Kind={}));let i;(function(e){e.Camera="camera";e.Microphone="microphone";e.ScreenShare="screen_share";e.ScreenShareAudio="screen_share_audio";e.Unknown="unknown"})(i=e.Source||(e.Source={}));let n;(function(e){e.Active="active";e.Paused="paused";e.Unknown="unknown"})(n=e.StreamState||(e.StreamState={}));function r(e){switch(e){case t.Audio:return tt.AUDIO;case t.Video:return tt.VIDEO;default:return tt.DATA}}e.kindToProto=r;function s(e){switch(e){case tt.AUDIO:return t.Audio;case tt.VIDEO:return t.Video;default:return t.Unknown}}e.kindFromProto=s;function o(e){switch(e){case i.Camera:return it.CAMERA;case i.Microphone:return it.MICROPHONE;case i.ScreenShare:return it.SCREEN_SHARE;case i.ScreenShareAudio:return it.SCREEN_SHARE_AUDIO;default:return it.UNKNOWN}}e.sourceToProto=o;function a(e){switch(e){case it.CAMERA:return i.Camera;case it.MICROPHONE:return i.Microphone;case it.SCREEN_SHARE:return i.ScreenShare;case it.SCREEN_SHARE_AUDIO:return i.ScreenShareAudio;default:return i.Unknown}}e.sourceFromProto=a;function c(e){switch(e){case Yt.ACTIVE:return n.Active;case Yt.PAUSED:return n.Paused;default:return n.Unknown}}e.streamStateFromProto=c})(Track||(Track={}));class VideoPreset{constructor(e,t,i,n,r){if(typeof e==="object"){this.width=e.width;this.height=e.height;this.aspectRatio=e.aspectRatio;this.encoding={maxBitrate:e.maxBitrate,maxFramerate:e.maxFramerate,priority:e.priority}}else{if(t===void 0||i===void 0)throw new TypeError("Unsupported options: provide at least width, height and maxBitrate");this.width=e;this.height=t;this.aspectRatio=e/t;this.encoding={maxBitrate:i,maxFramerate:n,priority:r}}}get resolution(){return{width:this.width,height:this.height,frameRate:this.encoding.maxFramerate,aspectRatio:this.aspectRatio}}}const ks=["vp8","h264"];const bs=["vp8","h264","vp9","av1","h265"];function ys(e){return!!ks.find((t=>t===e))}var Ts;(function(e){e[e.PREFER_REGRESSION=0]="PREFER_REGRESSION";e[e.SIMULCAST=1]="SIMULCAST";e[e.REGRESSION=2]="REGRESSION"})(Ts||(Ts={}));var Cs;(function(e){e.telephone={maxBitrate:12e3};e.speech={maxBitrate:24e3};e.music={maxBitrate:48e3};e.musicStereo={maxBitrate:64e3};e.musicHighQuality={maxBitrate:96e3};e.musicHighQualityStereo={maxBitrate:128e3}})(Cs||(Cs={}));const Ss={h90:new VideoPreset(160,90,9e4,20),h180:new VideoPreset(320,180,16e4,20),h216:new VideoPreset(384,216,18e4,20),h360:new VideoPreset(640,360,45e4,20),h540:new VideoPreset(960,540,8e5,25),h720:new VideoPreset(1280,720,17e5,30),h1080:new VideoPreset(1920,1080,3e6,30),h1440:new VideoPreset(2560,1440,5e6,30),h2160:new VideoPreset(3840,2160,8e6,30)};const ws={h120:new VideoPreset(160,120,7e4,20),h180:new VideoPreset(240,180,125e3,20),h240:new VideoPreset(320,240,14e4,20),h360:new VideoPreset(480,360,33e4,20),h480:new VideoPreset(640,480,5e5,20),h540:new VideoPreset(720,540,6e5,25),h720:new VideoPreset(960,720,13e5,30),h1080:new VideoPreset(1440,1080,23e5,30),h1440:new VideoPreset(1920,1440,38e5,30)};const Es={h360fps3:new VideoPreset(640,360,2e5,3,"medium"),h360fps15:new VideoPreset(640,360,4e5,15,"medium"),h720fps5:new VideoPreset(1280,720,8e5,5,"medium"),h720fps15:new VideoPreset(1280,720,15e5,15,"medium"),h720fps30:new VideoPreset(1280,720,2e6,30,"medium"),h1080fps15:new VideoPreset(1920,1080,25e5,15,"medium"),h1080fps30:new VideoPreset(1920,1080,5e6,30,"medium"),original:new VideoPreset(0,0,7e6,30,"medium")};const Ps="|";const Rs="https://aomediacodec.github.io/av1-rtp-spec/#dependency-descriptor-rtp-header-extension";function Is(e){const t=e.split(Ps);return t.length>1?[t[0],e.substr(t[0].length+1)]:[e,""]}function Os(e){return cn(this,void 0,void 0,(function*(){return new Promise((t=>CriticalTimers.setTimeout(t,e)))}))}function Ds(){return"addTransceiver"in RTCPeerConnection.prototype}function xs(){return"addTrack"in RTCPeerConnection.prototype}function Ms(){return typeof ResizeObserver!==void 0&&typeof IntersectionObserver!==void 0}function As(){return Ds()}function _s(){if(!("getCapabilities"in RTCRtpSender))return false;if(Bs()||Fs())return false;const e=RTCRtpSender.getCapabilities("video");let t=false;if(e)for(const i of e.codecs)if(i.mimeType==="video/AV1"){t=true;break}return t}function Ns(){if(!("getCapabilities"in RTCRtpSender))return false;if(Fs())return false;if(Bs()){const e=os();if((e===null||e===void 0?void 0:e.version)&&Zs(e.version,"16")<0)return false;if((e===null||e===void 0?void 0:e.os)==="iOS"&&(e===null||e===void 0?void 0:e.osVersion)&&Zs(e.osVersion,"16")<0)return false}const e=RTCRtpSender.getCapabilities("video");let t=false;if(e)for(const i of e.codecs)if(i.mimeType==="video/VP9"){t=true;break}return t}function Ls(e){return e==="av1"||e==="vp9"}function Us(e){if(!document||Vs())return false;e||(e=document.createElement("audio"));return"setSinkId"in e}function js(){return typeof RTCPeerConnection!=="undefined"&&(Ds()||xs())}function Fs(){var e;return((e=os())===null||e===void 0?void 0:e.name)==="Firefox"}function Bs(){var e;return((e=os())===null||e===void 0?void 0:e.name)==="Safari"}function Vs(){const e=os();return(e===null||e===void 0?void 0:e.name)==="Safari"||(e===null||e===void 0?void 0:e.os)==="iOS"}function qs(){const e=os();return(e===null||e===void 0?void 0:e.name)==="Safari"&&e.version.startsWith("17.")||(e===null||e===void 0?void 0:e.os)==="iOS"&&!!(e===null||e===void 0?void 0:e.osVersion)&&Zs(e.osVersion,"17")>=0}function Hs(e){e||(e=os());return(e===null||e===void 0?void 0:e.name)==="Safari"&&Zs(e.version,"18.3")>0||(e===null||e===void 0?void 0:e.os)==="iOS"&&!!(e===null||e===void 0?void 0:e.osVersion)&&Zs(e.osVersion,"18.3")>0}function Ws(){var e,t;return!!Gs()&&((t=(e=navigator.userAgentData)===null||e===void 0?void 0:e.mobile)!==null&&t!==void 0?t:/Tablet|iPad|Mobile|Android|BlackBerry/.test(navigator.userAgent))}function Ks(){const e=os();const t="17.2";if(e)return e.name!=="Safari"&&e.os!=="iOS"||(!!(e.os==="iOS"&&e.osVersion&&Zs(e.osVersion,t)>=0)||e.name==="Safari"&&Zs(e.version,t)>=0)}function Gs(){return typeof document!=="undefined"}function zs(){return navigator.product=="ReactNative"}function Js(e){return e.hostname.endsWith(".livekit.cloud")||e.hostname.endsWith(".livekit.run")}function Qs(){if(global&&global.LiveKitReactNativeGlobal)return global.LiveKitReactNativeGlobal}function Ys(){if(!zs())return;let e=Qs();return e?e.platform:void 0}function Xs(){if(Gs())return window.devicePixelRatio;if(zs()){let e=Qs();if(e)return e.devicePixelRatio}return 1}
/**
 * @param v1 - The first version string to compare.
 * @param v2 - The second version string to compare.
 * @returns A number indicating the order of the versions:
 *   - 1 if v1 is greater than v2
 *   - -1 if v1 is less than v2
 *   - 0 if v1 and v2 are equal
 */function Zs(e,t){const i=e.split(".");const n=t.split(".");const r=Math.min(i.length,n.length);for(let e=0;e<r;++e){const t=parseInt(i[e],10);const s=parseInt(n[e],10);if(t>s)return 1;if(t<s)return-1;if(e===r-1&&t===s)return 0}return e===""&&t!==""?-1:t===""?1:i.length==n.length?0:i.length<n.length?-1:1}function $s(e){for(const t of e)t.target.handleResize(t)}function eo(e){for(const t of e)t.target.handleVisibilityChanged(t)}let to=null;const io=()=>{to||(to=new ResizeObserver($s));return to};let no=null;const ro=()=>{no||(no=new IntersectionObserver(eo,{root:null,rootMargin:"0px"}));return no};function so(){var e;const t=new Ut({sdk:jt.JS,protocol:hs,version:us});zs()&&(t.os=(e=Ys())!==null&&e!==void 0?e:"");return t}let oo;function ao(){oo||(oo=co());return oo.clone()}function co(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:16;let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:16;let i=arguments.length>2&&arguments[2]!==void 0&&arguments[2];let n=arguments.length>3&&arguments[3]!==void 0&&arguments[3];const r=document.createElement("canvas");r.width=e;r.height=t;const s=r.getContext("2d");s===null||s===void 0?void 0:s.fillRect(0,0,r.width,r.height);if(n&&s){s.beginPath();s.arc(e/2,t/2,50,0,Math.PI*2,true);s.closePath();s.fillStyle="grey";s.fill()}const o=r.captureStream();const[a]=o.getTracks();if(!a)throw Error("Could not get empty media stream video track");a.enabled=i;return a}let lo;function uo(){if(!lo){const e=new AudioContext;const t=e.createOscillator();const i=e.createGain();i.gain.setValueAtTime(0,0);const n=e.createMediaStreamDestination();t.connect(i);i.connect(n);t.start();[lo]=n.stream.getAudioTracks();if(!lo)throw Error("Could not get empty media stream audio track");lo.enabled=false}return lo.clone()}class Future{get isResolved(){return this._isResolved}constructor(e,t){this._isResolved=false;this.onFinally=t;this.promise=new Promise(((t,i)=>cn(this,void 0,void 0,(function*(){this.resolve=t;this.reject=i;e&&(yield e(t,i))})))).finally((()=>{var e;this._isResolved=true;(e=this.onFinally)===null||e===void 0?void 0:e.call(this)}))}}function ho(e,t){const i=Object.assign({cloneTrack:false,fftSize:2048,smoothingTimeConstant:.8,minDecibels:-100,maxDecibels:-80},t);const n=Uo();if(!n)throw new Error("Audio Context not supported on this browser");const r=i.cloneTrack?e.mediaStreamTrack.clone():e.mediaStreamTrack;const s=n.createMediaStreamSource(new MediaStream([r]));const o=n.createAnalyser();o.minDecibels=i.minDecibels;o.maxDecibels=i.maxDecibels;o.fftSize=i.fftSize;o.smoothingTimeConstant=i.smoothingTimeConstant;s.connect(o);const a=new Uint8Array(o.frequencyBinCount);const c=()=>{o.getByteFrequencyData(a);let e=0;for(const t of a)e+=Math.pow(t/255,2);const t=Math.sqrt(e/a.length);return t};const d=()=>cn(this,void 0,void 0,(function*(){yield n.close();i.cloneTrack&&r.stop()}));return{calculateVolume:c,analyser:o,cleanup:d}}function po(e){return bs.includes(e)}function mo(e){if(typeof e==="string"||typeof e==="number")return e;if(Array.isArray(e))return e[0];if(e.exact!==void 0)return Array.isArray(e.exact)?e.exact[0]:e.exact;if(e.ideal!==void 0)return Array.isArray(e.ideal)?e.ideal[0]:e.ideal;throw Error("could not unwrap constraint")}function go(e){return e.startsWith("http")?e.replace(/^(http)/,"ws"):e}function fo(e){return e.startsWith("ws")?e.replace(/^(ws)/,"http"):e}function vo(e,t){return e.segments.map((e=>{let{id:i,text:n,language:r,startTime:s,endTime:o,final:a}=e;var c;const d=(c=t.get(i))!==null&&c!==void 0?c:Date.now();const l=Date.now();a?t.delete(i):t.set(i,d);return{id:i,text:n,startTime:Number.parseInt(s.toString()),endTime:Number.parseInt(o.toString()),final:a,language:r,firstReceivedTime:d,lastReceivedTime:l}}))}function ko(e){const{id:t,timestamp:i,message:n,editTimestamp:r}=e;return{id:t,timestamp:Number.parseInt(i.toString()),editTimestamp:r?Number.parseInt(r.toString()):void 0,message:n}}function bo(e){switch(e.reason){case Qr.LeaveRequest:return e.context;case Qr.Cancelled:return ot.CLIENT_INITIATED;case Qr.NotAllowed:return ot.USER_REJECTED;case Qr.ServerUnreachable:return ot.JOIN_FAILURE;default:return ot.UNKNOWN_REASON}}function yo(e){return e!==void 0?Number(e):void 0}function To(e){return e!==void 0?BigInt(e):void 0}function Co(e){return!!e&&!(e instanceof MediaStreamTrack)&&e.isLocal}function So(e){return!!e&&e.kind==Track.Kind.Audio}function wo(e){return!!e&&e.kind==Track.Kind.Video}function Eo(e){return Co(e)&&wo(e)}function Po(e){return Co(e)&&So(e)}function Ro(e){return!!e&&!e.isLocal}function Io(e){return!!e&&!e.isLocal}function Oo(e){return Ro(e)&&wo(e)}function Do(e){return e.isLocal}function xo(e){return!e.isLocal}function Mo(e,t){const i=[];let n=(new TextEncoder).encode(e);while(n.length>t){let e=t;while(e>0){const t=n[e];if(t!==void 0&&(t&192)!==128)break;e--}i.push(n.slice(0,e));n=n.slice(e)}n.length>0&&i.push(n);return i}function Ao(e,t,i){var n,r;var s,o;const{optionsWithoutProcessor:a,audioProcessor:c,videoProcessor:d}=Go(e!==null&&e!==void 0?e:{});const l=t===null||t===void 0?void 0:t.processor;const u=i===null||i===void 0?void 0:i.processor;const h=a!==null&&a!==void 0?a:{};h.audio===true&&(h.audio={});h.video===true&&(h.video={});if(h.audio){_o(h.audio,t);(n=(s=h.audio).deviceId)!==null&&n!==void 0?n:s.deviceId={ideal:"default"};(c||l)&&(h.audio.processor=c!==null&&c!==void 0?c:l)}if(h.video){_o(h.video,i);(r=(o=h.video).deviceId)!==null&&r!==void 0?r:o.deviceId={ideal:"default"};(d||u)&&(h.video.processor=d!==null&&d!==void 0?d:u)}return h}function _o(e,t){Object.keys(t).forEach((i=>{e[i]===void 0&&(e[i]=t[i])}));return e}function No(e){var t,i;var n,r;const s={};if(e.video)if(typeof e.video==="object"){const i={};const r=i;const o=e.video;Object.keys(o).forEach((e=>{switch(e){case"resolution":_o(r,o.resolution);break;default:r[e]=o[e]}}));s.video=i;(t=(n=s.video).deviceId)!==null&&t!==void 0?t:n.deviceId={ideal:"default"}}else s.video=!!e.video&&{deviceId:{ideal:"default"}};else s.video=false;if(e.audio)if(typeof e.audio==="object"){s.audio=e.audio;(i=(r=s.audio).deviceId)!==null&&i!==void 0?i:r.deviceId={ideal:"default"}}else s.audio={deviceId:{ideal:"default"}};else s.audio=false;return s}function Lo(e){return cn(this,arguments,void 0,(function(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:200;return function*(){const i=Uo();if(i){const n=i.createAnalyser();n.fftSize=2048;const r=n.frequencyBinCount;const s=new Uint8Array(r);const o=i.createMediaStreamSource(new MediaStream([e.mediaStreamTrack]));o.connect(n);yield Os(t);n.getByteTimeDomainData(s);const a=s.some((e=>e!==128&&e!==0));i.close();return!a}return false}()}))}function Uo(){var e;const t=typeof window!=="undefined"&&(window.AudioContext||window.webkitAudioContext);if(t){const i=new t({latencyHint:"interactive"});if(i.state==="suspended"&&typeof window!=="undefined"&&((e=window.document)===null||e===void 0?void 0:e.body)){const e=()=>cn(this,void 0,void 0,(function*(){var t;try{i.state==="suspended"&&(yield i.resume())}catch(e){console.warn("Error trying to auto-resume audio context",e)}(t=window.document.body)===null||t===void 0?void 0:t.removeEventListener("click",e)}));window.document.body.addEventListener("click",e)}return i}}function jo(e){return e==="audioinput"?Track.Source.Microphone:e==="videoinput"?Track.Source.Camera:Track.Source.Unknown}function Fo(e){return e===Track.Source.Microphone?"audioinput":e===Track.Source.Camera?"videoinput":void 0}function Bo(e){var t,i;let n=(t=e.video)===null||t===void 0||t;if(e.resolution&&e.resolution.width>0&&e.resolution.height>0){n=typeof n==="boolean"?{}:n;n=Bs()?Object.assign(Object.assign({},n),{width:{max:e.resolution.width},height:{max:e.resolution.height},frameRate:e.resolution.frameRate}):Object.assign(Object.assign({},n),{width:{ideal:e.resolution.width},height:{ideal:e.resolution.height},frameRate:e.resolution.frameRate})}return{audio:(i=e.audio)!==null&&i!==void 0&&i,video:n,controller:e.controller,selfBrowserSurface:e.selfBrowserSurface,surfaceSwitching:e.surfaceSwitching,systemAudio:e.systemAudio,preferCurrentTab:e.preferCurrentTab}}function Vo(e){return e.split("/")[1].toLowerCase()}function qo(e){const t=[];e.forEach((e=>{e.track!==void 0&&t.push(new oi({cid:e.track.mediaStreamID,track:e.trackInfo}))}));return t}function Ho(e){return"mediaStreamTrack"in e?{trackID:e.sid,source:e.source,muted:e.isMuted,enabled:e.mediaStreamTrack.enabled,kind:e.kind,streamID:e.mediaStreamID,streamTrackID:e.mediaStreamTrack.id}:{trackID:e.trackSid,enabled:e.isEnabled,muted:e.isMuted,trackInfo:Object.assign({mimeType:e.mimeType,name:e.trackName,encrypted:e.isEncrypted,kind:e.kind,source:e.source},e.track?Ho(e.track):{})}}function Wo(){return typeof RTCRtpReceiver!=="undefined"&&"getSynchronizationSources"in RTCRtpReceiver}function Ko(e,t){var i;e===void 0&&(e={});t===void 0&&(t={});const n=[...Object.keys(t),...Object.keys(e)];const r={};for(const s of n)e[s]!==t[s]&&(r[s]=(i=t[s])!==null&&i!==void 0?i:"");return r}function Go(e){const t=Object.assign({},e);let i;let n;if(typeof t.audio==="object"&&t.audio.processor){i=t.audio.processor;t.audio=Object.assign(Object.assign({},t.audio),{processor:void 0})}if(typeof t.video==="object"&&t.video.processor){n=t.video.processor;t.video=Object.assign(Object.assign({},t.video),{processor:void 0})}return{audioProcessor:i,videoProcessor:n,optionsWithoutProcessor:ns(t)}}function zo(e){switch(e){case it.CAMERA:return Track.Source.Camera;case it.MICROPHONE:return Track.Source.Microphone;case it.SCREEN_SHARE:return Track.Source.ScreenShare;case it.SCREEN_SHARE_AUDIO:return Track.Source.ScreenShareAudio;default:return Track.Source.Unknown}}function Jo(e,t){return e.width*e.height<t.width*t.height}function Qo(e,t){var i;return(i=e.layers)===null||i===void 0?void 0:i.find((e=>e.quality===t))}class E2EEManager extends mn.EventEmitter{constructor(e){super();this.onWorkerMessage=e=>{var t,i;const{kind:n,data:r}=e.data;switch(n){case"error":Zi.error(r.error.message);this.emit(xr.EncryptionError,r.error);break;case"initAck":r.enabled&&this.keyProvider.getKeys().forEach((e=>{this.postKey(e)}));break;case"enable":r.enabled&&this.keyProvider.getKeys().forEach((e=>{this.postKey(e)}));if(this.encryptionEnabled!==r.enabled&&r.participantIdentity===((t=this.room)===null||t===void 0?void 0:t.localParticipant.identity)){this.emit(xr.ParticipantEncryptionStatusChanged,r.enabled,this.room.localParticipant);this.encryptionEnabled=r.enabled}else if(r.participantIdentity){const e=(i=this.room)===null||i===void 0?void 0:i.getParticipantByIdentity(r.participantIdentity);if(!e)throw TypeError("couldn't set encryption status, participant not found".concat(r.participantIdentity));this.emit(xr.ParticipantEncryptionStatusChanged,r.enabled,e)}break;case"ratchetKey":this.keyProvider.emit(Or.KeyRatcheted,r.ratchetResult,r.participantIdentity,r.keyIndex);break}};this.onWorkerError=e=>{Zi.error("e2ee worker encountered an error:",{error:e.error});this.emit(xr.EncryptionError,e.error)};this.keyProvider=e.keyProvider;this.worker=e.worker;this.encryptionEnabled=false}setup(e){if(!Ar())throw new DeviceUnsupportedError("tried to setup end-to-end encryption on an unsupported browser");Zi.info("setting up e2ee");if(e!==this.room){this.room=e;this.setupEventListeners(e,this.keyProvider);const t={kind:"init",data:{keyProviderOptions:this.keyProvider.getOptions(),loglevel:rn.getLevel()}};if(this.worker){Zi.info("initializing worker",{worker:this.worker});this.worker.onmessage=this.onWorkerMessage;this.worker.onerror=this.onWorkerError;this.worker.postMessage(t)}}}setParticipantCryptorEnabled(e,t){Zi.debug("set e2ee to ".concat(e," for participant ").concat(t));this.postEnable(e,t)}setSifTrailer(e){e&&e.length!==0?this.postSifTrailer(e):Zi.warn("ignoring server sent trailer as it's empty")}setupEngine(e){e.on(ts.RTPVideoMapUpdate,(e=>{this.postRTPMap(e)}))}setupEventListeners(e,t){e.on($r.TrackPublished,((e,t)=>this.setParticipantCryptorEnabled(e.trackInfo.encryption!==vt.NONE,t.identity)));e.on($r.ConnectionStateChanged,(t=>{t===xc.Connected&&e.remoteParticipants.forEach((e=>{e.trackPublications.forEach((t=>{this.setParticipantCryptorEnabled(t.trackInfo.encryption!==vt.NONE,e.identity)}))}))})).on($r.TrackUnsubscribed,((e,t,i)=>{var n;const r={kind:"removeTransform",data:{participantIdentity:i.identity,trackId:e.mediaStreamID}};(n=this.worker)===null||n===void 0?void 0:n.postMessage(r)})).on($r.TrackSubscribed,((e,t,i)=>{this.setupE2EEReceiver(e,i.identity,t.trackInfo)})).on($r.SignalConnected,(()=>{if(!this.room)throw new TypeError("expected room to be present on signal connect");t.getKeys().forEach((e=>{this.postKey(e)}));this.setParticipantCryptorEnabled(this.room.localParticipant.isE2EEEnabled,this.room.localParticipant.identity)}));e.localParticipant.on(es.LocalSenderCreated,((e,t)=>cn(this,void 0,void 0,(function*(){this.setupE2EESender(t,e)}))));e.localParticipant.on(es.LocalTrackPublished,(e=>{if(!wo(e.track)||!Vs())return;const t={kind:"updateCodec",data:{trackId:e.track.mediaStreamID,codec:Vo(e.trackInfo.codecs[0].mimeType),participantIdentity:this.room.localParticipant.identity}};this.worker.postMessage(t)}));t.on(Or.SetKey,(e=>this.postKey(e))).on(Or.RatchetRequest,((e,t)=>this.postRatchetRequest(e,t)))}postRatchetRequest(e,t){if(!this.worker)throw Error("could not ratchet key, worker is missing");const i={kind:"ratchetRequest",data:{participantIdentity:e,keyIndex:t}};this.worker.postMessage(i)}postKey(e){let{key:t,participantIdentity:i,keyIndex:n}=e;var r;if(!this.worker)throw Error("could not set key, worker is missing");const s={kind:"setKey",data:{participantIdentity:i,isPublisher:i===((r=this.room)===null||r===void 0?void 0:r.localParticipant.identity),key:t,keyIndex:n}};this.worker.postMessage(s)}postEnable(e,t){if(!this.worker)throw new ReferenceError("failed to enable e2ee, worker is not ready");{const i={kind:"enable",data:{enabled:e,participantIdentity:t}};this.worker.postMessage(i)}}postRTPMap(e){var t;if(!this.worker)throw TypeError("could not post rtp map, worker is missing");if(!((t=this.room)===null||t===void 0?void 0:t.localParticipant.identity))throw TypeError("could not post rtp map, local participant identity is missing");const i={kind:"setRTPMap",data:{map:e,participantIdentity:this.room.localParticipant.identity}};this.worker.postMessage(i)}postSifTrailer(e){if(!this.worker)throw Error("could not post SIF trailer, worker is missing");const t={kind:"setSifTrailer",data:{trailer:e}};this.worker.postMessage(t)}setupE2EEReceiver(e,t,i){if(e.receiver){if(!(i===null||i===void 0?void 0:i.mimeType)||i.mimeType==="")throw new TypeError("MimeType missing from trackInfo, cannot set up E2EE cryptor");this.handleReceiver(e.receiver,e.mediaStreamID,t,e.kind==="video"?Vo(i.mimeType):void 0)}}setupE2EESender(e,t){Co(e)&&t?this.handleSender(t,e.mediaStreamID,void 0):t||Zi.warn("early return because sender is not ready")}handleReceiver(e,t,i,n){return cn(this,void 0,void 0,(function*(){if(this.worker){if(_r()){const r={kind:"decode",participantIdentity:i,trackId:t,codec:n};e.transform=new RTCRtpScriptTransform(this.worker,r)}else{if(Pr in e&&n){const e={kind:"updateCodec",data:{trackId:t,codec:n,participantIdentity:i}};this.worker.postMessage(e);return}let r=e.writableStream;let s=e.readableStream;if(!r||!s){const t=e.createEncodedStreams();e.writableStream=t.writable;r=t.writable;e.readableStream=t.readable;s=t.readable}const o={kind:"decode",data:{readableStream:s,writableStream:r,trackId:t,codec:n,participantIdentity:i,isReuse:Pr in e}};this.worker.postMessage(o,[s,r])}e[Pr]=true}}))}handleSender(e,t,i){var n;if(!(Pr in e)&&this.worker){if(!((n=this.room)===null||n===void 0?void 0:n.localParticipant.identity)||this.room.localParticipant.identity==="")throw TypeError("local identity needs to be known in order to set up encrypted sender");if(_r()){Zi.info("initialize script transform");const n={kind:"encode",participantIdentity:this.room.localParticipant.identity,trackId:t,codec:i};e.transform=new RTCRtpScriptTransform(this.worker,n)}else{Zi.info("initialize encoded streams");const n=e.createEncodedStreams();const r={kind:"encode",data:{readableStream:n.readable,writableStream:n.writable,codec:i,trackId:t,participantIdentity:this.room.localParticipant.identity,isReuse:false}};this.worker.postMessage(r,[n.readable,n.writable])}e[Pr]=true}}}const Yo="default";class DeviceManager{constructor(){this._previousDevices=[]}static getInstance(){this.instance===void 0&&(this.instance=new DeviceManager);return this.instance}get previousDevices(){return this._previousDevices}getDevices(e){return cn(this,arguments,void 0,(function(e){var t=this;let i=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];return function*(){var n;if(((n=DeviceManager.userMediaPromiseMap)===null||n===void 0?void 0:n.size)>0){Zi.debug("awaiting getUserMedia promise");try{e?yield DeviceManager.userMediaPromiseMap.get(e):yield Promise.all(DeviceManager.userMediaPromiseMap.values())}catch(e){Zi.warn("error waiting for media permissons")}}let r=yield navigator.mediaDevices.enumerateDevices();if(i&&!(Bs()&&t.hasDeviceInUse(e))){const t=r.filter((t=>t.kind===e)).length===0||r.some((t=>{const i=t.label==="";const n=!e||t.kind===e;return i&&n}));if(t){const t={video:e!=="audioinput"&&e!=="audiooutput",audio:e!=="videoinput"&&{deviceId:{ideal:"default"}}};const i=yield navigator.mediaDevices.getUserMedia(t);r=yield navigator.mediaDevices.enumerateDevices();i.getTracks().forEach((e=>{e.stop()}))}}t._previousDevices=r;e&&(r=r.filter((t=>t.kind===e)));return r}()}))}normalizeDeviceId(e,t,i){return cn(this,void 0,void 0,(function*(){if(t!==Yo)return t;const n=yield this.getDevices(e);const r=n.find((e=>e.deviceId===Yo));if(!r){Zi.warn("could not reliably determine default device");return}const s=n.find((e=>e.deviceId!==Yo&&e.groupId===(i!==null&&i!==void 0?i:r.groupId)));if(s)return s===null||s===void 0?void 0:s.deviceId;Zi.warn("could not reliably determine default device")}))}hasDeviceInUse(e){return e?DeviceManager.userMediaPromiseMap.has(e):DeviceManager.userMediaPromiseMap.size>0}}DeviceManager.mediaDeviceKinds=["audioinput","audiooutput","videoinput"];DeviceManager.userMediaPromiseMap=new Map;var Xo;(function(e){e[e.WAITING=0]="WAITING";e[e.RUNNING=1]="RUNNING";e[e.COMPLETED=2]="COMPLETED"})(Xo||(Xo={}));class AsyncQueue{constructor(){this.pendingTasks=new Map;this.taskMutex=new _;this.nextTaskIndex=0}run(e){return cn(this,void 0,void 0,(function*(){const t={id:this.nextTaskIndex++,enqueuedAt:Date.now(),status:Xo.WAITING};this.pendingTasks.set(t.id,t);const i=yield this.taskMutex.lock();try{t.executedAt=Date.now();t.status=Xo.RUNNING;return yield e()}finally{t.status=Xo.COMPLETED;this.pendingTasks.delete(t.id);i()}}))}flush(){return cn(this,void 0,void 0,(function*(){return this.run((()=>cn(this,void 0,void 0,(function*(){}))))}))}snapshot(){return Array.from(this.pendingTasks.values())}}function Zo(e,t){const i=new URL(go(e));t.forEach(((e,t)=>{i.searchParams.set(t,e)}));return ta(i,"rtc")}function $o(e){const t=new URL(fo(e));return ta(t,"validate")}function ea(e){return e.endsWith("/")?e:"".concat(e,"/")}function ta(e,t){e.pathname="".concat(ea(e.pathname)).concat(t);return e.toString()}const ia=["syncState","trickle","offer","answer","simulate","leave"];function na(e){const t=ia.indexOf(e.case)>=0;Zi.trace("request allowed to bypass queue:",{canPass:t,req:e});return t}var ra;(function(e){e[e.CONNECTING=0]="CONNECTING";e[e.CONNECTED=1]="CONNECTED";e[e.RECONNECTING=2]="RECONNECTING";e[e.DISCONNECTING=3]="DISCONNECTING";e[e.DISCONNECTED=4]="DISCONNECTED"})(ra||(ra={}));class SignalClient{get currentState(){return this.state}get isDisconnected(){return this.state===ra.DISCONNECTING||this.state===ra.DISCONNECTED}get isEstablishingConnection(){return this.state===ra.CONNECTING||this.state===ra.RECONNECTING}getNextRequestId(){this._requestId+=1;return this._requestId}constructor(){let e=arguments.length>0&&arguments[0]!==void 0&&arguments[0];let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};var i;this.rtt=0;this.state=ra.DISCONNECTED;this.log=Zi;this._requestId=0;this.resetCallbacks=()=>{this.onAnswer=void 0;this.onLeave=void 0;this.onLocalTrackPublished=void 0;this.onLocalTrackUnpublished=void 0;this.onNegotiateRequested=void 0;this.onOffer=void 0;this.onRemoteMuteChanged=void 0;this.onSubscribedQualityUpdate=void 0;this.onTokenRefresh=void 0;this.onTrickle=void 0;this.onClose=void 0};this.log=en((i=t.loggerName)!==null&&i!==void 0?i:Xi.Signal);this.loggerContextCb=t.loggerContextCb;this.useJSON=e;this.requestQueue=new AsyncQueue;this.queuedRequests=[];this.closingLock=new _;this.connectionLock=new _;this.state=ra.DISCONNECTED}get logContext(){var e,t;return(t=(e=this.loggerContextCb)===null||e===void 0?void 0:e.call(this))!==null&&t!==void 0?t:{}}join(e,t,i,n){return cn(this,void 0,void 0,(function*(){this.state=ra.CONNECTING;this.options=i;const r=yield this.connect(e,t,i,n);return r}))}reconnect(e,t,i,n){return cn(this,void 0,void 0,(function*(){if(!this.options){this.log.warn("attempted to reconnect without signal options being set, ignoring",this.logContext);return}this.state=ra.RECONNECTING;this.clearPingInterval();const r=yield this.connect(e,t,Object.assign(Object.assign({},this.options),{reconnect:true,sid:i,reconnectReason:n}));return r}))}connect(e,t,i,n){this.connectOptions=i;const r=so();const s=aa(t,r,i);const o=Zo(e,s);const a=$o(o);return new Promise(((e,t)=>cn(this,void 0,void 0,(function*(){const r=yield this.connectionLock.lock();try{const r=()=>cn(this,void 0,void 0,(function*(){this.close();clearTimeout(s);t(new ConnectionError("room connection has been cancelled (signal)",Qr.Cancelled))}));const s=setTimeout((()=>{this.close();t(new ConnectionError("room connection has timed out (signal)",Qr.ServerUnreachable))}),i.websocketTimeout);(n===null||n===void 0?void 0:n.aborted)&&r();n===null||n===void 0?void 0:n.addEventListener("abort",r);const c=new URL(o);c.searchParams.has("access_token")&&c.searchParams.set("access_token","<redacted>");this.log.debug("connecting to ".concat(c),Object.assign({reconnect:i.reconnect,reconnectReason:i.reconnectReason},this.logContext));this.ws&&(yield this.close(false));this.ws=new WebSocket(o);this.ws.binaryType="arraybuffer";this.ws.onopen=()=>{clearTimeout(s)};this.ws.onerror=e=>cn(this,void 0,void 0,(function*(){if(this.state===ra.CONNECTED)this.handleWSError(e);else{this.state=ra.DISCONNECTED;clearTimeout(s);try{const i=yield fetch(a);if(i.status.toFixed(0).startsWith("4")){const e=yield i.text();t(new ConnectionError(e,Qr.NotAllowed,i.status))}else t(new ConnectionError("Encountered unknown websocket error during connection: ".concat(e.toString()),Qr.InternalError,i.status))}catch(e){t(new ConnectionError(e instanceof Error?e.message:"server was not reachable",Qr.ServerUnreachable))}}}));this.ws.onmessage=s=>cn(this,void 0,void 0,(function*(){var o,a,c;let d;if(typeof s.data==="string"){const e=JSON.parse(s.data);d=$t.fromJson(e,{ignoreUnknownFields:true})}else{if(!(s.data instanceof ArrayBuffer)){this.log.error("could not decode websocket message: ".concat(typeof s.data),this.logContext);return}d=$t.fromBinary(new Uint8Array(s.data))}if(this.state!==ra.CONNECTED){let s=false;if(((o=d.message)===null||o===void 0?void 0:o.case)==="join"){this.state=ra.CONNECTED;n===null||n===void 0?void 0:n.removeEventListener("abort",r);this.pingTimeoutDuration=d.message.value.pingTimeout;this.pingIntervalDuration=d.message.value.pingInterval;if(this.pingTimeoutDuration&&this.pingTimeoutDuration>0){this.log.debug("ping config",Object.assign(Object.assign({},this.logContext),{timeout:this.pingTimeoutDuration,interval:this.pingIntervalDuration}));this.startPingInterval()}e(d.message.value)}else if(this.state===ra.RECONNECTING&&d.message.case!=="leave"){this.state=ra.CONNECTED;n===null||n===void 0?void 0:n.removeEventListener("abort",r);this.startPingInterval();if(((a=d.message)===null||a===void 0?void 0:a.case)==="reconnect")e(d.message.value);else{this.log.debug("declaring signal reconnected without reconnect response received",this.logContext);e(void 0);s=true}}else this.isEstablishingConnection&&d.message.case==="leave"?t(new ConnectionError("Received leave request while trying to (re)connect",Qr.LeaveRequest,void 0,d.message.value.reason)):i.reconnect||t(new ConnectionError("did not receive join response, got ".concat((c=d.message)===null||c===void 0?void 0:c.case," instead"),Qr.InternalError));if(!s)return}this.signalLatency&&(yield Os(this.signalLatency));this.handleSignalResponse(d)}));this.ws.onclose=e=>{this.isEstablishingConnection&&t(new ConnectionError("Websocket got closed during a (re)connection attempt",Qr.InternalError));this.log.warn("websocket closed",Object.assign(Object.assign({},this.logContext),{reason:e.reason,code:e.code,wasClean:e.wasClean,state:this.state}));this.handleOnClose(e.reason)}}finally{r()}}))))}close(){return cn(this,arguments,void 0,(function(){var e=this;let t=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];return function*(){const i=yield e.closingLock.lock();try{e.clearPingInterval();t&&(e.state=ra.DISCONNECTING);if(e.ws){e.ws.onmessage=null;e.ws.onopen=null;e.ws.onclose=null;const t=new Promise((t=>{e.ws?e.ws.onclose=()=>{t()}:t()}));if(e.ws.readyState<e.ws.CLOSING){e.ws.close();yield Promise.race([t,Os(250)])}e.ws=void 0}}finally{t&&(e.state=ra.DISCONNECTED);i()}}()}))}sendOffer(e,t){this.log.debug("sending offer",Object.assign(Object.assign({},this.logContext),{offerSdp:e.sdp}));this.sendRequest({case:"offer",value:oa(e,t)})}sendAnswer(e,t){this.log.debug("sending answer",Object.assign(Object.assign({},this.logContext),{answerSdp:e.sdp}));return this.sendRequest({case:"answer",value:oa(e,t)})}sendIceCandidate(e,t){this.log.debug("sending ice candidate",Object.assign(Object.assign({},this.logContext),{candidate:e}));return this.sendRequest({case:"trickle",value:new ii({candidateInit:JSON.stringify(e),target:t})})}sendMuteTrack(e,t){return this.sendRequest({case:"mute",value:new ni({sid:e,muted:t})})}sendAddTrack(e){return this.sendRequest({case:"addTrack",value:e})}sendUpdateLocalMetadata(e,t){return cn(this,arguments,void 0,(function(e,t){var i=this;let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};return function*(){const r=i.getNextRequestId();yield i.sendRequest({case:"updateMetadata",value:new vi({requestId:r,metadata:e,name:t,attributes:n})});return r}()}))}sendUpdateTrackSettings(e){this.sendRequest({case:"trackSetting",value:e})}sendUpdateSubscription(e){return this.sendRequest({case:"subscription",value:e})}sendSyncState(e){return this.sendRequest({case:"syncState",value:e})}sendUpdateVideoLayers(e,t){return this.sendRequest({case:"updateLayers",value:new fi({trackSid:e,layers:t})})}sendUpdateSubscriptionPermissions(e,t){return this.sendRequest({case:"subscriptionPermission",value:new Oi({allParticipants:e,trackPermissions:t})})}sendSimulateScenario(e){return this.sendRequest({case:"simulate",value:e})}sendPing(){return Promise.all([this.sendRequest({case:"ping",value:A.parse(Date.now())}),this.sendRequest({case:"pingReq",value:new Li({timestamp:A.parse(Date.now()),rtt:A.parse(this.rtt)})})])}sendUpdateLocalAudioTrack(e,t){return this.sendRequest({case:"updateAudioTrack",value:new hi({trackSid:e,features:t})})}sendLeave(){return this.sendRequest({case:"leave",value:new mi({reason:ot.CLIENT_INITIATED,action:gi.DISCONNECT})})}sendRequest(e){return cn(this,arguments,void 0,(function(e){var t=this;let i=arguments.length>1&&arguments[1]!==void 0&&arguments[1];return function*(){const n=!i&&!na(e);if(n&&t.state===ra.RECONNECTING){t.queuedRequests.push((()=>cn(t,void 0,void 0,(function*(){yield this.sendRequest(e,true)}))));return}i||(yield t.requestQueue.flush());t.signalLatency&&(yield Os(t.signalLatency));if(t.isDisconnected){t.log.debug("skipping signal request (type: ".concat(e.case,") - SignalClient disconnected"));return}if(!t.ws||t.ws.readyState!==t.ws.OPEN){t.log.error("cannot send signal request before connected, type: ".concat(e===null||e===void 0?void 0:e.case),t.logContext);return}const r=new Zt({message:e});try{t.useJSON?t.ws.send(r.toJsonString()):t.ws.send(r.toBinary())}catch(e){t.log.error("error sending signal message",Object.assign(Object.assign({},t.logContext),{error:e}))}}()}))}handleSignalResponse(e){var t,i;const n=e.message;if(n==void 0){this.log.debug("received unsupported message",this.logContext);return}let r=false;if(n.case==="answer"){const e=sa(n.value);this.onAnswer&&this.onAnswer(e,n.value.id)}else if(n.case==="offer"){const e=sa(n.value);this.onOffer&&this.onOffer(e,n.value.id)}else if(n.case==="trickle"){const e=JSON.parse(n.value.candidateInit);this.onTrickle&&this.onTrickle(e,n.value.target)}else if(n.case==="update")this.onParticipantUpdate&&this.onParticipantUpdate((t=n.value.participants)!==null&&t!==void 0?t:[]);else if(n.case==="trackPublished")this.onLocalTrackPublished&&this.onLocalTrackPublished(n.value);else if(n.case==="speakersChanged")this.onSpeakersChanged&&this.onSpeakersChanged((i=n.value.speakers)!==null&&i!==void 0?i:[]);else if(n.case==="leave")this.onLeave&&this.onLeave(n.value);else if(n.case==="mute")this.onRemoteMuteChanged&&this.onRemoteMuteChanged(n.value.sid,n.value.muted);else if(n.case==="roomUpdate")this.onRoomUpdate&&n.value.room&&this.onRoomUpdate(n.value.room);else if(n.case==="connectionQuality")this.onConnectionQuality&&this.onConnectionQuality(n.value);else if(n.case==="streamStateUpdate")this.onStreamStateUpdate&&this.onStreamStateUpdate(n.value);else if(n.case==="subscribedQualityUpdate")this.onSubscribedQualityUpdate&&this.onSubscribedQualityUpdate(n.value);else if(n.case==="subscriptionPermissionUpdate")this.onSubscriptionPermissionUpdate&&this.onSubscriptionPermissionUpdate(n.value);else if(n.case==="refreshToken")this.onTokenRefresh&&this.onTokenRefresh(n.value);else if(n.case==="trackUnpublished")this.onLocalTrackUnpublished&&this.onLocalTrackUnpublished(n.value);else if(n.case==="subscriptionResponse")this.onSubscriptionError&&this.onSubscriptionError(n.value);else if(n.case==="pong");else if(n.case==="pongResp"){this.rtt=Date.now()-Number.parseInt(n.value.lastPingTimestamp.toString());this.resetPingTimeout();r=true}else if(n.case==="requestResponse")this.onRequestResponse&&this.onRequestResponse(n.value);else if(n.case==="trackSubscribed")this.onLocalTrackSubscribed&&this.onLocalTrackSubscribed(n.value.trackSid);else if(n.case==="roomMoved"){this.onTokenRefresh&&this.onTokenRefresh(n.value.token);this.onRoomMoved&&this.onRoomMoved(n.value)}else this.log.debug("unsupported message",Object.assign(Object.assign({},this.logContext),{msgCase:n.case}));r||this.resetPingTimeout()}setReconnected(){while(this.queuedRequests.length>0){const e=this.queuedRequests.shift();e&&this.requestQueue.run(e)}}handleOnClose(e){return cn(this,void 0,void 0,(function*(){if(this.state===ra.DISCONNECTED)return;const t=this.onClose;yield this.close();this.log.debug("websocket connection closed: ".concat(e),Object.assign(Object.assign({},this.logContext),{reason:e}));t&&t(e)}))}handleWSError(e){this.log.error("websocket error",Object.assign(Object.assign({},this.logContext),{error:e}))}resetPingTimeout(){this.clearPingTimeout();this.pingTimeoutDuration?this.pingTimeout=CriticalTimers.setTimeout((()=>{this.log.warn("ping timeout triggered. last pong received at: ".concat(new Date(Date.now()-this.pingTimeoutDuration*1e3).toUTCString()),this.logContext);this.handleOnClose("ping timeout")}),this.pingTimeoutDuration*1e3):this.log.warn("ping timeout duration not set",this.logContext)}clearPingTimeout(){this.pingTimeout&&CriticalTimers.clearTimeout(this.pingTimeout)}startPingInterval(){this.clearPingInterval();this.resetPingTimeout();if(this.pingIntervalDuration){this.log.debug("start ping interval",this.logContext);this.pingInterval=CriticalTimers.setInterval((()=>{this.sendPing()}),this.pingIntervalDuration*1e3)}else this.log.warn("ping interval duration not set",this.logContext)}clearPingInterval(){this.log.debug("clearing ping interval",this.logContext);this.clearPingTimeout();this.pingInterval&&CriticalTimers.clearInterval(this.pingInterval)}}function sa(e){const t={type:"offer",sdp:e.sdp};switch(e.type){case"answer":case"offer":case"pranswer":case"rollback":t.type=e.type;break}return t}function oa(e,t){const i=new ci({sdp:e.sdp,type:e.type,id:t});return i}function aa(e,t,i){var n;const r=new URLSearchParams;r.set("access_token",e);if(i.reconnect){r.set("reconnect","1");i.sid&&r.set("sid",i.sid)}r.set("auto_subscribe",i.autoSubscribe?"1":"0");r.set("sdk",zs()?"reactnative":"js");r.set("version",t.version);r.set("protocol",t.protocol.toString());t.deviceModel&&r.set("device_model",t.deviceModel);t.os&&r.set("os",t.os);t.osVersion&&r.set("os_version",t.osVersion);t.browser&&r.set("browser",t.browser);t.browserVersion&&r.set("browser_version",t.browserVersion);i.adaptiveStream&&r.set("adaptive_stream","1");i.reconnectReason&&r.set("reconnect_reason",i.reconnectReason.toString());((n=navigator.connection)===null||n===void 0?void 0:n.type)&&r.set("network",navigator.connection.type);return r}class DataPacketBuffer{constructor(){this.buffer=[];this._totalSize=0}push(e){this.buffer.push(e);this._totalSize+=e.data.byteLength}pop(){const e=this.buffer.shift();e&&(this._totalSize-=e.data.byteLength);return e}getAll(){return this.buffer.slice()}popToSequence(e){while(this.buffer.length>0){const t=this.buffer[0];if(!(t.sequence<=e))break;this.pop()}}alignBufferedAmount(e){while(this.buffer.length>0){const t=this.buffer[0];if(this._totalSize-t.data.byteLength<=e)break;this.pop()}}get length(){return this.buffer.length}}class TTLMap{
/**
   * @param ttl ttl of the key (ms)
   */
constructor(e){this._map=new Map;this._lastCleanup=0;this.ttl=e}set(e,t){const i=Date.now();i-this._lastCleanup>this.ttl/2&&this.cleanup();const n=i+this.ttl;this._map.set(e,{value:t,expiresAt:n});return this}get(e){const t=this._map.get(e);if(t){if(!(t.expiresAt<Date.now()))return t.value;this._map.delete(e)}}has(e){const t=this._map.get(e);if(!t)return false;if(t.expiresAt<Date.now()){this._map.delete(e);return false}return true}delete(e){return this._map.delete(e)}clear(){this._map.clear()}cleanup(){const e=Date.now();for(const[t,i]of this._map.entries())i.expiresAt<e&&this._map.delete(t);this._lastCleanup=e}get size(){this.cleanup();return this._map.size}forEach(e){this.cleanup();for(const[t,i]of this._map.entries())i.expiresAt>=Date.now()&&e(i.value,t,this.asValueMap())}map(e){this.cleanup();const t=[];const i=this.asValueMap();for(const[n,r]of i.entries())t.push(e(r,n,i));return t}asValueMap(){const e=new Map;for(const[t,i]of this._map.entries())i.expiresAt>=Date.now()&&e.set(t,i.value);return e}}var ca={};var da={};var la={exports:{}};var ua;function ha(){if(ua)return la.exports;ua=1;var e=la.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return e.address!=null?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return e.subtype!=null?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return e.sessionConfig!=null?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";t+=e.raddr!=null?" raddr %s rport %d":"%v%v";t+=e.tcptype!=null?" tcptype %s":"%v";e.generation!=null&&(t+=" generation %d");t+=e["network-id"]!=null?" network-id %d":"%v";t+=e["network-cost"]!=null?" network-cost %d":"%v";return t}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";if(e.attribute!=null){t+=" %s";e.value!=null&&(t+=":%s")}return t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return e.maxMessageSize!=null?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return"ts-refclk:%s"+(e.clksrcExt!=null?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){var t="mediaclk:";t+=e.id!=null?"id=%s %s":"%v%s";t+=e.mediaClockValue!=null?"=%s":"";t+=e.rateNumerator!=null?" rate=%s":"";t+=e.rateDenominator!=null?"/%s":"";return t}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(e).forEach((function(t){var i=e[t];i.forEach((function(e){e.reg||(e.reg=/(.*)/);e.format||(e.format="%s")}))}));return la.exports}var pa;function ma(){if(pa)return da;pa=1;(function(e){var t=function(e){return String(Number(e))===e?Number(e):e};var i=function(e,i,n,r){if(r&&!n)i[r]=t(e[1]);else for(var s=0;s<n.length;s+=1)e[s+1]!=null&&(i[n[s]]=t(e[s+1]))};var n=function(e,t,n){var r=e.name&&e.names;e.push&&!t[e.push]?t[e.push]=[]:r&&!t[e.name]&&(t[e.name]={});var s=e.push?{}:r?t[e.name]:t;i(n.match(e.reg),s,e.names,e.name);e.push&&t[e.push].push(s)};var r=ha();var s=RegExp.prototype.test.bind(/^([a-z])=(.*)/);e.parse=function(e){var t={},i=[],o=t;e.split(/(\r\n|\r|\n)/).filter(s).forEach((function(e){var t=e[0];var s=e.slice(2);if(t==="m"){i.push({rtp:[],fmtp:[]});o=i[i.length-1]}for(var a=0;a<(r[t]||[]).length;a+=1){var c=r[t][a];if(c.reg.test(s))return n(c,o,s)}}));t.media=i;return t};var o=function(e,i){var n=i.split(/=(.+)/,2);n.length===2?e[n[0]]=t(n[1]):n.length===1&&i.length>1&&(e[n[0]]=void 0);return e};e.parseParams=function(e){return e.split(/;\s?/).reduce(o,{})};e.parseFmtpConfig=e.parseParams;e.parsePayloads=function(e){return e.toString().split(" ").map(Number)};e.parseRemoteCandidates=function(e){var i=[];var n=e.split(" ").map(t);for(var r=0;r<n.length;r+=3)i.push({component:n[r],ip:n[r+1],port:n[r+2]});return i};e.parseImageAttributes=function(e){return e.split(" ").map((function(e){return e.substring(1,e.length-1).split(",").reduce(o,{})}))};e.parseSimulcastStreamList=function(e){return e.split(";").map((function(e){return e.split(",").map((function(e){var i,n=false;if(e[0]!=="~")i=t(e);else{i=t(e.substring(1,e.length));n=true}return{scid:i,paused:n}}))}))}})(da);return da}var ga;var fa;function va(){if(fa)return ga;fa=1;var e=ha();var t=/%[sdv%]/g;var i=function(e){var i=1;var n=arguments;var r=n.length;return e.replace(t,(function(e){if(i>=r)return e;var t=n[i];i+=1;switch(e){case"%%":return"%";case"%s":return String(t);case"%d":return Number(t);case"%v":return""}}))};var n=function(e,t,n){var r=t.format instanceof Function?t.format(t.push?n:n[t.name]):t.format;var s=[e+"="+r];if(t.names)for(var o=0;o<t.names.length;o+=1){var a=t.names[o];t.name?s.push(n[t.name][a]):s.push(n[t.names[o]])}else s.push(n[t.name]);return i.apply(null,s)};var r=["v","o","s","i","u","e","p","c","b","t","r","z","a"];var s=["i","c","b","a"];ga=function(t,i){i=i||{};t.version==null&&(t.version=0);t.name==null&&(t.name=" ");t.media.forEach((function(e){e.payloads==null&&(e.payloads="")}));var o=i.outerOrder||r;var a=i.innerOrder||s;var c=[];o.forEach((function(i){e[i].forEach((function(e){e.name in t&&t[e.name]!=null?c.push(n(i,e,t)):e.push in t&&t[e.push]!=null&&t[e.push].forEach((function(t){c.push(n(i,e,t))}))}))}));t.media.forEach((function(t){c.push(n("m",e.m[0],t));a.forEach((function(i){e[i].forEach((function(e){e.name in t&&t[e.name]!=null?c.push(n(i,e,t)):e.push in t&&t[e.push]!=null&&t[e.push].forEach((function(t){c.push(n(i,e,t))}))}))}))}));return c.join("\r\n")+"\r\n"};return ga}var ka;function ba(){if(ka)return ca;ka=1;var e=ma();var t=va();var i=ha();ca.grammar=i;ca.write=t;ca.parse=e.parse;ca.parseParams=e.parseParams;ca.parseFmtpConfig=e.parseFmtpConfig;ca.parsePayloads=e.parsePayloads;ca.parseRemoteCandidates=e.parseRemoteCandidates;ca.parseImageAttributes=e.parseImageAttributes;ca.parseSimulcastStreamList=e.parseSimulcastStreamList;return ca}var ya=ba();function Ta(e,t,i){var n,r,s;void 0===t&&(t=50),void 0===i&&(i={});var o=null!=(n=i.isImmediate)&&n,a=null!=(r=i.callback)&&r,c=i.maxWait,d=Date.now(),l=[];function u(){if(void 0!==c){var e=Date.now()-d;if(e+t>=c)return c-e}return t}var h=function(){var t=[].slice.call(arguments),i=this;return new Promise((function(n,r){var c=o&&void 0===s;if(void 0!==s&&clearTimeout(s),s=setTimeout((function(){if(s=void 0,d=Date.now(),!o){var n=e.apply(i,t);a&&a(n),l.forEach((function(e){return(0,e.resolve)(n)})),l=[]}}),u()),c){var h=e.apply(i,t);return a&&a(h),n(h)}l.push({resolve:n,reject:r})}))};return h.cancel=function(e){void 0!==s&&clearTimeout(s),l.forEach((function(t){return(0,t.reject)(e)})),l=[]},h}const Ca=.7;const Sa=20;const wa={NegotiationStarted:"negotiationStarted",NegotiationComplete:"negotiationComplete",RTPVideoPayloadTypes:"rtpVideoPayloadTypes"};class PCTransport extends mn.EventEmitter{get pc(){this._pc||(this._pc=this.createPC());return this._pc}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};var i;super();this.log=Zi;this.ddExtID=0;this.latestOfferId=0;this.pendingCandidates=[];this.restartingIce=false;this.renegotiate=false;this.trackBitrates=[];this.remoteStereoMids=[];this.remoteNackMids=[];this.negotiate=Ta((e=>cn(this,void 0,void 0,(function*(){this.emit(wa.NegotiationStarted);try{yield this.createAndSendOffer()}catch(t){if(!e)throw t;e(t)}}))),Sa);this.close=()=>{if(this._pc){this._pc.close();this._pc.onconnectionstatechange=null;this._pc.oniceconnectionstatechange=null;this._pc.onicegatheringstatechange=null;this._pc.ondatachannel=null;this._pc.onnegotiationneeded=null;this._pc.onsignalingstatechange=null;this._pc.onicecandidate=null;this._pc.ondatachannel=null;this._pc.ontrack=null;this._pc.onconnectionstatechange=null;this._pc.oniceconnectionstatechange=null;this._pc=null}};this.log=en((i=t.loggerName)!==null&&i!==void 0?i:Xi.PCTransport);this.loggerOptions=t;this.config=e;this._pc=this.createPC();this.offerLock=new _}createPC(){const e=new RTCPeerConnection(this.config);e.onicecandidate=e=>{var t;e.candidate&&((t=this.onIceCandidate)===null||t===void 0?void 0:t.call(this,e.candidate))};e.onicecandidateerror=e=>{var t;(t=this.onIceCandidateError)===null||t===void 0?void 0:t.call(this,e)};e.oniceconnectionstatechange=()=>{var t;(t=this.onIceConnectionStateChange)===null||t===void 0?void 0:t.call(this,e.iceConnectionState)};e.onsignalingstatechange=()=>{var t;(t=this.onSignalingStatechange)===null||t===void 0?void 0:t.call(this,e.signalingState)};e.onconnectionstatechange=()=>{var t;(t=this.onConnectionStateChange)===null||t===void 0?void 0:t.call(this,e.connectionState)};e.ondatachannel=e=>{var t;(t=this.onDataChannel)===null||t===void 0?void 0:t.call(this,e)};e.ontrack=e=>{var t;(t=this.onTrack)===null||t===void 0?void 0:t.call(this,e)};return e}get logContext(){var e,t;return Object.assign({},(t=(e=this.loggerOptions).loggerContextCb)===null||t===void 0?void 0:t.call(e))}get isICEConnected(){return this._pc!==null&&(this.pc.iceConnectionState==="connected"||this.pc.iceConnectionState==="completed")}addIceCandidate(e){return cn(this,void 0,void 0,(function*(){if(this.pc.remoteDescription&&!this.restartingIce)return this.pc.addIceCandidate(e);this.pendingCandidates.push(e)}))}setRemoteDescription(e,t){return cn(this,void 0,void 0,(function*(){var i;if(e.type==="answer"&&this.latestOfferId>0&&t>0&&t!==this.latestOfferId){this.log.warn("ignoring answer for old offer",Object.assign(Object.assign({},this.logContext),{offerId:t,latestOfferId:this.latestOfferId}));return false}let n;if(e.type==="offer"){let{stereoMids:t,nackMids:i}=Pa(e);this.remoteStereoMids=t;this.remoteNackMids=i}else if(e.type==="answer"){const t=ya.parse((i=e.sdp)!==null&&i!==void 0?i:"");t.media.forEach((e=>{e.type==="audio"&&this.trackBitrates.some((t=>{if(!t.transceiver||e.mid!=t.transceiver.mid)return false;let i=0;e.rtp.some((e=>{if(e.codec.toUpperCase()===t.codec.toUpperCase()){i=e.payload;return true}return false}));if(i===0)return true;let n=false;for(const r of e.fmtp)if(r.payload===i){r.config=r.config.split(";").filter((e=>!e.includes("maxaveragebitrate"))).join(";");t.maxbr>0&&(r.config+=";maxaveragebitrate=".concat(t.maxbr*1e3));n=true;break}n||t.maxbr>0&&e.fmtp.push({payload:i,config:"maxaveragebitrate=".concat(t.maxbr*1e3)});return true}))}));n=ya.write(t)}yield this.setMungedSDP(e,n,true);this.pendingCandidates.forEach((e=>{this.pc.addIceCandidate(e)}));this.pendingCandidates=[];this.restartingIce=false;if(this.renegotiate){this.renegotiate=false;yield this.createAndSendOffer()}else if(e.type==="answer"){this.emit(wa.NegotiationComplete);if(e.sdp){const t=ya.parse(e.sdp);t.media.forEach((e=>{e.type==="video"&&this.emit(wa.RTPVideoPayloadTypes,e.rtp)}))}}return true}))}createAndSendOffer(e){return cn(this,void 0,void 0,(function*(){var t;const i=yield this.offerLock.lock();try{if(this.onOffer===void 0)return;if(e===null||e===void 0?void 0:e.iceRestart){this.log.debug("restarting ICE",this.logContext);this.restartingIce=true}if(this._pc&&this._pc.signalingState==="have-local-offer"){const t=this._pc.remoteDescription;if(!(e===null||e===void 0?void 0:e.iceRestart)||!t){this.renegotiate=true;return}yield this._pc.setRemoteDescription(t)}else if(!this._pc||this._pc.signalingState==="closed"){this.log.warn("could not createOffer with closed peer connection",this.logContext);return}this.log.debug("starting to negotiate",this.logContext);const i=this.latestOfferId+1;this.latestOfferId=i;const n=yield this.pc.createOffer(e);this.log.debug("original offer",Object.assign({sdp:n.sdp},this.logContext));const r=ya.parse((t=n.sdp)!==null&&t!==void 0?t:"");r.media.forEach((e=>{Ra(e);e.type==="audio"?Ea(e,[],[]):e.type==="video"&&this.trackBitrates.some((t=>{if(!e.msid||!t.cid||!e.msid.includes(t.cid))return false;let i=0;e.rtp.some((e=>{if(e.codec.toUpperCase()===t.codec.toUpperCase()){i=e.payload;return true}return false}));if(i===0)return true;Ls(t.codec)&&!Bs()&&this.ensureVideoDDExtensionForSVC(e,r);if(t.codec!=="av1")return true;const n=Math.round(t.maxbr*Ca);for(const t of e.fmtp)if(t.payload===i){t.config.includes("x-google-start-bitrate")||(t.config+=";x-google-start-bitrate=".concat(n));break}return true}))}));if(this.latestOfferId>i){this.log.warn("latestOfferId mismatch",Object.assign(Object.assign({},this.logContext),{latestOfferId:this.latestOfferId,offerId:i}));return}yield this.setMungedSDP(n,ya.write(r));this.onOffer(n,this.latestOfferId)}finally{i()}}))}createAndSetAnswer(){return cn(this,void 0,void 0,(function*(){var e;const t=yield this.pc.createAnswer();const i=ya.parse((e=t.sdp)!==null&&e!==void 0?e:"");i.media.forEach((e=>{Ra(e);e.type==="audio"&&Ea(e,this.remoteStereoMids,this.remoteNackMids)}));yield this.setMungedSDP(t,ya.write(i));return t}))}createDataChannel(e,t){return this.pc.createDataChannel(e,t)}addTransceiver(e,t){return this.pc.addTransceiver(e,t)}addTrack(e){if(!this._pc)throw new UnexpectedConnectionState("PC closed, cannot add track");return this._pc.addTrack(e)}setTrackCodecBitrate(e){this.trackBitrates.push(e)}setConfiguration(e){var t;if(!this._pc)throw new UnexpectedConnectionState("PC closed, cannot configure");return(t=this._pc)===null||t===void 0?void 0:t.setConfiguration(e)}canRemoveTrack(){var e;return!!((e=this._pc)===null||e===void 0?void 0:e.removeTrack)}removeTrack(e){var t;return(t=this._pc)===null||t===void 0?void 0:t.removeTrack(e)}getConnectionState(){var e,t;return(t=(e=this._pc)===null||e===void 0?void 0:e.connectionState)!==null&&t!==void 0?t:"closed"}getICEConnectionState(){var e,t;return(t=(e=this._pc)===null||e===void 0?void 0:e.iceConnectionState)!==null&&t!==void 0?t:"closed"}getSignallingState(){var e,t;return(t=(e=this._pc)===null||e===void 0?void 0:e.signalingState)!==null&&t!==void 0?t:"closed"}getTransceivers(){var e,t;return(t=(e=this._pc)===null||e===void 0?void 0:e.getTransceivers())!==null&&t!==void 0?t:[]}getSenders(){var e,t;return(t=(e=this._pc)===null||e===void 0?void 0:e.getSenders())!==null&&t!==void 0?t:[]}getLocalDescription(){var e;return(e=this._pc)===null||e===void 0?void 0:e.localDescription}getRemoteDescription(){var e;return(e=this.pc)===null||e===void 0?void 0:e.remoteDescription}getStats(){return this.pc.getStats()}getConnectedAddress(){return cn(this,void 0,void 0,(function*(){var e;if(!this._pc)return;let t="";const i=new Map;const n=new Map;const r=yield this._pc.getStats();r.forEach((e=>{switch(e.type){case"transport":t=e.selectedCandidatePairId;break;case"candidate-pair":t===""&&e.selected&&(t=e.id);i.set(e.id,e);break;case"remote-candidate":n.set(e.id,"".concat(e.address,":").concat(e.port));break}}));if(t==="")return;const s=(e=i.get(t))===null||e===void 0?void 0:e.remoteCandidateId;return s!==void 0?n.get(s):void 0}))}setMungedSDP(e,t,i){return cn(this,void 0,void 0,(function*(){if(t){const n=e.sdp;e.sdp=t;try{this.log.debug("setting munged ".concat(i?"remote":"local"," description"),this.logContext);i?yield this.pc.setRemoteDescription(e):yield this.pc.setLocalDescription(e);return}catch(i){this.log.warn("not able to set ".concat(e.type,", falling back to unmodified sdp"),Object.assign(Object.assign({},this.logContext),{error:i,sdp:t}));e.sdp=n}}try{i?yield this.pc.setRemoteDescription(e):yield this.pc.setLocalDescription(e)}catch(t){let n="unknown error";t instanceof Error?n=t.message:typeof t==="string"&&(n=t);const r={error:n,sdp:e.sdp};!i&&this.pc.remoteDescription&&(r.remoteSdp=this.pc.remoteDescription);this.log.error("unable to set ".concat(e.type),Object.assign(Object.assign({},this.logContext),{fields:r}));throw new NegotiationError(n)}}))}ensureVideoDDExtensionForSVC(e,t){var i,n;const r=(i=e.ext)===null||i===void 0?void 0:i.some((e=>e.uri===Rs));if(!r){if(this.ddExtID===0){let e=0;t.media.forEach((t=>{var i;t.type==="video"&&((i=t.ext)===null||i===void 0?void 0:i.forEach((t=>{t.value>e&&(e=t.value)})))}));this.ddExtID=e+1}(n=e.ext)===null||n===void 0?void 0:n.push({value:this.ddExtID,uri:Rs})}}}function Ea(e,t,i){let n=0;e.rtp.some((e=>{if(e.codec==="opus"){n=e.payload;return true}return false}));if(n>0){e.rtcpFb||(e.rtcpFb=[]);i.includes(e.mid)&&!e.rtcpFb.some((e=>e.payload===n&&e.type==="nack"))&&e.rtcpFb.push({payload:n,type:"nack"});t.includes(e.mid)&&e.fmtp.some((e=>{if(e.payload===n){e.config.includes("stereo=1")||(e.config+=";stereo=1");return true}return false}))}}function Pa(e){var t;const i=[];const n=[];const r=ya.parse((t=e.sdp)!==null&&t!==void 0?t:"");let s=0;r.media.forEach((e=>{var t;if(e.type==="audio"){e.rtp.some((e=>{if(e.codec==="opus"){s=e.payload;return true}return false}));((t=e.rtcpFb)===null||t===void 0?void 0:t.some((e=>e.payload===s&&e.type==="nack")))&&n.push(e.mid);e.fmtp.some((t=>{if(t.payload===s){t.config.includes("sprop-stereo=1")&&i.push(e.mid);return true}return false}))}}));return{stereoMids:i,nackMids:n}}function Ra(e){if(e.connection){const t=e.connection.ip.indexOf(":")>=0;if(e.connection.version===4&&t||e.connection.version===6&&!t){e.connection.ip="0.0.0.0";e.connection.version=4}}}const Ia="vp8";const Oa={audioPreset:Cs.music,dtx:true,red:true,forceStereo:false,simulcast:true,screenShareEncoding:Es.h1080fps15.encoding,stopMicTrackOnMute:false,videoCodec:Ia,backupCodec:true,preConnectBuffer:false};const Da={deviceId:{ideal:"default"},autoGainControl:true,echoCancellation:true,noiseSuppression:true,voiceIsolation:true};const xa={deviceId:{ideal:"default"},resolution:Ss.h720.resolution};const Ma={adaptiveStream:false,dynacast:false,stopLocalTrackOnUnpublish:true,reconnectPolicy:new DefaultReconnectPolicy,disconnectOnPageLeave:true,webAudioMix:false};const Aa={autoSubscribe:true,maxRetries:1,peerConnectionTimeout:15e3,websocketTimeout:15e3};var _a;(function(e){e[e.NEW=0]="NEW";e[e.CONNECTING=1]="CONNECTING";e[e.CONNECTED=2]="CONNECTED";e[e.FAILED=3]="FAILED";e[e.CLOSING=4]="CLOSING";e[e.CLOSED=5]="CLOSED"})(_a||(_a={}));class PCTransportManager{get needsPublisher(){return this.isPublisherConnectionRequired}get needsSubscriber(){return this.isSubscriberConnectionRequired}get currentState(){return this.state}constructor(e,t,i){var n;this.peerConnectionTimeout=Aa.peerConnectionTimeout;this.log=Zi;this.updateState=()=>{var e;const t=this.state;const i=this.requiredTransports.map((e=>e.getConnectionState()));i.every((e=>e==="connected"))?this.state=_a.CONNECTED:i.some((e=>e==="failed"))?this.state=_a.FAILED:i.some((e=>e==="connecting"))?this.state=_a.CONNECTING:i.every((e=>e==="closed"))?this.state=_a.CLOSED:i.some((e=>e==="closed"))?this.state=_a.CLOSING:i.every((e=>e==="new"))&&(this.state=_a.NEW);if(t!==this.state){this.log.debug("pc state change: from ".concat(_a[t]," to ").concat(_a[this.state]),this.logContext);(e=this.onStateChange)===null||e===void 0?void 0:e.call(this,this.state,this.publisher.getConnectionState(),this.subscriber.getConnectionState())}};this.log=en((n=i.loggerName)!==null&&n!==void 0?n:Xi.PCManager);this.loggerOptions=i;this.isPublisherConnectionRequired=!t;this.isSubscriberConnectionRequired=t;this.publisher=new PCTransport(e,i);this.subscriber=new PCTransport(e,i);this.publisher.onConnectionStateChange=this.updateState;this.subscriber.onConnectionStateChange=this.updateState;this.publisher.onIceConnectionStateChange=this.updateState;this.subscriber.onIceConnectionStateChange=this.updateState;this.publisher.onSignalingStatechange=this.updateState;this.subscriber.onSignalingStatechange=this.updateState;this.publisher.onIceCandidate=e=>{var t;(t=this.onIceCandidate)===null||t===void 0?void 0:t.call(this,e,Qt.PUBLISHER)};this.subscriber.onIceCandidate=e=>{var t;(t=this.onIceCandidate)===null||t===void 0?void 0:t.call(this,e,Qt.SUBSCRIBER)};this.subscriber.onDataChannel=e=>{var t;(t=this.onDataChannel)===null||t===void 0?void 0:t.call(this,e)};this.subscriber.onTrack=e=>{var t;(t=this.onTrack)===null||t===void 0?void 0:t.call(this,e)};this.publisher.onOffer=(e,t)=>{var i;(i=this.onPublisherOffer)===null||i===void 0?void 0:i.call(this,e,t)};this.state=_a.NEW;this.connectionLock=new _;this.remoteOfferLock=new _}get logContext(){var e,t;return Object.assign({},(t=(e=this.loggerOptions).loggerContextCb)===null||t===void 0?void 0:t.call(e))}requirePublisher(){let e=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];this.isPublisherConnectionRequired=e;this.updateState()}requireSubscriber(){let e=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];this.isSubscriberConnectionRequired=e;this.updateState()}createAndSendPublisherOffer(e){return this.publisher.createAndSendOffer(e)}setPublisherAnswer(e,t){return this.publisher.setRemoteDescription(e,t)}removeTrack(e){return this.publisher.removeTrack(e)}close(){return cn(this,void 0,void 0,(function*(){if(this.publisher&&this.publisher.getSignallingState()!=="closed"){const e=this.publisher;for(const t of e.getSenders())try{e.canRemoveTrack()&&e.removeTrack(t)}catch(e){this.log.warn("could not removeTrack",Object.assign(Object.assign({},this.logContext),{error:e}))}}yield Promise.all([this.publisher.close(),this.subscriber.close()]);this.updateState()}))}triggerIceRestart(){return cn(this,void 0,void 0,(function*(){this.subscriber.restartingIce=true;this.needsPublisher&&(yield this.createAndSendPublisherOffer({iceRestart:true}))}))}addIceCandidate(e,t){return cn(this,void 0,void 0,(function*(){t===Qt.PUBLISHER?yield this.publisher.addIceCandidate(e):yield this.subscriber.addIceCandidate(e)}))}createSubscriberAnswerFromOffer(e,t){return cn(this,void 0,void 0,(function*(){this.log.debug("received server offer",Object.assign(Object.assign({},this.logContext),{RTCSdpType:e.type,sdp:e.sdp,signalingState:this.subscriber.getSignallingState().toString()}));const i=yield this.remoteOfferLock.lock();try{const i=yield this.subscriber.setRemoteDescription(e,t);if(!i)return;const n=yield this.subscriber.createAndSetAnswer();return n}finally{i()}}))}updateConfiguration(e,t){this.publisher.setConfiguration(e);this.subscriber.setConfiguration(e);t&&this.triggerIceRestart()}ensurePCTransportConnection(e,t){return cn(this,void 0,void 0,(function*(){var i;const n=yield this.connectionLock.lock();try{if(this.isPublisherConnectionRequired&&this.publisher.getConnectionState()!=="connected"&&this.publisher.getConnectionState()!=="connecting"){this.log.debug("negotiation required, start negotiating",this.logContext);this.publisher.negotiate()}yield Promise.all((i=this.requiredTransports)===null||i===void 0?void 0:i.map((i=>this.ensureTransportConnected(i,e,t))))}finally{n()}}))}negotiate(e){return cn(this,void 0,void 0,(function*(){return new Promise(((t,i)=>cn(this,void 0,void 0,(function*(){const n=setTimeout((()=>{i("negotiation timed out")}),this.peerConnectionTimeout);const r=()=>{clearTimeout(n);i("negotiation aborted")};e.signal.addEventListener("abort",r);this.publisher.once(wa.NegotiationStarted,(()=>{e.signal.aborted||this.publisher.once(wa.NegotiationComplete,(()=>{clearTimeout(n);t()}))}));yield this.publisher.negotiate((e=>{clearTimeout(n);i(e)}))}))))}))}addPublisherTransceiver(e,t){return this.publisher.addTransceiver(e,t)}addPublisherTrack(e){return this.publisher.addTrack(e)}createPublisherDataChannel(e,t){return this.publisher.createDataChannel(e,t)}getConnectedAddress(e){return e===Qt.PUBLISHER||e===Qt.SUBSCRIBER?this.publisher.getConnectedAddress():this.requiredTransports[0].getConnectedAddress()}get requiredTransports(){const e=[];this.isPublisherConnectionRequired&&e.push(this.publisher);this.isSubscriberConnectionRequired&&e.push(this.subscriber);return e}ensureTransportConnected(e,t){return cn(this,arguments,void 0,(function(e,t){var i=this;let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:this.peerConnectionTimeout;return function*(){const r=e.getConnectionState();if(r!=="connected")return new Promise(((e,r)=>cn(i,void 0,void 0,(function*(){const i=()=>{this.log.warn("abort transport connection",this.logContext);CriticalTimers.clearTimeout(s);r(new ConnectionError("room connection has been cancelled",Qr.Cancelled))};(t===null||t===void 0?void 0:t.signal.aborted)&&i();t===null||t===void 0?void 0:t.signal.addEventListener("abort",i);const s=CriticalTimers.setTimeout((()=>{t===null||t===void 0?void 0:t.signal.removeEventListener("abort",i);r(new ConnectionError("could not establish pc connection",Qr.InternalError))}),n);while(this.state!==_a.CONNECTED){yield Os(50);if(t===null||t===void 0?void 0:t.signal.aborted){r(new ConnectionError("room connection has been cancelled",Qr.Cancelled));return}}CriticalTimers.clearTimeout(s);t===null||t===void 0?void 0:t.signal.removeEventListener("abort",i);e()}))))}()}))}}class RpcError extends Error{constructor(e,t,i){super(t);this.code=e;this.message=Ua(t,RpcError.MAX_MESSAGE_BYTES);this.data=i?Ua(i,RpcError.MAX_DATA_BYTES):void 0}static fromProto(e){return new RpcError(e.code,e.message,e.data)}toProto(){return new At({code:this.code,message:this.message,data:this.data})}static builtIn(e,t){return new RpcError(RpcError.ErrorCode[e],RpcError.ErrorMessage[e],t)}}RpcError.MAX_MESSAGE_BYTES=256;RpcError.MAX_DATA_BYTES=15360;RpcError.ErrorCode={APPLICATION_ERROR:1500,CONNECTION_TIMEOUT:1501,RESPONSE_TIMEOUT:1502,RECIPIENT_DISCONNECTED:1503,RESPONSE_PAYLOAD_TOO_LARGE:1504,SEND_FAILED:1505,UNSUPPORTED_METHOD:1400,RECIPIENT_NOT_FOUND:1401,REQUEST_PAYLOAD_TOO_LARGE:1402,UNSUPPORTED_SERVER:1403,UNSUPPORTED_VERSION:1404};RpcError.ErrorMessage={APPLICATION_ERROR:"Application error in method handler",CONNECTION_TIMEOUT:"Connection timeout",RESPONSE_TIMEOUT:"Response timeout",RECIPIENT_DISCONNECTED:"Recipient disconnected",RESPONSE_PAYLOAD_TOO_LARGE:"Response payload too large",SEND_FAILED:"Failed to send",UNSUPPORTED_METHOD:"Method not supported at destination",RECIPIENT_NOT_FOUND:"Recipient not found",REQUEST_PAYLOAD_TOO_LARGE:"Request payload too large",UNSUPPORTED_SERVER:"RPC not supported by server",UNSUPPORTED_VERSION:"Unsupported RPC version"};const Na=15360;function La(e){const t=new TextEncoder;return t.encode(e).length}function Ua(e,t){if(La(e)<=t)return e;let i=0;let n=e.length;const r=new TextEncoder;while(i<n){const s=Math.floor((i+n+1)/2);r.encode(e.slice(0,s)).length<=t?i=s:n=s-1}return e.slice(0,i)}const ja=2e3;function Fa(e,t){if(!t)return 0;let i;let n;if("bytesReceived"in e){i=e.bytesReceived;n=t.bytesReceived}else if("bytesSent"in e){i=e.bytesSent;n=t.bytesSent}return i===void 0||n===void 0||e.timestamp===void 0||t.timestamp===void 0?0:8*(i-n)*1e3/(e.timestamp-t.timestamp)}const Ba=typeof MediaRecorder!=="undefined";class FallbackRecorder{constructor(){throw new Error("MediaRecorder is not available in this environment")}}const Va=Ba?MediaRecorder:FallbackRecorder;class LocalTrackRecorder extends Va{constructor(e,t){if(!Ba)throw new Error("MediaRecorder is not available in this environment");super(new MediaStream([e.mediaStreamTrack]),t);let i;let n;const r=()=>n===void 0;const s=()=>{this.removeEventListener("dataavailable",i);this.removeEventListener("stop",s);this.removeEventListener("error",o);n===null||n===void 0?void 0:n.close();n=void 0};const o=e=>{n===null||n===void 0?void 0:n.error(e);this.removeEventListener("dataavailable",i);this.removeEventListener("stop",s);this.removeEventListener("error",o);n=void 0};this.byteStream=new ReadableStream({start:e=>{n=e;i=t=>cn(this,void 0,void 0,(function*(){let i;if(t.data.arrayBuffer){const e=yield t.data.arrayBuffer();i=new Uint8Array(e)}else{if(!t.data.byteArray)throw new Error("no data available!");i=t.data.byteArray}r()||e.enqueue(i)}));this.addEventListener("dataavailable",i)},cancel:()=>{s()}});this.addEventListener("stop",s);this.addEventListener("error",o)}}function qa(){return Ba}const Ha=1e3;const Wa=1e4;class LocalTrack extends Track{get sender(){return this._sender}set sender(e){this._sender=e}get constraints(){return this._constraints}get hasPreConnectBuffer(){return!!this.localTrackRecorder}
/**
   *
   * @param mediaTrack
   * @param kind
   * @param constraints MediaTrackConstraints that are being used when restarting or reacquiring tracks
   * @param userProvidedTrack Signals to the SDK whether or not the mediaTrack should be managed (i.e. released and reacquired) internally by the SDK
   */constructor(e,t,i){let n=arguments.length>3&&arguments[3]!==void 0&&arguments[3];let r=arguments.length>4?arguments[4]:void 0;super(e,t,r);this.manuallyStopped=false;this._isUpstreamPaused=false;this.handleTrackMuteEvent=()=>this.debouncedTrackMuteHandler().catch((()=>this.log.debug("track mute bounce got cancelled by an unmute event",this.logContext)));this.debouncedTrackMuteHandler=Ta((()=>cn(this,void 0,void 0,(function*(){yield this.pauseUpstream()}))),5e3);this.handleTrackUnmuteEvent=()=>cn(this,void 0,void 0,(function*(){this.debouncedTrackMuteHandler.cancel("unmute");yield this.resumeUpstream()}));this.handleEnded=()=>{this.isInBackground&&(this.reacquireTrack=true);this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent);this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent);this.emit(is.Ended,this)};this.reacquireTrack=false;this.providedByUser=n;this.muteLock=new _;this.pauseUpstreamLock=new _;this.trackChangeLock=new _;this.trackChangeLock.lock().then((t=>cn(this,void 0,void 0,(function*(){try{yield this.setMediaStreamTrack(e,true)}finally{t()}}))));this._constraints=e.getConstraints();i&&(this._constraints=i)}get id(){return this._mediaStreamTrack.id}get dimensions(){if(this.kind!==Track.Kind.Video)return;const{width:e,height:t}=this._mediaStreamTrack.getSettings();return e&&t?{width:e,height:t}:void 0}get isUpstreamPaused(){return this._isUpstreamPaused}get isUserProvided(){return this.providedByUser}get mediaStreamTrack(){var e,t;return(t=(e=this.processor)===null||e===void 0?void 0:e.processedTrack)!==null&&t!==void 0?t:this._mediaStreamTrack}get isLocal(){return true}getSourceTrackSettings(){return this._mediaStreamTrack.getSettings()}setMediaStreamTrack(e,t){return cn(this,void 0,void 0,(function*(){var i;if(e===this._mediaStreamTrack&&!t)return;if(this._mediaStreamTrack){this.attachedElements.forEach((e=>{vs(this._mediaStreamTrack,e)}));this.debouncedTrackMuteHandler.cancel("new-track");this._mediaStreamTrack.removeEventListener("ended",this.handleEnded);this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent);this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent)}this.mediaStream=new MediaStream([e]);if(e){e.addEventListener("ended",this.handleEnded);e.addEventListener("mute",this.handleTrackMuteEvent);e.addEventListener("unmute",this.handleTrackUnmuteEvent);this._constraints=e.getConstraints()}let n;if(this.processor&&e){this.log.debug("restarting processor",this.logContext);if(this.kind==="unknown")throw TypeError("cannot set processor on track of unknown kind");if(this.processorElement){fs(e,this.processorElement);this.processorElement.muted=true}yield this.processor.restart({track:e,kind:this.kind,element:this.processorElement});n=this.processor.processedTrack}this.sender&&((i=this.sender.transport)===null||i===void 0?void 0:i.state)!=="closed"&&(yield this.sender.replaceTrack(n!==null&&n!==void 0?n:e));this.providedByUser||this._mediaStreamTrack===e||this._mediaStreamTrack.stop();this._mediaStreamTrack=e;if(e){this._mediaStreamTrack.enabled=!this.isMuted;yield this.resumeUpstream();this.attachedElements.forEach((t=>{fs(n!==null&&n!==void 0?n:e,t)}))}}))}waitForDimensions(){return cn(this,arguments,void 0,(function(){var e=this;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Ha;return function*(){var i;if(e.kind===Track.Kind.Audio)throw new Error("cannot get dimensions for audio tracks");((i=os())===null||i===void 0?void 0:i.os)==="iOS"&&(yield Os(10));const n=Date.now();while(Date.now()-n<t){const t=e.dimensions;if(t)return t;yield Os(50)}throw new TrackInvalidError("unable to get track dimensions after timeout")}()}))}setDeviceId(e){return cn(this,void 0,void 0,(function*(){if(this._constraints.deviceId===e&&this._mediaStreamTrack.getSettings().deviceId===mo(e))return true;this._constraints.deviceId=e;if(this.isMuted)return true;yield this.restartTrack();return mo(e)===this._mediaStreamTrack.getSettings().deviceId}))}
/**
   * @returns DeviceID of the device that is currently being used for this track
   */getDeviceId(){return cn(this,arguments,void 0,(function(){var e=this;let t=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];return function*(){if(e.source===Track.Source.ScreenShare)return;const{deviceId:i,groupId:n}=e._mediaStreamTrack.getSettings();const r=e.kind===Track.Kind.Audio?"audioinput":"videoinput";return t?DeviceManager.getInstance().normalizeDeviceId(r,i,n):i}()}))}mute(){return cn(this,void 0,void 0,(function*(){this.setTrackMuted(true);return this}))}unmute(){return cn(this,void 0,void 0,(function*(){this.setTrackMuted(false);return this}))}replaceTrack(e,t){return cn(this,void 0,void 0,(function*(){const i=yield this.trackChangeLock.lock();try{if(!this.sender)throw new TrackInvalidError("unable to replace an unpublished track");let i;let n;if(typeof t==="boolean")i=t;else if(t!==void 0){i=t.userProvidedTrack;n=t.stopProcessor}this.providedByUser=i===null||i===void 0||i;this.log.debug("replace MediaStreamTrack",this.logContext);yield this.setMediaStreamTrack(e);n&&this.processor&&(yield this.internalStopProcessor());return this}finally{i()}}))}restart(e){return cn(this,void 0,void 0,(function*(){this.manuallyStopped=false;const t=yield this.trackChangeLock.lock();try{e||(e=this._constraints);const{deviceId:t,facingMode:i}=e,n=an(e,["deviceId","facingMode"]);this.log.debug("restarting track with constraints",Object.assign(Object.assign({},this.logContext),{constraints:e}));const r={audio:false,video:false};this.kind===Track.Kind.Video?r.video=!t&&!i||{deviceId:t,facingMode:i}:r.audio=!t||Object.assign({deviceId:t},n);this.attachedElements.forEach((e=>{vs(this.mediaStreamTrack,e)}));this._mediaStreamTrack.removeEventListener("ended",this.handleEnded);this._mediaStreamTrack.stop();const s=yield navigator.mediaDevices.getUserMedia(r);const o=s.getTracks()[0];this.kind===Track.Kind.Video&&(yield o.applyConstraints(n));o.addEventListener("ended",this.handleEnded);this.log.debug("re-acquired MediaStreamTrack",this.logContext);yield this.setMediaStreamTrack(o);this._constraints=e;this.emit(is.Restarted,this);if(this.manuallyStopped){this.log.warn("track was stopped during a restart, stopping restarted track",this.logContext);this.stop()}return this}finally{t()}}))}setTrackMuted(e){this.log.debug("setting ".concat(this.kind," track ").concat(e?"muted":"unmuted"),this.logContext);if(this.isMuted!==e||this._mediaStreamTrack.enabled===e){this.isMuted=e;this._mediaStreamTrack.enabled=!e;this.emit(e?is.Muted:is.Unmuted,this)}}get needsReAcquisition(){return this._mediaStreamTrack.readyState!=="live"||this._mediaStreamTrack.muted||!this._mediaStreamTrack.enabled||this.reacquireTrack}handleAppVisibilityChanged(){const e=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return cn(this,void 0,void 0,(function*(){yield e.handleAppVisibilityChanged.call(this);if(Ws()){this.log.debug("visibility changed, is in Background: ".concat(this.isInBackground),this.logContext);if(!this.isInBackground&&this.needsReAcquisition&&!this.isUserProvided&&!this.isMuted){this.log.debug("track needs to be reacquired, restarting ".concat(this.source),this.logContext);yield this.restart();this.reacquireTrack=false}}}))}stop(){var e;this.manuallyStopped=true;super.stop();this._mediaStreamTrack.removeEventListener("ended",this.handleEnded);this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent);this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent);(e=this.processor)===null||e===void 0?void 0:e.destroy();this.processor=void 0}pauseUpstream(){return cn(this,void 0,void 0,(function*(){var e;const t=yield this.pauseUpstreamLock.lock();try{if(this._isUpstreamPaused===true)return;if(!this.sender){this.log.warn("unable to pause upstream for an unpublished track",this.logContext);return}this._isUpstreamPaused=true;this.emit(is.UpstreamPaused,this);const t=os();if((t===null||t===void 0?void 0:t.name)==="Safari"&&Zs(t.version,"12.0")<0)throw new DeviceUnsupportedError("pauseUpstream is not supported on Safari < 12.");((e=this.sender.transport)===null||e===void 0?void 0:e.state)!=="closed"&&(yield this.sender.replaceTrack(null))}finally{t()}}))}resumeUpstream(){return cn(this,void 0,void 0,(function*(){var e;const t=yield this.pauseUpstreamLock.lock();try{if(this._isUpstreamPaused===false)return;if(!this.sender){this.log.warn("unable to resume upstream for an unpublished track",this.logContext);return}this._isUpstreamPaused=false;this.emit(is.UpstreamResumed,this);((e=this.sender.transport)===null||e===void 0?void 0:e.state)!=="closed"&&(yield this.sender.replaceTrack(this.mediaStreamTrack))}finally{t()}}))}
/**
   * Gets the RTCStatsReport for the LocalTrack's underlying RTCRtpSender
   * See https://developer.mozilla.org/en-US/docs/Web/API/RTCStatsReport
   *
   * @returns Promise<RTCStatsReport> | undefined
   */getRTCStatsReport(){return cn(this,void 0,void 0,(function*(){var e;if(!((e=this.sender)===null||e===void 0?void 0:e.getStats))return;const t=yield this.sender.getStats();return t}))}
/**
   * Sets a processor on this track.
   * See https://github.com/livekit/track-processors-js for example usage
   *
   * @experimental
   *
   * @param processor
   * @param showProcessedStreamLocally
   * @returns
   */setProcessor(e){return cn(this,arguments,void 0,(function(e){var t=this;let i=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];return function*(){var n;const r=yield t.trackChangeLock.lock();try{t.log.debug("setting up processor",t.logContext);const r=document.createElement(t.kind);const s={kind:t.kind,track:t._mediaStreamTrack,element:r,audioContext:t.audioContext};yield e.init(s);t.log.debug("processor initialized",t.logContext);t.processor&&(yield t.internalStopProcessor());if(t.kind==="unknown")throw TypeError("cannot set processor on track of unknown kind");fs(t._mediaStreamTrack,r);r.muted=true;r.play().catch((e=>{if(e instanceof DOMException&&e.name==="AbortError"){t.log.warn("failed to play processor element, retrying",Object.assign(Object.assign({},t.logContext),{error:e}));setTimeout((()=>{r.play().catch((e=>{t.log.error("failed to play processor element",Object.assign(Object.assign({},t.logContext),{err:e}))}))}),100)}else t.log.error("failed to play processor element",Object.assign(Object.assign({},t.logContext),{error:e}))}));t.processor=e;t.processorElement=r;if(t.processor.processedTrack){for(const e of t.attachedElements)if(e!==t.processorElement&&i){vs(t._mediaStreamTrack,e);fs(t.processor.processedTrack,e)}yield(n=t.sender)===null||n===void 0?void 0:n.replaceTrack(t.processor.processedTrack)}t.emit(is.TrackProcessorUpdate,t.processor)}finally{r()}}()}))}getProcessor(){return this.processor}
/**
   * Stops the track processor
   * See https://github.com/livekit/track-processors-js for example usage
   *
   * @experimental
   * @returns
   */stopProcessor(){return cn(this,arguments,void 0,(function(){var e=this;let t=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];return function*(){const i=yield e.trackChangeLock.lock();try{yield e.internalStopProcessor(t)}finally{i()}}()}))}internalStopProcessor(){return cn(this,arguments,void 0,(function(){var e=this;let t=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];return function*(){var i,n;if(e.processor){e.log.debug("stopping processor",e.logContext);(i=e.processor.processedTrack)===null||i===void 0?void 0:i.stop();yield e.processor.destroy();e.processor=void 0;if(!t){(n=e.processorElement)===null||n===void 0?void 0:n.remove();e.processorElement=void 0}yield e._mediaStreamTrack.applyConstraints(e._constraints);yield e.setMediaStreamTrack(e._mediaStreamTrack,true);e.emit(is.TrackProcessorUpdate)}}()}))}startPreConnectBuffer(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:100;if(qa())if(this.localTrackRecorder)this.log.warn("preconnect buffer already started");else{{let e="audio/webm;codecs=opus";MediaRecorder.isTypeSupported(e)||(e="video/mp4");this.localTrackRecorder=new LocalTrackRecorder(this,{mimeType:e})}this.localTrackRecorder.start(e);this.autoStopPreConnectBuffer=setTimeout((()=>{this.log.warn("preconnect buffer timed out, stopping recording automatically",this.logContext);this.stopPreConnectBuffer()}),Wa)}else this.log.warn("MediaRecorder is not available, cannot start preconnect buffer",this.logContext)}stopPreConnectBuffer(){clearTimeout(this.autoStopPreConnectBuffer);if(this.localTrackRecorder){this.localTrackRecorder.stop();this.localTrackRecorder=void 0}}getPreConnectBuffer(){var e;return(e=this.localTrackRecorder)===null||e===void 0?void 0:e.byteStream}getPreConnectBufferMimeType(){var e;return(e=this.localTrackRecorder)===null||e===void 0?void 0:e.mimeType}}class LocalAudioTrack extends LocalTrack{get enhancedNoiseCancellation(){return this.isKrispNoiseFilterEnabled}
/**
   *
   * @param mediaTrack
   * @param constraints MediaTrackConstraints that are being used when restarting or reacquiring tracks
   * @param userProvidedTrack Signals to the SDK whether or not the mediaTrack should be managed (i.e. released and reacquired) internally by the SDK
   */constructor(e,t){let i=!(arguments.length>2&&arguments[2]!==void 0)||arguments[2];let n=arguments.length>3?arguments[3]:void 0;let r=arguments.length>4?arguments[4]:void 0;super(e,Track.Kind.Audio,t,i,r);this.stopOnMute=false;this.isKrispNoiseFilterEnabled=false;this.monitorSender=()=>cn(this,void 0,void 0,(function*(){if(!this.sender){this._currentBitrate=0;return}let e;try{e=yield this.getSenderStats()}catch(e){this.log.error("could not get audio sender stats",Object.assign(Object.assign({},this.logContext),{error:e}));return}e&&this.prevStats&&(this._currentBitrate=Fa(e,this.prevStats));this.prevStats=e}));this.handleKrispNoiseFilterEnable=()=>{this.isKrispNoiseFilterEnabled=true;this.log.debug("Krisp noise filter enabled",this.logContext);this.emit(is.AudioTrackFeatureUpdate,this,dt.TF_ENHANCED_NOISE_CANCELLATION,true)};this.handleKrispNoiseFilterDisable=()=>{this.isKrispNoiseFilterEnabled=false;this.log.debug("Krisp noise filter disabled",this.logContext);this.emit(is.AudioTrackFeatureUpdate,this,dt.TF_ENHANCED_NOISE_CANCELLATION,false)};this.audioContext=n;this.checkForSilence()}mute(){const e=Object.create(null,{mute:{get:()=>super.mute}});return cn(this,void 0,void 0,(function*(){const t=yield this.muteLock.lock();try{if(this.isMuted){this.log.debug("Track already muted",this.logContext);return this}if(this.source===Track.Source.Microphone&&this.stopOnMute&&!this.isUserProvided){this.log.debug("stopping mic track",this.logContext);this._mediaStreamTrack.stop()}yield e.mute.call(this);return this}finally{t()}}))}unmute(){const e=Object.create(null,{unmute:{get:()=>super.unmute}});return cn(this,void 0,void 0,(function*(){const t=yield this.muteLock.lock();try{if(!this.isMuted){this.log.debug("Track already unmuted",this.logContext);return this}const t=this._constraints.deviceId&&this._mediaStreamTrack.getSettings().deviceId!==mo(this._constraints.deviceId);if(this.source===Track.Source.Microphone&&(this.stopOnMute||this._mediaStreamTrack.readyState==="ended"||t)&&!this.isUserProvided){this.log.debug("reacquiring mic track",this.logContext);yield this.restartTrack()}yield e.unmute.call(this);return this}finally{t()}}))}restartTrack(e){return cn(this,void 0,void 0,(function*(){let t;if(e){const i=No({audio:e});typeof i.audio!=="boolean"&&(t=i.audio)}yield this.restart(t)}))}restart(e){const t=Object.create(null,{restart:{get:()=>super.restart}});return cn(this,void 0,void 0,(function*(){const i=yield t.restart.call(this,e);this.checkForSilence();return i}))}startMonitor(){Gs()&&(this.monitorInterval||(this.monitorInterval=setInterval((()=>{this.monitorSender()}),ja)))}setProcessor(e){return cn(this,void 0,void 0,(function*(){var t;const i=yield this.trackChangeLock.lock();try{if(!zs()&&!this.audioContext)throw Error("Audio context needs to be set on LocalAudioTrack in order to enable processors");this.processor&&(yield this.internalStopProcessor());const i={kind:this.kind,track:this._mediaStreamTrack,audioContext:this.audioContext};this.log.debug("setting up audio processor ".concat(e.name),this.logContext);yield e.init(i);this.processor=e;if(this.processor.processedTrack){yield(t=this.sender)===null||t===void 0?void 0:t.replaceTrack(this.processor.processedTrack);this.processor.processedTrack.addEventListener("enable-lk-krisp-noise-filter",this.handleKrispNoiseFilterEnable);this.processor.processedTrack.addEventListener("disable-lk-krisp-noise-filter",this.handleKrispNoiseFilterDisable)}this.emit(is.TrackProcessorUpdate,this.processor)}finally{i()}}))}setAudioContext(e){this.audioContext=e}getSenderStats(){return cn(this,void 0,void 0,(function*(){var e;if(!((e=this.sender)===null||e===void 0?void 0:e.getStats))return;const t=yield this.sender.getStats();let i;t.forEach((e=>{e.type==="outbound-rtp"&&(i={type:"audio",streamId:e.id,packetsSent:e.packetsSent,packetsLost:e.packetsLost,bytesSent:e.bytesSent,timestamp:e.timestamp,roundTripTime:e.roundTripTime,jitter:e.jitter})}));return i}))}checkForSilence(){return cn(this,void 0,void 0,(function*(){const e=yield Lo(this);if(e){this.isMuted||this.log.warn("silence detected on local audio track",this.logContext);this.emit(is.AudioSilenceDetected)}return e}))}}function Ka(e,t,i){switch(e.kind){case"audio":return new LocalAudioTrack(e,t,false,void 0,i);case"video":return new LocalVideoTrack(e,t,false,i);default:throw new TrackInvalidError("unsupported track type: ".concat(e.kind))}}const Ga=Object.values(Ss);const za=Object.values(ws);const Ja=Object.values(Es);const Qa=[Ss.h180,Ss.h360];const Ya=[ws.h180,ws.h360];const Xa=e=>{const t=[{scaleResolutionDownBy:2,fps:e.encoding.maxFramerate}];return t.map((t=>{var i,n;return new VideoPreset(Math.floor(e.width/t.scaleResolutionDownBy),Math.floor(e.height/t.scaleResolutionDownBy),Math.max(15e4,Math.floor(e.encoding.maxBitrate/(Math.pow(t.scaleResolutionDownBy,2)*(((i=e.encoding.maxFramerate)!==null&&i!==void 0?i:30)/((n=t.fps)!==null&&n!==void 0?n:30))))),t.fps,e.encoding.priority)}))};const Za=["q","h","f"];function $a(e,t,i,n){var r,s;let o=n===null||n===void 0?void 0:n.videoEncoding;e&&(o=n===null||n===void 0?void 0:n.screenShareEncoding);const a=n===null||n===void 0?void 0:n.simulcast;const c=n===null||n===void 0?void 0:n.scalabilityMode;const d=n===null||n===void 0?void 0:n.videoCodec;if(!o&&!a&&!c||!t||!i)return[{}];if(!o){o=tc(e,t,i,d);Zi.debug("using video encoding",o)}const l=o.maxFramerate;const u=new VideoPreset(t,i,o.maxBitrate,o.maxFramerate,o.priority);if(c&&Ls(d)){const e=new ScalabilityMode(c);const t=[];if(e.spatial>3)throw new Error("unsupported scalabilityMode: ".concat(c));const i=os();if(Vs()||zs()||(i===null||i===void 0?void 0:i.name)==="Chrome"&&Zs(i===null||i===void 0?void 0:i.version,"113")<0){const n=e.suffix=="h"?2:3;const r=Hs(i);for(let i=0;i<e.spatial;i+=1)t.push({rid:Za[2-i],maxBitrate:o.maxBitrate/Math.pow(n,i),maxFramerate:u.encoding.maxFramerate,scaleResolutionDownBy:r?Math.pow(2,i):void 0});t[0].scalabilityMode=c}else t.push({maxBitrate:o.maxBitrate,maxFramerate:u.encoding.maxFramerate,scalabilityMode:c});if(u.encoding.priority){t[0].priority=u.encoding.priority;t[0].networkPriority=u.encoding.priority}Zi.debug("using svc encoding",{encodings:t});return t}if(!a)return[o];let h=[];h=e?(r=sc(n===null||n===void 0?void 0:n.screenShareSimulcastLayers))!==null&&r!==void 0?r:nc(e,u):(s=sc(n===null||n===void 0?void 0:n.videoSimulcastLayers))!==null&&s!==void 0?s:nc(e,u);let p;if(h.length>0){const e=h[0];h.length>1&&([,p]=h);const n=Math.max(t,i);if(n>=960&&p)return rc(t,i,[e,p,u],l);if(n>=480)return rc(t,i,[e,u],l)}return rc(t,i,[u])}function ec(e,t,i){var n,r,s,o;if(!i.backupCodec||i.backupCodec===true||i.backupCodec.codec===i.videoCodec)return;t!==i.backupCodec.codec&&Zi.warn("requested a different codec than specified as backup",{serverRequested:t,backup:i.backupCodec.codec});i.videoCodec=t;i.videoEncoding=i.backupCodec.encoding;const a=e.mediaStreamTrack.getSettings();const c=(n=a.width)!==null&&n!==void 0?n:(r=e.dimensions)===null||r===void 0?void 0:r.width;const d=(s=a.height)!==null&&s!==void 0?s:(o=e.dimensions)===null||o===void 0?void 0:o.height;e.source===Track.Source.ScreenShare&&i.simulcast&&(i.simulcast=false);const l=$a(e.source===Track.Source.ScreenShare,c,d,i);return l}function tc(e,t,i,n){const r=ic(e,t,i);let{encoding:s}=r[0];const o=Math.max(t,i);for(let e=0;e<r.length;e+=1){const t=r[e];s=t.encoding;if(t.width>=o)break}if(n)switch(n){case"av1":case"h265":s=Object.assign({},s);s.maxBitrate=s.maxBitrate*.7;break;case"vp9":s=Object.assign({},s);s.maxBitrate=s.maxBitrate*.85;break}return s}function ic(e,t,i){if(e)return Ja;const n=t>i?t/i:i/t;return Math.abs(n-16/9)<Math.abs(n-4/3)?Ga:za}function nc(e,t){if(e)return Xa(t);const{width:i,height:n}=t;const r=i>n?i/n:n/i;return Math.abs(r-16/9)<Math.abs(r-4/3)?Qa:Ya}function rc(e,t,i,n){const r=[];i.forEach(((i,s)=>{if(s>=Za.length)return;const o=Math.min(e,t);const a=Za[s];const c={rid:a,scaleResolutionDownBy:Math.max(1,o/Math.min(i.width,i.height)),maxBitrate:i.encoding.maxBitrate};const d=n&&i.encoding.maxFramerate?Math.min(n,i.encoding.maxFramerate):i.encoding.maxFramerate;d&&(c.maxFramerate=d);const l=Fs()||s===0;if(i.encoding.priority&&l){c.priority=i.encoding.priority;c.networkPriority=i.encoding.priority}r.push(c)}));if(zs()&&Ys()==="ios"){let e;r.forEach((t=>{e?t.maxFramerate&&t.maxFramerate>e&&(e=t.maxFramerate):e=t.maxFramerate}));let t=true;r.forEach((i=>{var n;if(i.maxFramerate!=e){if(t){t=false;Zi.info("Simulcast on iOS React-Native requires all encodings to share the same framerate.")}Zi.info('Setting framerate of encoding "'.concat((n=i.rid)!==null&&n!==void 0?n:"",'" to ').concat(e));i.maxFramerate=e}}))}return r}function sc(e){if(e)return e.sort(((e,t)=>{const{encoding:i}=e;const{encoding:n}=t;return i.maxBitrate>n.maxBitrate?1:i.maxBitrate<n.maxBitrate?-1:i.maxBitrate===n.maxBitrate&&i.maxFramerate&&n.maxFramerate?i.maxFramerate>n.maxFramerate?1:-1:0}))}class ScalabilityMode{constructor(e){const t=e.match(/^L(\d)T(\d)(h|_KEY|_KEY_SHIFT){0,1}$/);if(!t)throw new Error("invalid scalability mode");this.spatial=parseInt(t[1]);this.temporal=parseInt(t[2]);if(t.length>3)switch(t[3]){case"h":case"_KEY":case"_KEY_SHIFT":this.suffix=t[3]}}toString(){var e;return"L".concat(this.spatial,"T").concat(this.temporal).concat((e=this.suffix)!==null&&e!==void 0?e:"")}}function oc(e){return e.source===Track.Source.ScreenShare||e.constraints.height&&mo(e.constraints.height)>=1080?"maintain-resolution":"balanced"}const ac=5e3;class LocalVideoTrack extends LocalTrack{get sender(){return this._sender}set sender(e){this._sender=e;this.degradationPreference&&this.setDegradationPreference(this.degradationPreference)}
/**
   *
   * @param mediaTrack
   * @param constraints MediaTrackConstraints that are being used when restarting or reacquiring tracks
   * @param userProvidedTrack Signals to the SDK whether or not the mediaTrack should be managed (i.e. released and reacquired) internally by the SDK
   */constructor(e,t){let i=!(arguments.length>2&&arguments[2]!==void 0)||arguments[2];let n=arguments.length>3?arguments[3]:void 0;super(e,Track.Kind.Video,t,i,n);this.simulcastCodecs=new Map;this.degradationPreference="balanced";this.isCpuConstrained=false;this.optimizeForPerformance=false;this.monitorSender=()=>cn(this,void 0,void 0,(function*(){if(!this.sender){this._currentBitrate=0;return}let e;try{e=yield this.getSenderStats()}catch(e){this.log.error("could not get video sender stats",Object.assign(Object.assign({},this.logContext),{error:e}));return}const t=new Map(e.map((e=>[e.rid,e])));const i=e.some((e=>e.qualityLimitationReason==="cpu"));if(i!==this.isCpuConstrained){this.isCpuConstrained=i;this.isCpuConstrained&&this.emit(is.CpuConstrained)}if(this.prevStats){let e=0;t.forEach(((t,i)=>{var n;const r=(n=this.prevStats)===null||n===void 0?void 0:n.get(i);e+=Fa(t,r)}));this._currentBitrate=e}this.prevStats=t}));this.senderLock=new _}get isSimulcast(){return!!(this.sender&&this.sender.getParameters().encodings.length>1)}startMonitor(e){var t;this.signalClient=e;if(!Gs())return;const i=(t=this.sender)===null||t===void 0?void 0:t.getParameters();i&&(this.encodings=i.encodings);this.monitorInterval||(this.monitorInterval=setInterval((()=>{this.monitorSender()}),ja))}stop(){this._mediaStreamTrack.getConstraints();this.simulcastCodecs.forEach((e=>{e.mediaStreamTrack.stop()}));super.stop()}pauseUpstream(){const e=Object.create(null,{pauseUpstream:{get:()=>super.pauseUpstream}});return cn(this,void 0,void 0,(function*(){var t,i,n,r;var s;yield e.pauseUpstream.call(this);try{for(var o,a=true,c=ln(this.simulcastCodecs.values());o=yield c.next(),t=o.done,!t;a=true){r=o.value;a=false;const e=r;yield(s=e.sender)===null||s===void 0?void 0:s.replaceTrack(null)}}catch(e){i={error:e}}finally{try{a||t||!(n=c.return)||(yield n.call(c))}finally{if(i)throw i.error}}}))}resumeUpstream(){const e=Object.create(null,{resumeUpstream:{get:()=>super.resumeUpstream}});return cn(this,void 0,void 0,(function*(){var t,i,n,r;var s;yield e.resumeUpstream.call(this);try{for(var o,a=true,c=ln(this.simulcastCodecs.values());o=yield c.next(),t=o.done,!t;a=true){r=o.value;a=false;const e=r;yield(s=e.sender)===null||s===void 0?void 0:s.replaceTrack(e.mediaStreamTrack)}}catch(e){i={error:e}}finally{try{a||t||!(n=c.return)||(yield n.call(c))}finally{if(i)throw i.error}}}))}mute(){const e=Object.create(null,{mute:{get:()=>super.mute}});return cn(this,void 0,void 0,(function*(){const t=yield this.muteLock.lock();try{if(this.isMuted){this.log.debug("Track already muted",this.logContext);return this}if(this.source===Track.Source.Camera&&!this.isUserProvided){this.log.debug("stopping camera track",this.logContext);this._mediaStreamTrack.stop()}yield e.mute.call(this);return this}finally{t()}}))}unmute(){const e=Object.create(null,{unmute:{get:()=>super.unmute}});return cn(this,void 0,void 0,(function*(){const t=yield this.muteLock.lock();try{if(!this.isMuted){this.log.debug("Track already unmuted",this.logContext);return this}if(this.source===Track.Source.Camera&&!this.isUserProvided){this.log.debug("reacquiring camera track",this.logContext);yield this.restartTrack()}yield e.unmute.call(this);return this}finally{t()}}))}setTrackMuted(e){super.setTrackMuted(e);for(const t of this.simulcastCodecs.values())t.mediaStreamTrack.enabled=!e}getSenderStats(){return cn(this,void 0,void 0,(function*(){var e;if(!((e=this.sender)===null||e===void 0?void 0:e.getStats))return[];const t=[];const i=yield this.sender.getStats();i.forEach((e=>{var n;if(e.type==="outbound-rtp"){const r={type:"video",streamId:e.id,frameHeight:e.frameHeight,frameWidth:e.frameWidth,framesPerSecond:e.framesPerSecond,framesSent:e.framesSent,firCount:e.firCount,pliCount:e.pliCount,nackCount:e.nackCount,packetsSent:e.packetsSent,bytesSent:e.bytesSent,qualityLimitationReason:e.qualityLimitationReason,qualityLimitationDurations:e.qualityLimitationDurations,qualityLimitationResolutionChanges:e.qualityLimitationResolutionChanges,rid:(n=e.rid)!==null&&n!==void 0?n:e.id,retransmittedPacketsSent:e.retransmittedPacketsSent,targetBitrate:e.targetBitrate,timestamp:e.timestamp};const s=i.get(e.remoteId);if(s){r.jitter=s.jitter;r.packetsLost=s.packetsLost;r.roundTripTime=s.roundTripTime}t.push(r)}}));t.sort(((e,t)=>{var i,n;return((i=t.frameWidth)!==null&&i!==void 0?i:0)-((n=e.frameWidth)!==null&&n!==void 0?n:0)}));return t}))}setPublishingQuality(e){const t=[];for(let i=gs.LOW;i<=gs.HIGH;i+=1)t.push(new Ei({quality:i,enabled:i<=e}));this.log.debug("setting publishing quality. max quality ".concat(e),this.logContext);this.setPublishingLayers(Ls(this.codec),t)}restartTrack(e){return cn(this,void 0,void 0,(function*(){var t,i,n,r;var s;let o;if(e){const t=No({video:e});typeof t.video!=="boolean"&&(o=t.video)}yield this.restart(o);this.isCpuConstrained=false;try{for(var a,c=true,d=ln(this.simulcastCodecs.values());a=yield d.next(),t=a.done,!t;c=true){r=a.value;c=false;const e=r;if(e.sender&&((s=e.sender.transport)===null||s===void 0?void 0:s.state)!=="closed"){e.mediaStreamTrack=this.mediaStreamTrack.clone();yield e.sender.replaceTrack(e.mediaStreamTrack)}}}catch(e){i={error:e}}finally{try{c||t||!(n=d.return)||(yield n.call(d))}finally{if(i)throw i.error}}}))}setProcessor(e){const t=Object.create(null,{setProcessor:{get:()=>super.setProcessor}});return cn(this,arguments,void 0,(function(e){var i=this;let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];return function*(){var r,s,o,a;var c,d;yield t.setProcessor.call(i,e,n);if((c=i.processor)===null||c===void 0?void 0:c.processedTrack)try{for(var l,u=true,h=ln(i.simulcastCodecs.values());l=yield h.next(),r=l.done,!r;u=true){a=l.value;u=false;const e=a;yield(d=e.sender)===null||d===void 0?void 0:d.replaceTrack(i.processor.processedTrack)}}catch(e){s={error:e}}finally{try{u||r||!(o=h.return)||(yield o.call(h))}finally{if(s)throw s.error}}}()}))}setDegradationPreference(e){return cn(this,void 0,void 0,(function*(){this.degradationPreference=e;if(this.sender)try{this.log.debug("setting degradationPreference to ".concat(e),this.logContext);const t=this.sender.getParameters();t.degradationPreference=e;this.sender.setParameters(t)}catch(e){this.log.warn("failed to set degradationPreference",Object.assign({error:e},this.logContext))}}))}addSimulcastTrack(e,t){if(this.simulcastCodecs.has(e)){this.log.error("".concat(e," already added, skipping adding simulcast codec"),this.logContext);return}const i={codec:e,mediaStreamTrack:this.mediaStreamTrack.clone(),sender:void 0,encodings:t};this.simulcastCodecs.set(e,i);return i}setSimulcastTrackSender(e,t){const i=this.simulcastCodecs.get(e);if(i){i.sender=t;setTimeout((()=>{this.subscribedCodecs&&this.setPublishingCodecs(this.subscribedCodecs)}),ac)}}setPublishingCodecs(e){return cn(this,void 0,void 0,(function*(){var t,i,n;var r,s,o,a;this.log.debug("setting publishing codecs",Object.assign(Object.assign({},this.logContext),{codecs:e,currentCodec:this.codec}));if(!this.codec&&e.length>0){yield this.setPublishingLayers(Ls(e[0].codec),e[0].qualities);return[]}this.subscribedCodecs=e;const c=[];try{for(t=true,i=ln(e);n=yield i.next(),r=n.done,!r;t=true){a=n.value;t=false;const e=a;if(this.codec&&this.codec!==e.codec){const t=this.simulcastCodecs.get(e.codec);this.log.debug("try setPublishingCodec for ".concat(e.codec),Object.assign(Object.assign({},this.logContext),{simulcastCodecInfo:t}));if(t&&t.sender){if(t.encodings){this.log.debug("try setPublishingLayersForSender ".concat(e.codec),this.logContext);yield cc(t.sender,t.encodings,e.qualities,this.senderLock,Ls(e.codec),this.log,this.logContext)}}else for(const t of e.qualities)if(t.enabled){c.push(e.codec);break}}else yield this.setPublishingLayers(Ls(e.codec),e.qualities)}}catch(e){s={error:e}}finally{try{t||r||!(o=i.return)||(yield o.call(i))}finally{if(s)throw s.error}}return c}))}setPublishingLayers(e,t){return cn(this,void 0,void 0,(function*(){if(this.optimizeForPerformance)this.log.info("skipping setPublishingLayers due to optimized publishing performance",Object.assign(Object.assign({},this.logContext),{qualities:t}));else{this.log.debug("setting publishing layers",Object.assign(Object.assign({},this.logContext),{qualities:t}));this.sender&&this.encodings&&(yield cc(this.sender,this.encodings,t,this.senderLock,e,this.log,this.logContext))}}))}prioritizePerformance(){return cn(this,void 0,void 0,(function*(){if(!this.sender)throw new Error("sender not found");const e=yield this.senderLock.lock();try{this.optimizeForPerformance=true;const e=this.sender.getParameters();e.encodings=e.encodings.map(((e,t)=>{var i;return Object.assign(Object.assign({},e),{active:t===0,scaleResolutionDownBy:Math.max(1,Math.ceil(((i=this.mediaStreamTrack.getSettings().height)!==null&&i!==void 0?i:360)/360)),scalabilityMode:t===0&&Ls(this.codec)?"L1T3":void 0,maxFramerate:t===0?15:0,maxBitrate:t===0?e.maxBitrate:0})}));this.log.debug("setting performance optimised encodings",Object.assign(Object.assign({},this.logContext),{encodings:e.encodings}));this.encodings=e.encodings;yield this.sender.setParameters(e)}catch(e){this.log.error("failed to set performance optimised encodings",Object.assign(Object.assign({},this.logContext),{error:e}));this.optimizeForPerformance=false}finally{e()}}))}handleAppVisibilityChanged(){const e=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return cn(this,void 0,void 0,(function*(){yield e.handleAppVisibilityChanged.call(this);Ws()&&this.isInBackground&&this.source===Track.Source.Camera&&(this._mediaStreamTrack.enabled=false)}))}}function cc(e,t,i,n,r,s,o){return cn(this,void 0,void 0,(function*(){const a=yield n.lock();s.debug("setPublishingLayersForSender",Object.assign(Object.assign({},o),{sender:e,qualities:i,senderEncodings:t}));try{const n=e.getParameters();const{encodings:a}=n;if(!a)return;if(a.length!==t.length){s.warn("cannot set publishing layers, encodings mismatch",Object.assign(Object.assign({},o),{encodings:a,senderEncodings:t}));return}let c=false;const d=false;if(d&&a[0].scalabilityMode);else{if(r){const e=i.some((e=>e.enabled));e&&i.forEach((e=>e.enabled=true))}a.forEach(((e,n)=>{var r;let a=(r=e.rid)!==null&&r!==void 0?r:"";a===""&&(a="q");const d=dc(a);const l=i.find((e=>e.quality===d));if(l&&e.active!==l.enabled){c=true;e.active=l.enabled;s.debug("setting layer ".concat(l.quality," to ").concat(e.active?"enabled":"disabled"),o);if(Fs())if(l.enabled){e.scaleResolutionDownBy=t[n].scaleResolutionDownBy;e.maxBitrate=t[n].maxBitrate;e.maxFrameRate=t[n].maxFrameRate}else{e.scaleResolutionDownBy=4;e.maxBitrate=10;e.maxFrameRate=2}}}))}if(c){n.encodings=a;s.debug("setting encodings",Object.assign(Object.assign({},o),{encodings:n.encodings}));yield e.setParameters(n)}}finally{a()}}))}function dc(e){switch(e){case"f":return gs.HIGH;case"h":return gs.MEDIUM;case"q":return gs.LOW;default:return gs.HIGH}}function lc(e,t,i,n){if(!i)return[new yt({quality:gs.HIGH,width:e,height:t,bitrate:0,ssrc:0})];if(n){const n=i[0].scalabilityMode;const r=new ScalabilityMode(n);const s=[];const o=r.suffix=="h"?1.5:2;const a=r.suffix=="h"?2:3;for(let n=0;n<r.spatial;n+=1)s.push(new yt({quality:Math.min(gs.HIGH,r.spatial-1)-n,width:Math.ceil(e/Math.pow(o,n)),height:Math.ceil(t/Math.pow(o,n)),bitrate:i[0].maxBitrate?Math.ceil(i[0].maxBitrate/Math.pow(a,n)):0,ssrc:0}));return s}return i.map((i=>{var n,r,s;const o=(n=i.scaleResolutionDownBy)!==null&&n!==void 0?n:1;let a=dc((r=i.rid)!==null&&r!==void 0?r:"");return new yt({quality:a,width:Math.ceil(e/o),height:Math.ceil(t/o),bitrate:(s=i.maxBitrate)!==null&&s!==void 0?s:0,ssrc:0})}))}const uc="_lossy";const hc="_reliable";const pc=2e3;const mc="leave-reconnect";const gc=3e4;var fc;(function(e){e[e.New=0]="New";e[e.Connected=1]="Connected";e[e.Disconnected=2]="Disconnected";e[e.Reconnecting=3]="Reconnecting";e[e.Closed=4]="Closed"})(fc||(fc={}));class RTCEngine extends mn.EventEmitter{get isClosed(){return this._isClosed}get pendingReconnect(){return!!this.reconnectTimeout}constructor(e){var t;super();this.options=e;this.rtcConfig={};this.peerConnectionTimeout=Aa.peerConnectionTimeout;this.fullReconnectOnNext=false;this.latestRemoteOfferId=0;this.subscriberPrimary=false;this.pcState=fc.New;this._isClosed=true;this.pendingTrackResolvers={};this.reconnectAttempts=0;this.reconnectStart=0;this.attemptingReconnect=false;this.joinAttempts=0;this.maxJoinAttempts=1;this.shouldFailNext=false;this.log=Zi;this.reliableDataSequence=1;this.reliableMessageBuffer=new DataPacketBuffer;this.reliableReceivedState=new TTLMap(gc);this.handleDataChannel=e=>cn(this,[e],void 0,(function(e){var t=this;let{channel:i}=e;return function*(){if(i){if(i.label===hc)t.reliableDCSub=i;else{if(i.label!==uc)return;t.lossyDCSub=i}t.log.debug("on data channel ".concat(i.id,", ").concat(i.label),t.logContext);i.onmessage=t.handleDataMessage}}()}));this.handleDataMessage=e=>cn(this,void 0,void 0,(function*(){var t,i;const n=yield this.dataProcessLock.lock();try{let n;if(e.data instanceof ArrayBuffer)n=e.data;else{if(!(e.data instanceof Blob)){this.log.error("unsupported data type",Object.assign(Object.assign({},this.logContext),{data:e.data}));return}n=yield e.data.arrayBuffer()}const r=Tt.fromBinary(new Uint8Array(n));if(r.sequence>0&&r.participantSid!==""){const e=this.reliableReceivedState.get(r.participantSid);if(e&&r.sequence<=e)return;this.reliableReceivedState.set(r.participantSid,r.sequence)}if(((t=r.value)===null||t===void 0?void 0:t.case)==="speaker")this.emit(ts.ActiveSpeakersUpdate,r.value.value.speakers);else{((i=r.value)===null||i===void 0?void 0:i.case)==="user"&&kc(r,r.value.value);this.emit(ts.DataPacketReceived,r)}}finally{n()}}));this.handleDataError=e=>{const t=e.currentTarget;const i=t.maxRetransmits===0?"lossy":"reliable";if(e instanceof ErrorEvent&&e.error){const{error:t}=e.error;this.log.error("DataChannel error on ".concat(i,": ").concat(e.message),Object.assign(Object.assign({},this.logContext),{error:t}))}else this.log.error("Unknown DataChannel error on ".concat(i),Object.assign(Object.assign({},this.logContext),{event:e}))};this.handleBufferedAmountLow=e=>{const t=e.currentTarget;const i=t.maxRetransmits===0?Ct.LOSSY:Ct.RELIABLE;this.updateAndEmitDCBufferStatus(i)};this.handleDisconnect=(e,t)=>{if(this._isClosed)return;this.log.warn("".concat(e," disconnected"),this.logContext);this.reconnectAttempts===0&&(this.reconnectStart=Date.now());const i=e=>{this.log.warn("could not recover connection after ".concat(this.reconnectAttempts," attempts, ").concat(e,"ms. giving up"),this.logContext);this.emit(ts.Disconnected);this.close()};const n=Date.now()-this.reconnectStart;let r=this.getNextRetryDelay({elapsedMs:n,retryCount:this.reconnectAttempts});if(r!==null){e===mc&&(r=0);this.log.debug("reconnecting in ".concat(r,"ms"),this.logContext);this.clearReconnectTimeout();this.token&&this.regionUrlProvider&&this.regionUrlProvider.updateToken(this.token);this.reconnectTimeout=CriticalTimers.setTimeout((()=>this.attemptReconnect(t).finally((()=>this.reconnectTimeout=void 0))),r)}else i(n)};this.waitForRestarted=()=>new Promise(((e,t)=>{this.pcState===fc.Connected&&e();const i=()=>{this.off(ts.Disconnected,n);e()};const n=()=>{this.off(ts.Restarted,i);t()};this.once(ts.Restarted,i);this.once(ts.Disconnected,n)}));this.updateAndEmitDCBufferStatus=e=>{const t=this.isBufferStatusLow(e);if(typeof t!=="undefined"&&t!==this.dcBufferStatus.get(e)){this.dcBufferStatus.set(e,t);this.emit(ts.DCBufferStatusChanged,t,e)}};this.isBufferStatusLow=e=>{const t=this.dataChannelForKind(e);if(t){e===Ct.RELIABLE&&this.reliableMessageBuffer.alignBufferedAmount(t.bufferedAmount);return t.bufferedAmount<=t.bufferedAmountLowThreshold}};this.handleBrowserOnLine=()=>{if(this.client.currentState===ra.RECONNECTING){this.clearReconnectTimeout();this.attemptReconnect(at.RR_SIGNAL_DISCONNECTED)}};this.log=en((t=e.loggerName)!==null&&t!==void 0?t:Xi.Engine);this.loggerOptions={loggerName:e.loggerName,loggerContextCb:()=>this.logContext};this.client=new SignalClient(void 0,this.loggerOptions);this.client.signalLatency=this.options.expSignalLatency;this.reconnectPolicy=this.options.reconnectPolicy;this.registerOnLineListener();this.closingLock=new _;this.dataProcessLock=new _;this.dcBufferStatus=new Map([[Ct.LOSSY,true],[Ct.RELIABLE,true]]);this.client.onParticipantUpdate=e=>this.emit(ts.ParticipantUpdate,e);this.client.onConnectionQuality=e=>this.emit(ts.ConnectionQualityUpdate,e);this.client.onRoomUpdate=e=>this.emit(ts.RoomUpdate,e);this.client.onSubscriptionError=e=>this.emit(ts.SubscriptionError,e);this.client.onSubscriptionPermissionUpdate=e=>this.emit(ts.SubscriptionPermissionUpdate,e);this.client.onSpeakersChanged=e=>this.emit(ts.SpeakersChanged,e);this.client.onStreamStateUpdate=e=>this.emit(ts.StreamStateChanged,e);this.client.onRequestResponse=e=>this.emit(ts.SignalRequestResponse,e)}get logContext(){var e,t,i,n,r,s;return{room:(t=(e=this.latestJoinResponse)===null||e===void 0?void 0:e.room)===null||t===void 0?void 0:t.name,roomID:(n=(i=this.latestJoinResponse)===null||i===void 0?void 0:i.room)===null||n===void 0?void 0:n.sid,participant:(s=(r=this.latestJoinResponse)===null||r===void 0?void 0:r.participant)===null||s===void 0?void 0:s.identity,pID:this.participantSid}}join(e,t,i,n){return cn(this,void 0,void 0,(function*(){this.url=e;this.token=t;this.signalOpts=i;this.maxJoinAttempts=i.maxRetries;try{this.joinAttempts+=1;this.setupSignalClientCallbacks();const r=yield this.client.join(e,t,i,n);this._isClosed=false;this.latestJoinResponse=r;this.subscriberPrimary=r.subscriberPrimary;this.pcManager||(yield this.configure(r));this.subscriberPrimary&&!r.fastPublish||this.negotiate();this.clientConfiguration=r.clientConfiguration;this.emit(ts.SignalConnected,r);return r}catch(r){if(r instanceof ConnectionError&&r.reason===Qr.ServerUnreachable){this.log.warn("Couldn't connect to server, attempt ".concat(this.joinAttempts," of ").concat(this.maxJoinAttempts),this.logContext);if(this.joinAttempts<this.maxJoinAttempts)return this.join(e,t,i,n)}throw r}}))}close(){return cn(this,void 0,void 0,(function*(){const e=yield this.closingLock.lock();if(this.isClosed)e();else try{this._isClosed=true;this.joinAttempts=0;this.emit(ts.Closing);this.removeAllListeners();this.deregisterOnLineListener();this.clearPendingReconnect();yield this.cleanupPeerConnections();yield this.cleanupClient()}finally{e()}}))}cleanupPeerConnections(){return cn(this,void 0,void 0,(function*(){var e;yield(e=this.pcManager)===null||e===void 0?void 0:e.close();this.pcManager=void 0;const t=e=>{if(e){e.close();e.onbufferedamountlow=null;e.onclose=null;e.onclosing=null;e.onerror=null;e.onmessage=null;e.onopen=null}};t(this.lossyDC);t(this.lossyDCSub);t(this.reliableDC);t(this.reliableDCSub);this.lossyDC=void 0;this.lossyDCSub=void 0;this.reliableDC=void 0;this.reliableDCSub=void 0;this.reliableMessageBuffer=new DataPacketBuffer;this.reliableDataSequence=1;this.reliableReceivedState.clear()}))}cleanupClient(){return cn(this,void 0,void 0,(function*(){yield this.client.close();this.client.resetCallbacks()}))}addTrack(e){if(this.pendingTrackResolvers[e.cid])throw new TrackInvalidError("a track with the same ID has already been published");return new Promise(((t,i)=>{const n=setTimeout((()=>{delete this.pendingTrackResolvers[e.cid];i(new ConnectionError("publication of local track timed out, no response from server",Qr.Timeout))}),1e4);this.pendingTrackResolvers[e.cid]={resolve:e=>{clearTimeout(n);t(e)},reject:()=>{clearTimeout(n);i(new Error("Cancelled publication by calling unpublish"))}};this.client.sendAddTrack(e)}))}
/**
   * Removes sender from PeerConnection, returning true if it was removed successfully
   * and a negotiation is necessary
   * @param sender
   * @returns
   */removeTrack(e){if(e.track&&this.pendingTrackResolvers[e.track.id]){const{reject:t}=this.pendingTrackResolvers[e.track.id];t&&t();delete this.pendingTrackResolvers[e.track.id]}try{this.pcManager.removeTrack(e);return true}catch(e){this.log.warn("failed to remove track",Object.assign(Object.assign({},this.logContext),{error:e}))}return false}updateMuteStatus(e,t){this.client.sendMuteTrack(e,t)}get dataSubscriberReadyState(){var e;return(e=this.reliableDCSub)===null||e===void 0?void 0:e.readyState}getConnectedServerAddress(){return cn(this,void 0,void 0,(function*(){var e;return(e=this.pcManager)===null||e===void 0?void 0:e.getConnectedAddress()}))}setRegionUrlProvider(e){this.regionUrlProvider=e}configure(e){return cn(this,void 0,void 0,(function*(){var t,i;if(this.pcManager&&this.pcManager.currentState!==_a.NEW)return;this.participantSid=(t=e.participant)===null||t===void 0?void 0:t.sid;const n=this.makeRTCConfiguration(e);this.pcManager=new PCTransportManager(n,e.subscriberPrimary,this.loggerOptions);this.emit(ts.TransportsCreated,this.pcManager.publisher,this.pcManager.subscriber);this.pcManager.onIceCandidate=(e,t)=>{this.client.sendIceCandidate(e,t)};this.pcManager.onPublisherOffer=(e,t)=>{this.client.sendOffer(e,t)};this.pcManager.onDataChannel=this.handleDataChannel;this.pcManager.onStateChange=(t,i,n)=>cn(this,void 0,void 0,(function*(){this.log.debug("primary PC state changed ".concat(t),this.logContext);["closed","disconnected","failed"].includes(i)&&(this.publisherConnectionPromise=void 0);if(t===_a.CONNECTED){const t=this.pcState===fc.New;this.pcState=fc.Connected;t&&this.emit(ts.Connected,e)}else if(t===_a.FAILED&&this.pcState===fc.Connected){this.pcState=fc.Disconnected;this.handleDisconnect("peerconnection failed",n==="failed"?at.RR_SUBSCRIBER_FAILED:at.RR_PUBLISHER_FAILED)}const r=this.client.isDisconnected||this.client.currentState===ra.RECONNECTING;const s=[_a.FAILED,_a.CLOSING,_a.CLOSED].includes(t);r&&s&&!this._isClosed&&this.emit(ts.Offline)}));this.pcManager.onTrack=e=>{this.emit(ts.MediaTrackAdded,e.track,e.streams[0],e.receiver)};vc((i=e.serverInfo)===null||i===void 0?void 0:i.protocol)||this.createDataChannels()}))}setupSignalClientCallbacks(){this.client.onAnswer=(e,t)=>cn(this,void 0,void 0,(function*(){if(this.pcManager){this.log.debug("received server answer",Object.assign(Object.assign({},this.logContext),{RTCSdpType:e.type}));yield this.pcManager.setPublisherAnswer(e,t)}}));this.client.onTrickle=(e,t)=>{if(this.pcManager){this.log.debug("got ICE candidate from peer",Object.assign(Object.assign({},this.logContext),{candidate:e,target:t}));this.pcManager.addIceCandidate(e,t)}};this.client.onOffer=(e,t)=>cn(this,void 0,void 0,(function*(){this.latestRemoteOfferId=t;if(!this.pcManager)return;const i=yield this.pcManager.createSubscriberAnswerFromOffer(e,t);i&&this.client.sendAnswer(i,t)}));this.client.onLocalTrackPublished=e=>{var t;this.log.debug("received trackPublishedResponse",Object.assign(Object.assign({},this.logContext),{cid:e.cid,track:(t=e.track)===null||t===void 0?void 0:t.sid}));if(!this.pendingTrackResolvers[e.cid]){this.log.error("missing track resolver for ".concat(e.cid),Object.assign(Object.assign({},this.logContext),{cid:e.cid}));return}const{resolve:i}=this.pendingTrackResolvers[e.cid];delete this.pendingTrackResolvers[e.cid];i(e.track)};this.client.onLocalTrackUnpublished=e=>{this.emit(ts.LocalTrackUnpublished,e)};this.client.onLocalTrackSubscribed=e=>{this.emit(ts.LocalTrackSubscribed,e)};this.client.onTokenRefresh=e=>{this.token=e};this.client.onRemoteMuteChanged=(e,t)=>{this.emit(ts.RemoteMute,e,t)};this.client.onSubscribedQualityUpdate=e=>{this.emit(ts.SubscribedQualityUpdate,e)};this.client.onRoomMoved=e=>{var t;this.participantSid=(t=e.participant)===null||t===void 0?void 0:t.sid;this.latestJoinResponse&&(this.latestJoinResponse.room=e.room);this.emit(ts.RoomMoved,e)};this.client.onClose=()=>{this.handleDisconnect("signal",at.RR_SIGNAL_DISCONNECTED)};this.client.onLeave=e=>{this.log.debug("client leave request",Object.assign(Object.assign({},this.logContext),{reason:e===null||e===void 0?void 0:e.reason}));if(e.regions&&this.regionUrlProvider){this.log.debug("updating regions",this.logContext);this.regionUrlProvider.setServerReportedRegions(e.regions)}switch(e.action){case gi.DISCONNECT:this.emit(ts.Disconnected,e===null||e===void 0?void 0:e.reason);this.close();break;case gi.RECONNECT:this.fullReconnectOnNext=true;this.handleDisconnect(mc);break;case gi.RESUME:this.handleDisconnect(mc)}}}makeRTCConfiguration(e){var t;const i=Object.assign({},this.rtcConfig);if((t=this.signalOpts)===null||t===void 0?void 0:t.e2eeEnabled){this.log.debug("E2EE - setting up transports with insertable streams",this.logContext);i.encodedInsertableStreams=true}if(e.iceServers&&!i.iceServers){const t=[];e.iceServers.forEach((e=>{const i={urls:e.urls};e.username&&(i.username=e.username);e.credential&&(i.credential=e.credential);t.push(i)}));i.iceServers=t}e.clientConfiguration&&e.clientConfiguration.forceRelay===st.ENABLED&&(i.iceTransportPolicy="relay");i.sdpSemantics="unified-plan";i.continualGatheringPolicy="gather_continually";return i}createDataChannels(){if(this.pcManager){if(this.lossyDC){this.lossyDC.onmessage=null;this.lossyDC.onerror=null}if(this.reliableDC){this.reliableDC.onmessage=null;this.reliableDC.onerror=null}this.lossyDC=this.pcManager.createPublisherDataChannel(uc,{ordered:false,maxRetransmits:0});this.reliableDC=this.pcManager.createPublisherDataChannel(hc,{ordered:true});this.lossyDC.onmessage=this.handleDataMessage;this.reliableDC.onmessage=this.handleDataMessage;this.lossyDC.onerror=this.handleDataError;this.reliableDC.onerror=this.handleDataError;this.lossyDC.bufferedAmountLowThreshold=65535;this.reliableDC.bufferedAmountLowThreshold=65535;this.lossyDC.onbufferedamountlow=this.handleBufferedAmountLow;this.reliableDC.onbufferedamountlow=this.handleBufferedAmountLow}}createSender(e,t,i){return cn(this,void 0,void 0,(function*(){if(Ds()){const n=yield this.createTransceiverRTCRtpSender(e,t,i);return n}if(xs()){this.log.warn("using add-track fallback",this.logContext);const t=yield this.createRTCRtpSender(e.mediaStreamTrack);return t}throw new UnexpectedConnectionState("Required webRTC APIs not supported on this device")}))}createSimulcastSender(e,t,i,n){return cn(this,void 0,void 0,(function*(){if(Ds())return this.createSimulcastTransceiverSender(e,t,i,n);if(xs()){this.log.debug("using add-track fallback",this.logContext);return this.createRTCRtpSender(e.mediaStreamTrack)}throw new UnexpectedConnectionState("Cannot stream on this device")}))}createTransceiverRTCRtpSender(e,t,i){return cn(this,void 0,void 0,(function*(){if(!this.pcManager)throw new UnexpectedConnectionState("publisher is closed");const n=[];e.mediaStream&&n.push(e.mediaStream);wo(e)&&(e.codec=t.videoCodec);const r={direction:"sendonly",streams:n};i&&(r.sendEncodings=i);const s=yield this.pcManager.addPublisherTransceiver(e.mediaStreamTrack,r);return s.sender}))}createSimulcastTransceiverSender(e,t,i,n){return cn(this,void 0,void 0,(function*(){if(!this.pcManager)throw new UnexpectedConnectionState("publisher is closed");const r={direction:"sendonly"};n&&(r.sendEncodings=n);const s=yield this.pcManager.addPublisherTransceiver(t.mediaStreamTrack,r);if(i.videoCodec){e.setSimulcastTrackSender(i.videoCodec,s.sender);return s.sender}}))}createRTCRtpSender(e){return cn(this,void 0,void 0,(function*(){if(!this.pcManager)throw new UnexpectedConnectionState("publisher is closed");return this.pcManager.addPublisherTrack(e)}))}attemptReconnect(e){return cn(this,void 0,void 0,(function*(){var t,i,n;if(!this._isClosed)if(this.attemptingReconnect)Zi.warn("already attempting reconnect, returning early",this.logContext);else{((t=this.clientConfiguration)===null||t===void 0?void 0:t.resumeConnection)!==st.DISABLED&&((n=(i=this.pcManager)===null||i===void 0?void 0:i.currentState)!==null&&n!==void 0?n:_a.NEW)!==_a.NEW||(this.fullReconnectOnNext=true);try{this.attemptingReconnect=true;this.fullReconnectOnNext?yield this.restartConnection():yield this.resumeConnection(e);this.clearPendingReconnect();this.fullReconnectOnNext=false}catch(e){this.reconnectAttempts+=1;let t=true;if(e instanceof UnexpectedConnectionState){this.log.debug("received unrecoverable error",Object.assign(Object.assign({},this.logContext),{error:e}));t=false}else e instanceof SignalReconnectError||(this.fullReconnectOnNext=true);if(t)this.handleDisconnect("reconnect",at.RR_UNKNOWN);else{this.log.info("could not recover connection after ".concat(this.reconnectAttempts," attempts, ").concat(Date.now()-this.reconnectStart,"ms. giving up"),this.logContext);this.emit(ts.Disconnected);yield this.close()}}finally{this.attemptingReconnect=false}}}))}getNextRetryDelay(e){try{return this.reconnectPolicy.nextRetryDelayInMs(e)}catch(e){this.log.warn("encountered error in reconnect policy",Object.assign(Object.assign({},this.logContext),{error:e}))}return null}restartConnection(e){return cn(this,void 0,void 0,(function*(){var t,i,n;try{if(!this.url||!this.token)throw new UnexpectedConnectionState("could not reconnect, url or token not saved");this.log.info("reconnecting, attempt: ".concat(this.reconnectAttempts),this.logContext);this.emit(ts.Restarting);this.client.isDisconnected||(yield this.client.sendLeave());yield this.cleanupPeerConnections();yield this.cleanupClient();let i;try{if(!this.signalOpts){this.log.warn("attempted connection restart, without signal options present",this.logContext);throw new SignalReconnectError}i=yield this.join(e!==null&&e!==void 0?e:this.url,this.token,this.signalOpts)}catch(e){if(e instanceof ConnectionError&&e.reason===Qr.NotAllowed)throw new UnexpectedConnectionState("could not reconnect, token might be expired");throw new SignalReconnectError}if(this.shouldFailNext){this.shouldFailNext=false;throw new Error("simulated failure")}this.client.setReconnected();this.emit(ts.SignalRestarted,i);yield this.waitForPCReconnected();if(this.client.currentState!==ra.CONNECTED)throw new SignalReconnectError("Signal connection got severed during reconnect");(t=this.regionUrlProvider)===null||t===void 0?void 0:t.resetAttempts();this.emit(ts.Restarted)}catch(e){const t=yield(i=this.regionUrlProvider)===null||i===void 0?void 0:i.getNextBestRegionUrl();if(t){yield this.restartConnection(t);return}(n=this.regionUrlProvider)===null||n===void 0?void 0:n.resetAttempts();throw e}}))}resumeConnection(e){return cn(this,void 0,void 0,(function*(){var t;if(!this.url||!this.token)throw new UnexpectedConnectionState("could not reconnect, url or token not saved");if(!this.pcManager)throw new UnexpectedConnectionState("publisher and subscriber connections unset");this.log.info("resuming signal connection, attempt ".concat(this.reconnectAttempts),this.logContext);this.emit(ts.Resuming);let i;try{this.setupSignalClientCallbacks();i=yield this.client.reconnect(this.url,this.token,this.participantSid,e)}catch(e){let t="";if(e instanceof Error){t=e.message;this.log.error(e.message,Object.assign(Object.assign({},this.logContext),{error:e}))}if(e instanceof ConnectionError&&e.reason===Qr.NotAllowed)throw new UnexpectedConnectionState("could not reconnect, token might be expired");if(e instanceof ConnectionError&&e.reason===Qr.LeaveRequest)throw e;throw new SignalReconnectError(t)}this.emit(ts.SignalResumed);if(i){const e=this.makeRTCConfiguration(i);this.pcManager.updateConfiguration(e);this.latestJoinResponse&&(this.latestJoinResponse.serverInfo=i.serverInfo)}else this.log.warn("Did not receive reconnect response",this.logContext);if(this.shouldFailNext){this.shouldFailNext=false;throw new Error("simulated failure")}yield this.pcManager.triggerIceRestart();yield this.waitForPCReconnected();if(this.client.currentState!==ra.CONNECTED)throw new SignalReconnectError("Signal connection got severed during reconnect");this.client.setReconnected();((t=this.reliableDC)===null||t===void 0?void 0:t.readyState)==="open"&&this.reliableDC.id===null&&this.createDataChannels();(i===null||i===void 0?void 0:i.lastMessageSeq)&&this.resendReliableMessagesForResume(i.lastMessageSeq);this.emit(ts.Resumed)}))}waitForPCInitialConnection(e,t){return cn(this,void 0,void 0,(function*(){if(!this.pcManager)throw new UnexpectedConnectionState("PC manager is closed");yield this.pcManager.ensurePCTransportConnection(t,e)}))}waitForPCReconnected(){return cn(this,void 0,void 0,(function*(){this.pcState=fc.Reconnecting;this.log.debug("waiting for peer connection to reconnect",this.logContext);try{yield Os(pc);if(!this.pcManager)throw new UnexpectedConnectionState("PC manager is closed");yield this.pcManager.ensurePCTransportConnection(void 0,this.peerConnectionTimeout);this.pcState=fc.Connected}catch(e){this.pcState=fc.Disconnected;throw new ConnectionError("could not establish PC connection, ".concat(e.message),Qr.InternalError)}}))}publishRpcResponse(e,t,i,n){return cn(this,void 0,void 0,(function*(){const r=new Tt({destinationIdentities:[e],kind:Ct.RELIABLE,value:{case:"rpcResponse",value:new Mt({requestId:t,value:n?{case:"error",value:n.toProto()}:{case:"payload",value:i!==null&&i!==void 0?i:""}})}});yield this.sendDataPacket(r,Ct.RELIABLE)}))}publishRpcAck(e,t){return cn(this,void 0,void 0,(function*(){const i=new Tt({destinationIdentities:[e],kind:Ct.RELIABLE,value:{case:"rpcAck",value:new xt({requestId:t})}});yield this.sendDataPacket(i,Ct.RELIABLE)}))}sendDataPacket(e,t){return cn(this,void 0,void 0,(function*(){yield this.ensurePublisherConnected(t);if(t===Ct.RELIABLE){e.sequence=this.reliableDataSequence;this.reliableDataSequence+=1}const i=e.toBinary();const n=this.dataChannelForKind(t);if(n){t===Ct.RELIABLE&&this.reliableMessageBuffer.push({data:i,sequence:e.sequence});if(this.attemptingReconnect)return;n.send(i)}this.updateAndEmitDCBufferStatus(t)}))}resendReliableMessagesForResume(e){return cn(this,void 0,void 0,(function*(){yield this.ensurePublisherConnected(Ct.RELIABLE);const t=this.dataChannelForKind(Ct.RELIABLE);if(t){this.reliableMessageBuffer.popToSequence(e);this.reliableMessageBuffer.getAll().forEach((e=>{t.send(e.data)}))}this.updateAndEmitDCBufferStatus(Ct.RELIABLE)}))}waitForBufferStatusLow(e){return new Promise(((t,i)=>cn(this,void 0,void 0,(function*(){if(this.isBufferStatusLow(e))t();else{const n=()=>i("Engine closed");this.once(ts.Closing,n);while(!this.dcBufferStatus.get(e))yield Os(10);this.off(ts.Closing,n);t()}}))))}ensureDataTransportConnected(e){return cn(this,arguments,void 0,(function(e){var t=this;let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:this.subscriberPrimary;return function*(){var n;if(!t.pcManager)throw new UnexpectedConnectionState("PC manager is closed");const r=i?t.pcManager.subscriber:t.pcManager.publisher;const s=i?"Subscriber":"Publisher";if(!r)throw new ConnectionError("".concat(s," connection not set"),Qr.InternalError);let o=false;if(!i&&!t.dataChannelForKind(e,i)){t.createDataChannels();o=true}o||i||t.pcManager.publisher.isICEConnected||t.pcManager.publisher.getICEConnectionState()==="checking"||(o=true);o&&t.negotiate();const a=t.dataChannelForKind(e,i);if((a===null||a===void 0?void 0:a.readyState)==="open")return;const c=(new Date).getTime()+t.peerConnectionTimeout;while((new Date).getTime()<c){if(r.isICEConnected&&((n=t.dataChannelForKind(e,i))===null||n===void 0?void 0:n.readyState)==="open")return;yield Os(50)}throw new ConnectionError("could not establish ".concat(s," connection, state: ").concat(r.getICEConnectionState()),Qr.InternalError)}()}))}ensurePublisherConnected(e){return cn(this,void 0,void 0,(function*(){this.publisherConnectionPromise||(this.publisherConnectionPromise=this.ensureDataTransportConnected(e,false));yield this.publisherConnectionPromise}))}verifyTransport(){return!!this.pcManager&&(this.pcManager.currentState===_a.CONNECTED&&!(!this.client.ws||this.client.ws.readyState===WebSocket.CLOSED))}negotiate(){return cn(this,void 0,void 0,(function*(){return new Promise(((e,t)=>cn(this,void 0,void 0,(function*(){if(!this.pcManager){t(new NegotiationError("PC manager is closed"));return}this.pcManager.requirePublisher();this.pcManager.publisher.getTransceivers().length!=0||this.lossyDC||this.reliableDC||this.createDataChannels();const i=new AbortController;const n=()=>{i.abort();this.log.debug("engine disconnected while negotiation was ongoing",this.logContext);e()};this.isClosed&&t("cannot negotiate on closed engine");this.on(ts.Closing,n);this.pcManager.publisher.once(wa.RTPVideoPayloadTypes,(e=>{const t=new Map;e.forEach((e=>{const i=e.codec.toLowerCase();po(i)&&t.set(e.payload,i)}));this.emit(ts.RTPVideoMapUpdate,t)}));try{yield this.pcManager.negotiate(i);e()}catch(e){e instanceof NegotiationError&&(this.fullReconnectOnNext=true);this.handleDisconnect("negotiation",at.RR_UNKNOWN);t(e)}finally{this.off(ts.Closing,n)}}))))}))}dataChannelForKind(e,t){if(t){if(e===Ct.LOSSY)return this.lossyDCSub;if(e===Ct.RELIABLE)return this.reliableDCSub}else{if(e===Ct.LOSSY)return this.lossyDC;if(e===Ct.RELIABLE)return this.reliableDC}}sendSyncState(e,t){var i,n;if(!this.pcManager){this.log.warn("sync state cannot be sent without peer connection setup",this.logContext);return}const r=this.pcManager.subscriber.getLocalDescription();const s=this.pcManager.subscriber.getRemoteDescription();const o=(n=(i=this.signalOpts)===null||i===void 0?void 0:i.autoSubscribe)===null||n===void 0||n;const a=new Array;const c=new Array;e.forEach((e=>{e.isDesired!==o&&a.push(e.trackSid);e.isEnabled||c.push(e.trackSid)}));this.client.sendSyncState(new Mi({answer:r?oa({sdp:r.sdp,type:r.type}):void 0,offer:s?oa({sdp:s.sdp,type:s.type}):void 0,subscription:new li({trackSids:a,subscribe:!o,participantTracks:[]}),publishTracks:qo(t),dataChannels:this.dataChannelsInfo(),trackSidsDisabled:c,datachannelReceiveStates:this.reliableReceivedState.map(((e,t)=>new Ai({publisherSid:t,lastSeq:e})))}))}failNext(){this.shouldFailNext=true}dataChannelsInfo(){const e=[];const t=(t,i)=>{(t===null||t===void 0?void 0:t.id)!==void 0&&t.id!==null&&e.push(new _i({label:t.label,id:t.id,target:i}))};t(this.dataChannelForKind(Ct.LOSSY),Qt.PUBLISHER);t(this.dataChannelForKind(Ct.RELIABLE),Qt.PUBLISHER);t(this.dataChannelForKind(Ct.LOSSY,true),Qt.SUBSCRIBER);t(this.dataChannelForKind(Ct.RELIABLE,true),Qt.SUBSCRIBER);return e}clearReconnectTimeout(){this.reconnectTimeout&&CriticalTimers.clearTimeout(this.reconnectTimeout)}clearPendingReconnect(){this.clearReconnectTimeout();this.reconnectAttempts=0}registerOnLineListener(){Gs()&&window.addEventListener("online",this.handleBrowserOnLine)}deregisterOnLineListener(){Gs()&&window.removeEventListener("online",this.handleBrowserOnLine)}}class SignalReconnectError extends Error{}function vc(e){return e!==void 0&&e>13}function kc(e,t){const i=e.participantIdentity?e.participantIdentity:t.participantIdentity;e.participantIdentity=i;t.participantIdentity=i;const n=e.destinationIdentities.length!==0?e.destinationIdentities:t.destinationIdentities;e.destinationIdentities=n;t.destinationIdentities=n}class RegionUrlProvider{constructor(e,t){this.lastUpdateAt=0;this.settingsCacheTime=3e3;this.attemptedRegions=[];this.serverUrl=new URL(e);this.token=t}updateToken(e){this.token=e}isCloud(){return Js(this.serverUrl)}getServerUrl(){return this.serverUrl}getNextBestRegionUrl(e){return cn(this,void 0,void 0,(function*(){if(!this.isCloud())throw Error("region availability is only supported for LiveKit Cloud domains");(!this.regionSettings||Date.now()-this.lastUpdateAt>this.settingsCacheTime)&&(this.regionSettings=yield this.fetchRegionSettings(e));const t=this.regionSettings.regions.filter((e=>!this.attemptedRegions.find((t=>t.url===e.url))));if(t.length>0){const e=t[0];this.attemptedRegions.push(e);Zi.debug("next region: ".concat(e.region));return e.url}return null}))}resetAttempts(){this.attemptedRegions=[]}fetchRegionSettings(e){return cn(this,void 0,void 0,(function*(){const t=yield fetch("".concat(bc(this.serverUrl),"/regions"),{headers:{authorization:"Bearer ".concat(this.token)},signal:e});if(t.ok){const e=yield t.json();this.lastUpdateAt=Date.now();return e}throw new ConnectionError("Could not fetch region settings: ".concat(t.statusText),t.status===401?Qr.NotAllowed:Qr.InternalError,t.status)}))}setServerReportedRegions(e){this.regionSettings=e;this.lastUpdateAt=Date.now()}}function bc(e){return"".concat(e.protocol.replace("ws","http"),"//").concat(e.host,"/settings")}class BaseStreamReader{get info(){return this._info}validateBytesReceived(){let e=arguments.length>0&&arguments[0]!==void 0&&arguments[0];if(typeof this.totalByteSize==="number"&&this.totalByteSize!==0){if(e&&this.bytesReceived<this.totalByteSize)throw new DataStreamError("Not enough chunk(s) received - expected ".concat(this.totalByteSize," bytes of data total, only received ").concat(this.bytesReceived," bytes"),Yr.Incomplete);if(this.bytesReceived>this.totalByteSize)throw new DataStreamError("Extra chunk(s) received - expected ".concat(this.totalByteSize," bytes of data total, received ").concat(this.bytesReceived," bytes"),Yr.LengthExceeded)}}constructor(e,t,i,n){this.reader=t;this.totalByteSize=i;this._info=e;this.bytesReceived=0;this.outOfBandFailureRejectingFuture=n}}class ByteStreamReader extends BaseStreamReader{handleChunkReceived(e){var t;this.bytesReceived+=e.content.byteLength;this.validateBytesReceived();const i=this.totalByteSize?this.bytesReceived/this.totalByteSize:void 0;(t=this.onProgress)===null||t===void 0?void 0:t.call(this,i)}[Symbol.asyncIterator](){const e=this.reader.getReader();let t=new Future;let i=null;let n=null;if(this.signal){const e=this.signal;n=()=>{var i;(i=t.reject)===null||i===void 0?void 0:i.call(t,e.reason)};e.addEventListener("abort",n);i=e}const r=()=>{e.releaseLock();i&&n&&i.removeEventListener("abort",n);this.signal=void 0};return{next:()=>cn(this,void 0,void 0,(function*(){var i,n;try{const{done:r,value:s}=yield Promise.race([e.read(),t.promise,(n=(i=this.outOfBandFailureRejectingFuture)===null||i===void 0?void 0:i.promise)!==null&&n!==void 0?n:new Promise((()=>{}))]);if(r){this.validateBytesReceived(true);return{done:true,value:void 0}}this.handleChunkReceived(s);return{done:false,value:s.content}}catch(e){r();throw e}})),return(){return cn(this,void 0,void 0,(function*(){r();return{done:true,value:void 0}}))}}}withAbortSignal(e){this.signal=e;return this}readAll(){return cn(this,arguments,void 0,(function(){var e=this;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return function*(){var i,n,r,s;let o=new Set;const a=t.signal?e.withAbortSignal(t.signal):e;try{for(var c,d=true,l=ln(a);c=yield l.next(),i=c.done,!i;d=true){s=c.value;d=false;const e=s;o.add(e)}}catch(e){n={error:e}}finally{try{d||i||!(r=l.return)||(yield r.call(l))}finally{if(n)throw n.error}}return Array.from(o)}()}))}}class TextStreamReader extends BaseStreamReader{constructor(e,t,i,n){super(e,t,i,n);this.receivedChunks=new Map}handleChunkReceived(e){var t;const i=yo(e.chunkIndex);const n=this.receivedChunks.get(i);if(n&&n.version>e.version)return;this.receivedChunks.set(i,e);this.bytesReceived+=e.content.byteLength;this.validateBytesReceived();const r=this.totalByteSize?this.bytesReceived/this.totalByteSize:void 0;(t=this.onProgress)===null||t===void 0?void 0:t.call(this,r)}[Symbol.asyncIterator](){const e=this.reader.getReader();const t=new TextDecoder("utf-8",{fatal:true});let i=new Future;let n=null;let r=null;if(this.signal){const e=this.signal;r=()=>{var t;(t=i.reject)===null||t===void 0?void 0:t.call(i,e.reason)};e.addEventListener("abort",r);n=e}const s=()=>{e.releaseLock();n&&r&&n.removeEventListener("abort",r);this.signal=void 0};return{next:()=>cn(this,void 0,void 0,(function*(){var n,r;try{const{done:s,value:o}=yield Promise.race([e.read(),i.promise,(r=(n=this.outOfBandFailureRejectingFuture)===null||n===void 0?void 0:n.promise)!==null&&r!==void 0?r:new Promise((()=>{}))]);if(s){this.validateBytesReceived(true);return{done:true,value:void 0}}{this.handleChunkReceived(o);let e;try{e=t.decode(o.content)}catch(e){throw new DataStreamError("Cannot decode datastream chunk ".concat(o.chunkIndex," as text: ").concat(e),Yr.DecodeFailed)}return{done:false,value:e}}}catch(e){s();throw e}})),return(){return cn(this,void 0,void 0,(function*(){s();return{done:true,value:void 0}}))}}}withAbortSignal(e){this.signal=e;return this}readAll(){return cn(this,arguments,void 0,(function(){var e=this;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return function*(){var i,n,r,s;let o="";const a=t.signal?e.withAbortSignal(t.signal):e;try{for(var c,d=true,l=ln(a);c=yield l.next(),i=c.done,!i;d=true){s=c.value;d=false;const e=s;o+=e}}catch(e){n={error:e}}finally{try{d||i||!(r=l.return)||(yield r.call(l))}finally{if(n)throw n.error}}return o}()}))}}class IncomingDataStreamManager{constructor(){this.log=Zi;this.byteStreamControllers=new Map;this.textStreamControllers=new Map;this.byteStreamHandlers=new Map;this.textStreamHandlers=new Map}registerTextStreamHandler(e,t){if(this.textStreamHandlers.has(e))throw new DataStreamError('A text stream handler for topic "'.concat(e,'" has already been set.'),Yr.HandlerAlreadyRegistered);this.textStreamHandlers.set(e,t)}unregisterTextStreamHandler(e){this.textStreamHandlers.delete(e)}registerByteStreamHandler(e,t){if(this.byteStreamHandlers.has(e))throw new DataStreamError('A byte stream handler for topic "'.concat(e,'" has already been set.'),Yr.HandlerAlreadyRegistered);this.byteStreamHandlers.set(e,t)}unregisterByteStreamHandler(e){this.byteStreamHandlers.delete(e)}clearHandlersAndControllers(){this.byteStreamControllers.clear();this.textStreamControllers.clear();this.byteStreamHandlers.clear();this.textStreamHandlers.clear()}validateParticipantHasNoActiveDataStreams(e){var t,i,n,r;const s=Array.from(this.textStreamControllers.entries()).filter((t=>t[1].sendingParticipantIdentity===e));const o=Array.from(this.byteStreamControllers.entries()).filter((t=>t[1].sendingParticipantIdentity===e));if(s.length>0||o.length>0){const a=new DataStreamError("Participant ".concat(e," unexpectedly disconnected in the middle of sending data"),Yr.AbnormalEnd);for(const[e,n]of o){(i=(t=n.outOfBandFailureRejectingFuture).reject)===null||i===void 0?void 0:i.call(t,a);this.byteStreamControllers.delete(e)}for(const[e,t]of s){(r=(n=t.outOfBandFailureRejectingFuture).reject)===null||r===void 0?void 0:r.call(n,a);this.textStreamControllers.delete(e)}}}handleDataStreamPacket(e){return cn(this,void 0,void 0,(function*(){switch(e.value.case){case"streamHeader":return this.handleStreamHeader(e.value.value,e.participantIdentity);case"streamChunk":return this.handleStreamChunk(e.value.value);case"streamTrailer":return this.handleStreamTrailer(e.value.value);default:throw new Error('DataPacket of value "'.concat(e.value.case,'" is not data stream related!'))}}))}handleStreamHeader(e,t){return cn(this,void 0,void 0,(function*(){var i;if(e.contentHeader.case==="byteHeader"){const n=this.byteStreamHandlers.get(e.topic);if(!n){this.log.debug("ignoring incoming byte stream due to no handler for topic",e.topic);return}let r;const s=new Future;const o={id:e.streamId,name:(i=e.contentHeader.value.name)!==null&&i!==void 0?i:"unknown",mimeType:e.mimeType,size:e.totalLength?Number(e.totalLength):void 0,topic:e.topic,timestamp:yo(e.timestamp),attributes:e.attributes};const a=new ReadableStream({start:i=>{r=i;if(this.textStreamControllers.has(e.streamId))throw new DataStreamError("A data stream read is already in progress for a stream with id ".concat(e.streamId,"."),Yr.AlreadyOpened);this.byteStreamControllers.set(e.streamId,{info:o,controller:r,startTime:Date.now(),sendingParticipantIdentity:t,outOfBandFailureRejectingFuture:s})}});n(new ByteStreamReader(o,a,yo(e.totalLength),s),{identity:t})}else if(e.contentHeader.case==="textHeader"){const i=this.textStreamHandlers.get(e.topic);if(!i){this.log.debug("ignoring incoming text stream due to no handler for topic",e.topic);return}let n;const r=new Future;const s={id:e.streamId,mimeType:e.mimeType,size:e.totalLength?Number(e.totalLength):void 0,topic:e.topic,timestamp:Number(e.timestamp),attributes:e.attributes};const o=new ReadableStream({start:i=>{n=i;if(this.textStreamControllers.has(e.streamId))throw new DataStreamError("A data stream read is already in progress for a stream with id ".concat(e.streamId,"."),Yr.AlreadyOpened);this.textStreamControllers.set(e.streamId,{info:s,controller:n,startTime:Date.now(),sendingParticipantIdentity:t,outOfBandFailureRejectingFuture:r})}});i(new TextStreamReader(s,o,yo(e.totalLength),r),{identity:t})}}))}handleStreamChunk(e){const t=this.byteStreamControllers.get(e.streamId);t&&e.content.length>0&&t.controller.enqueue(e);const i=this.textStreamControllers.get(e.streamId);i&&e.content.length>0&&i.controller.enqueue(e)}handleStreamTrailer(e){const t=this.textStreamControllers.get(e.streamId);if(t){t.info.attributes=Object.assign(Object.assign({},t.info.attributes),e.attributes);t.controller.close();this.textStreamControllers.delete(e.streamId)}const i=this.byteStreamControllers.get(e.streamId);if(i){i.info.attributes=Object.assign(Object.assign({},i.info.attributes),e.attributes);i.controller.close();this.byteStreamControllers.delete(e.streamId)}}}class BaseStreamWriter{constructor(e,t,i){this.writableStream=e;this.defaultWriter=e.getWriter();this.onClose=i;this.info=t}write(e){return this.defaultWriter.write(e)}close(){return cn(this,void 0,void 0,(function*(){var e;yield this.defaultWriter.close();this.defaultWriter.releaseLock();(e=this.onClose)===null||e===void 0?void 0:e.call(this)}))}}class TextStreamWriter extends BaseStreamWriter{}class ByteStreamWriter extends BaseStreamWriter{}const yc=15e3;class OutgoingDataStreamManager{constructor(e,t){this.engine=e;this.log=t}setupEngine(e){this.engine=e}sendText(e,t){return cn(this,void 0,void 0,(function*(){var i;const n=crypto.randomUUID();const r=(new TextEncoder).encode(e);const s=r.byteLength;const o=(i=t===null||t===void 0?void 0:t.attachments)===null||i===void 0?void 0:i.map((()=>crypto.randomUUID()));const a=new Array(o?o.length+1:1).fill(0);const c=(e,i)=>{var n;a[i]=e;const r=a.reduce(((e,t)=>e+t),0);(n=t===null||t===void 0?void 0:t.onProgress)===null||n===void 0?void 0:n.call(t,r)};const d=yield this.streamText({streamId:n,totalSize:s,destinationIdentities:t===null||t===void 0?void 0:t.destinationIdentities,topic:t===null||t===void 0?void 0:t.topic,attachedStreamIds:o,attributes:t===null||t===void 0?void 0:t.attributes});yield d.write(e);c(1,0);yield d.close();(t===null||t===void 0?void 0:t.attachments)&&o&&(yield Promise.all(t.attachments.map(((e,i)=>cn(this,void 0,void 0,(function*(){return this._sendFile(o[i],e,{topic:t.topic,mimeType:e.type,onProgress:e=>{c(e,i+1)}})}))))));return d.info}))}streamText(e){return cn(this,void 0,void 0,(function*(){var t,i;const n=(t=e===null||e===void 0?void 0:e.streamId)!==null&&t!==void 0?t:crypto.randomUUID();const r={id:n,mimeType:"text/plain",timestamp:Date.now(),topic:(i=e===null||e===void 0?void 0:e.topic)!==null&&i!==void 0?i:"",size:e===null||e===void 0?void 0:e.totalSize,attributes:e===null||e===void 0?void 0:e.attributes};const s=new Gt({streamId:n,mimeType:r.mimeType,topic:r.topic,timestamp:To(r.timestamp),totalLength:To(e===null||e===void 0?void 0:e.totalSize),attributes:r.attributes,contentHeader:{case:"textHeader",value:new Wt({version:e===null||e===void 0?void 0:e.version,attachedStreamIds:e===null||e===void 0?void 0:e.attachedStreamIds,replyToStreamId:e===null||e===void 0?void 0:e.replyToStreamId,operationType:(e===null||e===void 0?void 0:e.type)==="update"?Ht.UPDATE:Ht.CREATE})}});const o=e===null||e===void 0?void 0:e.destinationIdentities;const a=new Tt({destinationIdentities:o,value:{case:"streamHeader",value:s}});yield this.engine.sendDataPacket(a,Ct.RELIABLE);let c=0;const d=this.engine;const l=new WritableStream({write(e){return cn(this,void 0,void 0,(function*(){for(const t of Mo(e,yc)){yield d.waitForBufferStatusLow(Ct.RELIABLE);const e=new zt({content:t,streamId:n,chunkIndex:To(c)});const i=new Tt({destinationIdentities:o,value:{case:"streamChunk",value:e}});yield d.sendDataPacket(i,Ct.RELIABLE);c+=1}}))},close(){return cn(this,void 0,void 0,(function*(){const e=new Jt({streamId:n});const t=new Tt({destinationIdentities:o,value:{case:"streamTrailer",value:e}});yield d.sendDataPacket(t,Ct.RELIABLE)}))},abort(e){console.log("Sink error:",e)}});let u=()=>cn(this,void 0,void 0,(function*(){yield h.close()}));d.once(ts.Closing,u);const h=new TextStreamWriter(l,r,(()=>this.engine.off(ts.Closing,u)));return h}))}sendFile(e,t){return cn(this,void 0,void 0,(function*(){const i=crypto.randomUUID();yield this._sendFile(i,e,t);return{id:i}}))}_sendFile(e,t,i){return cn(this,void 0,void 0,(function*(){var n;const r=yield this.streamBytes({streamId:e,totalSize:t.size,name:t.name,mimeType:(n=i===null||i===void 0?void 0:i.mimeType)!==null&&n!==void 0?n:t.type,topic:i===null||i===void 0?void 0:i.topic,destinationIdentities:i===null||i===void 0?void 0:i.destinationIdentities});const s=t.stream().getReader();while(true){const{done:e,value:t}=yield s.read();if(e)break;yield r.write(t)}yield r.close();return r.info}))}streamBytes(e){return cn(this,void 0,void 0,(function*(){var t,i,n,r,s;const o=(t=e===null||e===void 0?void 0:e.streamId)!==null&&t!==void 0?t:crypto.randomUUID();const a=e===null||e===void 0?void 0:e.destinationIdentities;const c={id:o,mimeType:(i=e===null||e===void 0?void 0:e.mimeType)!==null&&i!==void 0?i:"application/octet-stream",topic:(n=e===null||e===void 0?void 0:e.topic)!==null&&n!==void 0?n:"",timestamp:Date.now(),attributes:e===null||e===void 0?void 0:e.attributes,size:e===null||e===void 0?void 0:e.totalSize,name:(r=e===null||e===void 0?void 0:e.name)!==null&&r!==void 0?r:"unknown"};const d=new Gt({totalLength:To((s=c.size)!==null&&s!==void 0?s:0),mimeType:c.mimeType,streamId:o,topic:c.topic,timestamp:To(Date.now()),attributes:c.attributes,contentHeader:{case:"byteHeader",value:new Kt({name:c.name})}});const l=new Tt({destinationIdentities:a,value:{case:"streamHeader",value:d}});yield this.engine.sendDataPacket(l,Ct.RELIABLE);let u=0;const h=new _;const p=this.engine;const m=this.log;const g=new WritableStream({write(e){return cn(this,void 0,void 0,(function*(){const t=yield h.lock();let i=0;try{while(i<e.byteLength){const t=e.slice(i,i+yc);yield p.waitForBufferStatusLow(Ct.RELIABLE);const n=new Tt({destinationIdentities:a,value:{case:"streamChunk",value:new zt({content:t,streamId:o,chunkIndex:To(u)})}});yield p.sendDataPacket(n,Ct.RELIABLE);u+=1;i+=t.byteLength}}finally{t()}}))},close(){return cn(this,void 0,void 0,(function*(){const e=new Jt({streamId:o});const t=new Tt({destinationIdentities:a,value:{case:"streamTrailer",value:e}});yield p.sendDataPacket(t,Ct.RELIABLE)}))},abort(e){m.error("Sink error:",e)}});const f=new ByteStreamWriter(g,c);return f}))}}class RemoteTrack extends Track{constructor(e,t,i,n,r){super(e,i,r);this.sid=t;this.receiver=n}get isLocal(){return false}setMuted(e){if(this.isMuted!==e){this.isMuted=e;this._mediaStreamTrack.enabled=!e;this.emit(e?is.Muted:is.Unmuted,this)}}setMediaStream(e){this.mediaStream=e;const t=i=>{if(i.track===this._mediaStreamTrack){e.removeEventListener("removetrack",t);this.receiver&&"playoutDelayHint"in this.receiver&&(this.receiver.playoutDelayHint=void 0);this.receiver=void 0;this._currentBitrate=0;this.emit(is.Ended,this)}};e.addEventListener("removetrack",t)}start(){this.startMonitor();super.enable()}stop(){this.stopMonitor();super.disable()}
/**
   * Gets the RTCStatsReport for the RemoteTrack's underlying RTCRtpReceiver
   * See https://developer.mozilla.org/en-US/docs/Web/API/RTCStatsReport
   *
   * @returns Promise<RTCStatsReport> | undefined
   */getRTCStatsReport(){return cn(this,void 0,void 0,(function*(){var e;if(!((e=this.receiver)===null||e===void 0?void 0:e.getStats))return;const t=yield this.receiver.getStats();return t}))}setPlayoutDelay(e){this.receiver?"playoutDelayHint"in this.receiver?this.receiver.playoutDelayHint=e:this.log.warn("Playout delay not supported in this browser"):this.log.warn("Cannot set playout delay, track already ended")}getPlayoutDelay(){if(this.receiver){if("playoutDelayHint"in this.receiver)return this.receiver.playoutDelayHint;this.log.warn("Playout delay not supported in this browser")}else this.log.warn("Cannot get playout delay, track already ended");return 0}startMonitor(){this.monitorInterval||(this.monitorInterval=setInterval((()=>this.monitorReceiver()),ja));Wo()&&this.registerTimeSyncUpdate()}registerTimeSyncUpdate(){const e=()=>{var t;this.timeSyncHandle=requestAnimationFrame((()=>e()));const i=(t=this.receiver)===null||t===void 0?void 0:t.getSynchronizationSources()[0];if(i){const{timestamp:e,rtpTimestamp:t}=i;if(t&&this.rtpTimestamp!==t){this.emit(is.TimeSyncUpdate,{timestamp:e,rtpTimestamp:t});this.rtpTimestamp=t}}};e()}}class RemoteAudioTrack extends RemoteTrack{constructor(e,t,i,n,r,s){super(e,t,Track.Kind.Audio,i,s);this.monitorReceiver=()=>cn(this,void 0,void 0,(function*(){if(!this.receiver){this._currentBitrate=0;return}const e=yield this.getReceiverStats();e&&this.prevStats&&this.receiver&&(this._currentBitrate=Fa(e,this.prevStats));this.prevStats=e}));this.audioContext=n;this.webAudioPluginNodes=[];r&&(this.sinkId=r.deviceId)}setVolume(e){var t;for(const i of this.attachedElements)this.audioContext?(t=this.gainNode)===null||t===void 0?void 0:t.gain.setTargetAtTime(e,0,.1):i.volume=e;zs()&&this._mediaStreamTrack._setVolume(e);this.elementVolume=e}getVolume(){if(this.elementVolume)return this.elementVolume;if(zs())return 1;let e=0;this.attachedElements.forEach((t=>{t.volume>e&&(e=t.volume)}));return e}
/**
   * calls setSinkId on all attached elements, if supported
   * @param deviceId audio output device
   */setSinkId(e){return cn(this,void 0,void 0,(function*(){this.sinkId=e;yield Promise.all(this.attachedElements.map((t=>{if(Us(t))return t.setSinkId(e)})))}))}attach(e){const t=this.attachedElements.length===0;e?super.attach(e):e=super.attach();this.sinkId&&Us(e)&&e.setSinkId(this.sinkId).catch((e=>{this.log.error("Failed to set sink id on remote audio track",e,this.logContext)}));if(this.audioContext&&t){this.log.debug("using audio context mapping",this.logContext);this.connectWebAudio(this.audioContext,e);e.volume=0;e.muted=true}this.elementVolume&&this.setVolume(this.elementVolume);return e}detach(e){let t;if(e){t=super.detach(e);this.audioContext&&(this.attachedElements.length>0?this.connectWebAudio(this.audioContext,this.attachedElements[0]):this.disconnectWebAudio())}else{t=super.detach();this.disconnectWebAudio()}return t}setAudioContext(e){this.audioContext=e;e&&this.attachedElements.length>0?this.connectWebAudio(e,this.attachedElements[0]):e||this.disconnectWebAudio()}
/**
   * @internal
   * @experimental
   * @param {AudioNode[]} nodes - An array of WebAudio nodes. These nodes should not be connected to each other when passed, as the sdk will take care of connecting them in the order of the array.
   */setWebAudioPlugins(e){this.webAudioPluginNodes=e;this.attachedElements.length>0&&this.audioContext&&this.connectWebAudio(this.audioContext,this.attachedElements[0])}connectWebAudio(e,t){this.disconnectWebAudio();this.sourceNode=e.createMediaStreamSource(t.srcObject);let i=this.sourceNode;this.webAudioPluginNodes.forEach((e=>{i.connect(e);i=e}));this.gainNode=e.createGain();i.connect(this.gainNode);this.gainNode.connect(e.destination);this.elementVolume&&this.gainNode.gain.setTargetAtTime(this.elementVolume,0,.1);e.state!=="running"&&e.resume().then((()=>{e.state!=="running"&&this.emit(is.AudioPlaybackFailed,new Error("Audio Context couldn't be started automatically"))})).catch((e=>{this.emit(is.AudioPlaybackFailed,e)}))}disconnectWebAudio(){var e,t;(e=this.gainNode)===null||e===void 0?void 0:e.disconnect();(t=this.sourceNode)===null||t===void 0?void 0:t.disconnect();this.gainNode=void 0;this.sourceNode=void 0}getReceiverStats(){return cn(this,void 0,void 0,(function*(){if(!this.receiver||!this.receiver.getStats)return;const e=yield this.receiver.getStats();let t;e.forEach((e=>{e.type==="inbound-rtp"&&(t={type:"audio",streamId:e.id,timestamp:e.timestamp,jitter:e.jitter,bytesReceived:e.bytesReceived,concealedSamples:e.concealedSamples,concealmentEvents:e.concealmentEvents,silentConcealedSamples:e.silentConcealedSamples,silentConcealmentEvents:e.silentConcealmentEvents,totalAudioEnergy:e.totalAudioEnergy,totalSamplesDuration:e.totalSamplesDuration})}));return t}))}}const Tc=100;class RemoteVideoTrack extends RemoteTrack{constructor(e,t,i,n,r){super(e,t,Track.Kind.Video,i,r);this.elementInfos=[];this.monitorReceiver=()=>cn(this,void 0,void 0,(function*(){if(!this.receiver){this._currentBitrate=0;return}const e=yield this.getReceiverStats();e&&this.prevStats&&this.receiver&&(this._currentBitrate=Fa(e,this.prevStats));this.prevStats=e}));this.debouncedHandleResize=Ta((()=>{this.updateDimensions()}),Tc);this.adaptiveStreamSettings=n}get isAdaptiveStream(){return this.adaptiveStreamSettings!==void 0}setStreamState(e){super.setStreamState(e);console.log("setStreamState",e);e===Track.StreamState.Active&&this.updateVisibility()}get mediaStreamTrack(){return this._mediaStreamTrack}setMuted(e){super.setMuted(e);this.attachedElements.forEach((t=>{e?vs(this._mediaStreamTrack,t):fs(this._mediaStreamTrack,t)}))}attach(e){e?super.attach(e):e=super.attach();if(this.adaptiveStreamSettings&&this.elementInfos.find((t=>t.element===e))===void 0){const t=new HTMLElementInfo(e);this.observeElementInfo(t)}return e}
/**
   * Observe an ElementInfo for changes when adaptive streaming.
   * @param elementInfo
   * @internal
   */observeElementInfo(e){if(this.adaptiveStreamSettings&&this.elementInfos.find((t=>t===e))===void 0){e.handleResize=()=>{this.debouncedHandleResize()};e.handleVisibilityChanged=()=>{this.updateVisibility()};this.elementInfos.push(e);e.observe();this.debouncedHandleResize();this.updateVisibility()}else this.log.warn("visibility resize observer not triggered",this.logContext)}
/**
   * Stop observing an ElementInfo for changes.
   * @param elementInfo
   * @internal
   */stopObservingElementInfo(e){if(!this.isAdaptiveStream){this.log.warn("stopObservingElementInfo ignored",this.logContext);return}const t=this.elementInfos.filter((t=>t===e));for(const e of t)e.stopObserving();this.elementInfos=this.elementInfos.filter((t=>t!==e));this.updateVisibility();this.debouncedHandleResize()}detach(e){let t=[];if(e){this.stopObservingElement(e);return super.detach(e)}t=super.detach();for(const e of t)this.stopObservingElement(e);return t}getDecoderImplementation(){var e;return(e=this.prevStats)===null||e===void 0?void 0:e.decoderImplementation}getReceiverStats(){return cn(this,void 0,void 0,(function*(){if(!this.receiver||!this.receiver.getStats)return;const e=yield this.receiver.getStats();let t;let i="";let n=new Map;e.forEach((e=>{if(e.type==="inbound-rtp"){i=e.codecId;t={type:"video",streamId:e.id,framesDecoded:e.framesDecoded,framesDropped:e.framesDropped,framesReceived:e.framesReceived,packetsReceived:e.packetsReceived,packetsLost:e.packetsLost,frameWidth:e.frameWidth,frameHeight:e.frameHeight,pliCount:e.pliCount,firCount:e.firCount,nackCount:e.nackCount,jitter:e.jitter,timestamp:e.timestamp,bytesReceived:e.bytesReceived,decoderImplementation:e.decoderImplementation}}else e.type==="codec"&&n.set(e.id,e)}));t&&i!==""&&n.get(i)&&(t.mimeType=n.get(i).mimeType);return t}))}stopObservingElement(e){const t=this.elementInfos.filter((t=>t.element===e));for(const e of t)this.stopObservingElementInfo(e)}handleAppVisibilityChanged(){const e=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return cn(this,void 0,void 0,(function*(){yield e.handleAppVisibilityChanged.call(this);this.isAdaptiveStream&&this.updateVisibility()}))}updateVisibility(e){var t,i;const n=this.elementInfos.reduce(((e,t)=>Math.max(e,t.visibilityChangedAt||0)),0);const r=!((i=(t=this.adaptiveStreamSettings)===null||t===void 0?void 0:t.pauseVideoInBackground)!==null&&i!==void 0&&!i)&&this.isInBackground;const s=this.elementInfos.some((e=>e.pictureInPicture));const o=this.elementInfos.some((e=>e.visible))&&!r||s;if(this.lastVisible!==o||e)if(!o&&Date.now()-n<Tc)CriticalTimers.setTimeout((()=>{this.updateVisibility()}),Tc);else{this.lastVisible=o;this.emit(is.VisibilityChanged,o,this)}}updateDimensions(){var e,t;let i=0;let n=0;const r=this.getPixelDensity();for(const e of this.elementInfos){const t=e.width()*r;const s=e.height()*r;if(t+s>i+n){i=t;n=s}}if(((e=this.lastDimensions)===null||e===void 0?void 0:e.width)!==i||((t=this.lastDimensions)===null||t===void 0?void 0:t.height)!==n){this.lastDimensions={width:i,height:n};this.emit(is.VideoDimensionsChanged,this.lastDimensions,this)}}getPixelDensity(){var e;const t=(e=this.adaptiveStreamSettings)===null||e===void 0?void 0:e.pixelDensity;if(t==="screen")return Xs();if(!t){const e=Xs();return e>2?2:1}return t}}class HTMLElementInfo{get visible(){return this.isPiP||this.isIntersecting}get pictureInPicture(){return this.isPiP}constructor(e,t){this.onVisibilityChanged=e=>{var t;const{target:i,isIntersecting:n}=e;if(i===this.element){this.isIntersecting=n;this.isPiP=Cc(this.element);this.visibilityChangedAt=Date.now();(t=this.handleVisibilityChanged)===null||t===void 0?void 0:t.call(this)}};this.onEnterPiP=()=>{var e,t,i;(t=(e=window.documentPictureInPicture)===null||e===void 0?void 0:e.window)===null||t===void 0?void 0:t.addEventListener("pagehide",this.onLeavePiP);this.isPiP=Cc(this.element);(i=this.handleVisibilityChanged)===null||i===void 0?void 0:i.call(this)};this.onLeavePiP=()=>{var e;this.isPiP=Cc(this.element);(e=this.handleVisibilityChanged)===null||e===void 0?void 0:e.call(this)};this.element=e;this.isIntersecting=t!==null&&t!==void 0?t:Sc(e);this.isPiP=Gs()&&Cc(e);this.visibilityChangedAt=0}width(){return this.element.clientWidth}height(){return this.element.clientHeight}observe(){var e,t,i;this.isIntersecting=Sc(this.element);this.isPiP=Cc(this.element);this.element.handleResize=()=>{var e;(e=this.handleResize)===null||e===void 0?void 0:e.call(this)};this.element.handleVisibilityChanged=this.onVisibilityChanged;ro().observe(this.element);io().observe(this.element);this.element.addEventListener("enterpictureinpicture",this.onEnterPiP);this.element.addEventListener("leavepictureinpicture",this.onLeavePiP);(e=window.documentPictureInPicture)===null||e===void 0?void 0:e.addEventListener("enter",this.onEnterPiP);(i=(t=window.documentPictureInPicture)===null||t===void 0?void 0:t.window)===null||i===void 0?void 0:i.addEventListener("pagehide",this.onLeavePiP)}stopObserving(){var e,t,i,n,r;(e=ro())===null||e===void 0?void 0:e.unobserve(this.element);(t=io())===null||t===void 0?void 0:t.unobserve(this.element);this.element.removeEventListener("enterpictureinpicture",this.onEnterPiP);this.element.removeEventListener("leavepictureinpicture",this.onLeavePiP);(i=window.documentPictureInPicture)===null||i===void 0?void 0:i.removeEventListener("enter",this.onEnterPiP);(r=(n=window.documentPictureInPicture)===null||n===void 0?void 0:n.window)===null||r===void 0?void 0:r.removeEventListener("pagehide",this.onLeavePiP)}}function Cc(e){var t,i;return document.pictureInPictureElement===e||!!((t=window.documentPictureInPicture)===null||t===void 0?void 0:t.window)&&Sc(e,(i=window.documentPictureInPicture)===null||i===void 0?void 0:i.window)}function Sc(e,t){const i=t||window;let n=e.offsetTop;let r=e.offsetLeft;const s=e.offsetWidth;const o=e.offsetHeight;const{hidden:a}=e;const{display:c}=getComputedStyle(e);while(e.offsetParent){e=e.offsetParent;n+=e.offsetTop;r+=e.offsetLeft}return n<i.pageYOffset+i.innerHeight&&r<i.pageXOffset+i.innerWidth&&n+o>i.pageYOffset&&r+s>i.pageXOffset&&!a&&c!=="none"}class TrackPublication extends mn.EventEmitter{constructor(e,t,i,n){var r;super();this.metadataMuted=false;this.encryption=vt.NONE;this.log=Zi;this.handleMuted=()=>{this.emit(is.Muted)};this.handleUnmuted=()=>{this.emit(is.Unmuted)};this.log=en((r=n===null||n===void 0?void 0:n.loggerName)!==null&&r!==void 0?r:Xi.Publication);this.loggerContextCb=this.loggerContextCb;this.setMaxListeners(100);this.kind=e;this.trackSid=t;this.trackName=i;this.source=Track.Source.Unknown}setTrack(e){if(this.track){this.track.off(is.Muted,this.handleMuted);this.track.off(is.Unmuted,this.handleUnmuted)}this.track=e;if(e){e.on(is.Muted,this.handleMuted);e.on(is.Unmuted,this.handleUnmuted)}}get logContext(){var e;return Object.assign(Object.assign({},(e=this.loggerContextCb)===null||e===void 0?void 0:e.call(this)),Ho(this))}get isMuted(){return this.metadataMuted}get isEnabled(){return true}get isSubscribed(){return this.track!==void 0}get isEncrypted(){return this.encryption!==vt.NONE}get audioTrack(){if(So(this.track))return this.track}get videoTrack(){if(wo(this.track))return this.track}updateInfo(e){this.trackSid=e.sid;this.trackName=e.name;this.source=Track.sourceFromProto(e.source);this.mimeType=e.mimeType;if(this.kind===Track.Kind.Video&&e.width>0){this.dimensions={width:e.width,height:e.height};this.simulcasted=e.simulcast}this.encryption=e.encryption;this.trackInfo=e;this.log.debug("update publication info",Object.assign(Object.assign({},this.logContext),{info:e}))}}(function(e){(function(e){e.Desired="desired";e.Subscribed="subscribed";e.Unsubscribed="unsubscribed"})(e.SubscriptionStatus||(e.SubscriptionStatus={}));(function(e){e.Allowed="allowed";e.NotAllowed="not_allowed"})(e.PermissionStatus||(e.PermissionStatus={}))})(TrackPublication||(TrackPublication={}));class LocalTrackPublication extends TrackPublication{get isUpstreamPaused(){var e;return(e=this.track)===null||e===void 0?void 0:e.isUpstreamPaused}constructor(e,t,i,n){super(e,t.sid,t.name,n);this.track=void 0;this.handleTrackEnded=()=>{this.emit(is.Ended)};this.handleCpuConstrained=()=>{this.track&&wo(this.track)&&this.emit(is.CpuConstrained,this.track)};this.updateInfo(t);this.setTrack(i)}setTrack(e){if(this.track){this.track.off(is.Ended,this.handleTrackEnded);this.track.off(is.CpuConstrained,this.handleCpuConstrained)}super.setTrack(e);if(e){e.on(is.Ended,this.handleTrackEnded);e.on(is.CpuConstrained,this.handleCpuConstrained)}}get isMuted(){return this.track?this.track.isMuted:super.isMuted}get audioTrack(){return super.audioTrack}get videoTrack(){return super.videoTrack}get isLocal(){return true}mute(){return cn(this,void 0,void 0,(function*(){var e;return(e=this.track)===null||e===void 0?void 0:e.mute()}))}unmute(){return cn(this,void 0,void 0,(function*(){var e;return(e=this.track)===null||e===void 0?void 0:e.unmute()}))}pauseUpstream(){return cn(this,void 0,void 0,(function*(){var e;yield(e=this.track)===null||e===void 0?void 0:e.pauseUpstream()}))}resumeUpstream(){return cn(this,void 0,void 0,(function*(){var e;yield(e=this.track)===null||e===void 0?void 0:e.resumeUpstream()}))}getTrackFeatures(){var e;if(So(this.track)){const t=this.track.getSourceTrackSettings();const i=new Set;t.autoGainControl&&i.add(dt.TF_AUTO_GAIN_CONTROL);t.echoCancellation&&i.add(dt.TF_ECHO_CANCELLATION);t.noiseSuppression&&i.add(dt.TF_NOISE_SUPPRESSION);t.channelCount&&t.channelCount>1&&i.add(dt.TF_STEREO);((e=this.options)===null||e===void 0?void 0:e.dtx)||i.add(dt.TF_NO_DTX);this.track.enhancedNoiseCancellation&&i.add(dt.TF_ENHANCED_NOISE_CANCELLATION);return Array.from(i.values())}return[]}}
/**
 * Creates a local video and audio track at the same time. When acquiring both
 * audio and video tracks together, it'll display a single permission prompt to
 * the user instead of two separate ones.
 * @param options
 */function wc(e,t){return cn(this,void 0,void 0,(function*(){e!==null&&e!==void 0?e:e={};let i=false;const{audioProcessor:n,videoProcessor:r,optionsWithoutProcessor:s}=Go(e);let o=s.audio;let a=s.video;n&&typeof s.audio==="object"&&(s.audio.processor=n);r&&typeof s.video==="object"&&(s.video.processor=r);if(e.audio&&typeof s.audio==="object"&&typeof s.audio.deviceId==="string"){const e=s.audio.deviceId;s.audio.deviceId={exact:e};i=true;o=Object.assign(Object.assign({},s.audio),{deviceId:{ideal:e}})}if(s.video&&typeof s.video==="object"&&typeof s.video.deviceId==="string"){const e=s.video.deviceId;s.video.deviceId={exact:e};i=true;a=Object.assign(Object.assign({},s.video),{deviceId:{ideal:e}})}(s.audio===true||typeof s.audio==="object"&&!s.audio.deviceId)&&(s.audio={deviceId:"default"});s.video===true?s.video={deviceId:"default"}:typeof s.video!=="object"||s.video.deviceId||(s.video.deviceId="default");const c=Ao(s,Da,xa);const d=No(c);const l=navigator.mediaDevices.getUserMedia(d);if(s.audio){DeviceManager.userMediaPromiseMap.set("audioinput",l);l.catch((()=>DeviceManager.userMediaPromiseMap.delete("audioinput")))}if(s.video){DeviceManager.userMediaPromiseMap.set("videoinput",l);l.catch((()=>DeviceManager.userMediaPromiseMap.delete("videoinput")))}try{const e=yield l;return yield Promise.all(e.getTracks().map((i=>cn(this,void 0,void 0,(function*(){const s=i.kind==="audio";let o=s?c.audio:c.video;typeof o!=="boolean"&&o||(o={});let a;const l=s?d.audio:d.video;typeof l!=="boolean"&&(a=l);const u=i.getSettings().deviceId;(a===null||a===void 0?void 0:a.deviceId)&&mo(a.deviceId)!==u?a.deviceId=u:a||(a={deviceId:u});const h=Ka(i,a,t);h.kind===Track.Kind.Video?h.source=Track.Source.Camera:h.kind===Track.Kind.Audio&&(h.source=Track.Source.Microphone);h.mediaStream=e;So(h)&&n?yield h.setProcessor(n):wo(h)&&r&&(yield h.setProcessor(r));return h})))))}catch(n){if(!i)throw n;return wc(Object.assign(Object.assign({},e),{audio:o,video:a}),t)}}))}
/**
 * Creates a [[LocalVideoTrack]] with getUserMedia()
 * @param options
 */function Ec(e){return cn(this,void 0,void 0,(function*(){const t=yield wc({audio:false,video:e===null||e===void 0||e});return t[0]}))}function Pc(e){return cn(this,void 0,void 0,(function*(){const t=yield wc({audio:e===null||e===void 0||e,video:false});return t[0]}))}function Rc(e){return cn(this,void 0,void 0,(function*(){e===void 0&&(e={});e.resolution!==void 0||qs()||(e.resolution=Es.h1080fps30.resolution);if(navigator.mediaDevices.getDisplayMedia===void 0)throw new DeviceUnsupportedError("getDisplayMedia not supported");const t=Bo(e);const i=yield navigator.mediaDevices.getDisplayMedia(t);const n=i.getVideoTracks();if(n.length===0)throw new TrackInvalidError("no video track found");const r=new LocalVideoTrack(n[0],void 0,false);r.source=Track.Source.ScreenShare;const s=[r];if(i.getAudioTracks().length>0){const e=new LocalAudioTrack(i.getAudioTracks()[0],void 0,false);e.source=Track.Source.ScreenShareAudio;s.push(e)}return s}))}var Ic;(function(e){e.Excellent="excellent";e.Good="good";e.Poor="poor";e.Lost="lost";e.Unknown="unknown"})(Ic||(Ic={}));function Oc(e){switch(e){case rt.EXCELLENT:return Ic.Excellent;case rt.GOOD:return Ic.Good;case rt.POOR:return Ic.Poor;case rt.LOST:return Ic.Lost;default:return Ic.Unknown}}class Participant extends mn.EventEmitter{get logContext(){var e,t;return Object.assign({},(t=(e=this.loggerOptions)===null||e===void 0?void 0:e.loggerContextCb)===null||t===void 0?void 0:t.call(e))}get isEncrypted(){return this.trackPublications.size>0&&Array.from(this.trackPublications.values()).every((e=>e.isEncrypted))}get isAgent(){var e;return((e=this.permissions)===null||e===void 0?void 0:e.agent)||this.kind===gt.AGENT}get isActive(){var e;return((e=this.participantInfo)===null||e===void 0?void 0:e.state)===mt.ACTIVE}get kind(){return this._kind}get attributes(){return Object.freeze(Object.assign({},this._attributes))}constructor(e,t,i,n,r,s){let o=arguments.length>6&&arguments[6]!==void 0?arguments[6]:gt.STANDARD;var a;super();this.audioLevel=0;this.isSpeaking=false;this._connectionQuality=Ic.Unknown;this.log=Zi;this.log=en((a=s===null||s===void 0?void 0:s.loggerName)!==null&&a!==void 0?a:Xi.Participant);this.loggerOptions=s;this.setMaxListeners(100);this.sid=e;this.identity=t;this.name=i;this.metadata=n;this.audioTrackPublications=new Map;this.videoTrackPublications=new Map;this.trackPublications=new Map;this._kind=o;this._attributes=r!==null&&r!==void 0?r:{}}getTrackPublications(){return Array.from(this.trackPublications.values())}getTrackPublication(e){for(const[,t]of this.trackPublications)if(t.source===e)return t}getTrackPublicationByName(e){for(const[,t]of this.trackPublications)if(t.trackName===e)return t}
/**
   * Waits until the participant is active and ready to receive data messages
   * @returns a promise that resolves when the participant is active
   */waitUntilActive(){if(this.isActive)return Promise.resolve();if(this.activeFuture)return this.activeFuture.promise;this.activeFuture=new Future;this.once(es.Active,(()=>{var e,t;(t=(e=this.activeFuture)===null||e===void 0?void 0:e.resolve)===null||t===void 0?void 0:t.call(e);this.activeFuture=void 0}));return this.activeFuture.promise}get connectionQuality(){return this._connectionQuality}get isCameraEnabled(){var e;const t=this.getTrackPublication(Track.Source.Camera);return!((e=t===null||t===void 0?void 0:t.isMuted)===null||e===void 0||e)}get isMicrophoneEnabled(){var e;const t=this.getTrackPublication(Track.Source.Microphone);return!((e=t===null||t===void 0?void 0:t.isMuted)===null||e===void 0||e)}get isScreenShareEnabled(){const e=this.getTrackPublication(Track.Source.ScreenShare);return!!e}get isLocal(){return false}get joinedAt(){return this.participantInfo?new Date(Number.parseInt(this.participantInfo.joinedAt.toString())*1e3):new Date}updateInfo(e){var t;if(this.participantInfo&&this.participantInfo.sid===e.sid&&this.participantInfo.version>e.version)return false;this.identity=e.identity;this.sid=e.sid;this._setName(e.name);this._setMetadata(e.metadata);this._setAttributes(e.attributes);e.state===mt.ACTIVE&&((t=this.participantInfo)===null||t===void 0?void 0:t.state)!==mt.ACTIVE&&this.emit(es.Active);e.permission&&this.setPermissions(e.permission);this.participantInfo=e;return true}_setMetadata(e){const t=this.metadata!==e;const i=this.metadata;this.metadata=e;t&&this.emit(es.ParticipantMetadataChanged,i)}_setName(e){const t=this.name!==e;this.name=e;t&&this.emit(es.ParticipantNameChanged,e)}_setAttributes(e){const t=Ko(this.attributes,e);this._attributes=e;Object.keys(t).length>0&&this.emit(es.AttributesChanged,t)}setPermissions(e){var t,i,n,r,s,o;const a=this.permissions;const c=e.canPublish!==((t=this.permissions)===null||t===void 0?void 0:t.canPublish)||e.canSubscribe!==((i=this.permissions)===null||i===void 0?void 0:i.canSubscribe)||e.canPublishData!==((n=this.permissions)===null||n===void 0?void 0:n.canPublishData)||e.hidden!==((r=this.permissions)===null||r===void 0?void 0:r.hidden)||e.recorder!==((s=this.permissions)===null||s===void 0?void 0:s.recorder)||e.canPublishSources.length!==this.permissions.canPublishSources.length||e.canPublishSources.some(((e,t)=>{var i;return e!==((i=this.permissions)===null||i===void 0?void 0:i.canPublishSources[t])}))||e.canSubscribeMetrics!==((o=this.permissions)===null||o===void 0?void 0:o.canSubscribeMetrics);this.permissions=e;c&&this.emit(es.ParticipantPermissionsChanged,a);return c}setIsSpeaking(e){if(e!==this.isSpeaking){this.isSpeaking=e;e&&(this.lastSpokeAt=new Date);this.emit(es.IsSpeakingChanged,e)}}setConnectionQuality(e){const t=this._connectionQuality;this._connectionQuality=Oc(e);t!==this._connectionQuality&&this.emit(es.ConnectionQualityChanged,this._connectionQuality)}setDisconnected(){var e,t;if(this.activeFuture){(t=(e=this.activeFuture).reject)===null||t===void 0?void 0:t.call(e,new Error("Participant disconnected"));this.activeFuture=void 0}}setAudioContext(e){this.audioContext=e;this.audioTrackPublications.forEach((t=>So(t.track)&&t.track.setAudioContext(e)))}addTrackPublication(e){e.on(is.Muted,(()=>{this.emit(es.TrackMuted,e)}));e.on(is.Unmuted,(()=>{this.emit(es.TrackUnmuted,e)}));const t=e;t.track&&(t.track.sid=e.trackSid);this.trackPublications.set(e.trackSid,e);switch(e.kind){case Track.Kind.Audio:this.audioTrackPublications.set(e.trackSid,e);break;case Track.Kind.Video:this.videoTrackPublications.set(e.trackSid,e);break}}}function Dc(e){var t,i,n;if(!e.participantSid&&!e.participantIdentity)throw new Error("Invalid track permission, must provide at least one of participantIdentity and participantSid");return new Ii({participantIdentity:(t=e.participantIdentity)!==null&&t!==void 0?t:"",participantSid:(i=e.participantSid)!==null&&i!==void 0?i:"",allTracks:(n=e.allowAll)!==null&&n!==void 0&&n,trackSids:e.allowedTrackSids||[]})}class LocalParticipant extends Participant{constructor(e,t,i,n,r,s){super(e,t,void 0,void 0,void 0,{loggerName:n.loggerName,loggerContextCb:()=>this.engine.logContext});this.pendingPublishing=new Set;this.pendingPublishPromises=new Map;this.participantTrackPermissions=[];this.allParticipantsAllowedToSubscribe=true;this.encryptionType=vt.NONE;this.enabledPublishVideoCodecs=[];this.pendingAcks=new Map;this.pendingResponses=new Map;this.handleReconnecting=()=>{this.reconnectFuture||(this.reconnectFuture=new Future)};this.handleReconnected=()=>{var e,t;(t=(e=this.reconnectFuture)===null||e===void 0?void 0:e.resolve)===null||t===void 0?void 0:t.call(e);this.reconnectFuture=void 0;this.updateTrackSubscriptionPermissions()};this.handleClosing=()=>{var e,t,i,n,r,s;if(this.reconnectFuture){this.reconnectFuture.promise.catch((e=>this.log.warn(e.message,this.logContext)));(t=(e=this.reconnectFuture)===null||e===void 0?void 0:e.reject)===null||t===void 0?void 0:t.call(e,"Got disconnected during reconnection attempt");this.reconnectFuture=void 0}if(this.signalConnectedFuture){(n=(i=this.signalConnectedFuture).reject)===null||n===void 0?void 0:n.call(i,"Got disconnected without signal connected");this.signalConnectedFuture=void 0}(s=(r=this.activeAgentFuture)===null||r===void 0?void 0:r.reject)===null||s===void 0?void 0:s.call(r,"Got disconnected without active agent present");this.activeAgentFuture=void 0;this.firstActiveAgent=void 0};this.handleSignalConnected=e=>{var t,i;e.participant&&this.updateInfo(e.participant);this.signalConnectedFuture||(this.signalConnectedFuture=new Future);(i=(t=this.signalConnectedFuture).resolve)===null||i===void 0?void 0:i.call(t)};this.handleSignalRequestResponse=e=>{const{requestId:t,reason:i,message:n}=e;const r=this.pendingSignalRequests.get(t);if(r){i!==qi.OK&&r.reject(new SignalRequestError(n,i));this.pendingSignalRequests.delete(t)}};this.handleDataPacket=e=>{switch(e.value.case){case"rpcResponse":let t=e.value.value;let i=null;let n=null;t.value.case==="payload"?i=t.value.value:t.value.case==="error"&&(n=RpcError.fromProto(t.value.value));this.handleIncomingRpcResponse(t.requestId,i,n);break;case"rpcAck":let r=e.value.value;this.handleIncomingRpcAck(r.requestId);break}};this.updateTrackSubscriptionPermissions=()=>{this.log.debug("updating track subscription permissions",Object.assign(Object.assign({},this.logContext),{allParticipantsAllowed:this.allParticipantsAllowedToSubscribe,participantTrackPermissions:this.participantTrackPermissions}));this.engine.client.sendUpdateSubscriptionPermissions(this.allParticipantsAllowedToSubscribe,this.participantTrackPermissions.map((e=>Dc(e))))};this.onTrackUnmuted=e=>{this.onTrackMuted(e,e.isUpstreamPaused)};this.onTrackMuted=(e,t)=>{t===void 0&&(t=true);e.sid?this.engine.updateMuteStatus(e.sid,t):this.log.error("could not update mute status for unpublished track",Object.assign(Object.assign({},this.logContext),Ho(e)))};this.onTrackUpstreamPaused=e=>{this.log.debug("upstream paused",Object.assign(Object.assign({},this.logContext),Ho(e)));this.onTrackMuted(e,true)};this.onTrackUpstreamResumed=e=>{this.log.debug("upstream resumed",Object.assign(Object.assign({},this.logContext),Ho(e)));this.onTrackMuted(e,e.isMuted)};this.onTrackFeatureUpdate=e=>{const t=this.audioTrackPublications.get(e.sid);t?this.engine.client.sendUpdateLocalAudioTrack(t.trackSid,t.getTrackFeatures()):this.log.warn("Could not update local audio track settings, missing publication for track ".concat(e.sid),this.logContext)};this.onTrackCpuConstrained=(e,t)=>{this.log.debug("track cpu constrained",Object.assign(Object.assign({},this.logContext),Ho(t)));this.emit(es.LocalTrackCpuConstrained,e,t)};this.handleSubscribedQualityUpdate=e=>cn(this,void 0,void 0,(function*(){var t,i,n,r;var s;if(!((s=this.roomOptions)===null||s===void 0?void 0:s.dynacast))return;const o=this.videoTrackPublications.get(e.trackSid);if(!o){this.log.warn("received subscribed quality update for unknown track",Object.assign(Object.assign({},this.logContext),{trackSid:e.trackSid}));return}if(!o.videoTrack)return;const a=yield o.videoTrack.setPublishingCodecs(e.subscribedCodecs);try{for(var c,d=true,l=ln(a);c=yield l.next(),t=c.done,!t;d=true){r=c.value;d=false;const e=r;if(ys(e)){this.log.debug("publish ".concat(e," for ").concat(o.videoTrack.sid),Object.assign(Object.assign({},this.logContext),Ho(o)));yield this.publishAdditionalCodecForTrack(o.videoTrack,e,o.options)}}}catch(e){i={error:e}}finally{try{d||t||!(n=l.return)||(yield n.call(l))}finally{if(i)throw i.error}}}));this.handleLocalTrackUnpublished=e=>{const t=this.trackPublications.get(e.trackSid);t?this.unpublishTrack(t.track):this.log.warn("received unpublished event for unknown track",Object.assign(Object.assign({},this.logContext),{trackSid:e.trackSid}))};this.handleTrackEnded=e=>cn(this,void 0,void 0,(function*(){if(e.source===Track.Source.ScreenShare||e.source===Track.Source.ScreenShareAudio){this.log.debug("unpublishing local track due to TrackEnded",Object.assign(Object.assign({},this.logContext),Ho(e)));this.unpublishTrack(e)}else if(e.isUserProvided)yield e.mute();else if(Po(e)||Eo(e))try{if(Gs())try{const t=yield navigator===null||navigator===void 0?void 0:navigator.permissions.query({name:e.source===Track.Source.Camera?"camera":"microphone"});if(t&&t.state==="denied"){this.log.warn("user has revoked access to ".concat(e.source),Object.assign(Object.assign({},this.logContext),Ho(e)));t.onchange=()=>{if(t.state!=="denied"){e.isMuted||e.restartTrack();t.onchange=null}};throw new Error("GetUserMedia Permission denied")}}catch(e){}if(!e.isMuted){this.log.debug("track ended, attempting to use a different device",Object.assign(Object.assign({},this.logContext),Ho(e)));Po(e)?yield e.restartTrack({deviceId:"default"}):yield e.restartTrack()}}catch(t){this.log.warn("could not restart track, muting instead",Object.assign(Object.assign({},this.logContext),Ho(e)));yield e.mute()}}));this.audioTrackPublications=new Map;this.videoTrackPublications=new Map;this.trackPublications=new Map;this.engine=i;this.roomOptions=n;this.setupEngine(i);this.activeDeviceMap=new Map([["audioinput","default"],["videoinput","default"],["audiooutput","default"]]);this.pendingSignalRequests=new Map;this.rpcHandlers=r;this.roomOutgoingDataStreamManager=s}get lastCameraError(){return this.cameraError}get lastMicrophoneError(){return this.microphoneError}get isE2EEEnabled(){return this.encryptionType!==vt.NONE}getTrackPublication(e){const t=super.getTrackPublication(e);if(t)return t}getTrackPublicationByName(e){const t=super.getTrackPublicationByName(e);if(t)return t}setupEngine(e){var t;this.engine=e;this.engine.on(ts.RemoteMute,((e,t)=>{const i=this.trackPublications.get(e);i&&i.track&&(t?i.mute():i.unmute())}));((t=this.signalConnectedFuture)===null||t===void 0?void 0:t.isResolved)&&(this.signalConnectedFuture=void 0);this.engine.on(ts.Connected,this.handleReconnected).on(ts.SignalConnected,this.handleSignalConnected).on(ts.SignalRestarted,this.handleReconnected).on(ts.SignalResumed,this.handleReconnected).on(ts.Restarting,this.handleReconnecting).on(ts.Resuming,this.handleReconnecting).on(ts.LocalTrackUnpublished,this.handleLocalTrackUnpublished).on(ts.SubscribedQualityUpdate,this.handleSubscribedQualityUpdate).on(ts.Closing,this.handleClosing).on(ts.SignalRequestResponse,this.handleSignalRequestResponse).on(ts.DataPacketReceived,this.handleDataPacket)}
/**
   * Sets and updates the metadata of the local participant.
   * Note: this requires `canUpdateOwnMetadata` permission.
   * method will throw if the user doesn't have the required permissions
   * @param metadata
   */setMetadata(e){return cn(this,void 0,void 0,(function*(){yield this.requestMetadataUpdate({metadata:e})}))}
/**
   * Sets and updates the name of the local participant.
   * Note: this requires `canUpdateOwnMetadata` permission.
   * method will throw if the user doesn't have the required permissions
   * @param metadata
   */setName(e){return cn(this,void 0,void 0,(function*(){yield this.requestMetadataUpdate({name:e})}))}
/**
   * Set or update participant attributes. It will make updates only to keys that
   * are present in `attributes`, and will not override others.
   * Note: this requires `canUpdateOwnMetadata` permission.
   * @param attributes attributes to update
   */setAttributes(e){return cn(this,void 0,void 0,(function*(){yield this.requestMetadataUpdate({attributes:e})}))}requestMetadataUpdate(e){return cn(this,arguments,void 0,(function(e){var t=this;let{metadata:i,name:n,attributes:r}=e;return function*(){return new Promise(((e,s)=>cn(t,void 0,void 0,(function*(){var t,o;try{let a=false;const c=yield this.engine.client.sendUpdateLocalMetadata((t=i!==null&&i!==void 0?i:this.metadata)!==null&&t!==void 0?t:"",(o=n!==null&&n!==void 0?n:this.name)!==null&&o!==void 0?o:"",r);const d=performance.now();this.pendingSignalRequests.set(c,{resolve:e,reject:e=>{s(e);a=true},values:{name:n,metadata:i,attributes:r}});while(performance.now()-d<5e3&&!a){if((!n||this.name===n)&&(!i||this.metadata===i)&&(!r||Object.entries(r).every((e=>{let[t,i]=e;return this.attributes[t]===i||i===""&&!this.attributes[t]})))){this.pendingSignalRequests.delete(c);e();return}yield Os(50)}s(new SignalRequestError("Request to update local metadata timed out","TimeoutError"))}catch(e){e instanceof Error&&s(e)}}))))}()}))}setCameraEnabled(e,t,i){return this.setTrackEnabled(Track.Source.Camera,e,t,i)}setMicrophoneEnabled(e,t,i){return this.setTrackEnabled(Track.Source.Microphone,e,t,i)}setScreenShareEnabled(e,t,i){return this.setTrackEnabled(Track.Source.ScreenShare,e,t,i)}setPermissions(e){const t=this.permissions;const i=super.setPermissions(e);i&&t&&this.emit(es.ParticipantPermissionsChanged,t);return i}setE2EEEnabled(e){return cn(this,void 0,void 0,(function*(){this.encryptionType=e?vt.GCM:vt.NONE;yield this.republishAllTracks(void 0,false)}))}setTrackEnabled(e,t,i,n){return cn(this,void 0,void 0,(function*(){var r,s;this.log.debug("setTrackEnabled",Object.assign(Object.assign({},this.logContext),{source:e,enabled:t}));this.republishPromise&&(yield this.republishPromise);let o=this.getTrackPublication(e);if(t)if(o)yield o.unmute();else{let t;if(this.pendingPublishing.has(e)){const t=yield this.waitForPendingPublicationOfSource(e);t||this.log.info("waiting for pending publication promise timed out",Object.assign(Object.assign({},this.logContext),{source:e}));yield t===null||t===void 0?void 0:t.unmute();return t}this.pendingPublishing.add(e);try{switch(e){case Track.Source.Camera:t=yield this.createTracks({video:(r=i)===null||r===void 0||r});break;case Track.Source.Microphone:t=yield this.createTracks({audio:(s=i)===null||s===void 0||s});break;case Track.Source.ScreenShare:t=yield this.createScreenTracks(Object.assign({},i));break;default:throw new TrackInvalidError(e)}}catch(i){t===null||t===void 0?void 0:t.forEach((e=>{e.stop()}));i instanceof Error&&this.emit(es.MediaDevicesError,i,Fo(e));this.pendingPublishing.delete(e);throw i}for(const n of t){const t=Object.assign(Object.assign({},this.roomOptions.publishDefaults),i);if(e===Track.Source.Microphone&&So(n)&&t.preConnectBuffer){this.log.info("starting preconnect buffer for microphone",Object.assign({},this.logContext));n.startPreConnectBuffer()}}try{const e=[];for(const i of t){this.log.info("publishing track",Object.assign(Object.assign({},this.logContext),Ho(i)));e.push(this.publishTrack(i,n))}const i=yield Promise.all(e);[o]=i}catch(e){t===null||t===void 0?void 0:t.forEach((e=>{e.stop()}));throw e}finally{this.pendingPublishing.delete(e)}}else{if(!(o===null||o===void 0?void 0:o.track)&&this.pendingPublishing.has(e)){o=yield this.waitForPendingPublicationOfSource(e);o||this.log.info("waiting for pending publication promise timed out",Object.assign(Object.assign({},this.logContext),{source:e}))}if(o&&o.track)if(e===Track.Source.ScreenShare){o=yield this.unpublishTrack(o.track);const e=this.getTrackPublication(Track.Source.ScreenShareAudio);e&&e.track&&this.unpublishTrack(e.track)}else yield o.mute()}return o}))}enableCameraAndMicrophone(){return cn(this,void 0,void 0,(function*(){if(!this.pendingPublishing.has(Track.Source.Camera)&&!this.pendingPublishing.has(Track.Source.Microphone)){this.pendingPublishing.add(Track.Source.Camera);this.pendingPublishing.add(Track.Source.Microphone);try{const e=yield this.createTracks({audio:true,video:true});yield Promise.all(e.map((e=>this.publishTrack(e))))}finally{this.pendingPublishing.delete(Track.Source.Camera);this.pendingPublishing.delete(Track.Source.Microphone)}}}))}
/**
   * Create local camera and/or microphone tracks
   * @param options
   * @returns
   */createTracks(e){return cn(this,void 0,void 0,(function*(){var t,i;e!==null&&e!==void 0?e:e={};const n=Ao(e,(t=this.roomOptions)===null||t===void 0?void 0:t.audioCaptureDefaults,(i=this.roomOptions)===null||i===void 0?void 0:i.videoCaptureDefaults);try{const e=yield wc(n,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});const t=e.map((e=>{if(So(e)){this.microphoneError=void 0;e.setAudioContext(this.audioContext);e.source=Track.Source.Microphone;this.emit(es.AudioStreamAcquired)}if(wo(e)){this.cameraError=void 0;e.source=Track.Source.Camera}return e}));return t}catch(t){if(t instanceof Error){e.audio&&(this.microphoneError=t);e.video&&(this.cameraError=t)}throw t}}))}createScreenTracks(e){return cn(this,void 0,void 0,(function*(){e===void 0&&(e={});if(navigator.mediaDevices.getDisplayMedia===void 0)throw new DeviceUnsupportedError("getDisplayMedia not supported");e.resolution!==void 0||qs()||(e.resolution=Es.h1080fps30.resolution);const t=Bo(e);const i=yield navigator.mediaDevices.getDisplayMedia(t);const n=i.getVideoTracks();if(n.length===0)throw new TrackInvalidError("no video track found");const r=new LocalVideoTrack(n[0],void 0,false,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});r.source=Track.Source.ScreenShare;e.contentHint&&(r.mediaStreamTrack.contentHint=e.contentHint);const s=[r];if(i.getAudioTracks().length>0){this.emit(es.AudioStreamAcquired);const e=new LocalAudioTrack(i.getAudioTracks()[0],void 0,false,this.audioContext,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});e.source=Track.Source.ScreenShareAudio;s.push(e)}return s}))}
/**
   * Publish a new track to the room
   * @param track
   * @param options
   */publishTrack(e,t){return cn(this,void 0,void 0,(function*(){return this.publishOrRepublishTrack(e,t)}))}publishOrRepublishTrack(e,t){return cn(this,arguments,void 0,(function(e,t){var i=this;let n=arguments.length>2&&arguments[2]!==void 0&&arguments[2];return function*(){var r,s,o,a;Po(e)&&e.setAudioContext(i.audioContext);yield(r=i.reconnectFuture)===null||r===void 0?void 0:r.promise;i.republishPromise&&!n&&(yield i.republishPromise);Co(e)&&i.pendingPublishPromises.has(e)&&(yield i.pendingPublishPromises.get(e));let c;if(e instanceof MediaStreamTrack)c=e.getConstraints();else{c=e.constraints;let t;switch(e.source){case Track.Source.Microphone:t="audioinput";break;case Track.Source.Camera:t="videoinput"}t&&i.activeDeviceMap.has(t)&&(c=Object.assign(Object.assign({},c),{deviceId:i.activeDeviceMap.get(t)}))}if(e instanceof MediaStreamTrack)switch(e.kind){case"audio":e=new LocalAudioTrack(e,c,true,i.audioContext,{loggerName:i.roomOptions.loggerName,loggerContextCb:()=>i.logContext});break;case"video":e=new LocalVideoTrack(e,c,true,{loggerName:i.roomOptions.loggerName,loggerContextCb:()=>i.logContext});break;default:throw new TrackInvalidError("unsupported MediaStreamTrack kind ".concat(e.kind))}else e.updateLoggerOptions({loggerName:i.roomOptions.loggerName,loggerContextCb:()=>i.logContext});let d;i.trackPublications.forEach((t=>{t.track&&t.track===e&&(d=t)}));if(d){i.log.warn("track has already been published, skipping",Object.assign(Object.assign({},i.logContext),Ho(d)));return d}const l="channelCount"in e.mediaStreamTrack.getSettings()&&e.mediaStreamTrack.getSettings().channelCount===2||e.mediaStreamTrack.getConstraints().channelCount===2;const u=(s=t===null||t===void 0?void 0:t.forceStereo)!==null&&s!==void 0?s:l;if(u){t||(t={});t.dtx===void 0&&i.log.info("Opus DTX will be disabled for stereo tracks by default. Enable them explicitly to make it work.",Object.assign(Object.assign({},i.logContext),Ho(e)));t.red===void 0&&i.log.info("Opus RED will be disabled for stereo tracks by default. Enable them explicitly to make it work.");(o=t.dtx)!==null&&o!==void 0?o:t.dtx=false;(a=t.red)!==null&&a!==void 0?a:t.red=false}const h=Object.assign(Object.assign({},i.roomOptions.publishDefaults),t);if(!Ks()&&i.roomOptions.e2ee){i.log.info("End-to-end encryption is set up, simulcast publishing will be disabled on Safari versions and iOS browsers running iOS < v17.2",Object.assign({},i.logContext));h.simulcast=false}h.source&&(e.source=h.source);const p=new Promise(((t,n)=>cn(i,void 0,void 0,(function*(){try{if(this.engine.client.currentState!==ra.CONNECTED){this.log.debug("deferring track publication until signal is connected",Object.assign(Object.assign({},this.logContext),{track:Ho(e)}));const i=setTimeout((()=>{n(new PublishTrackError("publishing rejected as engine not connected within timeout",408))}),15e3);yield this.waitUntilEngineConnected();clearTimeout(i);const r=yield this.publish(e,h,u);t(r)}else try{const i=yield this.publish(e,h,u);t(i)}catch(e){n(e)}}catch(e){n(e)}}))));i.pendingPublishPromises.set(e,p);try{const e=yield p;return e}catch(e){throw e}finally{i.pendingPublishPromises.delete(e)}}()}))}waitUntilEngineConnected(){this.signalConnectedFuture||(this.signalConnectedFuture=new Future);return this.signalConnectedFuture.promise}hasPermissionsToPublish(e){if(!this.permissions){this.log.warn("no permissions present for publishing track",Object.assign(Object.assign({},this.logContext),Ho(e)));return false}const{canPublish:t,canPublishSources:i}=this.permissions;if(t&&(i.length===0||i.map((e=>zo(e))).includes(e.source)))return true;this.log.warn("insufficient permissions to publish",Object.assign(Object.assign({},this.logContext),Ho(e)));return false}publish(e,t,i){return cn(this,void 0,void 0,(function*(){var n,r,s,o,a,c,d,l,u,h;if(!this.hasPermissionsToPublish(e))throw new PublishTrackError("failed to publish track, insufficient permissions",403);const p=Array.from(this.trackPublications.values()).find((t=>Co(e)&&t.source===e.source));p&&e.source!==Track.Source.Unknown&&this.log.info("publishing a second track with the same source: ".concat(e.source),Object.assign(Object.assign({},this.logContext),Ho(e)));t.stopMicTrackOnMute&&So(e)&&(e.stopOnMute=true);e.source===Track.Source.ScreenShare&&Fs()&&(t.simulcast=false);t.videoCodec!=="av1"||_s()||(t.videoCodec=void 0);t.videoCodec!=="vp9"||Ns()||(t.videoCodec=void 0);t.videoCodec===void 0&&(t.videoCodec=Ia);this.enabledPublishVideoCodecs.length>0&&(this.enabledPublishVideoCodecs.some((e=>t.videoCodec===Vo(e.mime)))||(t.videoCodec=Vo(this.enabledPublishVideoCodecs[0].mime)));const m=t.videoCodec;e.on(is.Muted,this.onTrackMuted);e.on(is.Unmuted,this.onTrackUnmuted);e.on(is.Ended,this.handleTrackEnded);e.on(is.UpstreamPaused,this.onTrackUpstreamPaused);e.on(is.UpstreamResumed,this.onTrackUpstreamResumed);e.on(is.AudioTrackFeatureUpdate,this.onTrackFeatureUpdate);const g=[];const f=!((n=t.dtx)===null||n===void 0||n);const v=e.getSourceTrackSettings();v.autoGainControl&&g.push(dt.TF_AUTO_GAIN_CONTROL);v.echoCancellation&&g.push(dt.TF_ECHO_CANCELLATION);v.noiseSuppression&&g.push(dt.TF_NOISE_SUPPRESSION);v.channelCount&&v.channelCount>1&&g.push(dt.TF_STEREO);f&&g.push(dt.TF_NO_DTX);Po(e)&&e.hasPreConnectBuffer&&g.push(dt.TF_PRECONNECT_BUFFER);const k=new ti({cid:e.mediaStreamTrack.id,name:t.name,type:Track.kindToProto(e.kind),muted:e.isMuted,source:Track.sourceToProto(e.source),disableDtx:f,encryption:this.encryptionType,stereo:i,disableRed:this.isE2EEEnabled||!((r=t.red)===null||r===void 0||r),stream:t===null||t===void 0?void 0:t.stream,backupCodecPolicy:t===null||t===void 0?void 0:t.backupCodecPolicy,audioFeatures:g});let b;if(e.kind===Track.Kind.Video){let i={width:0,height:0};try{i=yield e.waitForDimensions()}catch(t){const n=(o=(s=this.roomOptions.videoCaptureDefaults)===null||s===void 0?void 0:s.resolution)!==null&&o!==void 0?o:Ss.h720.resolution;i={width:n.width,height:n.height};this.log.error("could not determine track dimensions, using defaults",Object.assign(Object.assign(Object.assign({},this.logContext),Ho(e)),{dims:i}))}k.width=i.width;k.height=i.height;if(Eo(e)){if(Ls(m)){if(e.source===Track.Source.ScreenShare){t.scalabilityMode="L1T3";if("contentHint"in e.mediaStreamTrack){e.mediaStreamTrack.contentHint="motion";this.log.info("forcing contentHint to motion for screenshare with SVC codecs",Object.assign(Object.assign({},this.logContext),Ho(e)))}}t.scalabilityMode=(a=t.scalabilityMode)!==null&&a!==void 0?a:"L3T3_KEY"}k.simulcastCodecs=[new ei({codec:m,cid:e.mediaStreamTrack.id})];t.backupCodec===true&&(t.backupCodec={codec:Ia});if(t.backupCodec&&m!==t.backupCodec.codec&&k.encryption===vt.NONE){this.roomOptions.dynacast||(this.roomOptions.dynacast=true);k.simulcastCodecs.push(new ei({codec:t.backupCodec.codec,cid:""}))}}b=$a(e.source===Track.Source.ScreenShare,k.width,k.height,t);k.layers=lc(k.width,k.height,b,Ls(t.videoCodec))}else e.kind===Track.Kind.Audio&&(b=[{maxBitrate:(c=t.audioPreset)===null||c===void 0?void 0:c.maxBitrate,priority:(l=(d=t.audioPreset)===null||d===void 0?void 0:d.priority)!==null&&l!==void 0?l:"high",networkPriority:(h=(u=t.audioPreset)===null||u===void 0?void 0:u.priority)!==null&&h!==void 0?h:"high"}]);if(!this.engine||this.engine.isClosed)throw new UnexpectedConnectionState("cannot publish track when not connected");const y=()=>cn(this,void 0,void 0,(function*(){var i,n,r;if(!this.engine.pcManager)throw new UnexpectedConnectionState("pcManager is not ready");e.sender=yield this.engine.createSender(e,t,b);this.emit(es.LocalSenderCreated,e.sender,e);if(Eo(e)){(i=t.degradationPreference)!==null&&i!==void 0?i:t.degradationPreference=oc(e);e.setDegradationPreference(t.degradationPreference)}if(b)if(Fs()&&e.kind===Track.Kind.Audio){let t;for(const i of this.engine.pcManager.publisher.getTransceivers())if(i.sender===e.sender){t=i;break}t&&this.engine.pcManager.publisher.setTrackCodecBitrate({transceiver:t,codec:"opus",maxbr:((n=b[0])===null||n===void 0?void 0:n.maxBitrate)?b[0].maxBitrate/1e3:0})}else e.codec&&Ls(e.codec)&&((r=b[0])===null||r===void 0?void 0:r.maxBitrate)&&this.engine.pcManager.publisher.setTrackCodecBitrate({cid:k.cid,codec:e.codec,maxbr:b[0].maxBitrate/1e3});yield this.engine.negotiate()}));let T;const C=new Promise(((t,i)=>cn(this,void 0,void 0,(function*(){var n;try{T=yield this.engine.addTrack(k);t(T)}catch(t){if(e.sender&&((n=this.engine.pcManager)===null||n===void 0?void 0:n.publisher)){this.engine.pcManager.publisher.removeTrack(e.sender);yield this.engine.negotiate().catch((t=>{this.log.error("failed to negotiate after removing track due to failed add track request",Object.assign(Object.assign(Object.assign({},this.logContext),Ho(e)),{error:t}))}))}i(t)}}))));if(this.enabledPublishVideoCodecs.length>0){const e=yield Promise.all([C,y()]);T=e[0]}else{T=yield C;let i;T.codecs.forEach((e=>{i===void 0&&(i=e.mimeType)}));if(i&&e.kind===Track.Kind.Video){const n=Vo(i);if(n!==m){this.log.debug("falling back to server selected codec",Object.assign(Object.assign(Object.assign({},this.logContext),Ho(e)),{codec:n}));t.videoCodec=n;b=$a(e.source===Track.Source.ScreenShare,k.width,k.height,t)}}yield y()}const S=new LocalTrackPublication(e.kind,T,e,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});S.on(is.CpuConstrained,(e=>this.onTrackCpuConstrained(e,S)));S.options=t;e.sid=T.sid;this.log.debug("publishing ".concat(e.kind," with encodings"),Object.assign(Object.assign({},this.logContext),{encodings:b,trackInfo:T}));Eo(e)?e.startMonitor(this.engine.client):Po(e)&&e.startMonitor();this.addTrackPublication(S);this.emit(es.LocalTrackPublished,S);if(Po(e)&&T.audioFeatures.includes(dt.TF_PRECONNECT_BUFFER)){const t=e.getPreConnectBuffer();const i=e.getPreConnectBufferMimeType();this.on(es.LocalTrackSubscribed,(t=>{if(t.trackSid===T.sid){if(!e.hasPreConnectBuffer){this.log.warn("subscribe event came to late, buffer already closed",this.logContext);return}this.log.debug("finished recording preconnect buffer",Object.assign(Object.assign({},this.logContext),Ho(e)));e.stopPreConnectBuffer()}}));if(t){const n=new Promise(((n,r)=>cn(this,void 0,void 0,(function*(){var s,o,a,c;var d,l;try{this.log.debug("waiting for agent",Object.assign(Object.assign({},this.logContext),Ho(e)));const m=setTimeout((()=>{r(new Error("agent not active within 10 seconds"))}),1e4);const g=yield this.waitUntilActiveAgentPresent();clearTimeout(m);this.log.debug("sending preconnect buffer",Object.assign(Object.assign({},this.logContext),Ho(e)));const f=yield this.streamBytes({name:"preconnect-buffer",mimeType:i,topic:"lk.agent.pre-connect-audio-buffer",destinationIdentities:[g.identity],attributes:{trackId:S.trackSid,sampleRate:String((d=v.sampleRate)!==null&&d!==void 0?d:"48000"),channels:String((l=v.channelCount)!==null&&l!==void 0?l:"1")}});try{for(var u,h=true,p=ln(t);u=yield p.next(),s=u.done,!s;h=true){c=u.value;h=false;const e=c;yield f.write(e)}}catch(e){o={error:e}}finally{try{h||s||!(a=p.return)||(yield a.call(p))}finally{if(o)throw o.error}}yield f.close();n()}catch(e){r(e)}}))));n.then((()=>{this.log.debug("preconnect buffer sent successfully",Object.assign(Object.assign({},this.logContext),Ho(e)))})).catch((t=>{this.log.error("error sending preconnect buffer",Object.assign(Object.assign(Object.assign({},this.logContext),Ho(e)),{error:t}))}))}}return S}))}get isLocal(){return true}publishAdditionalCodecForTrack(e,t,i){return cn(this,void 0,void 0,(function*(){var n;if(this.encryptionType!==vt.NONE)return;let r;this.trackPublications.forEach((t=>{t.track&&t.track===e&&(r=t)}));if(!r)throw new TrackInvalidError("track is not published");if(!Eo(e))throw new TrackInvalidError("track is not a video track");const s=Object.assign(Object.assign({},(n=this.roomOptions)===null||n===void 0?void 0:n.publishDefaults),i);const o=ec(e,t,s);if(!o){this.log.info("backup codec has been disabled, ignoring request to add additional codec for track",Object.assign(Object.assign({},this.logContext),Ho(e)));return}const a=e.addSimulcastTrack(t,o);if(!a)return;const c=new ti({cid:a.mediaStreamTrack.id,type:Track.kindToProto(e.kind),muted:e.isMuted,source:Track.sourceToProto(e.source),sid:e.sid,simulcastCodecs:[{codec:s.videoCodec,cid:a.mediaStreamTrack.id}]});c.layers=lc(c.width,c.height,o);if(!this.engine||this.engine.isClosed)throw new UnexpectedConnectionState("cannot publish track when not connected");const d=()=>cn(this,void 0,void 0,(function*(){yield this.engine.createSimulcastSender(e,a,s,o);yield this.engine.negotiate()}));const l=yield Promise.all([this.engine.addTrack(c),d()]);const u=l[0];this.log.debug("published ".concat(t," for track ").concat(e.sid),Object.assign(Object.assign({},this.logContext),{encodings:o,trackInfo:u}))}))}unpublishTrack(e,t){return cn(this,void 0,void 0,(function*(){var i,n;if(Co(e)){const t=this.pendingPublishPromises.get(e);if(t){this.log.info("awaiting publish promise before attempting to unpublish",Object.assign(Object.assign({},this.logContext),Ho(e)));yield t}}const r=this.getPublicationForTrack(e);const s=r?Ho(r):void 0;this.log.debug("unpublishing track",Object.assign(Object.assign({},this.logContext),s));if(!r||!r.track){this.log.warn("track was not unpublished because no publication was found",Object.assign(Object.assign({},this.logContext),s));return}e=r.track;e.off(is.Muted,this.onTrackMuted);e.off(is.Unmuted,this.onTrackUnmuted);e.off(is.Ended,this.handleTrackEnded);e.off(is.UpstreamPaused,this.onTrackUpstreamPaused);e.off(is.UpstreamResumed,this.onTrackUpstreamResumed);e.off(is.AudioTrackFeatureUpdate,this.onTrackFeatureUpdate);t===void 0&&(t=(n=(i=this.roomOptions)===null||i===void 0?void 0:i.stopLocalTrackOnUnpublish)===null||n===void 0||n);t?e.stop():e.stopMonitor();let o=false;const a=e.sender;e.sender=void 0;if(this.engine.pcManager&&this.engine.pcManager.currentState<_a.FAILED&&a)try{for(const e of this.engine.pcManager.publisher.getTransceivers())if(e.sender===a){e.direction="inactive";o=true}this.engine.removeTrack(a)&&(o=true);if(Eo(e)){for(const[,t]of e.simulcastCodecs)if(t.sender){this.engine.removeTrack(t.sender)&&(o=true);t.sender=void 0}e.simulcastCodecs.clear()}}catch(e){this.log.warn("failed to unpublish track",Object.assign(Object.assign(Object.assign({},this.logContext),s),{error:e}))}this.trackPublications.delete(r.trackSid);switch(r.kind){case Track.Kind.Audio:this.audioTrackPublications.delete(r.trackSid);break;case Track.Kind.Video:this.videoTrackPublications.delete(r.trackSid);break}this.emit(es.LocalTrackUnpublished,r);r.setTrack(void 0);o&&(yield this.engine.negotiate());return r}))}unpublishTracks(e){return cn(this,void 0,void 0,(function*(){const t=yield Promise.all(e.map((e=>this.unpublishTrack(e))));return t.filter((e=>!!e))}))}republishAllTracks(e){return cn(this,arguments,void 0,(function(e){var t=this;let i=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];return function*(){t.republishPromise&&(yield t.republishPromise);t.republishPromise=new Promise(((n,r)=>cn(t,void 0,void 0,(function*(){try{const t=[];this.trackPublications.forEach((i=>{if(i.track){e&&(i.options=Object.assign(Object.assign({},i.options),e));t.push(i)}}));yield Promise.all(t.map((e=>cn(this,void 0,void 0,(function*(){const t=e.track;yield this.unpublishTrack(t,false);if(i&&!t.isMuted&&t.source!==Track.Source.ScreenShare&&t.source!==Track.Source.ScreenShareAudio&&(Po(t)||Eo(t))&&!t.isUserProvided){this.log.debug("restarting existing track",Object.assign(Object.assign({},this.logContext),{track:e.trackSid}));yield t.restartTrack()}yield this.publishOrRepublishTrack(t,e.options,true)})))));n()}catch(e){r(e)}finally{this.republishPromise=void 0}}))));yield t.republishPromise}()}))}
/**
   * Publish a new data payload to the room. Data will be forwarded to each
   * participant in the room if the destination field in publishOptions is empty
   *
   * @param data Uint8Array of the payload. To send string data, use TextEncoder.encode
   * @param options optionally specify a `reliable`, `topic` and `destination`
   */publishData(e){return cn(this,arguments,void 0,(function(e){var t=this;let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};return function*(){const n=i.reliable?Ct.RELIABLE:Ct.LOSSY;const r=i.destinationIdentities;const s=i.topic;const o=new Tt({kind:n,value:{case:"user",value:new Et({participantIdentity:t.identity,payload:e,destinationIdentities:r,topic:s})}});yield t.engine.sendDataPacket(o,n)}()}))}
/**
   * Publish SIP DTMF message to the room.
   *
   * @param code DTMF code
   * @param digit DTMF digit
   */publishDtmf(e,t){return cn(this,void 0,void 0,(function*(){const i=new Tt({kind:Ct.RELIABLE,value:{case:"sipDtmf",value:new Pt({code:e,digit:t})}});yield this.engine.sendDataPacket(i,Ct.RELIABLE)}))}
/** @deprecated Consider migrating to {@link sendText} */sendChatMessage(e,t){return cn(this,void 0,void 0,(function*(){const i={id:crypto.randomUUID(),message:e,timestamp:Date.now(),attachedFiles:t===null||t===void 0?void 0:t.attachments};const n=new Tt({value:{case:"chatMessage",value:new Ot(Object.assign(Object.assign({},i),{timestamp:A.parse(i.timestamp)}))}});yield this.engine.sendDataPacket(n,Ct.RELIABLE);this.emit(es.ChatMessage,i);return i}))}
/** @deprecated Consider migrating to {@link sendText} */editChatMessage(e,t){return cn(this,void 0,void 0,(function*(){const i=Object.assign(Object.assign({},t),{message:e,editTimestamp:Date.now()});const n=new Tt({value:{case:"chatMessage",value:new Ot(Object.assign(Object.assign({},i),{timestamp:A.parse(i.timestamp),editTimestamp:A.parse(i.editTimestamp)}))}});yield this.engine.sendDataPacket(n,Ct.RELIABLE);this.emit(es.ChatMessage,i);return i}))}
/**
   * Sends the given string to participants in the room via the data channel.
   * For longer messages, consider using {@link streamText} instead.
   *
   * @param text The text payload
   * @param options.topic Topic identifier used to route the stream to appropriate handlers.
   */sendText(e,t){return cn(this,void 0,void 0,(function*(){return this.roomOutgoingDataStreamManager.sendText(e,t)}))}
/**
   * Creates a new TextStreamWriter which can be used to stream text incrementally
   * to participants in the room via the data channel.
   *
   * @param options.topic Topic identifier used to route the stream to appropriate handlers.
   *
   * @internal
   * @experimental CAUTION, might get removed in a minor release
   */streamText(e){return cn(this,void 0,void 0,(function*(){return this.roomOutgoingDataStreamManager.streamText(e)}))}
/** Send a File to all participants in the room via the data channel.
   * @param file The File object payload
   * @param options.topic Topic identifier used to route the stream to appropriate handlers.
   * @param options.onProgress A callback function used to monitor the upload progress percentage.
   */sendFile(e,t){return cn(this,void 0,void 0,(function*(){return this.roomOutgoingDataStreamManager.sendFile(e,t)}))}
/**
   * Stream bytes incrementally to participants in the room via the data channel.
   * For sending files, consider using {@link sendFile} instead.
   *
   * @param options.topic Topic identifier used to route the stream to appropriate handlers.
   */streamBytes(e){return cn(this,void 0,void 0,(function*(){return this.roomOutgoingDataStreamManager.streamBytes(e)}))}
/**
   * Initiate an RPC call to a remote participant
   * @param params - Parameters for initiating the RPC call, see {@link PerformRpcParams}
   * @returns A promise that resolves with the response payload or rejects with an error.
   * @throws Error on failure. Details in `message`.
   */performRpc(e){return cn(this,arguments,void 0,(function(e){var t=this;let{destinationIdentity:i,method:n,payload:r,responseTimeout:s=1e4}=e;return function*(){const e=2e3;return new Promise(((o,a)=>cn(t,void 0,void 0,(function*(){var t,c,d,l;if(La(r)>Na){a(RpcError.builtIn("REQUEST_PAYLOAD_TOO_LARGE"));return}if(((c=(t=this.engine.latestJoinResponse)===null||t===void 0?void 0:t.serverInfo)===null||c===void 0?void 0:c.version)&&Zs((l=(d=this.engine.latestJoinResponse)===null||d===void 0?void 0:d.serverInfo)===null||l===void 0?void 0:l.version,"1.8.0")<0){a(RpcError.builtIn("UNSUPPORTED_SERVER"));return}const u=crypto.randomUUID();yield this.publishRpcRequest(i,u,n,r,s-e);const h=setTimeout((()=>{this.pendingAcks.delete(u);a(RpcError.builtIn("CONNECTION_TIMEOUT"));this.pendingResponses.delete(u);clearTimeout(p)}),e);this.pendingAcks.set(u,{resolve:()=>{clearTimeout(h)},participantIdentity:i});const p=setTimeout((()=>{this.pendingResponses.delete(u);a(RpcError.builtIn("RESPONSE_TIMEOUT"))}),s);this.pendingResponses.set(u,{resolve:(e,t)=>{clearTimeout(p);if(this.pendingAcks.has(u)){console.warn("RPC response received before ack",u);this.pendingAcks.delete(u);clearTimeout(h)}t?a(t):o(e!==null&&e!==void 0?e:"")},participantIdentity:i})}))))}()}))}
/**
   * @deprecated use `room.registerRpcMethod` instead
   */registerRpcMethod(e,t){this.rpcHandlers.has(e)&&this.log.warn("you're overriding the RPC handler for method ".concat(e,", in the future this will throw an error"));this.rpcHandlers.set(e,t)}
/**
   * @deprecated use `room.unregisterRpcMethod` instead
   */unregisterRpcMethod(e){this.rpcHandlers.delete(e)}
/**
   * Control who can subscribe to LocalParticipant's published tracks.
   *
   * By default, all participants can subscribe. This allows fine-grained control over
   * who is able to subscribe at a participant and track level.
   *
   * Note: if access is given at a track-level (i.e. both [allParticipantsAllowed] and
   * [ParticipantTrackPermission.allTracksAllowed] are false), any newer published tracks
   * will not grant permissions to any participants and will require a subsequent
   * permissions update to allow subscription.
   *
   * @param allParticipantsAllowed Allows all participants to subscribe all tracks.
   *  Takes precedence over [[participantTrackPermissions]] if set to true.
   *  By default this is set to true.
   * @param participantTrackPermissions Full list of individual permissions per
   *  participant/track. Any omitted participants will not receive any permissions.
   */setTrackSubscriptionPermissions(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:[];this.participantTrackPermissions=t;this.allParticipantsAllowedToSubscribe=e;this.engine.client.isDisconnected||this.updateTrackSubscriptionPermissions()}handleIncomingRpcAck(e){const t=this.pendingAcks.get(e);if(t){t.resolve();this.pendingAcks.delete(e)}else console.error("Ack received for unexpected RPC request",e)}handleIncomingRpcResponse(e,t,i){const n=this.pendingResponses.get(e);if(n){n.resolve(t,i);this.pendingResponses.delete(e)}else console.error("Response received for unexpected RPC request",e)}publishRpcRequest(e,t,i,n,r){return cn(this,void 0,void 0,(function*(){const s=new Tt({destinationIdentities:[e],kind:Ct.RELIABLE,value:{case:"rpcRequest",value:new Dt({id:t,method:i,payload:n,responseTimeoutMs:r,version:1})}});yield this.engine.sendDataPacket(s,Ct.RELIABLE)}))}handleParticipantDisconnected(e){for(const[t,{participantIdentity:i}]of this.pendingAcks)i===e&&this.pendingAcks.delete(t);for(const[t,{participantIdentity:i,resolve:n}]of this.pendingResponses)if(i===e){n(null,RpcError.builtIn("RECIPIENT_DISCONNECTED"));this.pendingResponses.delete(t)}}setEnabledPublishCodecs(e){this.enabledPublishVideoCodecs=e.filter((e=>e.mime.split("/")[0].toLowerCase()==="video"))}updateInfo(e){if(!super.updateInfo(e))return false;e.tracks.forEach((e=>{var t,i;const n=this.trackPublications.get(e.sid);if(n){const r=n.isMuted||(i=(t=n.track)===null||t===void 0?void 0:t.isUpstreamPaused)!==null&&i!==void 0&&i;if(r!==e.muted){this.log.debug("updating server mute state after reconcile",Object.assign(Object.assign(Object.assign({},this.logContext),Ho(n)),{mutedOnServer:r}));this.engine.client.sendMuteTrack(e.sid,r)}}}));return true}setActiveAgent(e){var t,i,n,r;this.firstActiveAgent=e;e&&!this.firstActiveAgent&&(this.firstActiveAgent=e);e?(i=(t=this.activeAgentFuture)===null||t===void 0?void 0:t.resolve)===null||i===void 0?void 0:i.call(t,e):(r=(n=this.activeAgentFuture)===null||n===void 0?void 0:n.reject)===null||r===void 0?void 0:r.call(n,"Agent disconnected");this.activeAgentFuture=void 0}waitUntilActiveAgentPresent(){if(this.firstActiveAgent)return Promise.resolve(this.firstActiveAgent);this.activeAgentFuture||(this.activeAgentFuture=new Future);return this.activeAgentFuture.promise}getPublicationForTrack(e){let t;this.trackPublications.forEach((i=>{const n=i.track;n&&(e instanceof MediaStreamTrack?(Po(n)||Eo(n))&&n.mediaStreamTrack===e&&(t=i):e===n&&(t=i))}));return t}waitForPendingPublicationOfSource(e){return cn(this,void 0,void 0,(function*(){const t=1e4;const i=Date.now();while(Date.now()<i+t){const t=Array.from(this.pendingPublishPromises.entries()).find((t=>{let[i]=t;return i.source===e}));if(t)return t[1];yield Os(20)}}))}}class RemoteTrackPublication extends TrackPublication{constructor(e,t,i,n){super(e,t.sid,t.name,n);this.track=void 0;this.allowed=true;this.requestedDisabled=void 0;this.visible=true;this.handleEnded=e=>{this.setTrack(void 0);this.emit(is.Ended,e)};this.handleVisibilityChange=e=>{this.log.debug("adaptivestream video visibility ".concat(this.trackSid,", visible=").concat(e),this.logContext);this.visible=e;this.emitTrackUpdate()};this.handleVideoDimensionsChange=e=>{this.log.debug("adaptivestream video dimensions ".concat(e.width,"x").concat(e.height),this.logContext);this.videoDimensionsAdaptiveStream=e;this.emitTrackUpdate()};this.subscribed=i;this.updateInfo(t)}
/**
   * Subscribe or unsubscribe to this remote track
   * @param subscribed true to subscribe to a track, false to unsubscribe
   */setSubscribed(e){const t=this.subscriptionStatus;const i=this.permissionStatus;this.subscribed=e;e&&(this.allowed=true);const n=new li({trackSids:[this.trackSid],subscribe:this.subscribed,participantTracks:[new _t({participantSid:"",trackSids:[this.trackSid]})]});this.emit(is.UpdateSubscription,n);this.emitSubscriptionUpdateIfChanged(t);this.emitPermissionUpdateIfChanged(i)}get subscriptionStatus(){return this.subscribed===false?TrackPublication.SubscriptionStatus.Unsubscribed:super.isSubscribed?TrackPublication.SubscriptionStatus.Subscribed:TrackPublication.SubscriptionStatus.Desired}get permissionStatus(){return this.allowed?TrackPublication.PermissionStatus.Allowed:TrackPublication.PermissionStatus.NotAllowed}get isSubscribed(){return this.subscribed!==false&&super.isSubscribed}get isDesired(){return this.subscribed!==false}get isEnabled(){return this.requestedDisabled!==void 0?!this.requestedDisabled:!this.isAdaptiveStream||this.visible}get isLocal(){return false}
/**
   * disable server from sending down data for this track. this is useful when
   * the participant is off screen, you may disable streaming down their video
   * to reduce bandwidth requirements
   * @param enabled
   */setEnabled(e){if(this.isManualOperationAllowed()&&this.requestedDisabled!==!e){this.requestedDisabled=!e;this.emitTrackUpdate()}}setVideoQuality(e){if(this.isManualOperationAllowed()&&this.requestedMaxQuality!==e){this.requestedMaxQuality=e;this.requestedVideoDimensions=void 0;this.emitTrackUpdate()}}
/**
   * Explicitly set the video dimensions for this track.
   *
   * This will take precedence over adaptive stream dimensions.
   *
   * @param dimensions The video dimensions to set.
   */setVideoDimensions(e){var t,i;if(this.isManualOperationAllowed()&&(((t=this.requestedVideoDimensions)===null||t===void 0?void 0:t.width)!==e.width||((i=this.requestedVideoDimensions)===null||i===void 0?void 0:i.height)!==e.height)){Oo(this.track)&&(this.requestedVideoDimensions=e);this.requestedMaxQuality=void 0;this.emitTrackUpdate()}}setVideoFPS(e){if(this.isManualOperationAllowed()&&Oo(this.track)&&this.fps!==e){this.fps=e;this.emitTrackUpdate()}}get videoQuality(){var e;return(e=this.requestedMaxQuality)!==null&&e!==void 0?e:gs.HIGH}setTrack(e){const t=this.subscriptionStatus;const i=this.permissionStatus;const n=this.track;if(n!==e){if(n){n.off(is.VideoDimensionsChanged,this.handleVideoDimensionsChange);n.off(is.VisibilityChanged,this.handleVisibilityChange);n.off(is.Ended,this.handleEnded);n.detach();n.stopMonitor();this.emit(is.Unsubscribed,n)}super.setTrack(e);if(e){e.sid=this.trackSid;e.on(is.VideoDimensionsChanged,this.handleVideoDimensionsChange);e.on(is.VisibilityChanged,this.handleVisibilityChange);e.on(is.Ended,this.handleEnded);this.emit(is.Subscribed,e)}this.emitPermissionUpdateIfChanged(i);this.emitSubscriptionUpdateIfChanged(t)}}setAllowed(e){const t=this.subscriptionStatus;const i=this.permissionStatus;this.allowed=e;this.emitPermissionUpdateIfChanged(i);this.emitSubscriptionUpdateIfChanged(t)}setSubscriptionError(e){this.emit(is.SubscriptionFailed,e)}updateInfo(e){super.updateInfo(e);const t=this.metadataMuted;this.metadataMuted=e.muted;this.track?this.track.setMuted(e.muted):t!==e.muted&&this.emit(e.muted?is.Muted:is.Unmuted)}emitSubscriptionUpdateIfChanged(e){const t=this.subscriptionStatus;e!==t&&this.emit(is.SubscriptionStatusChanged,t,e)}emitPermissionUpdateIfChanged(e){const t=this.permissionStatus;t!==e&&this.emit(is.SubscriptionPermissionChanged,this.permissionStatus,e)}isManualOperationAllowed(){if(!this.isDesired){this.log.warn("cannot update track settings when not subscribed",this.logContext);return false}return true}get isAdaptiveStream(){return Oo(this.track)&&this.track.isAdaptiveStream}emitTrackUpdate(){const e=new ui({trackSids:[this.trackSid],disabled:!this.isEnabled,fps:this.fps});if(this.kind===Track.Kind.Video){let t=this.requestedVideoDimensions;if(this.videoDimensionsAdaptiveStream!==void 0)if(t){const e=Jo(this.videoDimensionsAdaptiveStream,t);if(e){this.log.debug("using adaptive stream dimensions instead of requested",Object.assign(Object.assign({},this.logContext),this.videoDimensionsAdaptiveStream));t=this.videoDimensionsAdaptiveStream}}else if(this.requestedMaxQuality!==void 0&&this.trackInfo){const e=Qo(this.trackInfo,this.requestedMaxQuality);if(e&&Jo(this.videoDimensionsAdaptiveStream,e)){this.log.debug("using adaptive stream dimensions instead of max quality layer",Object.assign(Object.assign({},this.logContext),this.videoDimensionsAdaptiveStream));t=this.videoDimensionsAdaptiveStream}}else{this.log.debug("using adaptive stream dimensions",Object.assign(Object.assign({},this.logContext),this.videoDimensionsAdaptiveStream));t=this.videoDimensionsAdaptiveStream}if(t){e.width=Math.ceil(t.width);e.height=Math.ceil(t.height)}else if(this.requestedMaxQuality!==void 0){this.log.debug("using requested max quality",Object.assign(Object.assign({},this.logContext),{quality:this.requestedMaxQuality}));e.quality=this.requestedMaxQuality}else{this.log.debug("using default quality",Object.assign(Object.assign({},this.logContext),{quality:gs.HIGH}));e.quality=gs.HIGH}}this.emit(is.UpdateSettings,e)}}class RemoteParticipant extends Participant{static fromParticipantInfo(e,t,i){return new RemoteParticipant(e,t.sid,t.identity,t.name,t.metadata,t.attributes,i,t.kind)}get logContext(){return Object.assign(Object.assign({},super.logContext),{rpID:this.sid,remoteParticipant:this.identity})}constructor(e,t,i,n,r,s,o){let a=arguments.length>7&&arguments[7]!==void 0?arguments[7]:gt.STANDARD;super(t,i||"",n,r,s,o,a);this.signalClient=e;this.trackPublications=new Map;this.audioTrackPublications=new Map;this.videoTrackPublications=new Map;this.volumeMap=new Map}addTrackPublication(e){super.addTrackPublication(e);e.on(is.UpdateSettings,(t=>{this.log.debug("send update settings",Object.assign(Object.assign(Object.assign({},this.logContext),Ho(e)),{settings:t}));this.signalClient.sendUpdateTrackSettings(t)}));e.on(is.UpdateSubscription,(e=>{e.participantTracks.forEach((e=>{e.participantSid=this.sid}));this.signalClient.sendUpdateSubscription(e)}));e.on(is.SubscriptionPermissionChanged,(t=>{this.emit(es.TrackSubscriptionPermissionChanged,e,t)}));e.on(is.SubscriptionStatusChanged,(t=>{this.emit(es.TrackSubscriptionStatusChanged,e,t)}));e.on(is.Subscribed,(t=>{this.emit(es.TrackSubscribed,t,e)}));e.on(is.Unsubscribed,(t=>{this.emit(es.TrackUnsubscribed,t,e)}));e.on(is.SubscriptionFailed,(t=>{this.emit(es.TrackSubscriptionFailed,e.trackSid,t)}))}getTrackPublication(e){const t=super.getTrackPublication(e);if(t)return t}getTrackPublicationByName(e){const t=super.getTrackPublicationByName(e);if(t)return t}setVolume(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Track.Source.Microphone;this.volumeMap.set(t,e);const i=this.getTrackPublication(t);i&&i.track&&i.track.setVolume(e)}getVolume(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Track.Source.Microphone;const t=this.getTrackPublication(e);return t&&t.track?t.track.getVolume():this.volumeMap.get(e)}addSubscribedMediaTrack(e,t,i,n,r,s){let o=this.getTrackPublicationBySid(t);o||t.startsWith("TR")||this.trackPublications.forEach((t=>{o||e.kind!==t.kind.toString()||(o=t)}));if(!o){if(s===0){this.log.error("could not find published track",Object.assign(Object.assign({},this.logContext),{trackSid:t}));this.emit(es.TrackSubscriptionFailed,t);return}s===void 0&&(s=20);setTimeout((()=>{this.addSubscribedMediaTrack(e,t,i,n,r,s-1)}),150);return}if(e.readyState==="ended"){this.log.error("unable to subscribe because MediaStreamTrack is ended. Do not call MediaStreamTrack.stop()",Object.assign(Object.assign({},this.logContext),Ho(o)));this.emit(es.TrackSubscriptionFailed,t);return}const a=e.kind==="video";let c;c=a?new RemoteVideoTrack(e,t,n,r):new RemoteAudioTrack(e,t,n,this.audioContext,this.audioOutput);c.source=o.source;c.isMuted=o.isMuted;c.setMediaStream(i);c.start();o.setTrack(c);this.volumeMap.has(o.source)&&Ro(c)&&So(c)&&c.setVolume(this.volumeMap.get(o.source));return o}get hasMetadata(){return!!this.participantInfo}getTrackPublicationBySid(e){return this.trackPublications.get(e)}updateInfo(e){if(!super.updateInfo(e))return false;const t=new Map;const i=new Map;e.tracks.forEach((e=>{var n,r;let s=this.getTrackPublicationBySid(e.sid);if(s)s.updateInfo(e);else{const t=Track.kindFromProto(e.type);if(!t)return;s=new RemoteTrackPublication(t,e,(n=this.signalClient.connectOptions)===null||n===void 0?void 0:n.autoSubscribe,{loggerContextCb:()=>this.logContext,loggerName:(r=this.loggerOptions)===null||r===void 0?void 0:r.loggerName});s.updateInfo(e);i.set(e.sid,s);const o=Array.from(this.trackPublications.values()).find((e=>e.source===(s===null||s===void 0?void 0:s.source)));o&&s.source!==Track.Source.Unknown&&this.log.debug("received a second track publication for ".concat(this.identity," with the same source: ").concat(s.source),Object.assign(Object.assign({},this.logContext),{oldTrack:Ho(o),newTrack:Ho(s)}));this.addTrackPublication(s)}t.set(e.sid,s)}));this.trackPublications.forEach((e=>{if(!t.has(e.trackSid)){this.log.trace("detected removed track on remote participant, unpublishing",Object.assign(Object.assign({},this.logContext),Ho(e)));this.unpublishTrack(e.trackSid,true)}}));i.forEach((e=>{this.emit(es.TrackPublished,e)}));return true}unpublishTrack(e,t){const i=this.trackPublications.get(e);if(!i)return;const{track:n}=i;if(n){n.stop();i.setTrack(void 0)}this.trackPublications.delete(e);switch(i.kind){case Track.Kind.Audio:this.audioTrackPublications.delete(e);break;case Track.Kind.Video:this.videoTrackPublications.delete(e);break}t&&this.emit(es.TrackUnpublished,i)}setAudioOutput(e){return cn(this,void 0,void 0,(function*(){this.audioOutput=e;const t=[];this.audioTrackPublications.forEach((i=>{var n;So(i.track)&&Ro(i.track)&&t.push(i.track.setSinkId((n=e.deviceId)!==null&&n!==void 0?n:"default"))}));yield Promise.all(t)}))}emit(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];this.log.trace("participant event",Object.assign(Object.assign({},this.logContext),{event:e,args:i}));return super.emit(e,...i)}}var xc;(function(e){e.Disconnected="disconnected";e.Connecting="connecting";e.Connected="connected";e.Reconnecting="reconnecting";e.SignalReconnecting="signalReconnecting"})(xc||(xc={}));const Mc=4e3;class Room extends mn.EventEmitter{
/**
   * Creates a new Room, the primary construct for a LiveKit session.
   * @param options
   */
constructor(e){var t;var i,n,r;super();t=this;this.state=xc.Disconnected;this.activeSpeakers=[];this.isE2EEEnabled=false;this.audioEnabled=true;this.isVideoPlaybackBlocked=false;this.log=Zi;this.bufferedEvents=[];this.isResuming=false;this.rpcHandlers=new Map;this.connect=(e,t,i)=>cn(this,void 0,void 0,(function*(){var n;if(!js())throw zs()?Error("WebRTC isn't detected, have you called registerGlobals?"):Error("LiveKit doesn't seem to be supported on this browser. Try to update your browser and make sure no browser extensions are disabling webRTC.");const r=yield this.disconnectLock.lock();if(this.state===xc.Connected){this.log.info("already connected to room ".concat(this.name),this.logContext);r();return Promise.resolve()}if(this.connectFuture){r();return this.connectFuture.promise}this.setAndEmitConnectionState(xc.Connecting);if(((n=this.regionUrlProvider)===null||n===void 0?void 0:n.getServerUrl().toString())!==e){this.regionUrl=void 0;this.regionUrlProvider=void 0}if(Js(new URL(e))){this.regionUrlProvider===void 0?this.regionUrlProvider=new RegionUrlProvider(e,t):this.regionUrlProvider.updateToken(t);this.regionUrlProvider.fetchRegionSettings().then((e=>{var t;(t=this.regionUrlProvider)===null||t===void 0?void 0:t.setServerReportedRegions(e)})).catch((e=>{this.log.warn("could not fetch region settings",Object.assign(Object.assign({},this.logContext),{error:e}))}))}const s=(n,o,a)=>cn(this,void 0,void 0,(function*(){var c,d;this.abortController&&this.abortController.abort();const l=new AbortController;this.abortController=l;r===null||r===void 0?void 0:r();try{yield this.attemptConnection(a!==null&&a!==void 0?a:e,t,i,l);this.abortController=void 0;n()}catch(e){if(this.regionUrlProvider&&e instanceof ConnectionError&&e.reason!==Qr.Cancelled&&e.reason!==Qr.NotAllowed){let t=null;try{t=yield this.regionUrlProvider.getNextBestRegionUrl((c=this.abortController)===null||c===void 0?void 0:c.signal)}catch(e){if(e instanceof ConnectionError&&(e.status===401||e.reason===Qr.Cancelled)){this.handleDisconnect(this.options.stopLocalTrackOnUnpublish);o(e);return}}if(t&&!((d=this.abortController)===null||d===void 0?void 0:d.signal.aborted)){this.log.info("Initial connection failed with ConnectionError: ".concat(e.message,". Retrying with another region: ").concat(t),this.logContext);this.recreateEngine();yield s(n,o,t)}else{this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,bo(e));o(e)}}else{let t=ot.UNKNOWN_REASON;e instanceof ConnectionError&&(t=bo(e));this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,t);o(e)}}}));const o=this.regionUrl;this.regionUrl=void 0;this.connectFuture=new Future(((e,t)=>{s(e,t,o)}),(()=>{this.clearConnectionFutures()}));return this.connectFuture.promise}));this.connectSignal=(e,t,i,n,r,s)=>cn(this,void 0,void 0,(function*(){var o,a,c;const d=yield i.join(e,t,{autoSubscribe:n.autoSubscribe,adaptiveStream:typeof r.adaptiveStream==="object"||r.adaptiveStream,maxRetries:n.maxRetries,e2eeEnabled:!!this.e2eeManager,websocketTimeout:n.websocketTimeout},s.signal);let l=d.serverInfo;l||(l={version:d.serverVersion,region:d.serverRegion});this.serverInfo=l;this.log.debug("connected to Livekit Server ".concat(Object.entries(l).map((e=>{let[t,i]=e;return"".concat(t,": ").concat(i)})).join(", ")),{room:(o=d.room)===null||o===void 0?void 0:o.name,roomSid:(a=d.room)===null||a===void 0?void 0:a.sid,identity:(c=d.participant)===null||c===void 0?void 0:c.identity});if(!l.version)throw new UnsupportedServer("unknown server version");if(l.version==="0.15.1"&&this.options.dynacast){this.log.debug("disabling dynacast due to server version",this.logContext);r.dynacast=false}return d}));this.applyJoinResponse=e=>{const t=e.participant;this.localParticipant.sid=t.sid;this.localParticipant.identity=t.identity;this.localParticipant.setEnabledPublishCodecs(e.enabledPublishCodecs);if(this.options.e2ee&&this.e2eeManager)try{this.e2eeManager.setSifTrailer(e.sifTrailer)}catch(e){this.log.error(e instanceof Error?e.message:"Could not set SifTrailer",Object.assign(Object.assign({},this.logContext),{error:e}))}this.handleParticipantUpdates([t,...e.otherParticipants]);e.room&&this.handleRoomUpdate(e.room)};this.attemptConnection=(e,t,i,n)=>cn(this,void 0,void 0,(function*(){var r,s;if(this.state===xc.Reconnecting||this.isResuming||((r=this.engine)===null||r===void 0?void 0:r.pendingReconnect)){this.log.info("Reconnection attempt replaced by new connection attempt",this.logContext);this.recreateEngine()}else this.maybeCreateEngine();((s=this.regionUrlProvider)===null||s===void 0?void 0:s.isCloud())&&this.engine.setRegionUrlProvider(this.regionUrlProvider);this.acquireAudioContext();this.connOptions=Object.assign(Object.assign({},Aa),i);this.connOptions.rtcConfig&&(this.engine.rtcConfig=this.connOptions.rtcConfig);this.connOptions.peerConnectionTimeout&&(this.engine.peerConnectionTimeout=this.connOptions.peerConnectionTimeout);try{const i=yield this.connectSignal(e,t,this.engine,this.connOptions,this.options,n);this.applyJoinResponse(i);this.setupLocalParticipantEvents();this.emit($r.SignalConnected)}catch(e){yield this.engine.close();this.recreateEngine();const t=new ConnectionError("could not establish signal connection",Qr.ServerUnreachable);e instanceof Error&&(t.message="".concat(t.message,": ").concat(e.message));if(e instanceof ConnectionError){t.reason=e.reason;t.status=e.status}this.log.debug("error trying to establish signal connection",Object.assign(Object.assign({},this.logContext),{error:e}));throw t}if(n.signal.aborted){yield this.engine.close();this.recreateEngine();throw new ConnectionError("Connection attempt aborted",Qr.Cancelled)}try{yield this.engine.waitForPCInitialConnection(this.connOptions.peerConnectionTimeout,n)}catch(e){yield this.engine.close();this.recreateEngine();throw e}if(Gs()&&this.options.disconnectOnPageLeave){window.addEventListener("pagehide",this.onPageLeave);window.addEventListener("beforeunload",this.onPageLeave)}Gs()&&document.addEventListener("freeze",this.onPageLeave);this.setAndEmitConnectionState(xc.Connected);this.emit($r.Connected);this.registerConnectionReconcile()}));this.disconnect=function(){for(var e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];return cn(t,[...i],void 0,(function(){var e=this;let t=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];return function*(){var i,n,r,s;const o=yield e.disconnectLock.lock();try{if(e.state===xc.Disconnected){e.log.debug("already disconnected",e.logContext);return}e.log.info("disconnect from room",Object.assign({},e.logContext));if(e.state===xc.Connecting||e.state===xc.Reconnecting||e.isResuming){e.log.warn("abort connection attempt",e.logContext);(i=e.abortController)===null||i===void 0?void 0:i.abort();(r=(n=e.connectFuture)===null||n===void 0?void 0:n.reject)===null||r===void 0?void 0:r.call(n,new ConnectionError("Client initiated disconnect",Qr.Cancelled));e.connectFuture=void 0}((s=e.engine)===null||s===void 0?void 0:s.client.isDisconnected)||(yield e.engine.client.sendLeave());e.engine&&(yield e.engine.close());e.handleDisconnect(t,ot.CLIENT_INITIATED);e.engine=void 0}finally{o()}}()}))};this.onPageLeave=()=>cn(this,void 0,void 0,(function*(){this.log.info("Page leave detected, disconnecting",this.logContext);yield this.disconnect()}));this.startAudio=()=>cn(this,void 0,void 0,(function*(){const e=[];const t=os();if(t&&t.os==="iOS"){const t="livekit-dummy-audio-el";let i=document.getElementById(t);if(!i){i=document.createElement("audio");i.id=t;i.autoplay=true;i.hidden=true;const e=uo();e.enabled=true;const n=new MediaStream([e]);i.srcObject=n;document.addEventListener("visibilitychange",(()=>{if(i){i.srcObject=document.hidden?null:n;if(!document.hidden){this.log.debug("page visible again, triggering startAudio to resume playback and update playback status",this.logContext);this.startAudio()}}}));document.body.append(i);this.once($r.Disconnected,(()=>{i===null||i===void 0?void 0:i.remove();i=null}))}e.push(i)}this.remoteParticipants.forEach((t=>{t.audioTrackPublications.forEach((t=>{t.track&&t.track.attachedElements.forEach((t=>{e.push(t)}))}))}));try{yield Promise.all([this.acquireAudioContext(),...e.map((e=>{e.muted=false;return e.play()}))]);this.handleAudioPlaybackStarted()}catch(e){this.handleAudioPlaybackFailed(e);throw e}}));this.startVideo=()=>cn(this,void 0,void 0,(function*(){const e=[];for(const t of this.remoteParticipants.values())t.videoTrackPublications.forEach((t=>{var i;(i=t.track)===null||i===void 0?void 0:i.attachedElements.forEach((t=>{e.includes(t)||e.push(t)}))}));yield Promise.all(e.map((e=>e.play()))).then((()=>{this.handleVideoPlaybackStarted()})).catch((e=>{e.name==="NotAllowedError"?this.handleVideoPlaybackFailed():this.log.warn("Resuming video playback failed, make sure you call `startVideo` directly in a user gesture handler",this.logContext)}))}));this.handleRestarting=()=>{this.clearConnectionReconcile();this.isResuming=false;for(const e of this.remoteParticipants.values())this.handleParticipantDisconnected(e.identity,e);this.setAndEmitConnectionState(xc.Reconnecting)&&this.emit($r.Reconnecting)};this.handleSignalRestarted=e=>cn(this,void 0,void 0,(function*(){this.log.debug("signal reconnected to server, region ".concat(e.serverRegion),Object.assign(Object.assign({},this.logContext),{region:e.serverRegion}));this.bufferedEvents=[];this.applyJoinResponse(e);try{yield this.localParticipant.republishAllTracks(void 0,true)}catch(e){this.log.error("error trying to re-publish tracks after reconnection",Object.assign(Object.assign({},this.logContext),{error:e}))}try{yield this.engine.waitForRestarted();this.log.debug("fully reconnected to server",Object.assign(Object.assign({},this.logContext),{region:e.serverRegion}))}catch(e){return}this.setAndEmitConnectionState(xc.Connected);this.emit($r.Reconnected);this.registerConnectionReconcile();this.emitBufferedEvents()}));this.handleParticipantUpdates=e=>{e.forEach((e=>{var t;if(e.identity===this.localParticipant.identity){this.localParticipant.updateInfo(e);return}e.identity===""&&(e.identity=(t=this.sidToIdentity.get(e.sid))!==null&&t!==void 0?t:"");let i=this.remoteParticipants.get(e.identity);e.state===mt.DISCONNECTED?this.handleParticipantDisconnected(e.identity,i):i=this.getOrCreateParticipant(e.identity,e)}))};this.handleActiveSpeakersUpdate=e=>{const t=[];const i={};e.forEach((e=>{i[e.sid]=true;if(e.sid===this.localParticipant.sid){this.localParticipant.audioLevel=e.level;this.localParticipant.setIsSpeaking(true);t.push(this.localParticipant)}else{const i=this.getRemoteParticipantBySid(e.sid);if(i){i.audioLevel=e.level;i.setIsSpeaking(true);t.push(i)}}}));if(!i[this.localParticipant.sid]){this.localParticipant.audioLevel=0;this.localParticipant.setIsSpeaking(false)}this.remoteParticipants.forEach((e=>{if(!i[e.sid]){e.audioLevel=0;e.setIsSpeaking(false)}}));this.activeSpeakers=t;this.emitWhenConnected($r.ActiveSpeakersChanged,t)};this.handleSpeakersChanged=e=>{const t=new Map;this.activeSpeakers.forEach((e=>{const i=this.remoteParticipants.get(e.identity);i&&i.sid!==e.sid||t.set(e.sid,e)}));e.forEach((e=>{let i=this.getRemoteParticipantBySid(e.sid);e.sid===this.localParticipant.sid&&(i=this.localParticipant);if(i){i.audioLevel=e.level;i.setIsSpeaking(e.active);e.active?t.set(e.sid,i):t.delete(e.sid)}}));const i=Array.from(t.values());i.sort(((e,t)=>t.audioLevel-e.audioLevel));this.activeSpeakers=i;this.emitWhenConnected($r.ActiveSpeakersChanged,i)};this.handleStreamStateUpdate=e=>{e.streamStates.forEach((e=>{const t=this.getRemoteParticipantBySid(e.participantSid);if(!t)return;const i=t.getTrackPublicationBySid(e.trackSid);if(!i||!i.track)return;const n=Track.streamStateFromProto(e.state);i.track.setStreamState(n);if(n!==i.track.streamState){t.emit(es.TrackStreamStateChanged,i,i.track.streamState);this.emitWhenConnected($r.TrackStreamStateChanged,i,i.track.streamState,t)}}))};this.handleSubscriptionPermissionUpdate=e=>{const t=this.getRemoteParticipantBySid(e.participantSid);if(!t)return;const i=t.getTrackPublicationBySid(e.trackSid);i&&i.setAllowed(e.allowed)};this.handleSubscriptionError=e=>{const t=Array.from(this.remoteParticipants.values()).find((t=>t.trackPublications.has(e.trackSid)));if(!t)return;const i=t.getTrackPublicationBySid(e.trackSid);i&&i.setSubscriptionError(e.err)};this.handleDataPacket=e=>{const t=this.remoteParticipants.get(e.participantIdentity);if(e.value.case==="user")this.handleUserPacket(t,e.value.value,e.kind);else if(e.value.case==="transcription")this.handleTranscription(t,e.value.value);else if(e.value.case==="sipDtmf")this.handleSipDtmf(t,e.value.value);else if(e.value.case==="chatMessage")this.handleChatMessage(t,e.value.value);else if(e.value.case==="metrics")this.handleMetrics(e.value.value,t);else if(e.value.case==="streamHeader"||e.value.case==="streamChunk"||e.value.case==="streamTrailer")this.handleDataStream(e);else if(e.value.case==="rpcRequest"){const t=e.value.value;this.handleIncomingRpcRequest(e.participantIdentity,t.id,t.method,t.payload,t.responseTimeoutMs,t.version)}};this.handleUserPacket=(e,t,i)=>{this.emit($r.DataReceived,t.payload,e,i,t.topic);e===null||e===void 0?void 0:e.emit(es.DataReceived,t.payload,i)};this.handleSipDtmf=(e,t)=>{this.emit($r.SipDTMFReceived,t,e);e===null||e===void 0?void 0:e.emit(es.SipDTMFReceived,t)};this.handleTranscription=(e,t)=>{const i=t.transcribedParticipantIdentity===this.localParticipant.identity?this.localParticipant:this.getParticipantByIdentity(t.transcribedParticipantIdentity);const n=i===null||i===void 0?void 0:i.trackPublications.get(t.trackId);const r=vo(t,this.transcriptionReceivedTimes);n===null||n===void 0?void 0:n.emit(is.TranscriptionReceived,r);i===null||i===void 0?void 0:i.emit(es.TranscriptionReceived,r,n);this.emit($r.TranscriptionReceived,r,i,n)};this.handleChatMessage=(e,t)=>{const i=ko(t);this.emit($r.ChatMessage,i,e)};this.handleMetrics=(e,t)=>{this.emit($r.MetricsReceived,e,t)};this.handleDataStream=e=>{this.incomingDataStreamManager.handleDataStreamPacket(e)};this.bufferedSegments=new Map;this.handleAudioPlaybackStarted=()=>{if(!this.canPlaybackAudio){this.audioEnabled=true;this.emit($r.AudioPlaybackStatusChanged,true)}};this.handleAudioPlaybackFailed=e=>{this.log.warn("could not playback audio",Object.assign(Object.assign({},this.logContext),{error:e}));if(this.canPlaybackAudio){this.audioEnabled=false;this.emit($r.AudioPlaybackStatusChanged,false)}};this.handleVideoPlaybackStarted=()=>{if(this.isVideoPlaybackBlocked){this.isVideoPlaybackBlocked=false;this.emit($r.VideoPlaybackStatusChanged,true)}};this.handleVideoPlaybackFailed=()=>{if(!this.isVideoPlaybackBlocked){this.isVideoPlaybackBlocked=true;this.emit($r.VideoPlaybackStatusChanged,false)}};this.handleDeviceChange=()=>cn(this,void 0,void 0,(function*(){var e;((e=os())===null||e===void 0?void 0:e.os)!=="iOS"&&(yield this.selectDefaultDevices());this.emit($r.MediaDevicesChanged)}));this.handleRoomUpdate=e=>{const t=this.roomInfo;this.roomInfo=e;t&&t.metadata!==e.metadata&&this.emitWhenConnected($r.RoomMetadataChanged,e.metadata);(t===null||t===void 0?void 0:t.activeRecording)!==e.activeRecording&&this.emitWhenConnected($r.RecordingStatusChanged,e.activeRecording)};this.handleConnectionQualityUpdate=e=>{e.updates.forEach((e=>{if(e.participantSid===this.localParticipant.sid){this.localParticipant.setConnectionQuality(e.quality);return}const t=this.getRemoteParticipantBySid(e.participantSid);t&&t.setConnectionQuality(e.quality)}))};this.onLocalParticipantMetadataChanged=e=>{this.emit($r.ParticipantMetadataChanged,e,this.localParticipant)};this.onLocalParticipantNameChanged=e=>{this.emit($r.ParticipantNameChanged,e,this.localParticipant)};this.onLocalAttributesChanged=e=>{this.emit($r.ParticipantAttributesChanged,e,this.localParticipant)};this.onLocalTrackMuted=e=>{this.emit($r.TrackMuted,e,this.localParticipant)};this.onLocalTrackUnmuted=e=>{this.emit($r.TrackUnmuted,e,this.localParticipant)};this.onTrackProcessorUpdate=e=>{var t;(t=e===null||e===void 0?void 0:e.onPublish)===null||t===void 0?void 0:t.call(e,this)};this.onLocalTrackPublished=e=>cn(this,void 0,void 0,(function*(){var t,i,n,r,s,o;(t=e.track)===null||t===void 0?void 0:t.on(is.TrackProcessorUpdate,this.onTrackProcessorUpdate);(i=e.track)===null||i===void 0?void 0:i.on(is.Restarted,this.onLocalTrackRestarted);(s=(r=(n=e.track)===null||n===void 0?void 0:n.getProcessor())===null||r===void 0?void 0:r.onPublish)===null||s===void 0?void 0:s.call(r,this);this.emit($r.LocalTrackPublished,e,this.localParticipant);if(Po(e.track)){const t=yield e.track.checkForSilence();t&&this.emit($r.LocalAudioSilenceDetected,e)}const a=yield(o=e.track)===null||o===void 0?void 0:o.getDeviceId(false);const c=Fo(e.source);if(c&&a&&a!==this.localParticipant.activeDeviceMap.get(c)){this.localParticipant.activeDeviceMap.set(c,a);this.emit($r.ActiveDeviceChanged,c,a)}}));this.onLocalTrackUnpublished=e=>{var t,i;(t=e.track)===null||t===void 0?void 0:t.off(is.TrackProcessorUpdate,this.onTrackProcessorUpdate);(i=e.track)===null||i===void 0?void 0:i.off(is.Restarted,this.onLocalTrackRestarted);this.emit($r.LocalTrackUnpublished,e,this.localParticipant)};this.onLocalTrackRestarted=e=>cn(this,void 0,void 0,(function*(){const t=yield e.getDeviceId(false);const i=Fo(e.source);if(i&&t&&t!==this.localParticipant.activeDeviceMap.get(i)){this.log.debug("local track restarted, setting ".concat(i," ").concat(t," active"),this.logContext);this.localParticipant.activeDeviceMap.set(i,t);this.emit($r.ActiveDeviceChanged,i,t)}}));this.onLocalConnectionQualityChanged=e=>{this.emit($r.ConnectionQualityChanged,e,this.localParticipant)};this.onMediaDevicesError=(e,t)=>{this.emit($r.MediaDevicesError,e,t)};this.onLocalParticipantPermissionsChanged=e=>{this.emit($r.ParticipantPermissionsChanged,e,this.localParticipant)};this.onLocalChatMessageSent=e=>{this.emit($r.ChatMessage,e,this.localParticipant)};this.setMaxListeners(100);this.remoteParticipants=new Map;this.sidToIdentity=new Map;this.options=Object.assign(Object.assign({},Ma),e);this.log=en((i=this.options.loggerName)!==null&&i!==void 0?i:Xi.Room);this.transcriptionReceivedTimes=new Map;this.options.audioCaptureDefaults=Object.assign(Object.assign({},Da),e===null||e===void 0?void 0:e.audioCaptureDefaults);this.options.videoCaptureDefaults=Object.assign(Object.assign({},xa),e===null||e===void 0?void 0:e.videoCaptureDefaults);this.options.publishDefaults=Object.assign(Object.assign({},Oa),e===null||e===void 0?void 0:e.publishDefaults);this.maybeCreateEngine();this.incomingDataStreamManager=new IncomingDataStreamManager;this.outgoingDataStreamManager=new OutgoingDataStreamManager(this.engine,this.log);this.disconnectLock=new _;this.localParticipant=new LocalParticipant("","",this.engine,this.options,this.rpcHandlers,this.outgoingDataStreamManager);this.options.videoCaptureDefaults.deviceId&&this.localParticipant.activeDeviceMap.set("videoinput",mo(this.options.videoCaptureDefaults.deviceId));this.options.audioCaptureDefaults.deviceId&&this.localParticipant.activeDeviceMap.set("audioinput",mo(this.options.audioCaptureDefaults.deviceId));((n=this.options.audioOutput)===null||n===void 0?void 0:n.deviceId)&&this.switchActiveDevice("audiooutput",mo(this.options.audioOutput.deviceId)).catch((e=>this.log.warn("Could not set audio output: ".concat(e.message),this.logContext)));this.options.e2ee&&this.setupE2EE();if(Gs()){const e=new AbortController;(r=navigator.mediaDevices)===null||r===void 0?void 0:r.addEventListener("devicechange",this.handleDeviceChange,{signal:e.signal});Room.cleanupRegistry&&Room.cleanupRegistry.register(this,(()=>{e.abort()}))}}registerTextStreamHandler(e,t){return this.incomingDataStreamManager.registerTextStreamHandler(e,t)}unregisterTextStreamHandler(e){return this.incomingDataStreamManager.unregisterTextStreamHandler(e)}registerByteStreamHandler(e,t){return this.incomingDataStreamManager.registerByteStreamHandler(e,t)}unregisterByteStreamHandler(e){return this.incomingDataStreamManager.unregisterByteStreamHandler(e)}
/**
   * Establishes the participant as a receiver for calls of the specified RPC method.
   *
   * @param method - The name of the indicated RPC method
   * @param handler - Will be invoked when an RPC request for this method is received
   * @returns A promise that resolves when the method is successfully registered
   * @throws {Error} If a handler for this method is already registered (must call unregisterRpcMethod first)
   *
   * @example
   * ```typescript
   * room.localParticipant?.registerRpcMethod(
   *   'greet',
   *   async (data: RpcInvocationData) => {
   *     console.log(`Received greeting from ${data.callerIdentity}: ${data.payload}`);
   *     return `Hello, ${data.callerIdentity}!`;
   *   }
   * );
   * ```
   *
   * The handler should return a Promise that resolves to a string.
   * If unable to respond within `responseTimeout`, the request will result in an error on the caller's side.
   *
   * You may throw errors of type `RpcError` with a string `message` in the handler,
   * and they will be received on the caller's side with the message intact.
   * Other errors thrown in your handler will not be transmitted as-is, and will instead arrive to the caller as `1500` ("Application Error").
   */registerRpcMethod(e,t){if(this.rpcHandlers.has(e))throw Error("RPC handler already registered for method ".concat(e,", unregisterRpcMethod before trying to register again"));this.rpcHandlers.set(e,t)}
/**
   * Unregisters a previously registered RPC method.
   *
   * @param method - The name of the RPC method to unregister
   */unregisterRpcMethod(e){this.rpcHandlers.delete(e)}setE2EEEnabled(e){return cn(this,void 0,void 0,(function*(){if(!this.e2eeManager)throw Error("e2ee not configured, please set e2ee settings within the room options");yield Promise.all([this.localParticipant.setE2EEEnabled(e)]);this.localParticipant.identity!==""&&this.e2eeManager.setParticipantCryptorEnabled(e,this.localParticipant.identity)}))}setupE2EE(){var e;if(this.options.e2ee){"e2eeManager"in this.options.e2ee?this.e2eeManager=this.options.e2ee.e2eeManager:this.e2eeManager=new E2EEManager(this.options.e2ee);this.e2eeManager.on(xr.ParticipantEncryptionStatusChanged,((e,t)=>{Do(t)&&(this.isE2EEEnabled=e);this.emit($r.ParticipantEncryptionStatusChanged,e,t)}));this.e2eeManager.on(xr.EncryptionError,(e=>this.emit($r.EncryptionError,e)));(e=this.e2eeManager)===null||e===void 0?void 0:e.setup(this)}}get logContext(){var e;return{room:this.name,roomID:(e=this.roomInfo)===null||e===void 0?void 0:e.sid,participant:this.localParticipant.identity,pID:this.localParticipant.sid}}get isRecording(){var e,t;return(t=(e=this.roomInfo)===null||e===void 0?void 0:e.activeRecording)!==null&&t!==void 0&&t}getSid(){return cn(this,void 0,void 0,(function*(){return this.state===xc.Disconnected?"":this.roomInfo&&this.roomInfo.sid!==""?this.roomInfo.sid:new Promise(((e,t)=>{const i=t=>{if(t.sid!==""){this.engine.off(ts.RoomUpdate,i);e(t.sid)}};this.engine.on(ts.RoomUpdate,i);this.once($r.Disconnected,(()=>{this.engine.off(ts.RoomUpdate,i);t("Room disconnected before room server id was available")}))}))}))}get name(){var e,t;return(t=(e=this.roomInfo)===null||e===void 0?void 0:e.name)!==null&&t!==void 0?t:""}get metadata(){var e;return(e=this.roomInfo)===null||e===void 0?void 0:e.metadata}get numParticipants(){var e,t;return(t=(e=this.roomInfo)===null||e===void 0?void 0:e.numParticipants)!==null&&t!==void 0?t:0}get numPublishers(){var e,t;return(t=(e=this.roomInfo)===null||e===void 0?void 0:e.numPublishers)!==null&&t!==void 0?t:0}maybeCreateEngine(){if(!this.engine||this.engine.isClosed){this.engine=new RTCEngine(this.options);this.engine.on(ts.ParticipantUpdate,this.handleParticipantUpdates).on(ts.RoomUpdate,this.handleRoomUpdate).on(ts.SpeakersChanged,this.handleSpeakersChanged).on(ts.StreamStateChanged,this.handleStreamStateUpdate).on(ts.ConnectionQualityUpdate,this.handleConnectionQualityUpdate).on(ts.SubscriptionError,this.handleSubscriptionError).on(ts.SubscriptionPermissionUpdate,this.handleSubscriptionPermissionUpdate).on(ts.MediaTrackAdded,((e,t,i)=>{this.onTrackAdded(e,t,i)})).on(ts.Disconnected,(e=>{this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,e)})).on(ts.ActiveSpeakersUpdate,this.handleActiveSpeakersUpdate).on(ts.DataPacketReceived,this.handleDataPacket).on(ts.Resuming,(()=>{this.clearConnectionReconcile();this.isResuming=true;this.log.info("Resuming signal connection",this.logContext);this.setAndEmitConnectionState(xc.SignalReconnecting)&&this.emit($r.SignalReconnecting)})).on(ts.Resumed,(()=>{this.registerConnectionReconcile();this.isResuming=false;this.log.info("Resumed signal connection",this.logContext);this.updateSubscriptions();this.emitBufferedEvents();this.setAndEmitConnectionState(xc.Connected)&&this.emit($r.Reconnected)})).on(ts.SignalResumed,(()=>{this.bufferedEvents=[];(this.state===xc.Reconnecting||this.isResuming)&&this.sendSyncState()})).on(ts.Restarting,this.handleRestarting).on(ts.SignalRestarted,this.handleSignalRestarted).on(ts.Offline,(()=>{this.setAndEmitConnectionState(xc.Reconnecting)&&this.emit($r.Reconnecting)})).on(ts.DCBufferStatusChanged,((e,t)=>{this.emit($r.DCBufferStatusChanged,e,t)})).on(ts.LocalTrackSubscribed,(e=>{const t=this.localParticipant.getTrackPublications().find((t=>{let{trackSid:i}=t;return i===e}));if(t){this.localParticipant.emit(es.LocalTrackSubscribed,t);this.emitWhenConnected($r.LocalTrackSubscribed,t,this.localParticipant)}else this.log.warn("could not find local track subscription for subscribed event",this.logContext)})).on(ts.RoomMoved,(e=>{this.log.debug("room moved",e);e.room&&this.handleRoomUpdate(e.room);this.remoteParticipants.forEach(((e,t)=>{this.handleParticipantDisconnected(t,e)}));this.emit($r.Moved,e.room.name);e.participant?this.handleParticipantUpdates([e.participant,...e.otherParticipants]):this.handleParticipantUpdates(e.otherParticipants)}));this.localParticipant&&this.localParticipant.setupEngine(this.engine);this.e2eeManager&&this.e2eeManager.setupEngine(this.engine);this.outgoingDataStreamManager&&this.outgoingDataStreamManager.setupEngine(this.engine)}}
/**
   * getLocalDevices abstracts navigator.mediaDevices.enumerateDevices.
   * In particular, it requests device permissions by default if needed
   * and makes sure the returned device does not consist of dummy devices
   * @param kind
   * @returns a list of available local devices
   */static getLocalDevices(e){let t=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];return DeviceManager.getInstance().getDevices(e,t)}prepareConnection(e,t){return cn(this,void 0,void 0,(function*(){if(this.state===xc.Disconnected){this.log.debug("prepareConnection to ".concat(e),this.logContext);try{if(Js(new URL(e))&&t){this.regionUrlProvider=new RegionUrlProvider(e,t);const i=yield this.regionUrlProvider.getNextBestRegionUrl();if(i&&this.state===xc.Disconnected){this.regionUrl=i;yield fetch(fo(i),{method:"HEAD"});this.log.debug("prepared connection to ".concat(i),this.logContext)}}else yield fetch(fo(e),{method:"HEAD"})}catch(e){this.log.warn("could not prepare connection",Object.assign(Object.assign({},this.logContext),{error:e}))}}}))}
/**
   * retrieves a participant by identity
   * @param identity
   * @returns
   */getParticipantByIdentity(e){return this.localParticipant.identity===e?this.localParticipant:this.remoteParticipants.get(e)}clearConnectionFutures(){this.connectFuture=void 0}simulateScenario(e,t){return cn(this,void 0,void 0,(function*(){let i=()=>{};let n;switch(e){case"signal-reconnect":yield this.engine.client.handleOnClose("simulate disconnect");break;case"speaker":n=new Ni({scenario:{case:"speakerUpdate",value:3}});break;case"node-failure":n=new Ni({scenario:{case:"nodeFailure",value:true}});break;case"server-leave":n=new Ni({scenario:{case:"serverLeave",value:true}});break;case"migration":n=new Ni({scenario:{case:"migration",value:true}});break;case"resume-reconnect":this.engine.failNext();yield this.engine.client.handleOnClose("simulate resume-disconnect");break;case"disconnect-signal-on-resume":i=()=>cn(this,void 0,void 0,(function*(){yield this.engine.client.handleOnClose("simulate resume-disconnect")}));n=new Ni({scenario:{case:"disconnectSignalOnResume",value:true}});break;case"disconnect-signal-on-resume-no-messages":i=()=>cn(this,void 0,void 0,(function*(){yield this.engine.client.handleOnClose("simulate resume-disconnect")}));n=new Ni({scenario:{case:"disconnectSignalOnResumeNoMessages",value:true}});break;case"full-reconnect":this.engine.fullReconnectOnNext=true;yield this.engine.client.handleOnClose("simulate full-reconnect");break;case"force-tcp":case"force-tls":n=new Ni({scenario:{case:"switchCandidateProtocol",value:e==="force-tls"?2:1}});i=()=>cn(this,void 0,void 0,(function*(){const e=this.engine.client.onLeave;e&&e(new mi({reason:ot.CLIENT_INITIATED,action:gi.RECONNECT}))}));break;case"subscriber-bandwidth":if(t===void 0||typeof t!=="number")throw new Error("subscriber-bandwidth requires a number as argument");n=new Ni({scenario:{case:"subscriberBandwidth",value:To(t)}});break;case"leave-full-reconnect":n=new Ni({scenario:{case:"leaveRequestFullReconnect",value:true}})}if(n){yield this.engine.client.sendSimulateScenario(n);yield i()}}))}get canPlaybackAudio(){return this.audioEnabled}get canPlaybackVideo(){return!this.isVideoPlaybackBlocked}getActiveDevice(e){return this.localParticipant.activeDeviceMap.get(e)}
/**
   * Switches all active devices used in this room to the given device.
   *
   * Note: setting AudioOutput is not supported on some browsers. See [setSinkId](https://developer.mozilla.org/en-US/docs/Web/API/HTMLMediaElement/setSinkId#browser_compatibility)
   *
   * @param kind use `videoinput` for camera track,
   *  `audioinput` for microphone track,
   *  `audiooutput` to set speaker for all incoming audio tracks
   * @param deviceId
   */switchActiveDevice(e,t){return cn(this,arguments,void 0,(function(e,t){var i=this;let n=!(arguments.length>2&&arguments[2]!==void 0)||arguments[2];return function*(){var r,s,o,a,c,d;var l;let u=true;let h=false;const p=n?{exact:t}:t;if(e==="audioinput"){h=i.localParticipant.audioTrackPublications.size===0;const t=(r=i.getActiveDevice(e))!==null&&r!==void 0?r:i.options.audioCaptureDefaults.deviceId;i.options.audioCaptureDefaults.deviceId=p;const n=Array.from(i.localParticipant.audioTrackPublications.values()).filter((e=>e.source===Track.Source.Microphone));try{u=(yield Promise.all(n.map((e=>{var t;return(t=e.audioTrack)===null||t===void 0?void 0:t.setDeviceId(p)})))).every((e=>e===true))}catch(e){i.options.audioCaptureDefaults.deviceId=t;throw e}const s=n.some((e=>{var t,i;return(i=(t=e.track)===null||t===void 0?void 0:t.isMuted)!==null&&i!==void 0&&i}));u&&s&&(h=true)}else if(e==="videoinput"){h=i.localParticipant.videoTrackPublications.size===0;const t=(s=i.getActiveDevice(e))!==null&&s!==void 0?s:i.options.videoCaptureDefaults.deviceId;i.options.videoCaptureDefaults.deviceId=p;const n=Array.from(i.localParticipant.videoTrackPublications.values()).filter((e=>e.source===Track.Source.Camera));try{u=(yield Promise.all(n.map((e=>{var t;return(t=e.videoTrack)===null||t===void 0?void 0:t.setDeviceId(p)})))).every((e=>e===true))}catch(e){i.options.videoCaptureDefaults.deviceId=t;throw e}const r=n.some((e=>{var t,i;return(i=(t=e.track)===null||t===void 0?void 0:t.isMuted)!==null&&i!==void 0&&i}));u&&r&&(h=true)}else if(e==="audiooutput"){h=true;if(!Us()&&!i.options.webAudioMix||i.options.webAudioMix&&i.audioContext&&!("setSinkId"in i.audioContext))throw new Error("cannot switch audio output, the current browser does not support it");i.options.webAudioMix&&(t=(o=yield DeviceManager.getInstance().normalizeDeviceId("audiooutput",t))!==null&&o!==void 0?o:"");(a=(l=i.options).audioOutput)!==null&&a!==void 0?a:l.audioOutput={};const n=(c=i.getActiveDevice(e))!==null&&c!==void 0?c:i.options.audioOutput.deviceId;i.options.audioOutput.deviceId=t;try{i.options.webAudioMix&&((d=i.audioContext)===null||d===void 0?void 0:d.setSinkId(t));yield Promise.all(Array.from(i.remoteParticipants.values()).map((e=>e.setAudioOutput({deviceId:t}))))}catch(e){i.options.audioOutput.deviceId=n;throw e}}if(h){i.localParticipant.activeDeviceMap.set(e,t);i.emit($r.ActiveDeviceChanged,e,t)}return u}()}))}setupLocalParticipantEvents(){this.localParticipant.on(es.ParticipantMetadataChanged,this.onLocalParticipantMetadataChanged).on(es.ParticipantNameChanged,this.onLocalParticipantNameChanged).on(es.AttributesChanged,this.onLocalAttributesChanged).on(es.TrackMuted,this.onLocalTrackMuted).on(es.TrackUnmuted,this.onLocalTrackUnmuted).on(es.LocalTrackPublished,this.onLocalTrackPublished).on(es.LocalTrackUnpublished,this.onLocalTrackUnpublished).on(es.ConnectionQualityChanged,this.onLocalConnectionQualityChanged).on(es.MediaDevicesError,this.onMediaDevicesError).on(es.AudioStreamAcquired,this.startAudio).on(es.ChatMessage,this.onLocalChatMessageSent).on(es.ParticipantPermissionsChanged,this.onLocalParticipantPermissionsChanged)}recreateEngine(){var e;(e=this.engine)===null||e===void 0?void 0:e.close();this.engine=void 0;this.isResuming=false;this.remoteParticipants.clear();this.sidToIdentity.clear();this.bufferedEvents=[];this.maybeCreateEngine()}onTrackAdded(e,t,i){if(this.state===xc.Connecting||this.state===xc.Reconnecting){const n=()=>{this.onTrackAdded(e,t,i);r()};const r=()=>{this.off($r.Reconnected,n);this.off($r.Connected,n);this.off($r.Disconnected,r)};this.once($r.Reconnected,n);this.once($r.Connected,n);this.once($r.Disconnected,r);return}if(this.state===xc.Disconnected){this.log.warn("skipping incoming track after Room disconnected",this.logContext);return}if(e.readyState==="ended"){this.log.info("skipping incoming track as it already ended",this.logContext);return}const n=Is(t.id);const r=n[0];let s=n[1];let o=e.id;s&&s.startsWith("TR")&&(o=s);if(r===this.localParticipant.sid){this.log.warn("tried to create RemoteParticipant for local participant",this.logContext);return}const a=Array.from(this.remoteParticipants.values()).find((e=>e.sid===r));if(!a){this.log.error("Tried to add a track for a participant, that's not present. Sid: ".concat(r),this.logContext);return}let c;this.options.adaptiveStream&&(c=typeof this.options.adaptiveStream==="object"?this.options.adaptiveStream:{});const d=a.addSubscribedMediaTrack(e,o,t,i,c);(d===null||d===void 0?void 0:d.isEncrypted)&&!this.e2eeManager&&this.emit($r.EncryptionError,new Error("Encrypted ".concat(d.source," track received from participant ").concat(a.sid,", but room does not have encryption enabled!")))}handleDisconnect(){let e=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];let t=arguments.length>1?arguments[1]:void 0;var i;this.clearConnectionReconcile();this.isResuming=false;this.bufferedEvents=[];this.transcriptionReceivedTimes.clear();this.incomingDataStreamManager.clearHandlersAndControllers();if(this.state!==xc.Disconnected){this.regionUrl=void 0;try{this.remoteParticipants.forEach((e=>{e.trackPublications.forEach((t=>{e.unpublishTrack(t.trackSid)}))}));this.localParticipant.trackPublications.forEach((t=>{var i,n,r;t.track&&this.localParticipant.unpublishTrack(t.track,e);if(e){(i=t.track)===null||i===void 0?void 0:i.detach();(n=t.track)===null||n===void 0?void 0:n.stop()}else(r=t.track)===null||r===void 0?void 0:r.stopMonitor()}));this.localParticipant.off(es.ParticipantMetadataChanged,this.onLocalParticipantMetadataChanged).off(es.ParticipantNameChanged,this.onLocalParticipantNameChanged).off(es.AttributesChanged,this.onLocalAttributesChanged).off(es.TrackMuted,this.onLocalTrackMuted).off(es.TrackUnmuted,this.onLocalTrackUnmuted).off(es.LocalTrackPublished,this.onLocalTrackPublished).off(es.LocalTrackUnpublished,this.onLocalTrackUnpublished).off(es.ConnectionQualityChanged,this.onLocalConnectionQualityChanged).off(es.MediaDevicesError,this.onMediaDevicesError).off(es.AudioStreamAcquired,this.startAudio).off(es.ChatMessage,this.onLocalChatMessageSent).off(es.ParticipantPermissionsChanged,this.onLocalParticipantPermissionsChanged);this.localParticipant.trackPublications.clear();this.localParticipant.videoTrackPublications.clear();this.localParticipant.audioTrackPublications.clear();this.remoteParticipants.clear();this.sidToIdentity.clear();this.activeSpeakers=[];if(this.audioContext&&typeof this.options.webAudioMix==="boolean"){this.audioContext.close();this.audioContext=void 0}if(Gs()){window.removeEventListener("beforeunload",this.onPageLeave);window.removeEventListener("pagehide",this.onPageLeave);window.removeEventListener("freeze",this.onPageLeave);(i=navigator.mediaDevices)===null||i===void 0?void 0:i.removeEventListener("devicechange",this.handleDeviceChange)}}finally{this.setAndEmitConnectionState(xc.Disconnected);this.emit($r.Disconnected,t)}}}handleParticipantDisconnected(e,t){var i;this.remoteParticipants.delete(e);if(t){this.incomingDataStreamManager.validateParticipantHasNoActiveDataStreams(e);t.trackPublications.forEach((e=>{t.unpublishTrack(e.trackSid,true)}));this.emit($r.ParticipantDisconnected,t);t.setDisconnected();(i=this.localParticipant)===null||i===void 0?void 0:i.handleParticipantDisconnected(t.identity)}}handleIncomingRpcRequest(e,t,i,n,r,s){return cn(this,void 0,void 0,(function*(){yield this.engine.publishRpcAck(e,t);if(s!==1){yield this.engine.publishRpcResponse(e,t,null,RpcError.builtIn("UNSUPPORTED_VERSION"));return}const o=this.rpcHandlers.get(i);if(!o){yield this.engine.publishRpcResponse(e,t,null,RpcError.builtIn("UNSUPPORTED_METHOD"));return}let a=null;let c=null;try{const s=yield o({requestId:t,callerIdentity:e,payload:n,responseTimeout:r});if(La(s)>Na){a=RpcError.builtIn("RESPONSE_PAYLOAD_TOO_LARGE");console.warn("RPC Response payload too large for ".concat(i))}else c=s}catch(e){if(e instanceof RpcError)a=e;else{console.warn("Uncaught error returned by RPC handler for ".concat(i,". Returning APPLICATION_ERROR instead."),e);a=RpcError.builtIn("APPLICATION_ERROR")}}yield this.engine.publishRpcResponse(e,t,c,a)}))}selectDefaultDevices(){return cn(this,void 0,void 0,(function*(){var e,t,i;const n=DeviceManager.getInstance().previousDevices;const r=yield DeviceManager.getInstance().getDevices(void 0,false);const s=os();if((s===null||s===void 0?void 0:s.name)==="Chrome"&&s.os!=="iOS")for(let e of r){const t=n.find((t=>t.deviceId===e.deviceId));t&&t.label!==""&&t.kind===e.kind&&t.label!==e.label&&this.getActiveDevice(e.kind)==="default"&&this.emit($r.ActiveDeviceChanged,e.kind,e.deviceId)}const o=["audiooutput","audioinput","videoinput"];for(let s of o){const o=jo(s);const a=this.localParticipant.getTrackPublication(o);if(a&&((e=a.track)===null||e===void 0?void 0:e.isUserProvided))continue;const c=r.filter((e=>e.kind===s));const d=this.getActiveDevice(s);d===((t=n.filter((e=>e.kind===s))[0])===null||t===void 0?void 0:t.deviceId)&&c.length>0&&((i=c[0])===null||i===void 0?void 0:i.deviceId)!==d?yield this.switchActiveDevice(s,c[0].deviceId):s==="audioinput"&&!Vs()||s==="videoinput"||!(c.length>0)||c.find((e=>e.deviceId===this.getActiveDevice(s)))||s==="audiooutput"&&Vs()||(yield this.switchActiveDevice(s,c[0].deviceId))}}))}acquireAudioContext(){return cn(this,void 0,void 0,(function*(){var e,t;typeof this.options.webAudioMix!=="boolean"&&this.options.webAudioMix.audioContext?this.audioContext=this.options.webAudioMix.audioContext:this.audioContext&&this.audioContext.state!=="closed"||(this.audioContext=(e=Uo())!==null&&e!==void 0?e:void 0);this.options.webAudioMix&&this.remoteParticipants.forEach((e=>e.setAudioContext(this.audioContext)));this.localParticipant.setAudioContext(this.audioContext);if(this.audioContext&&this.audioContext.state==="suspended")try{yield Promise.race([this.audioContext.resume(),Os(200)])}catch(e){this.log.warn("Could not resume audio context",Object.assign(Object.assign({},this.logContext),{error:e}))}const i=((t=this.audioContext)===null||t===void 0?void 0:t.state)==="running";if(i!==this.canPlaybackAudio){this.audioEnabled=i;this.emit($r.AudioPlaybackStatusChanged,i)}}))}createParticipant(e,t){var i;let n;n=t?RemoteParticipant.fromParticipantInfo(this.engine.client,t,{loggerContextCb:()=>this.logContext,loggerName:this.options.loggerName}):new RemoteParticipant(this.engine.client,"",e,void 0,void 0,void 0,{loggerContextCb:()=>this.logContext,loggerName:this.options.loggerName});this.options.webAudioMix&&n.setAudioContext(this.audioContext);((i=this.options.audioOutput)===null||i===void 0?void 0:i.deviceId)&&n.setAudioOutput(this.options.audioOutput).catch((e=>this.log.warn("Could not set audio output: ".concat(e.message),this.logContext)));return n}getOrCreateParticipant(e,t){if(this.remoteParticipants.has(e)){const i=this.remoteParticipants.get(e);if(t){const e=i.updateInfo(t);e&&this.sidToIdentity.set(t.sid,t.identity)}return i}const i=this.createParticipant(e,t);this.remoteParticipants.set(e,i);this.sidToIdentity.set(t.sid,t.identity);this.emitWhenConnected($r.ParticipantConnected,i);i.on(es.TrackPublished,(e=>{this.emitWhenConnected($r.TrackPublished,e,i)})).on(es.TrackSubscribed,((e,t)=>{if(e.kind===Track.Kind.Audio){e.on(is.AudioPlaybackStarted,this.handleAudioPlaybackStarted);e.on(is.AudioPlaybackFailed,this.handleAudioPlaybackFailed)}else if(e.kind===Track.Kind.Video){e.on(is.VideoPlaybackFailed,this.handleVideoPlaybackFailed);e.on(is.VideoPlaybackStarted,this.handleVideoPlaybackStarted)}this.emit($r.TrackSubscribed,e,t,i)})).on(es.TrackUnpublished,(e=>{this.emit($r.TrackUnpublished,e,i)})).on(es.TrackUnsubscribed,((e,t)=>{this.emit($r.TrackUnsubscribed,e,t,i)})).on(es.TrackMuted,(e=>{this.emitWhenConnected($r.TrackMuted,e,i)})).on(es.TrackUnmuted,(e=>{this.emitWhenConnected($r.TrackUnmuted,e,i)})).on(es.ParticipantMetadataChanged,(e=>{this.emitWhenConnected($r.ParticipantMetadataChanged,e,i)})).on(es.ParticipantNameChanged,(e=>{this.emitWhenConnected($r.ParticipantNameChanged,e,i)})).on(es.AttributesChanged,(e=>{this.emitWhenConnected($r.ParticipantAttributesChanged,e,i)})).on(es.ConnectionQualityChanged,(e=>{this.emitWhenConnected($r.ConnectionQualityChanged,e,i)})).on(es.ParticipantPermissionsChanged,(e=>{this.emitWhenConnected($r.ParticipantPermissionsChanged,e,i)})).on(es.TrackSubscriptionStatusChanged,((e,t)=>{this.emitWhenConnected($r.TrackSubscriptionStatusChanged,e,t,i)})).on(es.TrackSubscriptionFailed,((e,t)=>{this.emit($r.TrackSubscriptionFailed,e,i,t)})).on(es.TrackSubscriptionPermissionChanged,((e,t)=>{this.emitWhenConnected($r.TrackSubscriptionPermissionChanged,e,t,i)})).on(es.Active,(()=>{this.emitWhenConnected($r.ParticipantActive,i);i.kind===gt.AGENT&&this.localParticipant.setActiveAgent(i)}));t&&i.updateInfo(t);return i}sendSyncState(){const e=Array.from(this.remoteParticipants.values()).reduce(((e,t)=>{e.push(...t.getTrackPublications());return e}),[]);const t=this.localParticipant.getTrackPublications();this.engine.sendSyncState(e,t)}updateSubscriptions(){for(const e of this.remoteParticipants.values())for(const t of e.videoTrackPublications.values())t.isSubscribed&&Io(t)&&t.emitTrackUpdate()}getRemoteParticipantBySid(e){const t=this.sidToIdentity.get(e);if(t)return this.remoteParticipants.get(t)}registerConnectionReconcile(){this.clearConnectionReconcile();let e=0;this.connectionReconcileInterval=CriticalTimers.setInterval((()=>{if(this.engine&&!this.engine.isClosed&&this.engine.verifyTransport())e=0;else{e++;this.log.warn("detected connection state mismatch",Object.assign(Object.assign({},this.logContext),{numFailures:e,engine:this.engine?{closed:this.engine.isClosed,transportsConnected:this.engine.verifyTransport()}:void 0}));if(e>=3){this.recreateEngine();this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,ot.STATE_MISMATCH)}}}),Mc)}clearConnectionReconcile(){this.connectionReconcileInterval&&CriticalTimers.clearInterval(this.connectionReconcileInterval)}setAndEmitConnectionState(e){if(e===this.state)return false;this.state=e;this.emit($r.ConnectionStateChanged,this.state);return true}emitBufferedEvents(){this.bufferedEvents.forEach((e=>{let[t,i]=e;this.emit(t,...i)}));this.bufferedEvents=[]}emitWhenConnected(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];if(this.state===xc.Reconnecting||this.isResuming||!this.engine||this.engine.pendingReconnect)this.bufferedEvents.push([e,i]);else if(this.state===xc.Connected)return this.emit(e,...i);return false}simulateParticipants(e){return cn(this,void 0,void 0,(function*(){var t,i;const n=Object.assign({audio:true,video:true,useRealTracks:false},e.publish);const r=Object.assign({count:9,audio:false,video:true,aspectRatios:[1.66,1.7,1.3]},e.participants);this.handleDisconnect();this.roomInfo=new lt({sid:"RM_SIMULATED",name:"simulated-room",emptyTimeout:0,maxParticipants:0,creationTime:A.parse((new Date).getTime()),metadata:"",numParticipants:1,numPublishers:1,turnPassword:"",enabledCodecs:[],activeRecording:false});this.localParticipant.updateInfo(new pt({identity:"simulated-local",name:"local-name"}));this.setupLocalParticipantEvents();this.emit($r.SignalConnected);this.emit($r.Connected);this.setAndEmitConnectionState(xc.Connected);if(n.video){const e=new LocalTrackPublication(Track.Kind.Video,new bt({source:it.CAMERA,sid:Math.floor(Math.random()*1e4).toString(),type:tt.AUDIO,name:"video-dummy"}),new LocalVideoTrack(n.useRealTracks?(yield window.navigator.mediaDevices.getUserMedia({video:true})).getVideoTracks()[0]:co(160*((t=r.aspectRatios[0])!==null&&t!==void 0?t:1),160,true,true),void 0,false,{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext}),{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext});this.localParticipant.addTrackPublication(e);this.localParticipant.emit(es.LocalTrackPublished,e)}if(n.audio){const e=new LocalTrackPublication(Track.Kind.Audio,new bt({source:it.MICROPHONE,sid:Math.floor(Math.random()*1e4).toString(),type:tt.AUDIO}),new LocalAudioTrack(n.useRealTracks?(yield navigator.mediaDevices.getUserMedia({audio:true})).getAudioTracks()[0]:uo(),void 0,false,this.audioContext,{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext}),{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext});this.localParticipant.addTrackPublication(e);this.localParticipant.emit(es.LocalTrackPublished,e)}for(let e=0;e<r.count-1;e+=1){let t=new pt({sid:Math.floor(Math.random()*1e4).toString(),identity:"simulated-".concat(e),state:mt.ACTIVE,tracks:[],joinedAt:A.parse(Date.now())});const n=this.getOrCreateParticipant(t.identity,t);if(r.video){const s=co(160*((i=r.aspectRatios[e%r.aspectRatios.length])!==null&&i!==void 0?i:1),160,false,true);const o=new bt({source:it.CAMERA,sid:Math.floor(Math.random()*1e4).toString(),type:tt.AUDIO});n.addSubscribedMediaTrack(s,o.sid,new MediaStream([s]),new RTCRtpReceiver);t.tracks=[...t.tracks,o]}if(r.audio){const e=uo();const i=new bt({source:it.MICROPHONE,sid:Math.floor(Math.random()*1e4).toString(),type:tt.AUDIO});n.addSubscribedMediaTrack(e,i.sid,new MediaStream([e]),new RTCRtpReceiver);t.tracks=[...t.tracks,i]}n.updateInfo(t)}}))}emit(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];if(e!==$r.ActiveSpeakersChanged&&e!==$r.TranscriptionReceived){const t=Ac(i).filter((e=>e!==void 0));this.log.debug("room event ".concat(e),Object.assign(Object.assign({},this.logContext),{event:e,args:t}))}return super.emit(e,...i)}}Room.cleanupRegistry=typeof FinalizationRegistry!=="undefined"&&new FinalizationRegistry((e=>{e()}));function Ac(e){return e.map((e=>{if(e)return Array.isArray(e)?Ac(e):typeof e==="object"?"logContext"in e?e.logContext:void 0:e}))}class Convert{static toAgentAttributes(e){return JSON.parse(e)}static agentAttributesToJson(e){return JSON.stringify(e)}static toTranscriptionAttributes(e){return JSON.parse(e)}static transcriptionAttributesToJson(e){return JSON.stringify(e)}}var _c=Object.freeze({__proto__:null,Convert:Convert});var Nc;(function(e){e[e.IDLE=0]="IDLE";e[e.RUNNING=1]="RUNNING";e[e.SKIPPED=2]="SKIPPED";e[e.SUCCESS=3]="SUCCESS";e[e.FAILED=4]="FAILED"})(Nc||(Nc={}));class Checker extends mn.EventEmitter{constructor(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};super();this.status=Nc.IDLE;this.logs=[];this.options={};this.url=e;this.token=t;this.name=this.constructor.name;this.room=new Room(i.roomOptions);this.connectOptions=i.connectOptions;this.options=i}run(e){return cn(this,void 0,void 0,(function*(){if(this.status!==Nc.IDLE)throw Error("check is running already");this.setStatus(Nc.RUNNING);try{yield this.perform()}catch(e){e instanceof Error&&(this.options.errorsAsWarnings?this.appendWarning(e.message):this.appendError(e.message))}yield this.disconnect();yield new Promise((e=>setTimeout(e,500)));this.status!==Nc.SKIPPED&&this.setStatus(this.isSuccess()?Nc.SUCCESS:Nc.FAILED);e&&e();return this.getInfo()}))}isSuccess(){return!this.logs.some((e=>e.level==="error"))}connect(e){return cn(this,void 0,void 0,(function*(){if(this.room.state===xc.Connected)return this.room;e||(e=this.url);yield this.room.connect(e,this.token,this.connectOptions);return this.room}))}disconnect(){return cn(this,void 0,void 0,(function*(){if(this.room&&this.room.state!==xc.Disconnected){yield this.room.disconnect();yield new Promise((e=>setTimeout(e,500)))}}))}skip(){this.setStatus(Nc.SKIPPED)}switchProtocol(e){return cn(this,void 0,void 0,(function*(){let t=false;let i=false;this.room.on($r.Reconnecting,(()=>{t=true}));this.room.once($r.Reconnected,(()=>{i=true}));this.room.simulateScenario("force-".concat(e));yield new Promise((e=>setTimeout(e,1e3)));if(!t)return;const n=Date.now()+1e4;while(Date.now()<n){if(i)return;yield Os(100)}throw new Error("Could not reconnect using ".concat(e," protocol after 10 seconds"))}))}appendMessage(e){this.logs.push({level:"info",message:e});this.emit("update",this.getInfo())}appendWarning(e){this.logs.push({level:"warning",message:e});this.emit("update",this.getInfo())}appendError(e){this.logs.push({level:"error",message:e});this.emit("update",this.getInfo())}setStatus(e){this.status=e;this.emit("update",this.getInfo())}get engine(){var e;return(e=this.room)===null||e===void 0?void 0:e.engine}getInfo(){return{logs:this.logs,name:this.name,status:this.status,description:this.description}}}class CloudRegionCheck extends Checker{get description(){return"Cloud regions"}perform(){return cn(this,void 0,void 0,(function*(){const e=new RegionUrlProvider(this.url,this.token);if(!e.isCloud()){this.skip();return}const t=[];const i=new Set;for(let n=0;n<3;n++){const n=yield e.getNextBestRegionUrl();if(!n)break;if(i.has(n))continue;i.add(n);const r=yield this.checkCloudRegion(n);this.appendMessage("".concat(r.region," RTT: ").concat(r.rtt,"ms, duration: ").concat(r.duration,"ms"));t.push(r)}t.sort(((e,t)=>.5*(e.duration-t.duration)+.5*(e.rtt-t.rtt)));const n=t[0];this.bestStats=n;this.appendMessage("best Cloud region: ".concat(n.region))}))}getInfo(){const e=super.getInfo();e.data=this.bestStats;return e}checkCloudRegion(e){return cn(this,void 0,void 0,(function*(){var t,i;yield this.connect(e);this.options.protocol==="tcp"&&(yield this.switchProtocol("tcp"));const n=(t=this.room.serverInfo)===null||t===void 0?void 0:t.region;if(!n)throw new Error("Region not found");const r=yield this.room.localParticipant.streamText({topic:"test"});const s=1e3;const o=1e6;const a=o/s;const c="A".repeat(s);const d=Date.now();for(let e=0;e<a;e++)yield r.write(c);yield r.close();const l=Date.now();const u=yield(i=this.room.engine.pcManager)===null||i===void 0?void 0:i.publisher.getStats();const h={region:n,rtt:1e4,duration:l-d};u===null||u===void 0?void 0:u.forEach((e=>{e.type==="candidate-pair"&&e.nominated&&(h.rtt=e.currentRoundTripTime*1e3)}));yield this.disconnect();return h}))}}const Lc=1e4;class ConnectionProtocolCheck extends Checker{get description(){return"Connection via UDP vs TCP"}perform(){return cn(this,void 0,void 0,(function*(){const e=yield this.checkConnectionProtocol("udp");const t=yield this.checkConnectionProtocol("tcp");this.bestStats=e;if(e.qualityLimitationDurations.bandwidth-t.qualityLimitationDurations.bandwidth>.5||(e.packetsLost-t.packetsLost)/e.packetsSent>.01){this.appendMessage("best connection quality via tcp");this.bestStats=t}else this.appendMessage("best connection quality via udp");const i=this.bestStats;this.appendMessage("upstream bitrate: ".concat((i.bitrateTotal/i.count/1e3/1e3).toFixed(2)," mbps"));this.appendMessage("RTT: ".concat((i.rttTotal/i.count*1e3).toFixed(2)," ms"));this.appendMessage("jitter: ".concat((i.jitterTotal/i.count*1e3).toFixed(2)," ms"));i.packetsLost>0&&this.appendWarning("packets lost: ".concat((i.packetsLost/i.packetsSent*100).toFixed(2),"%"));i.qualityLimitationDurations.bandwidth>1&&this.appendWarning("bandwidth limited ".concat((i.qualityLimitationDurations.bandwidth/(Lc/1e3)*100).toFixed(2),"%"));i.qualityLimitationDurations.cpu>0&&this.appendWarning("cpu limited ".concat((i.qualityLimitationDurations.cpu/(Lc/1e3)*100).toFixed(2),"%"))}))}getInfo(){const e=super.getInfo();e.data=this.bestStats;return e}checkConnectionProtocol(e){return cn(this,void 0,void 0,(function*(){yield this.connect();e==="tcp"?yield this.switchProtocol("tcp"):yield this.switchProtocol("udp");const t=document.createElement("canvas");t.width=1280;t.height=720;const i=t.getContext("2d");if(!i)throw new Error("Could not get canvas context");let n=0;const r=()=>{n=(n+1)%360;i.fillStyle="hsl(".concat(n,", 100%, 50%)");i.fillRect(0,0,t.width,t.height);requestAnimationFrame(r)};r();const s=t.captureStream(30);const o=s.getVideoTracks()[0];const a=yield this.room.localParticipant.publishTrack(o,{simulcast:false,degradationPreference:"maintain-resolution",videoEncoding:{maxBitrate:2e6}});const c=a.track;const d={protocol:e,packetsLost:0,packetsSent:0,qualityLimitationDurations:{},rttTotal:0,jitterTotal:0,bitrateTotal:0,count:0};const l=setInterval((()=>cn(this,void 0,void 0,(function*(){const e=yield c.getRTCStatsReport();e===null||e===void 0?void 0:e.forEach((e=>{if(e.type==="outbound-rtp"){d.packetsSent=e.packetsSent;d.qualityLimitationDurations=e.qualityLimitationDurations;d.bitrateTotal+=e.targetBitrate;d.count++}else if(e.type==="remote-inbound-rtp"){d.packetsLost=e.packetsLost;d.rttTotal+=e.roundTripTime;d.jitterTotal+=e.jitter}}))}))),1e3);yield new Promise((e=>setTimeout(e,Lc)));clearInterval(l);o.stop();t.remove();yield this.disconnect();return d}))}}class PublishAudioCheck extends Checker{get description(){return"Can publish audio"}perform(){return cn(this,void 0,void 0,(function*(){var e;const t=yield this.connect();const i=yield Pc();const n=yield Lo(i,1e3);if(n)throw new Error("unable to detect audio from microphone");this.appendMessage("detected audio from microphone");t.localParticipant.publishTrack(i);yield new Promise((e=>setTimeout(e,3e3)));const r=yield(e=i.sender)===null||e===void 0?void 0:e.getStats();if(!r)throw new Error("Could not get RTCStats");let s=0;r.forEach((e=>{e.type!=="outbound-rtp"||e.kind!=="audio"&&(e.kind||e.mediaType!=="audio")||(s=e.packetsSent)}));if(s===0)throw new Error("Could not determine packets are sent");this.appendMessage("published ".concat(s," audio packets"))}))}}class PublishVideoCheck extends Checker{get description(){return"Can publish video"}perform(){return cn(this,void 0,void 0,(function*(){var e;const t=yield this.connect();const i=yield Ec();yield this.checkForVideo(i.mediaStreamTrack);t.localParticipant.publishTrack(i);yield new Promise((e=>setTimeout(e,5e3)));const n=yield(e=i.sender)===null||e===void 0?void 0:e.getStats();if(!n)throw new Error("Could not get RTCStats");let r=0;n.forEach((e=>{e.type!=="outbound-rtp"||e.kind!=="video"&&(e.kind||e.mediaType!=="video")||(r+=e.packetsSent)}));if(r===0)throw new Error("Could not determine packets are sent");this.appendMessage("published ".concat(r," video packets"))}))}checkForVideo(e){return cn(this,void 0,void 0,(function*(){const t=new MediaStream;t.addTrack(e.clone());const i=document.createElement("video");i.srcObject=t;i.muted=true;yield new Promise((t=>{i.onplay=()=>{setTimeout((()=>{var n,r,s,o;const a=document.createElement("canvas");const c=e.getSettings();const d=(r=(n=c.width)!==null&&n!==void 0?n:i.videoWidth)!==null&&r!==void 0?r:1280;const l=(o=(s=c.height)!==null&&s!==void 0?s:i.videoHeight)!==null&&o!==void 0?o:720;a.width=d;a.height=l;const u=a.getContext("2d");u.drawImage(i,0,0);const h=u.getImageData(0,0,a.width,a.height);const p=h.data;let m=true;for(let e=0;e<p.length;e+=4)if(p[e]!==0||p[e+1]!==0||p[e+2]!==0){m=false;break}m?this.appendError("camera appears to be producing only black frames"):this.appendMessage("received video frames");t()}),1e3)};i.play()}));t.getTracks().forEach((e=>e.stop()));i.remove()}))}}class ReconnectCheck extends Checker{get description(){return"Resuming connection after interruption"}perform(){return cn(this,void 0,void 0,(function*(){var e;const t=yield this.connect();let i=false;let n=false;let r;const s=new Promise((e=>{setTimeout(e,5e3);r=e}));const o=()=>{i=true};t.on($r.SignalReconnecting,o).on($r.Reconnecting,o).on($r.Reconnected,(()=>{n=true;r(true)}));(e=t.engine.client.ws)===null||e===void 0?void 0:e.close();const a=t.engine.client.onClose;a&&a("");yield s;if(!i)throw new Error("Did not attempt to reconnect");if(!n||t.state!==xc.Connected){this.appendWarning("reconnection is only possible in Redis-based configurations");throw new Error("Not able to reconnect")}}))}}class TURNCheck extends Checker{get description(){return"Can connect via TURN"}perform(){return cn(this,void 0,void 0,(function*(){var e,t;const i=new SignalClient;const n=yield i.join(this.url,this.token,{autoSubscribe:true,maxRetries:0,e2eeEnabled:false,websocketTimeout:15e3});let r=false;let s=false;let o=false;for(let e of n.iceServers)for(let t of e.urls){if(t.startsWith("turn:")){s=true;o=true}else if(t.startsWith("turns:")){s=true;o=true;r=true}t.startsWith("stun:")&&(o=true)}o?s&&!r&&this.appendWarning("TURN is configured server side, but TURN/TLS is unavailable."):this.appendWarning("No STUN servers configured on server side.");yield i.close();if(((t=(e=this.connectOptions)===null||e===void 0?void 0:e.rtcConfig)===null||t===void 0?void 0:t.iceServers)||s)yield this.room.connect(this.url,this.token,{rtcConfig:{iceTransportPolicy:"relay"}});else{this.appendWarning("No TURN servers configured.");this.skip();yield new Promise((e=>setTimeout(e,0)))}}))}}class WebRTCCheck extends Checker{get description(){return"Establishing WebRTC connection"}perform(){return cn(this,void 0,void 0,(function*(){let e=false;let t=false;this.room.on($r.SignalConnected,(()=>{const i=this.room.engine.client.onTrickle;this.room.engine.client.onTrickle=(n,r)=>{if(n.candidate){const i=new RTCIceCandidate(n);let r="".concat(i.protocol," ").concat(i.address,":").concat(i.port," ").concat(i.type);if(i.address)if(Uc(i.address))r+=" (private)";else if(i.protocol==="tcp"&&i.tcpType==="passive"){e=true;r+=" (passive)"}else i.protocol==="udp"&&(t=true);this.appendMessage(r)}i&&i(n,r)};this.room.engine.pcManager&&(this.room.engine.pcManager.subscriber.onIceCandidateError=e=>{e instanceof RTCPeerConnectionIceErrorEvent&&this.appendWarning("error with ICE candidate: ".concat(e.errorCode," ").concat(e.errorText," ").concat(e.url))})}));try{yield this.connect();Zi.info("now the room is connected")}catch(e){this.appendWarning("ports need to be open on firewall in order to connect.");throw e}e||this.appendWarning("Server is not configured for ICE/TCP");t||this.appendWarning("No public IPv4 UDP candidates were found. Your server is likely not configured correctly")}))}}function Uc(e){const t=e.split(".");if(t.length===4){if(t[0]==="10")return true;if(t[0]==="192"&&t[1]==="168")return true;if(t[0]==="172"){const e=parseInt(t[1],10);if(e>=16&&e<=31)return true}}return false}class WebSocketCheck extends Checker{get description(){return"Connecting to signal connection via WebSocket"}perform(){return cn(this,void 0,void 0,(function*(){var e,t,i;(this.url.startsWith("ws:")||this.url.startsWith("http:"))&&this.appendWarning("Server is insecure, clients may block connections to it");let n=new SignalClient;const r=yield n.join(this.url,this.token,{autoSubscribe:true,maxRetries:0,e2eeEnabled:false,websocketTimeout:15e3});this.appendMessage("Connected to server, version ".concat(r.serverVersion,"."));((e=r.serverInfo)===null||e===void 0?void 0:e.edition)===Lt.Cloud&&((t=r.serverInfo)===null||t===void 0?void 0:t.region)&&this.appendMessage("LiveKit Cloud: ".concat((i=r.serverInfo)===null||i===void 0?void 0:i.region));yield n.close()}))}}class ConnectionCheck extends mn.EventEmitter{constructor(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};super();this.options={};this.checkResults=new Map;this.url=e;this.token=t;this.options=i}getNextCheckId(){const e=this.checkResults.size;this.checkResults.set(e,{logs:[],status:Nc.IDLE,name:"",description:""});return e}updateCheck(e,t){this.checkResults.set(e,t);this.emit("checkUpdate",e,t)}isSuccess(){return Array.from(this.checkResults.values()).every((e=>e.status!==Nc.FAILED))}getResults(){return Array.from(this.checkResults.values())}createAndRunCheck(e){return cn(this,void 0,void 0,(function*(){const t=this.getNextCheckId();const i=new e(this.url,this.token,this.options);const n=e=>{this.updateCheck(t,e)};i.on("update",n);const r=yield i.run();i.off("update",n);return r}))}checkWebsocket(){return cn(this,void 0,void 0,(function*(){return this.createAndRunCheck(WebSocketCheck)}))}checkWebRTC(){return cn(this,void 0,void 0,(function*(){return this.createAndRunCheck(WebRTCCheck)}))}checkTURN(){return cn(this,void 0,void 0,(function*(){return this.createAndRunCheck(TURNCheck)}))}checkReconnect(){return cn(this,void 0,void 0,(function*(){return this.createAndRunCheck(ReconnectCheck)}))}checkPublishAudio(){return cn(this,void 0,void 0,(function*(){return this.createAndRunCheck(PublishAudioCheck)}))}checkPublishVideo(){return cn(this,void 0,void 0,(function*(){return this.createAndRunCheck(PublishVideoCheck)}))}checkConnectionProtocol(){return cn(this,void 0,void 0,(function*(){const e=yield this.createAndRunCheck(ConnectionProtocolCheck);if(e.data&&"protocol"in e.data){const t=e.data;this.options.protocol=t.protocol}return e}))}checkCloudRegion(){return cn(this,void 0,void 0,(function*(){return this.createAndRunCheck(CloudRegionCheck)}))}}function jc(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};var i;const n=Co(e)?e.mediaStreamTrack:e;const r=n.getSettings();let s={facingMode:(i=t.defaultFacingMode)!==null&&i!==void 0?i:"user",confidence:"low"};if("facingMode"in r){const e=r.facingMode;Zi.trace("rawFacingMode",{rawFacingMode:e});e&&typeof e==="string"&&qc(e)&&(s={facingMode:e,confidence:"high"})}if(["low","medium"].includes(s.confidence)){Zi.trace("Try to get facing mode from device label: (".concat(n.label,")"));const e=Vc(n.label);e!==void 0&&(s=e)}return s}const Fc=new Map([["obs virtual camera",{facingMode:"environment",confidence:"medium"}]]);const Bc=new Map([["iphone",{facingMode:"environment",confidence:"medium"}],["ipad",{facingMode:"environment",confidence:"medium"}]]);function Vc(e){var t;const i=e.trim().toLowerCase();if(i!=="")return Fc.has(i)?Fc.get(i):(t=Array.from(Bc.entries()).find((e=>{let[t]=e;return i.includes(t)})))===null||t===void 0?void 0:t[1]}function qc(e){const t=["user","environment","left","right"];return e===void 0||t.includes(e)}export{Cs as AudioPresets,Ts as BackupCodecPolicy,BaseKeyProvider,Nc as CheckStatus,Checker,ConnectionCheck,ConnectionError,Qr as ConnectionErrorReason,Ic as ConnectionQuality,xc as ConnectionState,CriticalTimers,CryptorError,Zr as CryptorErrorReason,Mr as CryptorEvent,Ct as DataPacket_Kind,DataStreamError,Yr as DataStreamErrorReason,DefaultReconnectPolicy,DeviceUnsupportedError,ot as DisconnectReason,xr as EncryptionEvent,ts as EngineEvent,ExternalE2EEKeyProvider,Dr as KeyHandlerEvent,Or as KeyProviderEvent,LivekitError,LocalAudioTrack,LocalParticipant,LocalTrack,LocalTrackPublication,LocalTrackRecorder,LocalVideoTrack,Yi as LogLevel,Xi as LoggerNames,Xr as MediaDeviceFailure,_ as Mutex,NegotiationError,Participant,es as ParticipantEvent,gt as ParticipantKind,PublishDataError,PublishTrackError,RemoteAudioTrack,RemoteParticipant,RemoteTrack,RemoteTrackPublication,RemoteVideoTrack,Room,$r as RoomEvent,RpcError,Es as ScreenSharePresets,SignalRequestError,ct as SubscriptionError,Track,is as TrackEvent,TrackInvalidError,TrackPublication,tt as TrackType,UnexpectedConnectionState,UnsupportedServer,VideoPreset,Ss as VideoPresets,ws as VideoPresets43,gs as VideoQuality,fs as attachToElement,_c as attributes,Zs as compareVersions,ho as createAudioAnalyser,qr as createE2EEKey,Fr as createKeyMaterialFromBuffer,jr as createKeyMaterialFromString,Pc as createLocalAudioTrack,Rc as createLocalScreenTracks,wc as createLocalTracks,Ec as createLocalVideoTrack,Vr as deriveKeys,vs as detachTrack,Vc as facingModeFromDeviceLabel,jc as facingModeFromLocalTrack,os as getBrowser,uo as getEmptyAudioStreamTrack,ao as getEmptyVideoStreamTrack,en as getLogger,Ur as importKey,So as isAudioTrack,ys as isBackupCodec,js as isBrowserSupported,Ar as isE2EESupported,Nr as isInsertableStreamSupported,Do as isLocalParticipant,Co as isLocalTrack,xo as isRemoteParticipant,Ro as isRemoteTrack,_r as isScriptTransformSupported,Lr as isVideoFrame,wo as isVideoTrack,Wr as needsRbspUnescaping,Kr as parseRbsp,hs as protocolVersion,Hr as ratchet,nn as setLogExtension,tn as setLogLevel,_s as supportsAV1,Ms as supportsAdaptiveStream,As as supportsDynacast,Ns as supportsVP9,us as version,bs as videoCodecs,Jr as writeRbsp};

